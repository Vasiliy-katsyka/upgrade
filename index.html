```html
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–°–∏–º—É–ª—è—Ç–æ—Ä –ü–æ–¥–∞—Ä–∫–æ–≤ Telegram</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"></script>
    <style>
        :root {
            --tg-theme-bg-color: #0e1621;
            --tg-theme-text-color: #ffffff;
            --tg-theme-hint-color: #708499;
            --tg-theme-link-color: #62bcf9;
            --tg-theme-button-color: #3e97f0;
            --tg-theme-button-text-color: #ffffff;
            --tg-theme-secondary-bg-color: #17212b;
            --tg-theme-accent-blue: #5288c1;

            --app-modal-backdrop-color: rgba(0,0,0,0.7);
            --app-rarity-chip-bg: rgba(0,0,0,0.2); 
            --app-rarity-chip-text: var(--tg-theme-text-color);
            --app-action-button-bg: #232e3a;
            --app-action-button-text: var(--tg-theme-link-color);
            --app-profile-gradient-fallback: var(--tg-theme-secondary-bg-color);
            --app-clear-data-color: #ff3b30;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--tg-theme-bg-color);
            color: var(--tg-theme-text-color);
            overscroll-behavior-y: none;
            line-height: 1.4;
            font-size: 16px;
        }

        .app-container {
            max-width: 600px;
            margin: 0 auto;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .page {
            display: none;
            flex-direction: column;
            flex-grow: 1;
            background-color: var(--tg-theme-bg-color);
        }

        .page.active {
            display: flex;
        }

        .page-header {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            background-color: var(--tg-theme-secondary-bg-color);
            min-height: 56px;
            position: sticky; top: 0; z-index: 10;
        }
        #profile-page > .page-header { 
            background-color: transparent; 
            position: absolute;
            top: 0; left:0; right:0;
            z-index: 100;
        }
        .page-header .back-button {
            background: none; border: none;
            color: var(--tg-theme-link-color);
            cursor: pointer;
            padding: 5px; margin-right: 15px;
            display: flex; align-items: center; justify-content: center;
        }
        #profile-page > .page-header .back-button { color: var(--tg-theme-text-color); }
        .page-header .back-button svg { width: 24px; height: 24px; fill: currentColor; }
        .page-header h2 {
            font-size: 1.15em;
            color: var(--tg-theme-text-color);
            font-weight: 500;
        }
        .page-header .menu-button {
            background: none; border: none;
            color: var(--tg-theme-link-color);
            font-size: 1.8em; /* Adjusted for just icon */
            margin-left: auto;
            cursor: pointer;
            padding: 5px;
        }

        /* Profile Page Pinned Gifts Styling */
        .profile-page-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        .profile-top-section {
            position: relative;
            padding-top: 20px; /* Reduced to make space for absolute pinned gifts */
            background: var(--app-profile-gradient-fallback);
            transition: background 0.3s ease;
            min-height: 180px; /* Ensure enough height for floating gifts */
        }
        .profile-header-pattern-overlay {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background-repeat: repeat;
            background-size: 30% auto;
            opacity: 0.07;
            pointer-events: none;
            z-index: 0;
        }
        #profile-top-pinned-gifts {
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 130px; /* Adjust height to contain floating gifts */
            pointer-events: none; /* Container itself shouldn't capture events */
            z-index: 5; /* Above background, below header buttons */
        }
        #profile-top-pinned-gifts .pinned-gift-item {
            position: absolute;
            width: 45px; /* Size of floating gifts */
            height: 45px;
            border-radius: 8px;
            background-color: rgba(0,0,0,0.1); /* Fallback bg */
            overflow: hidden;
            pointer-events: auto; /* Individual gifts can be interactive if needed */
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        /* Example positions for 6 pinned gifts */
        #profile-top-pinned-gifts .pinned-gift-item:nth-child(1) { top: 55px; left: 15%; transform: rotate(-10deg) scale(0.9); }
        #profile-top-pinned-gifts .pinned-gift-item:nth-child(2) { top: 20px; left: 30%; transform: rotate(5deg) scale(1.0); }
        #profile-top-pinned-gifts .pinned-gift-item:nth-child(3) { top: 60px; left: 48%; transform: rotate(-5deg) scale(0.85); }
        #profile-top-pinned-gifts .pinned-gift-item:nth-child(4) { top: 15px; left: 65%; transform: rotate(12deg) scale(0.95); }
        #profile-top-pinned-gifts .pinned-gift-item:nth-child(5) { top: 65px; left: 80%; transform: rotate(8deg) scale(0.9); }
        #profile-top-pinned-gifts .pinned-gift-item:nth-child(6) { top: 30px; left: 5%; transform: rotate(-15deg) scale(0.8); }

        .profile-header-content-wrapper {
             position: relative; z-index: 10; /* Above pinned gifts visually for text/avatar */
             padding: 0 15px;
             margin-top: 56px; /* Space for the floating gifts area + page header */
        }
        .profile-main-info {
            display: flex;
            align-items: center;
            padding: 8px 0 20px 0;
        }
        .profile-avatar {
            width: 70px; height: 70px;
            border-radius: 50%;
            background-color: var(--tg-theme-hint-color);
            margin-right: 15px;
            object-fit: cover;
            border: 3px solid rgba(255,255,255,0.1);
        }
        .profile-name-status { display: flex; flex-direction: column; }
        .profile-name-status .name-line { display: flex; align-items: center; }
        .profile-name-status h1 {
            font-size: 1.4em; font-weight: 600;
            color: var(--tg-theme-text-color);
        }
        #worn-gift-icon-container {
            width: 24px; height: 24px; margin-left: 8px;
            overflow: hidden;
        }
        #profile-owner-worn-gift-icon-collectible-modal { /* For collectible modal */
             width: 20px; height: 20px; margin-left: 5px; display: inline-block; vertical-align: middle;
        }
        .profile-name-status p { font-size: 0.95em; color: var(--tg-theme-text-color); opacity: 0.7; margin-top: 3px; }
        .profile-name-status p.online { opacity: 1; color: var(--tg-theme-link-color); }
        
        .profile-details-section {
            background-color: var(--tg-theme-bg-color);
            padding: 15px 15px 5px 15px;
        }
        .profile-details p { margin-bottom: 12px; font-size: 0.95em; }
        .profile-details p:last-child { margin-bottom: 0; }
        .profile-details p strong {
            display: block; color: var(--tg-theme-hint-color);
            font-weight: normal; font-size: 0.9em; margin-bottom: 4px;
        }
        .profile-details p span { color: var(--tg-theme-text-color); }
        .profile-details p span#profile-username { color: var(--tg-theme-link-color); }

        .profile-tabs {
            display: flex; justify-content: space-around;
            background-color: var(--tg-theme-bg-color);
            padding: 5px 0 0 0;
        }
        .profile-tabs button {
            background: none; border: none;
            color: var(--tg-theme-hint-color);
            padding: 14px 10px; font-size: 1em;
            cursor: pointer; flex-grow: 1;
            border-bottom: 3px solid transparent; position: relative;
            font-weight: 500;
        }
        .profile-tabs button.active { color: var(--tg-theme-link-color); }
        .profile-tabs button.active::after {
            content: ''; position: absolute;
            bottom: 0px; left: 0; right: 0;
            height: 3px; background-color: var(--tg-theme-link-color);
        }
        
        .profile-gifts-actions-wrapper {
            display: flex;
            align-items: center;
            background-color: var(--tg-theme-bg-color);
            padding: 12px 15px;
        }
        #filter-long-press-target {
            flex-grow: 1; height: 36px; cursor: pointer;
        }
        .profile-gifts-actions {
            display: flex; justify-content: flex-end;
            align-items: center;
            margin-left: 10px;
        }
        .profile-gifts-actions .action-button {
            background-color: var(--tg-theme-button-color);
            color: var(--tg-theme-button-text-color);
            border: none; padding: 8px 18px;
            border-radius: 20px; font-size: 0.9em; cursor: pointer;
            font-weight: 500;
        }
        #upgrade-all-gifts-button { background-color: var(--tg-theme-accent-blue); margin-right: 10px; }

        .gifts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 5px;
            padding: 10px;
            flex-grow: 1;
            overflow-y: auto;
            background-color: var(--tg-theme-bg-color);
        }
        .empty-grid-message {
            color: var(--tg-theme-hint-color); text-align: center;
            padding: 30px 40px; font-size: 0.95em; line-height: 1.5; width: 100%; 
        }

        .gift-card, .buy-gift-item { /* Combined common styles */
            background-color: var(--tg-theme-secondary-bg-color);
            border-radius: 10px;
            padding: 8px;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            aspect-ratio: 1 / 1; cursor: pointer;
            position: relative; overflow: hidden;
            transition: transform 0.1s ease-out;
        }
        .buy-gift-item { aspect-ratio: 1/1.1; } /* Specific for buy items */
        .gift-card.is-updating { transform: scale(0.95); opacity: 0.7; }
        .gift-card-bg-pattern, .buy-gift-item-bg-pattern { /* For collectibles */
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background-size: cover; pointer-events: none; z-index: 0;
        }
        .gift-card-pattern-overlay, .buy-gift-item-pattern-overlay {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background-repeat: repeat;
            background-size: 30% auto;
            background-position: center;
            opacity: 0.1;
            pointer-events: none; z-index: 1;
        }
        .image-container { /* Common for gift cards and buy items */
            width: 70%; height: 70%; /* For gift-card */
            display: flex; align-items: center; justify-content: center;
            position: relative; z-index: 2;
        }
        .buy-gift-item .image-container { /* Specific for buy-gift-item */
            width: 65%; max-height: 60px; /* from buy-gift-item img */
            margin-bottom: 8px; height: auto; /* Adjust as needed */
        }
        
        .static-image-fallback {
            max-width: 100%; max-height: 100%;
            object-fit: contain;
        }
        .lottie-animation-container {
            width: 100%; height: 100%;
            display: flex; align-items: center; justify-content: center;
        }
        .gift-card .collectible-number-badge {
            position: absolute; top: 5px; right: 5px;
            background-color: rgba(0,0,0,0.35);
            color: var(--tg-theme-text-color);
            font-size: 0.65em; padding: 2px 5px;
            border-radius: 8px; z-index: 3; font-weight: 500;
        }
        .gift-card .gift-rarity-badge {
            position: absolute; bottom: 5px; left:0; right: 0;
            text-align: center;
            background-color: rgba(0,0,0,0.25);
            color: var(--tg-theme-text-color);
            font-size: 0.6em; padding: 2px 0;
            z-index: 3; font-weight: 400;
        }
        .gift-card .pin-indicator {
            position: absolute; top: 5px; left: 5px;
            z-index: 3; display: flex; align-items: center; justify-content: center;
        }
        .gift-card .pin-indicator svg { width: 18px; height: 18px; fill: var(--tg-theme-link-color); opacity: 0.8; }

        .buy-gift-item .gift-name {
            font-size: 0.8em; text-align: center;
            color: var(--tg-theme-text-color); margin-bottom: 6px;
            min-height: 2.4em; overflow: hidden; text-overflow: ellipsis;
            display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;
            z-index: 2; /* Above potential bg pattern */
        }
        .buy-gift-item .gift-price { font-size: 0.9em; color: var(--tg-theme-hint-color); z-index: 2;}
        .buy-gift-item .gift-price .star-icon { color: #f5a623; margin-right: 3px;}
        .buy-gift-item .limited-label { /* Copied from .limited-label */
            position: absolute; top: 6px; right: 6px;
            background-color: var(--tg-theme-accent-blue);
            color: var(--tg-theme-button-text-color);
            font-size: 0.6em; padding: 2px 6px;
            border-radius: 8px; font-weight: 500; z-index: 3;
        }

        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background-color: var(--app-modal-backdrop-color);
            display: flex; align-items: flex-end;
            justify-content: center; z-index: 1000;
            opacity: 0; visibility: hidden;
            transition: opacity 0.25s ease, transform 0.25s ease;
            transform: translateY(100%);
        }
        .modal-overlay.active { opacity: 1; visibility: visible; transform: translateY(0%); }
        .modal-content {
            background-color: var(--tg-theme-secondary-bg-color);
            padding-top: 0;
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
            width: 100%; max-width: 600px;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.2);
            display: flex; flex-direction: column;
            max-height: 90vh;
        }
        .modal-header-bar {
            padding: 15px 20px; text-align: center;
            position: sticky; top: 0; background-color: var(--tg-theme-secondary-bg-color); z-index: 1;
        }
        .modal-header-bar h3 { font-size: 1.1em; font-weight: 500; }
        
        .modal-scrollable-content { overflow-y: auto; padding: 15px 20px; flex-grow: 1; }
        .modal-buttons-footer {
            padding: 15px 20px;
            background-color: var(--tg-theme-secondary-bg-color);
            position: sticky; bottom: 0; z-index: 1;
        }
        .modal-button {
            background-color: var(--tg-theme-button-color);
            color: var(--tg-theme-button-text-color);
            border: none; padding: 13px; border-radius: 8px;
            font-size: 1em; cursor: pointer; text-align: center;
            font-weight: 500; width: 100%;
        }
        .modal-button.secondary {
            background-color: var(--app-action-button-bg);
            color: var(--tg-theme-link-color);
            margin-top: 10px;
        }

        #gift-detail-modal .modal-gift-image-container {
            width: 120px; height: 120px;
            margin: 10px auto 15px auto; display: flex;
            align-items: center; justify-content: center;
        }
        #gift-detail-modal .modal-gift-image-static {
             max-width: 100%; max-height: 100%; object-fit: contain;
        }
        #gift-detail-modal .lottie-animation-container { /* Reusing generic */
             width: 100%; height: 100%;
        }
        #gift-detail-modal .modal-gift-description {
            font-size: 0.9em; color: var(--tg-theme-hint-color);
            margin-bottom: 8px; text-align: center; line-height: 1.5;
        }
        #gift-detail-modal .modal-info-table .info-row {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px 0; font-size: 0.95em;
        }
        #gift-detail-modal .modal-info-table .info-row:not(:last-child) { margin-bottom: 2px; }
        #gift-detail-modal .modal-info-table .info-label { color: var(--tg-theme-text-color); }
        #gift-detail-modal .modal-info-table .info-value { color: var(--tg-theme-hint-color); }
        #gift-detail-modal .info-value-with-action { display: flex; align-items: center; }
        #gift-detail-modal .info-value-with-action span { margin-right: 10px; color: var(--tg-theme-hint-color); }
        #gift-detail-modal .button-link-styled {
            background: none; border: none;
            color: var(--tg-theme-link-color);
            font-size: 0.95em; font-weight: 500;
            padding: 5px; cursor: pointer;
        }
        #gift-detail-modal .button-link-styled:disabled { color: var(--tg-theme-hint-color); }
        
        /* Collectible Detail Modal Redesign */
        #collectible-detail-modal .modal-content { padding-top: 0; }
        #collectible-detail-modal .page-header {
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
            background-color: transparent; /* Header itself is transparent */
            z-index: 20; /* Above display area background */
        }
        #collectible-detail-modal .page-header h2 { display: none; } /* Hide title from header */
        #collectible-detail-modal .modal-scrollable-content { padding: 0; }

        .collectible-display-area {
            /* background-color: var(--tg-theme-bg-color); */ /* Removed, background handled by modal-collectible-bg and pattern */
            padding: 20px 20px 10px 20px; /* Reduced bottom padding */
            text-align: center;
            position: relative; /* For stacking context of bg and pattern */
            min-height: 280px; /* Ensure enough space */
            display: flex; flex-direction: column; justify-content: flex-end;
        }
        #modal-collectible-bg { /* Moved to cover collectible-display-area */
            position: absolute; top:0;left:0;right:0;bottom:0; z-index: 1;
        }
        #modal-collectible-pattern { /* Moved to cover collectible-display-area */
            position: absolute; top:0;left:0;right:0;bottom:0;
            background-size: 25% auto; 
            background-repeat: repeat; opacity: 0.15; 
            z-index: 2;
        }
        .modal-collectible-visual { /* Container for the Lottie/image, now smaller and transparent bg */
            width: 60%; /* Smaller gift visual, e.g. 60% of display area width */
            max-width: 180px; /* Max size for visual */
            aspect-ratio: 1/1; margin: 0 auto;
            border-radius: 12px; position: relative; overflow: hidden;
            display: flex; align-items: center; justify-content: center;
            background-color: transparent; /* No distinct square bg */
            z-index: 3; /* Above area bg/pattern */
            margin-bottom: 10px; /* Space before name */
        }
        .modal-collectible-visual .static-image-fallback,
        .modal-collectible-visual .lottie-animation-container {
             max-width: 100%; max-height: 100%; /* Lottie/Image fills the visual container */
             object-fit: contain;
             /* z-index remains as previously set for them within this container */
        }
        .collectible-display-area h3#modal-collectible-main-name { /* Was model name, now gift name */
            font-size: 1.5em; font-weight: 600; margin-top: 0; /* No margin-top if visual has margin-bottom */
            color: var(--tg-theme-text-color);
            position: relative; z-index: 3;
        }
        .collectible-display-area p#modal-collectible-number-subtext {
            font-size: 0.95em; color: var(--tg-theme-hint-color); margin-bottom: 10px; /* Reduced margin */
            position: relative; z-index: 3;
        }

        .modal-action-buttons-row {
            display: flex; justify-content: space-around; gap: 10px;
            padding: 10px 20px 15px 20px; /* Adjusted padding */
            background-color: var(--tg-theme-bg-color); /* Matches Telegram */
            position: relative; z-index: 3; /* For display area stacking */
        }
        .modal-action-buttons-row button {
            flex-grow: 1; padding: 10px 5px; font-size: 0.9em;
            background-color: var(--app-action-button-bg);
            color: var(--tg-theme-text-color);
            border: none; border-radius: 8px;
            display: flex; flex-direction: column; align-items: center;
            font-weight: 500;
        }
        .modal-action-buttons-row button .icon { margin-bottom: 5px; display: flex; align-items: center; justify-content: center; }
        .modal-action-buttons-row button .icon svg { width: 22px; height: 22px; fill: var(--tg-theme-link-color); }
        .modal-action-buttons-row button .text { font-size: 0.9em; }

        .collectible-info-section { 
            padding: 0 20px; 
            background-color: var(--tg-theme-secondary-bg-color); 
        }
        .collectible-info-section .info-row {
            display: flex; align-items: center; justify-content: space-between;
            padding: 12px 0; font-size: 0.95em;
        }
        .collectible-info-section .info-row:not(:last-child) { margin-bottom: 2px; }
        .collectible-info-section .info-label { color: var(--tg-theme-text-color); }
        .collectible-info-section .info-value { color: var(--tg-theme-hint-color); display: flex; align-items: center; }
        .collectible-info-section .info-value img.owner-avatar { width: 24px; height: 24px; border-radius: 50%; margin-right: 8px; }
        .collectible-info-section .info-value .rarity-chip {
            background-color: var(--app-rarity-chip-bg);
            color: var(--app-rarity-chip-text);
            padding: 2px 7px; border-radius: 8px;
            font-size: 0.8em; margin-left: 8px; font-weight: 500;
        }
        
        .modal-footer-message {
            text-align: center; font-size: 0.85em;
            color: var(--tg-theme-hint-color); padding: 15px 20px;
            background-color: var(--tg-theme-bg-color); /* Matches Telegram */
        }
        .modal-footer-message .link { color: var(--tg-theme-link-color); cursor: pointer; }

        #long-press-menu {
            position: fixed;
            background-color: var(--tg-theme-secondary-bg-color);
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            z-index: 1001; padding: 6px 0; min-width: 180px;
        }
        #long-press-menu ul { list-style: none; }
        #long-press-menu li { padding: 10px 20px; cursor: pointer; color: var(--tg-theme-text-color); font-size: 0.95em; }
        #long-press-menu li.disabled { color: var(--tg-theme-hint-color); cursor: default; }
        #long-press-menu li:not(.disabled):hover { background-color: rgba(255,255,255,0.05); }
        
        #buy-multiple-quantity, #transfer-recipient-input {
            width: 100%; padding: 10px; text-align: center; margin-bottom:15px; 
            background-color: var(--tg-theme-bg-color); 
            color: var(--tg-theme-text-color); 
            border: 1px solid var(--tg-theme-hint-color);
            border-radius: 8px; font-size: 1em;
        }
        #buy-multiple-quantity::-webkit-outer-spin-button,
        #buy-multiple-quantity::-webkit-inner-spin-button,
        #transfer-recipient-input::-webkit-outer-spin-button,
        #transfer-recipient-input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        #buy-multiple-quantity[type=number],
        #transfer-recipient-input[type=text] { -moz-appearance: textfield; }


        #filter-popup .filter-section { margin-bottom: 15px; }
        #filter-popup .filter-section h4 {
            font-size: 0.9em; font-weight: 500; color: var(--tg-theme-hint-color);
            margin-bottom: 8px; padding-left: 5px;
        }
        #filter-popup .filter-options-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            gap: 8px; max-height: 150px; overflow-y: auto;
            padding: 5px; background-color: rgba(0,0,0,0.1); border-radius: 8px;
        }
        #filter-popup .filter-option {
            aspect-ratio: 1/1; border-radius: 6px;
            background-color: var(--tg-theme-bg-color);
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; border: 2px solid transparent;
            overflow: hidden;
        }
        #filter-popup .filter-option.selected { border-color: var(--tg-theme-link-color); }
        #filter-popup .filter-option img { max-width: 80%; max-height: 80%; object-fit: contain; }
        #filter-popup .filter-option .gradient-square { width: 100%; height: 100%; }
        #filter-popup .clear-data-button {
            background-color: transparent;
            color: var(--app-clear-data-color);
            border: none; padding: 13px; border-radius: 8px;
            font-size: 1em; cursor: pointer; text-align: center;
            font-weight: 500; width: 100%;
            display: flex; align-items: center; justify-content: center;
            margin-top: 15px;
        }
        #filter-popup .clear-data-button svg { width: 20px; height: 20px; fill: currentColor; margin-right: 8px; }

        .spinner {
            border: 4px solid var(--tg-theme-hint-color);
            border-top: 4px solid var(--tg-theme-link-color);
            border-radius: 50%; width: 30px; height: 30px;
            animation: spin 1s linear infinite; margin: 20px auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .hidden { display: none !important; }
        .placeholder-image {
            background-color: var(--tg-theme-hint-color); width: 100%; height: 100%;
            display: flex; align-items: center; justify-content: center;
            color: var(--tg-theme-bg-color); font-size: 0.8em; border-radius: 8px;
        }
        .toast-notification {
            position: fixed;
            bottom: 70px; /* Above potential main button */
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--tg-theme-secondary-bg-color);
            color: var(--tg-theme-text-color);
            padding: 10px 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 2000;
            opacity: 0;
            transition: opacity 0.3s ease, bottom 0.3s ease;
            font-size: 0.9em;
        }
        .toast-notification.show {
            opacity: 1;
            bottom: 90px;
        }
        .toast-notification a {
            color: var(--tg-theme-link-color);
            text-decoration: none;
        }

    </style>
</head>
<body>
    <div class="app-container">
        <div id="profile-page" class="page active">
             <div class="page-header">
                <button id="profile-back-button" class="back-button hidden"></button>
                <!-- Menu button will be automatically pushed right by flexbox -->
            </div>
            <div class="profile-page-content">
                <div id="profile-top-section" class="profile-top-section">
                    <div id="profile-header-pattern-overlay" class="profile-header-pattern-overlay"></div>
                    <div id="profile-top-pinned-gifts" class="profile-top-pinned-gifts">
                        <!-- Pinned gifts will be dynamically added here -->
                    </div>
                    <div class="profile-header-content-wrapper">
                        <div id="profile-main-info-block" class="profile-main-info">
                            <img id="profile-avatar" class="profile-avatar" src="" alt="Avatar">
                            <div class="profile-name-status">
                                <div class="name-line">
                                    <h1 id="profile-name">–ò–º—è</h1>
                                    <div id="worn-gift-icon-container" class="hidden lottie-animation-container"></div>
                                </div>
                                <p id="profile-gift-count-subtext">0 –ø–æ–¥–∞—Ä–∫–æ–≤</p>
                                <p id="profile-status" class="online">–≤ —Å–µ—Ç–∏</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="profile-details-section">
                    <div id="profile-details" class="profile-details">
                        <p><strong>–¢–µ–ª–µ—Ñ–æ–Ω</strong><span id="profile-phone"></span></p>
                        <p><strong>–û —Å–µ–±–µ</strong><span id="profile-bio"></span></p>
                        <p><strong>–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</strong><span id="profile-username"></span></p>
                    </div>
                </div>

                <div class="profile-tabs">
                    <button>–ü—É–±–ª–∏–∫–∞—Ü–∏–∏</button>
                    <button>–ê—Ä—Ö–∏–≤</button>
                    <button class="active" id="gifts-tab-button">–ü–æ–¥–∞—Ä–∫–∏</button>
                </div>
                
                <div class="profile-gifts-actions-wrapper">
                    <div id="filter-long-press-target"></div>
                    <div class="profile-gifts-actions">
                        <button id="upgrade-all-gifts-button" class="action-button" style="display: none;">‚ú® –£–ª—É—á—à–∏—Ç—å –≤—Å–µ</button>
                        <button id="go-to-buy-gifts" class="action-button">üéÅ –ö—É–ø–∏—Ç—å –ø–æ–¥–∞—Ä–∫–∏</button>
                    </div>
                </div>

                <div id="gifts-grid" class="gifts-grid">
                    <div class="spinner hidden" id="gifts-loading-spinner"></div>
                </div>
            </div>
        </div>

        <div id="buy-gifts-page" class="page">
            <div class="page-header">
                <button id="back-to-profile-buy" class="back-button"></button>
                <h2>–ú–∞–≥–∞–∑–∏–Ω –ø–æ–¥–∞—Ä–∫–æ–≤</h2>
            </div>
            <div id="buy-gifts-grid" class="gifts-grid">
                <div class="spinner" id="buy-gifts-loading-spinner"></div>
            </div>
        </div>

        <div id="gift-detail-modal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header-bar">
                    <h3 id="modal-gift-name">–ù–∞–∑–≤–∞–Ω–∏–µ –ø–æ–¥–∞—Ä–∫–∞</h3>
                </div>
                <div class="modal-scrollable-content">
                    <div id="modal-gift-image-container" class="modal-gift-image-container">
                        <div id="modal-lottie-gift-original" class="lottie-animation-container"></div>
                        <img id="modal-gift-image-static" class="static-image-fallback" src="" alt="–ü–æ–¥–∞—Ä–æ–∫" style="display:none;">
                    </div>
                    <p id="modal-gift-description1" class="modal-gift-description"></p>
                    <p id="modal-gift-description2" class="modal-gift-description"></p>
                    <div id="modal-gift-info" class="modal-info-table"></div>
                </div>
                <div class="modal-buttons-footer">
                    <button id="close-gift-detail-modal" class="modal-button">–û–ö</button>
                </div>
            </div>
        </div>

        <div id="collectible-detail-modal" class="modal-overlay">
            <div class="modal-content">
                <div class="page-header"> <!-- Header for back button and menu -->
                    <button id="back-from-collectible-modal" class="back-button"></button>
                    <h2 id="modal-collectible-header-title" class="hidden">–ö–æ–ª–ª–µ–∫—Ü–∏–æ–Ω–Ω—ã–π</h2> <!-- Hidden by CSS -->
                    <button class="menu-button">‚ãÆ</button>
                </div>
                <div class="modal-scrollable-content">
                    <div class="collectible-display-area">
                        <div id="modal-collectible-bg" class="collectible-bg-gradient"></div>
                        <div id="modal-collectible-pattern" class="collectible-pattern-tile"></div>
                        
                        <div id="modal-collectible-visual" class="modal-collectible-visual">
                            <!-- Lottie/Static image will be dynamically inserted here -->
                            <div id="modal-lottie-collectible-model" class="lottie-animation-container"></div>
                            <img id="modal-collectible-model-img-static" class="static-image-fallback" src="" alt="–ú–æ–¥–µ–ª—å" style="display:none;">
                        </div>
                        <h3 id="modal-collectible-main-name">–ù–∞–∑–≤–∞–Ω–∏–µ –ü–æ–¥–∞—Ä–∫–∞</h3> <!-- Changed from Model Name -->
                        <p id="modal-collectible-number-subtext">–ö–æ–ª–ª–µ–∫—Ü–∏–æ–Ω–Ω—ã–π #123</p>
                    </div>

                    <div id="modal-collectible-actions" class="modal-action-buttons-row">
                        <button id="collectible-action-transfer"><span class="icon"></span><span class="text">–ü–µ—Ä–µ–¥–∞—Ç—å</span></button>
                        <button id="collectible-action-wear"><span class="icon"></span><span class="text">–ù–∞–¥–µ—Ç—å</span></button>
                        <button id="collectible-action-sell"><span class="icon"></span><span class="text">–ü—Ä–æ–¥–∞—Ç—å</span></button>
                    </div>
                    <div class="collectible-info-section">
                        <div id="modal-collectible-info-table" class="modal-info-table"></div>
                    </div>
                    <div class="modal-footer-message">
                        –≠—Ç–æ—Ç –ø–æ–¥–∞—Ä–æ–∫ –≤–∏–¥–µ–Ω –≤ –≤–∞—à–µ–º –ø—Ä–æ—Ñ–∏–ª–µ. <span id="collectible-hide-link" class="link">–°–∫—Ä—ã—Ç—å ></span>
                    </div>
                </div>
                 <div class="modal-buttons-footer">
                    <button id="close-collectible-detail-modal" class="modal-button">–û–ö</button>
                </div>
            </div>
        </div>

        <div id="too-many-pins-modal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header-bar"><h3>–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –∑–∞–∫—Ä–µ–ø–ª—ë–Ω–Ω—ã—Ö –ø–æ–¥–∞—Ä–∫–æ–≤</h3></div>
                <div class="modal-scrollable-content" style="text-align: center;">
                    <p style="margin-bottom:15px; color: var(--tg-theme-hint-color);">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–¥–∞—Ä–æ–∫ –¥–ª—è –æ—Ç–∫—Ä–µ–ø–ª–µ–Ω–∏—è. –ú–æ–∂–Ω–æ –∑–∞–∫—Ä–µ–ø–∏—Ç—å –¥–æ 6 –∫–æ–ª–ª–µ–∫—Ü–∏–æ–Ω–Ω—ã—Ö –ø–æ–¥–∞—Ä–∫–æ–≤.</p>
                    <div id="unpin-selection-grid" class="gifts-grid" style="grid-template-columns: repeat(3, 1fr); max-height: 200px; overflow-y: auto; padding:0 10px;">
                    </div>
                </div>
                 <div class="modal-buttons-footer">
                    <button id="cancel-unpin-modal" class="modal-button secondary">–û—Ç–º–µ–Ω–∞</button>
                </div>
            </div>
        </div>

        <div id="buy-multiple-modal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header-bar"><h3 id="buy-multiple-modal-title">–ö—É–ø–∏—Ç—å –ø–æ–¥–∞—Ä–æ–∫</h3></div>
                <div class="modal-scrollable-content" style="text-align: center;">
                    <p id="buy-multiple-gift-name" style="margin-bottom: 15px;"></p>
                    <label for="buy-multiple-quantity" style="display: block; margin-bottom: 8px; color: var(--tg-theme-hint-color);">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ:</label>
                    <input type="number" id="buy-multiple-quantity" min="1" value="1">
                </div>
                <div class="modal-buttons-footer">
                    <button id="confirm-buy-multiple" class="modal-button">–ö—É–ø–∏—Ç—å</button>
                    <button id="cancel-buy-multiple" class="modal-button secondary">–û—Ç–º–µ–Ω–∞</button>
                </div>
            </div>
        </div>
        
        <div id="transfer-gift-modal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header-bar"><h3 id="transfer-gift-modal-title">–ü–µ—Ä–µ–¥–∞—Ç—å –ø–æ–¥–∞—Ä–æ–∫</h3></div>
                <div class="modal-scrollable-content" style="text-align: center;">
                    <p id="transfer-gift-name-info" style="margin-bottom: 15px;"></p>
                    <label for="transfer-recipient-input" style="display: block; margin-bottom: 8px; color: var(--tg-theme-hint-color);">ID –ø–æ–ª—É—á–∞—Ç–µ–ª—è –∏–ª–∏ @username:</label>
                    <input type="text" id="transfer-recipient-input" placeholder="ID –∏–ª–∏ @username">
                </div>
                <div class="modal-buttons-footer">
                    <button id="confirm-transfer-gift" class="modal-button">–°–æ–∑–¥–∞—Ç—å —Å—Å—ã–ª–∫—É –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏</button>
                    <button id="cancel-transfer-gift" class="modal-button secondary">–û—Ç–º–µ–Ω–∞</button>
                </div>
            </div>
        </div>


        <div id="filter-popup" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header-bar">
                    <h3>–§–∏–ª—å—Ç—Ä—ã –ü–æ–¥–∞—Ä–∫–æ–≤</h3>
                </div>
                <div class="modal-scrollable-content">
                    <div class="filter-section" id="filter-collections-section">
                        <h4>–ö–æ–ª–ª–µ–∫—Ü–∏–∏</h4>
                        <div class="filter-options-grid" id="filter-options-collections"></div>
                    </div>
                    <div class="filter-section hidden" id="filter-models-section">
                        <h4>–ú–æ–¥–µ–ª–∏</h4>
                        <div class="filter-options-grid" id="filter-options-models"></div>
                    </div>
                    <div class="filter-section" id="filter-backdrops-section">
                        <h4>–§–æ–Ω—ã</h4>
                        <div class="filter-options-grid" id="filter-options-backdrops"></div>
                    </div>
                    <div class="filter-section" id="filter-patterns-section">
                        <h4>–°–∏–º–≤–æ–ª—ã</h4>
                        <div class="filter-options-grid" id="filter-options-patterns"></div>
                    </div>
                </div>
                <div class="modal-buttons-footer">
                    <button id="apply-filters-button" class="modal-button">–ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã</button>
                    <button id="clear-filters-button" class="modal-button secondary">–°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã</button>
                    <button id="clear-all-data-button" class="clear-data-button">
                        <span id="clear-data-icon-placeholder"></span> –û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="long-press-menu" class="hidden">
        <ul>
            <li id="menu-pin-action">–ó–∞–∫—Ä–µ–ø–∏—Ç—å</li>
        </ul>
    </div>
    <div id="toast-notification" class="toast-notification"></div>

    <script>
        // --- Constants and Global Variables ---
        const CDN_BASE_URL = "https://cdn.changes.tg/gifts/";
        const GIFTS_JSON_URL = `${CDN_BASE_URL}id-to-name.json`;
        const YOUR_BOT_USERNAME = "YourBotUsername"; // FIXME: Replace with actual bot username
        const YOUR_MINI_APP_NAME = "your_mini_app_name"; // FIXME: Replace with actual mini app name (path)
        const XOR_KEY = "GiftSimSecretKey2024";


        const PIN_ICON_SVG = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><title>pin</title><path d="M16,12V4H17V2H7V4H8V12L6,14V16H11.2V22H12.8V16H18V14L16,12Z" /></svg>`;
        const BACK_ARROW_SVG = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><title>arrow-left-bold</title><path d="M20,9V15H12V19.84L4.16,12L12,4.16V9H20Z" /></svg>`;
        const DIAMOND_SVG = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><title>diamond-stone</title><path d="M16,9H19L14,16M10,9H14L12,17M5,9H8L10,16M15,4H17L19,7H16M11,4H13L14,7H10M7,4H9L8,7H5M6,2L2,8L12,22L22,8L18,2H6Z" /></svg>`;
        const CROWN_SVG = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><title>crown</title><path d="M5 16L3 5L8.5 10L12 4L15.5 10L21 5L19 16H5M19 19C19 19.6 18.6 20 18 20H6C5.4 20 5 19.6 5 19V18H19V19Z" /></svg>`;
        const LABEL_SVG = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><title>label</title><path d="M17.63,5.84C17.27,5.33 16.67,5 16,5H5A2,2 0 0,0 3,7V17A2,2 0 0,0 5,19H16C16.67,19 17.27,18.66 17.63,18.15L22,12L17.63,5.84Z" /></svg>`;
        const TRASH_ICON_SVG = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><title>trash-can-outline</title><path d="M9,3V4H4V6H5V19A2,2 0 0,0 7,21H17A2,2 0 0,0 19,19V6H20V4H15V3H9M7,6H17V19H7V6M9,8V17H11V8H9M13,8V17H15V8H13Z" /></svg>`;
        
        let allAvailableGifts = {};
        let ownedGifts = [];
        let pinnedGifts = [];
        let wornGiftInstanceId = null;
        const MAX_PINS = 6;
        let tg = window.Telegram.WebApp;
        
        let activeFilters = { collection: null, model: null, backdrop: null, pattern: null };
        
        const profilePage = document.getElementById('profile-page');
        const profileBackButton = document.getElementById('profile-back-button');
        const profileTopSection = document.getElementById('profile-top-section');
        const profileHeaderPatternOverlay = document.getElementById('profile-header-pattern-overlay');
        const profileAvatar = document.getElementById('profile-avatar');
        const profileName = document.getElementById('profile-name');
        const wornGiftIconContainer = document.getElementById('worn-gift-icon-container');
        const profileGiftCountSubtext = document.getElementById('profile-gift-count-subtext');
        const profileStatus = document.getElementById('profile-status');
        const profilePhone = document.getElementById('profile-phone');
        const profileBio = document.getElementById('profile-bio');
        const profileUsername = document.getElementById('profile-username');
        const profileTopPinnedGifts = document.getElementById('profile-top-pinned-gifts');
        const giftsGrid = document.getElementById('gifts-grid');
        const goToBuyGiftsButton = document.getElementById('go-to-buy-gifts');
        const upgradeAllGiftsButton = document.getElementById('upgrade-all-gifts-button');
        const filterLongPressTarget = document.getElementById('filter-long-press-target');
        
        const buyGiftsPage = document.getElementById('buy-gifts-page');
        const backToProfileBuyButton = document.getElementById('back-to-profile-buy');
        const buyGiftsGrid = document.getElementById('buy-gifts-grid');
        
        const giftDetailModal = document.getElementById('gift-detail-modal');
        const modalGiftName = document.getElementById('modal-gift-name');
        const modalLottieGiftOriginal = document.getElementById('modal-lottie-gift-original');
        const modalGiftImageStatic = document.getElementById('modal-gift-image-static');
        const modalGiftDescription1 = document.getElementById('modal-gift-description1');
        const modalGiftDescription2 = document.getElementById('modal-gift-description2');
        const modalGiftInfo = document.getElementById('modal-gift-info');
        const closeGiftDetailModalButton = document.getElementById('close-gift-detail-modal');
        
        const collectibleDetailModal = document.getElementById('collectible-detail-modal');
        const backFromCollectibleModal = document.getElementById('back-from-collectible-modal');
        // modalCollectibleHeaderTitle is hidden by CSS
        const modalCollectibleBg = document.getElementById('modal-collectible-bg');
        const modalCollectiblePattern = document.getElementById('modal-collectible-pattern');
        const modalLottieCollectibleModel = document.getElementById('modal-lottie-collectible-model');
        const modalCollectibleModelImgStatic = document.getElementById('modal-collectible-model-img-static');
        const modalCollectibleMainName = document.getElementById('modal-collectible-main-name');
        const modalCollectibleNumberSubtext = document.getElementById('modal-collectible-number-subtext');
        const modalCollectibleInfoTable = document.getElementById('modal-collectible-info-table');
        const collectibleActionTransfer = document.getElementById('collectible-action-transfer');
        const collectibleActionWear = document.getElementById('collectible-action-wear');
        const collectibleActionSell = document.getElementById('collectible-action-sell');
        const closeCollectibleDetailModalButton = document.getElementById('close-collectible-detail-modal');
        
        const tooManyPinsModal = document.getElementById('too-many-pins-modal');
        const unpinSelectionGrid = document.getElementById('unpin-selection-grid');
        const cancelUnpinModal = document.getElementById('cancel-unpin-modal');

        const buyMultipleModal = document.getElementById('buy-multiple-modal');
        const buyMultipleModalTitle = document.getElementById('buy-multiple-modal-title');
        const buyMultipleGiftName = document.getElementById('buy-multiple-gift-name');
        const buyMultipleQuantityInput = document.getElementById('buy-multiple-quantity');
        const confirmBuyMultipleButton = document.getElementById('confirm-buy-multiple');
        const cancelBuyMultipleButton = document.getElementById('cancel-buy-multiple');
        let currentGiftToBuyMultiple = null;

        const transferGiftModal = document.getElementById('transfer-gift-modal');
        const transferGiftModalTitle = document.getElementById('transfer-gift-modal-title');
        const transferGiftNameInfo = document.getElementById('transfer-gift-name-info');
        const transferRecipientInput = document.getElementById('transfer-recipient-input');
        const confirmTransferGiftButton = document.getElementById('confirm-transfer-gift');
        const cancelTransferGiftButton = document.getElementById('cancel-transfer-gift');
        let currentGiftToTransfer = null;

        const longPressMenu = document.getElementById('long-press-menu');
        const menuPinAction = document.getElementById('menu-pin-action');
        const giftsLoadingSpinner = document.getElementById('gifts-loading-spinner');
        const buyGiftsLoadingSpinner = document.getElementById('buy-gifts-loading-spinner');

        const filterPopup = document.getElementById('filter-popup');
        const filterModelsSection = document.getElementById('filter-models-section');
        const filterOptionsCollections = document.getElementById('filter-options-collections');
        const filterOptionsModels = document.getElementById('filter-options-models');
        const filterOptionsBackdrops = document.getElementById('filter-options-backdrops');
        const filterOptionsPatterns = document.getElementById('filter-options-patterns');
        const applyFiltersButton = document.getElementById('apply-filters-button');
        const clearFiltersButton = document.getElementById('clear-filters-button');
        const clearAllDataButton = document.getElementById('clear-all-data-button');
        const clearDataIconPlaceholder = document.getElementById('clear-data-icon-placeholder');
        const toastNotification = document.getElementById('toast-notification');
        
        const russianFirstNames = ["–í–∞—Å–∏–ª–∏–π", "–ò–≤–∞–Ω", "–ê–ª–µ–∫—Å–µ–π", "–î–º–∏—Ç—Ä–∏–π", "–°–µ—Ä–≥–µ–π"];
        const russianLastNames = ["–î—É—Ä–æ–≤", "–ü–µ—Ç—Ä–æ–≤", "–ò–≤–∞–Ω–æ–≤", "–°–º–∏—Ä–Ω–æ–≤", "–ö—É–∑–Ω–µ—Ü–æ–≤"];
        const russianBios = ["–í—Å—ë —Ç–æ–ª—å–∫–æ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è.", "–õ—é–±–ª—é –ø—É—Ç–µ—à–µ—Å—Ç–≤–æ–≤–∞—Ç—å.", "–ö–æ—Ñ–µ–º–∞–Ω."];
        
        function getRandomElement(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
        function generateRandomPhoneNumber() {
            let num = '+7 (9'; for (let i = 0; i < 2; i++) num += Math.floor(Math.random() * 10); num += ') ';
            for (let i = 0; i < 3; i++) num += Math.floor(Math.random() * 10); num += '-';
            for (let i = 0; i < 2; i++) num += Math.floor(Math.random() * 10); num += '-';
            for (let i = 0; i < 2; i++) num += Math.floor(Math.random() * 10); return num;
        }
        function generateUniqueId() { return `${Date.now().toString(36)}-${Math.random().toString(36).substring(2, 9)}`; }
        
        const mockUser = {
            id: String(Math.floor(Math.random() * 1000000000)),
            first_name: getRandomElement(russianFirstNames), last_name: getRandomElement(russianLastNames),
            photo_url: `https://i.pravatar.cc/140?u=${generateUniqueId()}`, bio: getRandomElement(russianBios), phone: generateRandomPhoneNumber()
        };
        mockUser.username = `${mockUser.first_name.toLowerCase().replace(' ', '')}${Math.floor(Math.random() * 1000)}`;
        
        let lottieIntersectionObserver;

        // --- Lottie & Observers ---
        function playLottieAnimation(container, path, loop = true, isGridItem = false) {
            if (!container || !path) return;
            if (container.lottieInstance) { container.lottieInstance.destroy(); delete container.lottieInstance; }
            container.innerHTML = '';
            try {
                const anim = bodymovin.loadAnimation({
                    container: container, path: path, renderer: 'svg', loop: loop, autoplay: true
                });
                container.lottieInstance = anim;
                 anim.addEventListener('DOMLoaded', () => {}); // Ensure it's loaded
                anim.addEventListener('error', (e) => {
                    console.warn(`Lottie error for ${path}:`, e);
                    container.innerHTML = '‚ö†Ô∏è'; // Show error in container
                });
                if (isGridItem && !loop) {
                    anim.addEventListener('complete', () => {
                        if (container.lottieInstance === anim) { 
                            container.dataset.playedOnce = 'true';
                        }
                    });
                }
            } catch (error) {
                console.warn(`Failed to load Lottie ${path}:`, error);
                container.innerHTML = 'üñºÔ∏è'; // Fallback
            }
        }
        function destroyLottieAnimation(container) {
            if (container && container.lottieInstance) {
                try {
                    container.lottieInstance.destroy();
                } catch (e) { console.warn("Error destroying Lottie:", e); }
                delete container.lottieInstance;
                delete container.dataset.playedOnce;
                container.innerHTML = ''; 
            }
        }
        function handleLottieIntersection(entries, observer) {
            entries.forEach(entry => {
                const cardElement = entry.target;
                const lottieContainer = cardElement.querySelector('.lottie-animation-container');
                const staticFallback = cardElement.querySelector('.static-image-fallback');
                const lottiePath = cardElement.dataset.lottiePath;
        
                if (entry.isIntersecting) {
                    if (lottiePath && lottieContainer) {
                        if(staticFallback) staticFallback.style.display = 'none';
                        lottieContainer.style.display = 'flex';
                        playLottieAnimation(lottieContainer, lottiePath, false, true);
                    }
                } else {
                    if (lottieContainer) {
                        destroyLottieAnimation(lottieContainer);
                        if(staticFallback) staticFallback.style.display = 'block';
                        lottieContainer.style.display = 'none';
                    }
                }
            });
        }
        function initLottieObserver() {
            lottieIntersectionObserver = new IntersectionObserver(handleLottieIntersection, {
                root: null, rootMargin: '100px', threshold: 0.01
            });
        }
        function observeLottieElement(element) {
            if (lottieIntersectionObserver && element.dataset.lottiePath) {
                lottieIntersectionObserver.observe(element);
            }
        }
        function unobserveLottieElement(element) {
             if (lottieIntersectionObserver && element.dataset.lottiePath) {
                lottieIntersectionObserver.unobserve(element);
                const lottieContainer = element.querySelector('.lottie-animation-container');
                if(lottieContainer) destroyLottieAnimation(lottieContainer);
            }
        }

        // --- Initialization and Core Logic ---
        async function initApp() {
            tg.ready(); tg.expand();
            applyTheme(tg.themeParams);
            tg.onEvent('themeChanged', () => applyTheme(tg.themeParams));
            initLottieObserver();
        
            profileBackButton.innerHTML = BACK_ARROW_SVG;
            backToProfileBuyButton.innerHTML = BACK_ARROW_SVG;
            backFromCollectibleModal.innerHTML = BACK_ARROW_SVG;
            collectibleActionTransfer.querySelector('.icon').innerHTML = DIAMOND_SVG;
            collectibleActionWear.querySelector('.icon').innerHTML = CROWN_SVG;
            collectibleActionSell.querySelector('.icon').innerHTML = LABEL_SVG;
            clearDataIconPlaceholder.innerHTML = TRASH_ICON_SVG;
        
            loadUserData(); loadState();
            applyWornGiftStyles(wornGiftInstanceId); // Must be after loadState
            renderProfileGifts();
            setupEventListeners();
            await fetchAvailableGifts(); // Ensure gifts are fetched before processing start_param

            // Process transferred gift if start_param exists
            if (tg.initDataUnsafe && tg.initDataUnsafe.start_param) {
                await processReceivedGift(tg.initDataUnsafe.start_param);
            }
        }
        
        function applyTheme(themeParams) { 
            if (themeParams && Object.keys(themeParams).length > 0) {
                const root = document.documentElement;
                const setVar = (varName, value) => { if (value) root.style.setProperty(varName, value); };
                setVar('--tg-theme-bg-color', themeParams.bg_color);
                setVar('--tg-theme-text-color', themeParams.text_color);
                setVar('--tg-theme-hint-color', themeParams.hint_color);
                setVar('--tg-theme-link-color', themeParams.link_color);
                setVar('--tg-theme-button-color', themeParams.button_color);
                setVar('--tg-theme-button-text-color', themeParams.button_text_color);
                setVar('--tg-theme-secondary-bg-color', themeParams.secondary_bg_color);
                setVar('--tg-theme-accent-blue', themeParams.accent_text_color || '#5288c1'); // Or any other suitable property for accent
                document.body.style.backgroundColor = themeParams.bg_color || 'var(--tg-theme-bg-color)';
                document.body.style.color = themeParams.text_color || 'var(--tg-theme-text-color)';
                if (upgradeAllGiftsButton) upgradeAllGiftsButton.style.backgroundColor = themeParams.accent_text_color || 'var(--tg-theme-accent-blue)';
                applyWornGiftStyles(wornGiftInstanceId); // Re-apply theme related styles for worn gift
            } else {
                console.log("Using default CSS variables as themeParams are empty.");
            }
        }
        function loadUserData() { 
            const user = tg.initDataUnsafe?.user || mockUser;
            profileName.textContent = user.first_name || mockUser.first_name;
            profileAvatar.src = user.photo_url || mockUser.photo_url;
            profileAvatar.onerror = () => { profileAvatar.src = `https://i.pravatar.cc/140?u=fallback${generateUniqueId()}`; };
            profileUsername.textContent = user.username ? `@${user.username}` : (mockUser.username ? `@${mockUser.username}` : "N/A");
            profileBio.textContent = user.bio || mockUser.bio || "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ —É–∫–∞–∑–∞–ª –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–µ–±–µ.";
            profilePhone.textContent = user.phone || mockUser.phone || "–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ —Å–∫—Ä—ã—Ç.";
        }
        function saveState() { 
            localStorage.setItem('ownedGifts_v8', JSON.stringify(ownedGifts));
            localStorage.setItem('pinnedGifts_v8', JSON.stringify(pinnedGifts));
            localStorage.setItem('wornGiftInstanceId_v8', wornGiftInstanceId || ""); // Store empty string if null
            localStorage.setItem('activeFilters_v8', JSON.stringify(activeFilters));
        }
        function loadState() { 
            const loadedOwnedGifts = JSON.parse(localStorage.getItem('ownedGifts_v8')) || [];
            ownedGifts = loadedOwnedGifts.map(gift => ({ ...gift, instanceId: gift.instanceId || generateUniqueId() }));
            pinnedGifts = JSON.parse(localStorage.getItem('pinnedGifts_v8')) || [];
            wornGiftInstanceId = localStorage.getItem('wornGiftInstanceId_v8') || null;
            if (wornGiftInstanceId === "") wornGiftInstanceId = null;
            activeFilters = JSON.parse(localStorage.getItem('activeFilters_v8')) || { collection: null, model: null, backdrop: null, pattern: null };
        }
        
        function applyWornGiftStyles(instanceId) {
            const currentWornGift = ownedGifts.find(g => g.instanceId === instanceId && g.isCollectible);
            destroyLottieAnimation(wornGiftIconContainer); 
            if (currentWornGift && currentWornGift.collectibleData) {
                if (currentWornGift.collectibleData.lottieModelPath) {
                    playLottieAnimation(wornGiftIconContainer, currentWornGift.collectibleData.lottieModelPath, true);
                } else if (currentWornGift.collectibleData.modelImage) { 
                    wornGiftIconContainer.innerHTML = `<img src="${currentWornGift.collectibleData.modelImage}" style="width:100%; height:100%; object-fit:contain;" alt="">`;
                }
                wornGiftIconContainer.classList.remove('hidden');
                const colors = currentWornGift.collectibleData.backdropColors;
                if (colors && colors.centerColor && colors.edgeColor) {
                     profileTopSection.style.background = `radial-gradient(circle at 50% 0%, ${colors.centerColor} 0%, ${colors.edgeColor} 100%)`;
                } else {
                     profileTopSection.style.background = getComputedStyle(document.documentElement).getPropertyValue('--app-profile-gradient-fallback').trim();
                }
                if (currentWornGift.collectibleData.patternImage) {
                    profileHeaderPatternOverlay.style.backgroundImage = `url('${currentWornGift.collectibleData.patternImage}')`;
                    profileHeaderPatternOverlay.style.opacity = '0.07';
                } else {
                     profileHeaderPatternOverlay.style.backgroundImage = 'none';
                }
            } else {
                wornGiftIconContainer.classList.add('hidden');
                wornGiftIconContainer.innerHTML = '';
                profileTopSection.style.background = getComputedStyle(document.documentElement).getPropertyValue('--app-profile-gradient-fallback').trim();
                profileHeaderPatternOverlay.style.backgroundImage = 'none';
            }
        }
        
        function showPage(pageId) { 
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
        }
        async function fetchAvailableGifts() { 
            buyGiftsLoadingSpinner.classList.remove('hidden');
            buyGiftsGrid.innerHTML = '';
            try {
                const response = await fetch(GIFTS_JSON_URL);
                if (!response.ok) throw new Error(`HTTP ${response.status} when fetching ${GIFTS_JSON_URL}`);
                allAvailableGifts = await response.json();
                renderAvailableGifts(); 
                populateFilterOptions();
            } catch (error) {
                console.error("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–æ—Å—Ç—É–ø–Ω—ã–µ –ø–æ–¥–∞—Ä–∫–∏:", error);
                buyGiftsGrid.innerHTML = `<p class="empty-grid-message" style="width:100%;">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø–æ–¥–∞—Ä–∫–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.</p>`;
            } finally {
                buyGiftsLoadingSpinner.classList.add('hidden');
            }
        }
        
        function renderAvailableGifts() { 
            buyGiftsGrid.innerHTML = '';
            if (Object.keys(allAvailableGifts).length === 0 && !buyGiftsLoadingSpinner.classList.contains('hidden')) {
                buyGiftsGrid.innerHTML = `<p class="empty-grid-message" style="width:100%;">–°–µ–π—á–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –ø–æ–¥–∞—Ä–∫–æ–≤.</p>`; return;
            }
            for (const id in allAvailableGifts) {
                const name = allAvailableGifts[id];
                const originalImageUrl = `${CDN_BASE_URL}originals/${id}/Original.png`;
                const lottiePath = `${CDN_BASE_URL}originals/${id}/Original.json`;
        
                const item = document.createElement('div');
                item.className = 'buy-gift-item';
                item.dataset.id = id; item.dataset.name = name;
                item.dataset.originalImage = originalImageUrl;
                item.dataset.lottiePath = lottiePath; 
        
                item.innerHTML = `
                    <div class="image-container">
                        <div class="lottie-animation-container" style="display:none;"></div>
                        <img class="static-image-fallback" src="${originalImageUrl}" alt="${name}" loading="lazy" onerror="this.style.display='none'; this.parentElement.querySelector('.lottie-animation-container').innerHTML = 'üñºÔ∏è';">
                    </div>
                    <div class="gift-name">${name}</div>
                    <div class="gift-price"><span class="star-icon">‚≠ê</span> –ë–µ—Å–ø–ª–∞—Ç–Ω–æ</div>
                    <div class="limited-label">–û–≥—Ä–∞–Ω–∏—á–µ–Ω–æ</div>
                `;
                item.addEventListener('click', () => buyGift(id, name, originalImageUrl, lottiePath, 1));
                let buyItemLongPressTimer;
                item.addEventListener('touchstart', (e) => { buyItemLongPressTimer = setTimeout(() => openBuyMultipleModal(id, name, originalImageUrl, lottiePath), 700); }, { passive: true });
                item.addEventListener('touchend', () => clearTimeout(buyItemLongPressTimer));
                item.addEventListener('touchmove', () => clearTimeout(buyItemLongPressTimer));
                item.addEventListener('contextmenu', (e) => { e.preventDefault(); openBuyMultipleModal(id, name, originalImageUrl, lottiePath); });
                
                observeLottieElement(item); 
                buyGiftsGrid.appendChild(item);
            }
        }
        
        function getGiftCountText(count) { 
            if (count % 10 === 1 && count % 100 !== 11) return `${count} –ø–æ–¥–∞—Ä–æ–∫`;
            if (count % 10 >= 2 && count % 10 <= 4 && (count % 100 < 10 || count % 100 >= 20)) return `${count} –ø–æ–¥–∞—Ä–∫–∞`;
            return `${count} –ø–æ–¥–∞—Ä–∫–æ–≤`;
        }
        function renderProfileGifts() { 
            Array.from(giftsGrid.children).forEach(child => unobserveLottieElement(child));
            giftsGrid.innerHTML = '';
            
            const filteredGifts = ownedGifts.filter(gift => { 
                if (activeFilters.collection && gift.id !== activeFilters.collection) return false;
                if (gift.isCollectible && gift.collectibleData) {
                    if (activeFilters.model && gift.collectibleData.model?.name !== activeFilters.model) return false;
                    if (activeFilters.backdrop && gift.collectibleData.backdrop?.name !== activeFilters.backdrop) return false;
                    if (activeFilters.pattern && gift.collectibleData.pattern?.name !== activeFilters.pattern) return false;
                } else if (activeFilters.model || activeFilters.backdrop || activeFilters.pattern) return false; // If filters for collectible parts are set, non-collectibles are filtered out.
                return true;
            });
            profileGiftCountSubtext.textContent = getGiftCountText(filteredGifts.length);
            if (ownedGifts.length > 0 && filteredGifts.length !== ownedGifts.length) {
                profileGiftCountSubtext.textContent += ` –∏–∑ ${getGiftCountText(ownedGifts.length)}`;
            }
            
            const sortedGifts = [...filteredGifts].sort((a, b) => { 
                const aIsPinned = pinnedGifts.includes(a.instanceId); const bIsPinned = pinnedGifts.includes(b.instanceId);
                if (aIsPinned && !bIsPinned) return -1; if (!aIsPinned && bIsPinned) return 1;
                // If both are pinned or both not pinned, sort by date
                return (new Date(b.acquiredDate || 0)) - (new Date(a.acquiredDate || 0));
            });
            if (sortedGifts.length === 0) { 
                giftsGrid.style.display = 'flex'; giftsGrid.style.alignItems = 'center'; giftsGrid.style.justifyContent = 'center';
                giftsGrid.innerHTML = `<p class="empty-grid-message">${ownedGifts.length > 0 ? '–ù–µ—Ç –ø–æ–¥–∞—Ä–∫–æ–≤, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏—Ö —Ñ–∏–ª—å—Ç—Ä–∞–º.' : '–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –ø–æ–¥–∞—Ä–∫–æ–≤. –í—Ä–µ–º—è —á—Ç–æ-–Ω–∏–±—É–¥—å –∫—É–ø–∏—Ç—å!'}</p>`;
            } else {
                giftsGrid.style.display = 'grid';
                sortedGifts.forEach(gift => {
                    const card = createGiftCardDOM(gift);
                    giftsGrid.appendChild(card);
                    observeLottieElement(card); 
                });
            }
            renderTopPinnedGiftsPreview(); 
            const hasNonCollectible = ownedGifts.some(g => !g.isCollectible);
            if (upgradeAllGiftsButton) { 
                upgradeAllGiftsButton.style.display = hasNonCollectible ? 'inline-block' : 'none';
                if (!hasNonCollectible) { 
                    upgradeAllGiftsButton.textContent = '‚ú® –£–ª—É—á—à–∏—Ç—å –≤—Å–µ'; 
                    upgradeAllGiftsButton.disabled = false; 
                }
            }
        }
        
        function createGiftCardDOM(gift) { 
            const card = document.createElement('div');
            card.className = 'gift-card';
            card.dataset.instanceId = gift.instanceId;
        
            const imageContainer = document.createElement('div');
            imageContainer.className = 'image-container';
            
            const lottieContainer = document.createElement('div');
            lottieContainer.className = 'lottie-animation-container';
            lottieContainer.style.display = 'none'; 
        
            const staticImage = document.createElement('img');
            staticImage.className = 'static-image-fallback';
            staticImage.loading = 'lazy';
        
            let lottiePathForCard = null;
        
            if (gift.isCollectible && gift.collectibleData) {
                const cd = gift.collectibleData;
                staticImage.src = cd.modelImage || gift.originalImage; // Fallback to original if model image missing
                staticImage.alt = cd.model?.name || gift.name;
                lottiePathForCard = cd.lottieModelPath;
                
                const bgDiv = document.createElement('div'); bgDiv.className = 'gift-card-bg-pattern';
                if (cd.backdropColors && cd.backdropColors.centerColor && cd.backdropColors.edgeColor) {
                     bgDiv.style.background = `radial-gradient(circle, ${cd.backdropColors.centerColor}, ${cd.backdropColors.edgeColor})`;
                } else {
                     bgDiv.style.background = 'linear-gradient(45deg, #2a3745, #17212b)'; // Default fallback
                }
                card.appendChild(bgDiv);

                if (cd.patternImage) { 
                    const pOverlay = document.createElement('div'); 
                    pOverlay.className = 'gift-card-pattern-overlay'; 
                    pOverlay.style.backgroundImage = `url('${cd.patternImage}')`; 
                    card.appendChild(pOverlay); 
                }
                const numDiv = document.createElement('div'); 
                numDiv.className = 'collectible-number-badge'; 
                numDiv.textContent = `#${cd.number}`; 
                card.appendChild(numDiv);
                
                if (cd.model?.rarityPermille) { 
                    const rBadge = document.createElement('div'); 
                    rBadge.className = 'gift-rarity-badge'; 
                    const totalIssuedMock = Math.max(1000, Math.floor(100000 / cd.model.rarityPermille) * (100 + Math.floor(cd.number / 1000)));
                    rBadge.textContent = `1 of ${(totalIssuedMock / 1000).toFixed(1)}K`; 
                    card.appendChild(rBadge); 
                }
            } else { 
                staticImage.src = gift.originalImage;
                staticImage.alt = gift.name;
                lottiePathForCard = gift.lottiePath; 
            }
            
            if (lottiePathForCard) card.dataset.lottiePath = lottiePathForCard;
        
            staticImage.onerror = function() { 
                this.style.display='none'; 
                lottieContainer.style.display='flex'; // Show lottie container for fallback text
                lottieContainer.innerHTML = 'üñºÔ∏è';
            }; 
            
            imageContainer.appendChild(lottieContainer);
            imageContainer.appendChild(staticImage);
            card.appendChild(imageContainer);
        
            if (pinnedGifts.includes(gift.instanceId)) { 
                const pinDiv = document.createElement('div'); pinDiv.className = 'pin-indicator';
                pinDiv.innerHTML = PIN_ICON_SVG; 
                if(pinDiv.querySelector('svg')) pinDiv.querySelector('svg').style.fill = 'var(--tg-theme-link-color)';
                card.appendChild(pinDiv);
            }
            card.addEventListener('click', () => openGiftDetailByInstanceId(gift.instanceId));
            setupLongPress(card, gift);
            return card;
        }
        
        function renderTopPinnedGiftsPreview() {
            Array.from(profileTopPinnedGifts.children).forEach(childLottieContainer => {
                destroyLottieAnimation(childLottieContainer);
            });
            profileTopPinnedGifts.innerHTML = '';
        
            // Get the actual pinned gift objects
            const pinnedGiftObjects = pinnedGifts
                .map(instanceId => ownedGifts.find(g => g.instanceId === instanceId))
                .filter(Boolean); // Remove undefined if any gift was deleted but still in pinnedGifts

            pinnedGiftObjects.slice(0, MAX_PINS).forEach(gift => {
                const lottieContainer = document.createElement('div');
                lottieContainer.className = 'pinned-gift-item lottie-animation-container';
                
                let lottiePathForPinned = null;
                let staticImageForPinned = gift.originalImage; // Default

                if (gift.isCollectible && gift.collectibleData) {
                    if (gift.collectibleData.lottieModelPath) {
                        lottiePathForPinned = gift.collectibleData.lottieModelPath;
                    }
                    if (gift.collectibleData.modelImage) {
                         staticImageForPinned = gift.collectibleData.modelImage;
                    }
                } else if (gift.lottiePath) {
                    lottiePathForPinned = gift.lottiePath;
                }
    
                if (lottiePathForPinned) {
                    playLottieAnimation(lottieContainer, lottiePathForPinned, true);
                } else { 
                    lottieContainer.innerHTML = `<img src="${staticImageForPinned}" alt="${gift.name}" style="width:100%; height:100%; object-fit:contain;" onerror="this.parentElement.innerHTML = 'üéÅ'">`;
                }
                profileTopPinnedGifts.appendChild(lottieContainer);
            });
        }
        
        function openBuyMultipleModal(id, name, originalImage, lottiePath) { 
            currentGiftToBuyMultiple = { id, name, originalImage, lottiePath }; 
            buyMultipleModalTitle.textContent = `–ö—É–ø–∏—Ç—å "${name}"`;
            buyMultipleGiftName.textContent = `–£–∫–∞–∂–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–ª—è "${name}"`;
            buyMultipleQuantityInput.value = "1";
            buyMultipleModal.classList.add('active');
            buyMultipleQuantityInput.focus();
        }
        function handleConfirmBuyMultiple() { 
            if (!currentGiftToBuyMultiple) return;
            const quantity = parseInt(buyMultipleQuantityInput.value, 10);
            if (isNaN(quantity) || quantity < 1) { showToast("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ."); return; }
            buyGift(currentGiftToBuyMultiple.id, currentGiftToBuyMultiple.name, currentGiftToBuyMultiple.originalImage, currentGiftToBuyMultiple.lottiePath, quantity);
            closeModal(buyMultipleModal);
            currentGiftToBuyMultiple = null;
        }
        function buyGift(id, name, originalImage, lottiePath, quantity = 1) { 
            for (let i = 0; i < quantity; i++) {
                ownedGifts.unshift({
                    id, instanceId: generateUniqueId(), name, originalImage, lottiePath, 
                    isCollectible: false, collectibleData: null, acquiredDate: new Date().toISOString()
                });
            }
            saveState(); renderProfileGifts(); populateFilterOptions();
            tg.HapticFeedback.notificationOccurred('success');
            const message = quantity > 1 ? `"${name}" (${quantity} —à—Ç.) –¥–æ–±–∞–≤–ª–µ–Ω—ã!` : `"${name}" –¥–æ–±–∞–≤–ª–µ–Ω!`;
            showToast(message); showPage('profile-page');
        }
        
        function openGiftDetailByInstanceId(instanceId) {
            const gift = ownedGifts.find(g => g.instanceId === instanceId);
            if (!gift) return;
        
            if (gift.isCollectible && gift.collectibleData) {
                const cd = gift.collectibleData;
                collectibleDetailModal.dataset.instanceId = gift.instanceId;
                // modalCollectibleHeaderTitle is hidden, main name is used below
                modalCollectibleMainName.textContent = gift.name; // Display original gift name
                modalCollectibleNumberSubtext.textContent = `–ö–æ–ª–ª–µ–∫—Ü–∏–æ–Ω–Ω—ã–π #${cd.number}`;
                
                modalCollectibleBg.style.background = (cd.backdropColors && cd.backdropColors.centerColor && cd.backdropColors.edgeColor)
                    ? `radial-gradient(circle, ${cd.backdropColors.centerColor}, ${cd.backdropColors.edgeColor})`
                    : 'linear-gradient(45deg, #555, #333)';
                modalCollectiblePattern.style.backgroundImage = cd.patternImage ? `url('${cd.patternImage}')` : 'none';
        
                destroyLottieAnimation(modalLottieCollectibleModel); // Clear previous
                modalCollectibleModelImgStatic.style.display = 'none'; // Hide static first

                if (cd.lottieModelPath) { 
                    modalLottieCollectibleModel.style.display = 'flex';
                    playLottieAnimation(modalLottieCollectibleModel, cd.lottieModelPath, true); 
                } else if (cd.modelImage) { 
                    modalLottieCollectibleModel.style.display = 'none';
                    modalCollectibleModelImgStatic.src = cd.modelImage; 
                    modalCollectibleModelImgStatic.style.display = 'block'; 
                    modalCollectibleModelImgStatic.onerror = function() { this.src = `https://i.pravatar.cc/200?u=err${generateUniqueId()}`; };
                } else { // Fallback if neither exists
                    modalLottieCollectibleModel.innerHTML = 'üñºÔ∏è';
                    modalLottieCollectibleModel.style.display = 'flex';
                }
                
                const ownerName = profileName.textContent; 
                const ownerAvatar = profileAvatar.src;
                let ownerWornGiftIconHTML = '';
                const ownerWornGift = ownedGifts.find(g => g.instanceId === wornGiftInstanceId && g.isCollectible);
                if(ownerWornGift && ownerWornGift.collectibleData) {
                    ownerWornGiftIconHTML = `<span id="profile-owner-worn-gift-icon-collectible-modal" class="lottie-animation-container"></span>`;
                }

                modalCollectibleInfoTable.innerHTML = `
                    <div class="info-row">
                        <span class="info-label">–í–ª–∞–¥–µ–ª–µ—Ü</span>
                        <span class="info-value">
                            <img src="${ownerAvatar}" alt="" class="owner-avatar">${ownerName}${ownerWornGiftIconHTML}
                        </span>
                    </div>
                    <div class="info-row"><span class="info-label">–ú–æ–¥–µ–ª—å</span><span class="info-value">${cd.model?.name || 'N/A'} <span class="rarity-chip">${(cd.model?.rarityPermille || 0) / 10}%</span></span></div>
                    <div class="info-row"><span class="info-label">–§–æ–Ω</span><span class="info-value">${cd.backdrop?.name || 'N/A'} <span class="rarity-chip">${(cd.backdrop?.rarityPermille || 0) / 10}%</span></span></div>
                    <div class="info-row"><span class="info-label">–°–∏–º–≤–æ–ª</span><span class="info-value">${cd.pattern?.name || 'N/A'} <span class="rarity-chip">${(cd.pattern?.rarityPermille || 0) / 10}%</span></span></div>
                    <div class="info-row"><span class="info-label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</span><span class="info-value">#${cd.number} (–£–Ω–∏–∫–∞–ª—å–Ω—ã–π)</span></div>`;
                
                if(ownerWornGiftIconHTML){
                    const ownerWornGiftIconElem = document.getElementById('profile-owner-worn-gift-icon-collectible-modal');
                    if(ownerWornGiftIconElem && ownerWornGift.collectibleData.lottieModelPath) {
                        playLottieAnimation(ownerWornGiftIconElem, ownerWornGift.collectibleData.lottieModelPath, true);
                    } else if (ownerWornGiftIconElem && ownerWornGift.collectibleData.modelImage) {
                        ownerWornGiftIconElem.innerHTML = `<img src="${ownerWornGift.collectibleData.modelImage}" style="width:100%; height:100%; object-fit:contain;" alt="">`;
                    }
                }

                collectibleActionWear.querySelector('.text').textContent = (wornGiftInstanceId === gift.instanceId) ? '–°–Ω—è—Ç—å' : '–ù–∞–¥–µ—Ç—å';
                collectibleDetailModal.classList.add('active');
            } else { // Non-collectible gift detail
                modalGiftName.textContent = "–°–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π –ø–æ–¥–∞—Ä–æ–∫";
                destroyLottieAnimation(modalLottieGiftOriginal);
                modalGiftImageStatic.style.display = 'none';

                if (gift.lottiePath) { 
                    modalLottieGiftOriginal.style.display = 'flex';
                    playLottieAnimation(modalLottieGiftOriginal, gift.lottiePath, true); 
                } else if (gift.originalImage) { 
                    modalLottieGiftOriginal.style.display = 'none';
                    modalGiftImageStatic.src = gift.originalImage; 
                    modalGiftImageStatic.style.display = 'block'; 
                    modalGiftImageStatic.onerror = function() { this.src = `https://i.pravatar.cc/100?u=err${generateUniqueId()}`; };
                } else {
                    modalLottieGiftOriginal.innerHTML = 'üñºÔ∏è';
                    modalLottieGiftOriginal.style.display = 'flex';
                }

                modalGiftDescription1.textContent = `–î–æ–±–∞–≤—å—Ç–µ ¬´${gift.name}¬ª –≤ —Å–≤–æ–π –ø—Ä–æ—Ñ–∏–ª—å –∏–ª–∏ —É–ª—É—á—à–∏—Ç–µ –µ–≥–æ.`;
                modalGiftDescription2.textContent = "–¢–æ–ª—å–∫–æ –≤—ã –º–æ–∂–µ—Ç–µ –≤–∏–¥–µ—Ç—å –∏–º—è –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è.";
                modalGiftInfo.innerHTML = `
                    <div class="info-row"><span class="info-label">–î–∞—Ç–∞</span><span class="info-value">${new Date(gift.acquiredDate).toLocaleDateString('ru-RU', {day:'numeric', month:'short', year:'numeric', hour:'2-digit', minute:'2-digit'})}</span></div>
                    <div class="info-row"><span class="info-label">–°—Ç–æ–∏–º–æ—Å—Ç—å</span><span class="info-value"><span class="star-icon">‚≠ê</span> –ë–µ—Å–ø–ª–∞—Ç–Ω–æ</span></div>
                    <div class="info-row"><span class="info-label">–î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å</span><span class="info-value">–û–≥—Ä–∞–Ω–∏—á–µ–Ω–æ</span></div>
                    <div class="info-row" id="uniqueness-row-${gift.instanceId}"><span class="info-label">–£–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å</span><div class="info-value-with-action"><span id="modal-uniqueness-value-${gift.instanceId}">–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π</span><button id="modal-action-upgrade-gift-${gift.instanceId}" class="button-link-styled" data-instance-id="${gift.instanceId}">–£–ª—É—á—à–∏—Ç—å</button></div></div>`;
                giftDetailModal.classList.add('active');
                const inlineUpgradeBtn = document.getElementById(`modal-action-upgrade-gift-${gift.instanceId}`);
                if (inlineUpgradeBtn) inlineUpgradeBtn.addEventListener('click', (e) => handleSingleGiftUpgradeFromModal(e.target.dataset.instanceId));
            }
        }

        async function upgradeSingleGiftLogic(giftToUpgrade) { 
            if (giftToUpgrade.isCollectible) return { instanceId: giftToUpgrade.instanceId, name: giftToUpgrade.name, status: 'skipped' };
            const giftNameEncoded = encodeURIComponent(giftToUpgrade.name); // Use original gift name for paths
            try {
                const [modelsRes, backdropsRes, patternsRes] = await Promise.all([
                    fetch(`${CDN_BASE_URL}models/${giftNameEncoded}/models.json`),
                    fetch(`${CDN_BASE_URL}backdrops/${giftNameEncoded}/backdrops.json`),
                    fetch(`${CDN_BASE_URL}patterns/${giftNameEncoded}/patterns.json`)
                ]);
                if (!modelsRes.ok) throw new Error(`–ú–æ–¥–µ–ª–∏ (${giftToUpgrade.name}) –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.`);
                if (!backdropsRes.ok) throw new Error(`–§–æ–Ω—ã (${giftToUpgrade.name}) –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.`);
                if (!patternsRes.ok) throw new Error(`–°–∏–º–≤–æ–ª—ã (${giftToUpgrade.name}) –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.`);
                
                const [modelsData, backdropsData, patternsData] = await Promise.all([modelsRes.json(), backdropsRes.json(), patternsRes.json()]);
                
                if (!modelsData?.models?.length || !backdropsData?.backdrops?.length || !patternsData?.patterns?.length) {
                     throw new Error(`–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è (–æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –º–æ–¥–µ–ª–∏/—Ñ–æ–Ω—ã/—Å–∏–º–≤–æ–ª—ã) –¥–ª—è "${giftToUpgrade.name}".`);
                }
                const selectedModel = selectWeightedRandom(modelsData.models);
                const selectedBackdrop = selectWeightedRandom(backdropsData.backdrops);
                const selectedPattern = selectWeightedRandom(patternsData.patterns);

                if (!selectedModel || !selectedBackdrop || !selectedPattern) {
                    throw new Error(`–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–±—Ä–∞—Ç—å –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è "${giftToUpgrade.name}".`);
                }

                const randomNumber = Math.floor(Math.random() * 200000) + 1;
                const giftIndexInOwned = ownedGifts.findIndex(g => g.instanceId === giftToUpgrade.instanceId);
                if (giftIndexInOwned !== -1) {
                    const newCollectibleData = {
                        model: selectedModel, backdrop: selectedBackdrop, pattern: selectedPattern, number: randomNumber,
                        modelImage: `${CDN_BASE_URL}models/${giftNameEncoded}/png/${encodeURIComponent(selectedModel.name)}.png`,
                        lottieModelPath: `${CDN_BASE_URL}models/${giftNameEncoded}/lottie/${encodeURIComponent(selectedModel.name)}.json`,
                        patternImage: `${CDN_BASE_URL}patterns/${giftNameEncoded}/png/${encodeURIComponent(selectedPattern.name)}.png`,
                        backdropColors: selectedBackdrop.hex,
                    };
                    // Preserve original gift ID and name, update collectible data
                    ownedGifts[giftIndexInOwned] = { 
                        ...ownedGifts[giftIndexInOwned], 
                        isCollectible: true, 
                        collectibleData: newCollectibleData, 
                        lottiePath: null // Original Lottie path no longer primary for display
                    };
                    return { instanceId: giftToUpgrade.instanceId, name: giftToUpgrade.name, status: 'success', collectibleData: newCollectibleData };
                } else {
                    throw new Error(`–ü–æ–¥–∞—Ä–æ–∫ "${giftToUpgrade.name}" –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä–µ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è.`);
                }
            } catch (error) {
                console.error(`–û—à–∏–±–∫–∞ —É–ª—É—á—à–µ–Ω–∏—è –¥–ª—è "${giftToUpgrade.name}" (ID: ${giftToUpgrade.instanceId}):`, error);
                return { instanceId: giftToUpgrade.instanceId, name: giftToUpgrade.name, status: 'failed', error: error.message };
            }
        }
        async function handleSingleGiftUpgradeFromModal(instanceId) { 
            const gift = ownedGifts.find(g => g.instanceId === instanceId);
            if (!gift || gift.isCollectible) return;
            const upgradeButton = document.getElementById(`modal-action-upgrade-gift-${instanceId}`);
            const uniquenessValueEl = document.getElementById(`modal-uniqueness-value-${instanceId}`);
            if (upgradeButton) { upgradeButton.textContent = '–£–ª—É—á—à–µ–Ω–∏–µ...'; upgradeButton.disabled = true; }
            if (uniquenessValueEl) uniquenessValueEl.textContent = '–û–±—Ä–∞–±–æ—Ç–∫–∞...';
            
            const result = await upgradeSingleGiftLogic(gift);
            
            if (result.status === 'success' && result.collectibleData) {
                if (uniquenessValueEl) uniquenessValueEl.textContent = `–ö–æ–ª–ª–µ–∫—Ü–∏–æ–Ω–Ω—ã–π #${result.collectibleData.number}`;
                saveState(); renderProfileGifts(); populateFilterOptions();
                tg.HapticFeedback.notificationOccurred('success');
                // Close current (non-collectible) modal and open new (collectible) modal after a short delay
                setTimeout(() => { 
                    closeModal(giftDetailModal); 
                    openGiftDetailByInstanceId(gift.instanceId); // Re-open with new collectible data
                }, 1200);
            } else {
                showToast(`–ù–µ —É–¥–∞–ª–æ—Å—å —É–ª—É—á—à–∏—Ç—å "${gift.name}". ${result.error || ''}`);
                if (uniquenessValueEl) uniquenessValueEl.textContent = '–û—à–∏–±–∫–∞';
                if (upgradeButton) { upgradeButton.textContent = '–£–ª—É—á—à–∏—Ç—å'; upgradeButton.disabled = false; }
            }
        }
        async function handleUpgradeAllGifts() { 
            const giftsToUpgrade = ownedGifts.filter(g => !g.isCollectible);
            if (giftsToUpgrade.length === 0) { showToast("–ù–µ—Ç –ø–æ–¥–∞—Ä–∫–æ–≤ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è."); return; }
            const originalButtonText = upgradeAllGiftsButton.textContent;
            upgradeAllGiftsButton.disabled = true;
            let successCount = 0, failureCount = 0;
            
            for (let i = 0; i < giftsToUpgrade.length; i++) {
                const gift = giftsToUpgrade[i];
                upgradeAllGiftsButton.textContent = `–£–ª—É—á—à–µ–Ω–∏–µ (${i + 1}/${giftsToUpgrade.length})...`;
                const cardElement = giftsGrid.querySelector(`.gift-card[data-instance-id="${gift.instanceId}"]`);
                if (cardElement) cardElement.classList.add('is-updating');
                
                const result = await upgradeSingleGiftLogic(gift); // This updates ownedGifts array directly
                
                if (cardElement) cardElement.classList.remove('is-updating');
                
                if (result.status === 'success') {
                    successCount++;
                     // No need to manually update card DOM here, renderProfileGifts will do it.
                } else if (result.status === 'failed') {
                    failureCount++;
                }
                // Small delay between upgrades if there are many
                if (giftsToUpgrade.length > 1 && i < giftsToUpgrade.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 100)); // Reduced delay
                }
            }
            saveState(); 
            renderProfileGifts(); // Re-render the entire grid with updated data
            populateFilterOptions();

            let summaryMessage = `–£–ª—É—á—à–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ.\n–£—Å–ø–µ—à–Ω–æ: ${successCount}`;
            if (failureCount > 0) summaryMessage += `\n–ù–µ —É–¥–∞–ª–æ—Å—å: ${failureCount}`;
            showToast(summaryMessage.replace('\n', ' ')); // Toast for brief summary
            
            tg.HapticFeedback.notificationOccurred(successCount > 0 ? 'success' : (failureCount > 0 ? 'error' : 'warning'));
            
            const stillHasNonCollectible = ownedGifts.some(g => !g.isCollectible);
            upgradeAllGiftsButton.style.display = stillHasNonCollectible ? 'inline-block' : 'none';
            if (stillHasNonCollectible) { 
                upgradeAllGiftsButton.textContent = originalButtonText; 
                upgradeAllGiftsButton.disabled = false; 
            }
        }
        function selectWeightedRandom(items) { 
            if (!items || items.length === 0) return null;
            let totalWeight = items.reduce((sum, item) => sum + (item.rarityPermille || 1), 0);
            if (totalWeight === 0 && items.length > 0) return items[Math.floor(Math.random() * items.length)]; // All zero, pick random
            if (totalWeight === 0) return null;

            let randomNum = Math.random() * totalWeight;
            for (let item of items) {
                const currentWeight = item.rarityPermille || 1;
                if (randomNum < currentWeight) return item;
                randomNum -= currentWeight;
            }
            return items[items.length - 1]; // Fallback, should ideally not be reached if weights are positive
        }
        
        // --- Modals and Popups ---
        function closeModal(modalElement) { 
            if (modalElement.id === 'gift-detail-modal') destroyLottieAnimation(modalLottieGiftOriginal);
            if (modalElement.id === 'collectible-detail-modal') {
                destroyLottieAnimation(modalLottieCollectibleModel);
                const ownerWornIcon = document.getElementById('profile-owner-worn-gift-icon-collectible-modal');
                if(ownerWornIcon) destroyLottieAnimation(ownerWornIcon);
            }
            if (modalElement.id === 'transfer-gift-modal') currentGiftToTransfer = null;
            modalElement.classList.remove('active');
        }
        let currentLongPressGift = null; let longPressTimer;
        function setupLongPress(element, gift) { 
            element.addEventListener('touchstart', (e) => {
                clearTimeout(longPressTimer);
                longPressTimer = setTimeout(() => {
                    if (e.touches.length === 1) openLongPressMenu(gift, e.touches[0]);
                }, 500);
            }, { passive: false }); // Not passive to allow preventDefault for contextmenu
            element.addEventListener('touchend', () => clearTimeout(longPressTimer));
            element.addEventListener('touchmove', () => clearTimeout(longPressTimer));
            element.addEventListener('contextmenu', (e) => { 
                e.preventDefault(); 
                clearTimeout(longPressTimer); 
                openLongPressMenu(gift, e); 
            });
        }
        function openLongPressMenu(gift, eventCoords) {
            currentLongPressGift = gift;
            if (!gift.isCollectible) { 
                menuPinAction.textContent = '–ó–∞–∫—Ä–µ–ø–∏—Ç—å (—Ç–æ–ª—å–∫–æ –∫–æ–ª–ª–µ–∫—Ü–∏–æ–Ω–Ω—ã–µ)'; 
                menuPinAction.classList.add('disabled'); 
            } else { 
                const isPinned = pinnedGifts.includes(gift.instanceId); 
                menuPinAction.textContent = isPinned ? '–û—Ç–∫—Ä–µ–ø–∏—Ç—å' : '–ó–∞–∫—Ä–µ–ø–∏—Ç—å'; 
                menuPinAction.classList.remove('disabled'); 
            }
            longPressMenu.style.top = `${Math.min(eventCoords.clientY, window.innerHeight - longPressMenu.offsetHeight - 10)}px`;
            longPressMenu.style.left = `${Math.min(eventCoords.clientX, window.innerWidth - longPressMenu.offsetWidth - 10)}px`;
            longPressMenu.classList.remove('hidden');
            // Use capture to ensure this fires before any other click that might open a modal
            document.addEventListener('click', closeLongPressMenuOnClickOutside, { once: true, capture: true });
        }
        function closeLongPressMenuOnClickOutside(event) {
            // Check if the click was on the menu itself or a child of it
            if (longPressMenu && !longPressMenu.classList.contains('hidden') && !longPressMenu.contains(event.target)) {
                 longPressMenu.classList.add('hidden'); 
                 currentLongPressGift = null;
            }
        }
        function handlePinAction() {
            if (!currentLongPressGift || menuPinAction.classList.contains('disabled')) {
                longPressMenu.classList.add('hidden');
                if (currentLongPressGift && !currentLongPressGift.isCollectible) showToast("–¢–æ–ª—å–∫–æ –∫–æ–ª–ª–µ–∫—Ü–∏–æ–Ω–Ω—ã–µ –ø–æ–¥–∞—Ä–∫–∏ –º–æ–∂–Ω–æ –∑–∞–∫—Ä–µ–ø–ª—è—Ç—å.");
                currentLongPressGift = null; return;
            }
            const giftInstanceId = currentLongPressGift.instanceId; const isPinned = pinnedGifts.includes(giftInstanceId);
            if (isPinned) {
                pinnedGifts = pinnedGifts.filter(id => id !== giftInstanceId);
            } else { 
                if (pinnedGifts.length >= MAX_PINS) { 
                    showTooManyPinsModal(); 
                    longPressMenu.classList.add('hidden'); 
                    // currentLongPressGift remains set, so after unpinning one, this one can be pinned
                    return; 
                } 
                pinnedGifts.push(giftInstanceId); 
            }
            saveState(); renderProfileGifts(); longPressMenu.classList.add('hidden');
            tg.HapticFeedback.impactOccurred(isPinned ? 'light' : 'medium'); 
            currentLongPressGift = null; 
        }
        function showTooManyPinsModal() {
            unpinSelectionGrid.innerHTML = '';
             // Unobserve any previous Lottie elements in this grid
            Array.from(unpinSelectionGrid.children).forEach(child => unobserveLottieElement(child));

            pinnedGifts.forEach(pinnedInstanceId => {
                const giftToUnpin = ownedGifts.find(g => g.instanceId === pinnedInstanceId);
                if (giftToUnpin) {
                    const card = createGiftCardDOM(giftToUnpin); 
                    card.addEventListener('click', () => {
                        pinnedGifts = pinnedGifts.filter(id => id !== pinnedInstanceId);
                        // If there was a gift waiting to be pinned (currentLongPressGift)
                        if (currentLongPressGift && currentLongPressGift.isCollectible && !pinnedGifts.includes(currentLongPressGift.instanceId) && pinnedGifts.length < MAX_PINS) {
                            pinnedGifts.push(currentLongPressGift.instanceId);
                        }
                        saveState(); renderProfileGifts(); closeModal(tooManyPinsModal);
                        tg.HapticFeedback.impactOccurred('medium'); 
                        currentLongPressGift = null; // Reset after action
                    });
                    unpinSelectionGrid.appendChild(card);
                    observeLottieElement(card); 
                }
            });
            tooManyPinsModal.classList.add('active');
        }
        function handleWearAction() { 
            const currentModalInstanceId = collectibleDetailModal.dataset.instanceId; if (!currentModalInstanceId) return;
            if (wornGiftInstanceId === currentModalInstanceId) { 
                wornGiftInstanceId = null; 
                collectibleActionWear.querySelector('.text').textContent = '–ù–∞–¥–µ—Ç—å'; 
            } else { 
                wornGiftInstanceId = currentModalInstanceId; 
                collectibleActionWear.querySelector('.text').textContent = '–°–Ω—è—Ç—å'; 
            }
            applyWornGiftStyles(wornGiftInstanceId); saveState(); tg.HapticFeedback.impactOccurred('light');
            // If the owner info is visible, re-render it to update their worn gift icon
            if (collectibleDetailModal.classList.contains('active')) {
                const gift = ownedGifts.find(g => g.instanceId === currentModalInstanceId);
                if (gift) openGiftDetailByInstanceId(gift.instanceId); // Re-opens and re-renders modal
            }
        }
        
        // --- Filters ---
        let filterPopupLongPressTimer; 
        function setupFilterPopupTrigger() {
            filterLongPressTarget.addEventListener('touchstart', (e) => { filterPopupLongPressTimer = setTimeout(openFilterPopup, 700); }, { passive: true });
            filterLongPressTarget.addEventListener('touchend', () => clearTimeout(filterPopupLongPressTimer));
            filterLongPressTarget.addEventListener('touchmove', () => clearTimeout(filterPopupLongPressTimer));
            filterLongPressTarget.addEventListener('contextmenu', (e) => { e.preventDefault(); clearTimeout(filterPopupLongPressTimer); openFilterPopup(); });
        }
        function openFilterPopup() { populateFilterOptions(); filterPopup.classList.add('active'); }
        function populateFilterOptions() {
            const uniqueCollections = [...new Map(ownedGifts.map(item => [item.id, {id: item.id, name: item.name, image: item.originalImage, lottie: item.lottiePath }])).values()];
            renderFilterOptions(filterOptionsCollections, uniqueCollections, 'collection', (item) => 
                item.lottie ? `<div class="lottie-animation-container filter-lottie-item" data-lottie-path="${item.lottie}"></div>` : `<img src="${item.image}" alt="${item.name}">`
            );
        
            if (activeFilters.collection) {
                const giftsInCollection = ownedGifts.filter(g => g.id === activeFilters.collection && g.isCollectible && g.collectibleData?.model);
                const uniqueModels = [...new Map(giftsInCollection.map(item => [item.collectibleData.model.name, {name: item.collectibleData.model.name, image: item.collectibleData.modelImage, lottie: item.collectibleData.lottieModelPath}])).values()];
                renderFilterOptions(filterOptionsModels, uniqueModels, 'model', (item) => 
                     item.lottie ? `<div class="lottie-animation-container filter-lottie-item" data-lottie-path="${item.lottie}"></div>` : `<img src="${item.image}" alt="${item.name}">`
                );
                filterModelsSection.classList.remove('hidden');
            } else { 
                filterModelsSection.classList.add('hidden'); filterOptionsModels.innerHTML = ''; 
            }
            
            const collectibleGiftsWithBackdrop = ownedGifts.filter(g => g.isCollectible && g.collectibleData?.backdrop && g.collectibleData.backdropColors);
            const uniqueBackdrops = [...new Map(collectibleGiftsWithBackdrop.map(item => [item.collectibleData.backdrop.name, {name: item.collectibleData.backdrop.name, colors: item.collectibleData.backdropColors}])).values()];
            renderFilterOptions(filterOptionsBackdrops, uniqueBackdrops, 'backdrop', (item) => `<div class="gradient-square" style="background: radial-gradient(circle, ${item.colors.centerColor}, ${item.colors.edgeColor});"></div>`);
            
            const collectibleGiftsWithPattern = ownedGifts.filter(g => g.isCollectible && g.collectibleData?.pattern && g.collectibleData.patternImage);
            const uniquePatterns = [...new Map(collectibleGiftsWithPattern.map(item => [item.collectibleData.pattern.name, {name: item.collectibleData.pattern.name, image: item.collectibleData.patternImage}])).values()];
            renderFilterOptions(filterOptionsPatterns, uniquePatterns, 'pattern', (item) => `<img src="${item.image}" alt="${item.name}">`);
        }
        function renderFilterOptions(container, items, filterType, displayFn) {
            // Unobserve old Lottie items in filter options
            container.querySelectorAll('.filter-lottie-item').forEach(lottieElem => {
                 if (lottieElem.lottieInstance) destroyLottieAnimation(lottieElem);
            });
            container.innerHTML = '';

            items.forEach(item => {
                const optionEl = document.createElement('div'); optionEl.className = 'filter-option';
                optionEl.innerHTML = displayFn(item);
                const valueToCompare = filterType === 'collection' ? item.id : item.name;
                if (activeFilters[filterType] === valueToCompare) optionEl.classList.add('selected');
                
                optionEl.addEventListener('click', () => {
                    if (activeFilters[filterType] === valueToCompare) {
                        activeFilters[filterType] = null;
                        if (filterType === 'collection') activeFilters.model = null; // Reset dependent filter
                    } else {
                        activeFilters[filterType] = valueToCompare;
                        if (filterType === 'collection') activeFilters.model = null; // Reset dependent filter
                    }
                    populateFilterOptions(); // Re-render options to update selection and dependent filters
                });
                container.appendChild(optionEl);
                // Play Lottie for filter options if any
                const lottieElem = optionEl.querySelector('.filter-lottie-item');
                if (lottieElem && lottieElem.dataset.lottiePath) {
                    playLottieAnimation(lottieElem, lottieElem.dataset.lottiePath, true);
                }
            });
        }
        function handleApplyFilters() { renderProfileGifts(); saveState(); closeModal(filterPopup); }
        function handleClearFilters() {
            activeFilters = { collection: null, model: null, backdrop: null, pattern: null };
            populateFilterOptions(); renderProfileGifts(); saveState();
        }
        function handleClearAllData() {
            tg.showConfirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –≤—Å–µ —Å–≤–æ–∏ –ø–æ–¥–∞—Ä–∫–∏ –∏ –¥–∞–Ω–Ω—ã–µ? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ.", (confirmed) => {
                if (confirmed) {
                    ownedGifts = []; pinnedGifts = []; wornGiftInstanceId = null;
                    activeFilters = { collection: null, model: null, backdrop: null, pattern: null };
                    
                    Array.from(giftsGrid.children).forEach(child => unobserveLottieElement(child));
                    Array.from(buyGiftsGrid.children).forEach(child => unobserveLottieElement(child));
                    Array.from(profileTopPinnedGifts.children).forEach(childLottieContainer => destroyLottieAnimation(childLottieContainer));
                    
                    saveState(); applyWornGiftStyles(null); renderProfileGifts(); populateFilterOptions();
                    tg.HapticFeedback.notificationOccurred('success'); showToast("–í—Å–µ –¥–∞–Ω–Ω—ã–µ —É–¥–∞–ª–µ–Ω—ã.");
                    closeModal(filterPopup);
                }
            });
        }

        // --- Gift Transfer Feature ---
        function simpleXorEncrypt(text, key) {
            let result = "";
            for (let i = 0; i < text.length; i++) {
                result += String.fromCharCode(text.charCodeAt(i) ^ key.charCodeAt(i % key.length));
            }
            // URL-safe Base64 encoding
            return btoa(result).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
        }

        function simpleXorDecrypt(cipherText, key) {
            try {
                // URL-safe Base64 decoding
                let base64 = cipherText.replace(/-/g, '+').replace(/_/g, '/');
                while (base64.length % 4) {
                    base64 += '=';
                }
                const decodedB64 = atob(base64);
                let result = "";
                for (let i = 0; i < decodedB64.length; i++) {
                    result += String.fromCharCode(decodedB64.charCodeAt(i) ^ key.charCodeAt(i % key.length));
                }
                return result;
            } catch (e) {
                console.error("Decryption failed:", e);
                showToast("–û—à–∏–±–∫–∞ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ–¥–∞—Ä–∫–∞.");
                return null; 
            }
        }

        function openTransferGiftModal(gift) {
            currentGiftToTransfer = gift;
            transferGiftModalTitle.textContent = `–ü–µ—Ä–µ–¥–∞—Ç—å "${gift.name}"`;
            transferGiftNameInfo.textContent = `–í—ã —Å–æ–±–∏—Ä–∞–µ—Ç–µ—Å—å –ø–µ—Ä–µ–¥–∞—Ç—å –∫–æ–ª–ª–µ–∫—Ü–∏–æ–Ω–Ω—ã–π –ø–æ–¥–∞—Ä–æ–∫ #${gift.collectibleData.number}.`;
            transferRecipientInput.value = '';
            transferGiftModal.classList.add('active');
            transferRecipientInput.focus();
        }

        async function handleConfirmTransferGift() {
            if (!currentGiftToTransfer || !currentGiftToTransfer.isCollectible) {
                showToast("–ú–æ–∂–Ω–æ –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –∫–æ–ª–ª–µ–∫—Ü–∏–æ–Ω–Ω—ã–µ –ø–æ–¥–∞—Ä–∫–∏.");
                return;
            }
            const recipientIdOrUsername = transferRecipientInput.value.trim();
            if (!recipientIdOrUsername) {
                showToast("–í–≤–µ–¥–∏—Ç–µ ID –∏–ª–∏ @username –ø–æ–ª—É—á–∞—Ç–µ–ª—è.");
                return;
            }

            const gift = currentGiftToTransfer;
            const cd = gift.collectibleData;
            const senderUser = tg.initDataUnsafe?.user || mockUser;
            const senderUsername = senderUser.username || mockUser.username || "UnknownSender";

            const payloadParts = [
                "receive", // 0: action
                recipientIdOrUsername, // 1: recipient
                `@${senderUsername}`, // 2: sender
                gift.id, // 3: original gift ID (from allAvailableGifts)
                gift.name, // 4: original gift name (for display and path construction)
                cd.model.name, // 5: model name
                cd.backdrop.name, // 6: backdrop name
                cd.pattern.name, // 7: pattern name
                String(cd.number), // 8: collectible number
                cd.modelImage, // 9: model static image URL
                cd.lottieModelPath || "", // 10: model lottie path
                cd.patternImage, // 11: pattern image URL
                JSON.stringify(cd.backdropColors), // 12: backdrop colors
                String(cd.model.rarityPermille || 0), // 13: model rarity
                String(cd.backdrop.rarityPermille || 0), // 14: backdrop rarity
                String(cd.pattern.rarityPermille || 0)  // 15: pattern rarity
            ];
            const payloadString = payloadParts.join("|");
            const encryptedPayload = simpleXorEncrypt(payloadString, XOR_KEY);
            
            const transferUrl = `https://t.me/${YOUR_BOT_USERNAME}/${YOUR_MINI_APP_NAME}?startapp=${encryptedPayload}`;

            try {
                await navigator.clipboard.writeText(transferUrl);
                tg.showPopup({
                    title: "–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!",
                    message: `–û—Ç–ø—Ä–∞–≤—å—Ç–µ —ç—Ç—É —Å—Å—ã–ª–∫—É –ø–æ–ª—É—á–∞—Ç–µ–ª—é. –ü–æ—Å–ª–µ —Ç–æ–≥–æ –∫–∞–∫ –æ–Ω –æ—Ç–∫—Ä–æ–µ—Ç –µ—ë, –ø–æ–¥–∞—Ä–æ–∫ –±—É–¥–µ—Ç —É–¥–∞–ª–µ–Ω –∏–∑ –≤–∞—à–µ–≥–æ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è.\n\n–°—Å—ã–ª–∫–∞: ${transferUrl}`,
                    buttons: [{ type: "ok", text: "–ü–æ–Ω—è—Ç–Ω–æ" }]
                }, () => {
                     // Remove gift from sender's inventory
                    ownedGifts = ownedGifts.filter(g => g.instanceId !== gift.instanceId);
                    if (pinnedGifts.includes(gift.instanceId)) {
                        pinnedGifts = pinnedGifts.filter(id => id !== gift.instanceId);
                    }
                    if (wornGiftInstanceId === gift.instanceId) {
                        wornGiftInstanceId = null;
                        applyWornGiftStyles(null);
                    }
                    saveState();
                    renderProfileGifts();
                    showToast(`"${gift.name}" #${cd.number} —É–¥–∞–ª–µ–Ω –∏ –≥–æ—Ç–æ–≤ –∫ –ø–µ—Ä–µ–¥–∞—á–µ.`);
                    closeModal(transferGiftModal);
                    closeModal(collectibleDetailModal); // Close the main collectible modal too
                });

            } catch (err) {
                console.error('Failed to copy transfer link: ', err);
                showToast("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤—Ä—É—á–Ω—É—é.");
                 tg.showPopup({
                    title: "–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è",
                    message: `–ù–µ —É–¥–∞–ª–æ—Å—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–∫–æ–ø–∏—Ä—É–π—Ç–µ –µ—ë –≤—Ä—É—á–Ω—É—é:\n\n${transferUrl}`,
                    buttons: [{ type: "ok" }]
                });
            }
        }
        
        async function processReceivedGift(startParam) {
            const decryptedPayload = simpleXorDecrypt(startParam, XOR_KEY);
            if (!decryptedPayload) {
                showToast("–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –ø–æ–ª—É—á–µ–Ω–Ω—ã–π –ø–æ–¥–∞—Ä–æ–∫: –æ—à–∏–±–∫–∞ –¥–∞–Ω–Ω—ã—Ö.");
                return;
            }

            const parts = decryptedPayload.split("|");
            if (parts[0] !== "receive" || parts.length < 16) {
                showToast("–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –ø–æ–ª—É—á–µ–Ω–Ω—ã–π –ø–æ–¥–∞—Ä–æ–∫: –Ω–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç.");
                return;
            }

            const recipientTarget = parts[1];
            const senderUsername = parts[2];
            const giftId = parts[3];
            const giftName = parts[4];
            const modelName = parts[5];
            const backdropName = parts[6];
            const patternName = parts[7];
            const collectibleNumber = parseInt(parts[8], 10);
            const modelImage = parts[9];
            const lottieModelPath = parts[10];
            const patternImage = parts[11];
            const backdropColors = JSON.parse(parts[12]);
            const modelRarity = parseInt(parts[13], 10);
            const backdropRarity = parseInt(parts[14], 10);
            const patternRarity = parseInt(parts[15], 10);

            const currentUser = tg.initDataUnsafe?.user || mockUser;
            const currentUsername = currentUser.username ? `@${currentUser.username}` : null;
            const currentUserId = String(currentUser.id);

            if (recipientTarget !== currentUserId && recipientTarget !== currentUsername) {
                showToast("–≠—Ç–æ—Ç –ø–æ–¥–∞—Ä–æ–∫ –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω –Ω–µ –≤–∞–º.");
                return;
            }

            // Duplicate check (by original gift name + collectible number)
            const existingGift = ownedGifts.find(g => 
                g.name === giftName && g.isCollectible && g.collectibleData?.number === collectibleNumber
            );
            if (existingGift) {
                showToast(`–í—ã —É–∂–µ –≤–ª–∞–¥–µ–µ—Ç–µ –ø–æ–¥–∞—Ä–∫–æ–º "${giftName}" #${collectibleNumber}.`);
                return;
            }
            
            // Find base gift for originalImage etc.
            const baseGiftInfo = allAvailableGifts[giftId] ? 
                                 { name: allAvailableGifts[giftId], originalImage: `${CDN_BASE_URL}originals/${giftId}/Original.png`, lottiePath: `${CDN_BASE_URL}originals/${giftId}/Original.json`} : 
                                 { name: giftName, originalImage: modelImage, lottiePath: lottieModelPath }; // Fallback if base not in allAvailableGifts

            const newGiftInstance = {
                id: giftId,
                instanceId: generateUniqueId(),
                name: giftName, // This is the original gift's name like "Winter Wreath"
                originalImage: baseGiftInfo.originalImage, 
                lottiePath: baseGiftInfo.lottiePath, 
                isCollectible: true,
                collectibleData: {
                    model: { name: modelName, rarityPermille: modelRarity },
                    backdrop: { name: backdropName, rarityPermille: backdropRarity },
                    pattern: { name: patternName, rarityPermille: patternRarity },
                    number: collectibleNumber,
                    modelImage: modelImage,
                    lottieModelPath: lottieModelPath,
                    patternImage: patternImage,
                    backdropColors: backdropColors,
                },
                acquiredDate: new Date().toISOString()
            };

            ownedGifts.unshift(newGiftInstance);
            saveState();
            renderProfileGifts();
            populateFilterOptions();
            
            showToastWithLink(`–í—ã –ø–æ–ª—É—á–∏–ª–∏ "${giftName}" #${collectibleNumber} –æ—Ç `, senderUsername, `https://t.me/${senderUsername.substring(1)}`);
            openGiftDetailByInstanceId(newGiftInstance.instanceId); // Show the received gift
        }

        function showToast(message, duration = 3000) {
            toastNotification.textContent = message;
            toastNotification.classList.add('show');
            setTimeout(() => {
                toastNotification.classList.remove('show');
            }, duration);
        }
        function showToastWithLink(messagePart1, linkText, linkHref, duration = 5000) {
            toastNotification.innerHTML = ''; // Clear previous content
            const text1 = document.createTextNode(messagePart1);
            const link = document.createElement('a');
            link.href = linkHref;
            link.target = "_blank"; // Open in new tab/external
            link.textContent = linkText;
            
            toastNotification.appendChild(text1);
            toastNotification.appendChild(link);
            toastNotification.classList.add('show');
            
            setTimeout(() => {
                toastNotification.classList.remove('show');
            }, duration);
        }

        // --- Event Listeners Setup ---
        function setupEventListeners() { 
            goToBuyGiftsButton.addEventListener('click', () => showPage('buy-gifts-page'));
            if (upgradeAllGiftsButton) upgradeAllGiftsButton.addEventListener('click', handleUpgradeAllGifts);
            backToProfileBuyButton.addEventListener('click', () => showPage('profile-page'));
            
            closeGiftDetailModalButton.addEventListener('click', () => closeModal(giftDetailModal));
            
            backFromCollectibleModal.addEventListener('click', () => closeModal(collectibleDetailModal));
            collectibleActionTransfer.addEventListener('click', () => {
                const instanceId = collectibleDetailModal.dataset.instanceId;
                const gift = ownedGifts.find(g => g.instanceId === instanceId);
                if (gift) openTransferGiftModal(gift);
            });
            collectibleActionWear.addEventListener('click', handleWearAction);
            closeCollectibleDetailModalButton.addEventListener('click', () => closeModal(collectibleDetailModal));
            
            menuPinAction.addEventListener('click', handlePinAction);
            cancelUnpinModal.addEventListener('click', () => { closeModal(tooManyPinsModal); currentLongPressGift = null; });
            
            confirmBuyMultipleButton.addEventListener('click', handleConfirmBuyMultiple);
            cancelBuyMultipleButton.addEventListener('click', () => closeModal(buyMultipleModal));

            confirmTransferGiftButton.addEventListener('click', handleConfirmTransferGift);
            cancelTransferGiftButton.addEventListener('click', () => closeModal(transferGiftModal));
            
            [giftDetailModal, collectibleDetailModal, tooManyPinsModal, buyMultipleModal, filterPopup, transferGiftModal].forEach(modal => {
                modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(modal); });
            });
            
            setupFilterPopupTrigger();
            applyFiltersButton.addEventListener('click', handleApplyFilters);
            clearFiltersButton.addEventListener('click', handleClearFilters);
            clearAllDataButton.addEventListener('click', handleClearAllData);

            document.getElementById('collectible-hide-link').addEventListener('click', () => {
                showToast("–§—É–Ω–∫—Ü–∏—è '–°–∫—Ä—ã—Ç—å' –µ—â–µ –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞.");
            });
        }
        
        // --- App Start ---
        if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.initData !== undefined) {
            initApp();
        } else {
            console.warn("Telegram WebApp –Ω–µ –Ω–∞–π–¥–µ–Ω. –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –º–æ–∫-–¥–∞–Ω–Ω—ã–µ –∏ —Ç–µ–º–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é.");
            document.addEventListener('DOMContentLoaded', () => {
                tg.initDataUnsafe = { 
                    user: mockUser,
                    // start_param: "YOUR_ENCRYPTED_PAYLOAD_FOR_TESTING" // Uncomment and replace for testing transfer
                }; 
                tg.themeParams = { // Example theme for local testing
                     bg_color: "#17212b", text_color: "#ffffff", hint_color: "#b0c4de", link_color: "#87cefa",
                     button_color: "#5288c1", button_text_color: "#ffffff", secondary_bg_color: "#0e1621",
                     accent_text_color: "#62bcf9"
                };
                tg.showAlert = (message) => alert(message);
                tg.showConfirm = (message, callback) => callback(confirm(message));
                tg.showPopup = (params, callback) => { 
                    alert(`${params.title}\n${params.message}`);
                    if (callback) callback();
                }
                tg.HapticFeedback = {
                    impactOccurred: (style) => console.log(`Haptic: ${style}`),
                    notificationOccurred: (type) => console.log(`Haptic Notification: ${type}`),
                };
                tg.ready = () => {}; tg.expand = () => {}; tg.onEvent = (event, callback) => {};
                initApp();
            });
        }
    </script>
</body>
</html>
```
