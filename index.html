<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Telegram Gift Simulator</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.2/Sortable.min.js"></script>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-F3KPE0SD07"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-F3KPE0SD07');
    </script>
    <style>
        :root {
            --tg-theme-bg-color: #0e1621;
            --tg-theme-text-color: #ffffff;
            --tg-theme-hint-color: #708499;
            --tg-theme-link-color: #62bcf9;
            --tg-theme-button-color: #3e97f0;
            --tg-theme-button-text-color: #ffffff;
            --tg-theme-secondary-bg-color: #17212b;
            --tg-theme-accent-blue: #5288c1;

            --app-modal-backdrop-color: rgba(0,0,0,0.7);
            --app-rarity-chip-bg: rgba(0,0,0,0.2);
            --app-rarity-chip-text: var(--tg-theme-text-color);
            --app-action-button-bg: #232e3a;
            --app-action-button-text: var(--tg-theme-link-color);
            --app-profile-gradient-fallback: var(--tg-theme-secondary-bg-color);
            --app-clear-data-color: #ff3b30;

            /* Wall Colors */
            --app-wall-demonic-red: #ff3b30;
            --app-wall-pink: #ff80ab;
            --app-wall-green: #4caf50;
            --app-wall-blue: #2196f3;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--tg-theme-bg-color);
            color: var(--tg-theme-text-color);
            overscroll-behavior-y: none;
            line-height: 1.4;
            font-size: 16px;
            overflow-x: hidden;
        }

        .app-container {
            max-width: 600px;
            margin: 0 auto;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        
        #loading-screen {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background-color: var(--tg-theme-bg-color);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 9999;
            transition: opacity 0.3s ease-out;
        }
        #loading-screen.hidden { opacity: 0; pointer-events: none; }
        #loading-screen h1 { font-size: 1.5em; font-weight: 500; margin-bottom: 5px; }
        #loading-screen p { font-size: 1em; color: var(--tg-theme-hint-color); margin-bottom: 20px; }


        /* Account Sidebar Styles */
        .account-sidebar {
            position: fixed;
            top: 0;
            left: 0;
            bottom: 0;
            width: 80%;
            max-width: 320px;
            background-color: var(--tg-theme-bg-color);
            z-index: 2000;
            transform: translateX(-100%);
            transition: transform 0.3s ease-in-out;
            display: flex;
            flex-direction: column;
            box-shadow: 2px 0 15px rgba(0,0,0,0.3);
        }
        .account-sidebar.active {
            transform: translateX(0);
        }
        .sidebar-header {
            padding: 15px;
            background-color: var(--tg-theme-secondary-bg-color);
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        .sidebar-header .user-info { display: flex; align-items: center; width: 100%; margin-bottom: 15px; }
        .sidebar-header img {
            width: 50px; height: 50px;
            border-radius: 50%;
            margin-right: 15px;
        }
        .sidebar-header .name {
            font-size: 1.1em;
            font-weight: 500;
        }
        #sidebar-search-container { width: 100%; position: relative; }
        #sidebar-search-input { 
            width: 100%; padding: 10px 15px; border-radius: 8px;
            border: none; background-color: var(--tg-theme-bg-color);
            color: var(--tg-theme-text-color); font-size: 1em;
        }
        #sidebar-search-results {
             position: absolute; top: 105%; left:0; right:0;
             background-color: var(--tg-theme-secondary-bg-color);
             border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.2);
             max-height: 200px; overflow-y: auto; z-index: 10;
        }
        .search-result-item {
            padding: 10px 15px; cursor: pointer; display: flex; align-items: center;
        }
        .search-result-item:hover { background-color: rgba(255,255,255,0.05); }
        .search-result-item img { width: 30px; height: 30px; border-radius: 50%; margin-right: 10px; }

        .accounts-list {
            list-style: none;
            flex-grow: 1;
            overflow-y: auto;
        }
        .accounts-list li {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            cursor: pointer;
            border-bottom: 1px solid var(--tg-theme-secondary-bg-color);
        }
        .accounts-list li:hover {
            background-color: rgba(255,255,255,0.05);
        }
        .accounts-list li.active {
            background-color: var(--tg-theme-link-color);
            color: var(--tg-theme-button-text-color);
        }
        .accounts-list li img {
            width: 40px; height: 40px;
            border-radius: 50%;
            margin-right: 15px;
        }
        .sidebar-footer {
            padding: 10px 15px;
            border-top: 1px solid var(--tg-theme-secondary-bg-color);
            overflow-y: auto;
        }
        .sidebar-footer button {
             width: 100%;
             padding: 12px;
             background: none;
             border: none;
             color: var(--tg-theme-link-color);
             text-align: left;
             font-size: 1em;
             cursor: pointer;
             border-radius: 8px;
             display: flex; align-items: center;
        }
        .sidebar-footer button svg {
            margin-right: 12px;
            width: 22px; height: 22px;
            fill: currentColor;
        }
        .sidebar-footer button:hover {
            background-color: rgba(255,255,255,0.05);
        }
        .sidebar-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0,0,0,0.5);
            z-index: 1999;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out;
        }
        .sidebar-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        /* End Account Sidebar */

        .page {
            display: none;
            flex-direction: column;
            flex-grow: 1;
            background-color: var(--tg-theme-bg-color);
        }

        .page.active {
            display: flex;
        }

        .page-header {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            background-color: var(--tg-theme-secondary-bg-color);
            min-height: 56px;
            position: sticky; top: 0; z-index: 10;
        }
        #profile-page > .page-header {
            background-color: transparent;
            position: absolute;
            top: 0; left:0; right:0;
            z-index: 100;
        }
        .page-header h2 {
            font-size: 1.15em;
            color: var(--tg-theme-text-color);
            font-weight: 500;
        }

        .profile-page-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        .profile-top-section {
            position: relative;
            padding-top: 56px;
            background: var(--app-profile-gradient-fallback);
            transition: background 0.3s ease;
        }
        .profile-header-pattern-overlay {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background-repeat: repeat;
            background-size: 30% auto;
            opacity: 0.07;
            pointer-events: none;
            z-index: 0;
        }
        .profile-header-content-wrapper {
             position: relative; z-index: 1;
             padding: 0 15px;
        }
        .profile-top-pinned-gifts {
            display: flex;
            justify-content: center;
            gap: 8px;
            padding: 5px 0 8px 0;
            min-height: 30px;
        }
        .profile-top-pinned-gifts .pinned-gift-item {
            width: 30px; height: 30px;
            border-radius: 8px;
            background-color: rgba(0,0,0,0.1);
            overflow: hidden;
            cursor: pointer;
        }
        .profile-main-info {
            display: flex;
            align-items: center;
            padding: 8px 0 20px 0;
        }
        .profile-avatar {
            width: 70px; height: 70px;
            border-radius: 50%;
            background-color: var(--tg-theme-hint-color);
            margin-right: 15px;
            object-fit: cover;
            border: 3px solid rgba(255,255,255,0.1);
            cursor: pointer;
        }
        .profile-name-status { display: flex; flex-direction: column; }
        .profile-name-status .name-line { display: flex; align-items: center; }
        .profile-name-status h1 {
            font-size: 1.4em; font-weight: 600;
            color: var(--tg-theme-text-color);
        }
        #worn-gift-icon-container {
            width: 24px; height: 24px; margin-left: 8px;
            overflow: hidden;
            cursor: pointer;
        }
        .profile-name-status p { font-size: 0.95em; color: var(--tg-theme-text-color); opacity: 0.7; margin-top: 3px; }
        .profile-name-status p.online { opacity: 1; color: var(--tg-theme-link-color); }

        .profile-details-section {
            background-color: var(--tg-theme-bg-color);
            padding: 15px 15px 5px 15px;
        }
        .profile-details .info-block {
            margin-bottom: 16px;
        }
        .profile-details .info-value {
            font-size: 0.95em;
            color: var(--tg-theme-text-color);
            white-space: pre-wrap;
            word-break: break-word;
        }
        .profile-details .info-label {
            font-size: 0.9em;
            color: var(--tg-theme-hint-color);
            margin-bottom: 3px;
            display: block;
        }
        .profile-details .info-value.collectible-value {
            color: var(--tg-theme-link-color);
            cursor: pointer;
        }
        #profile-bio {
             cursor: pointer;
        }
        #collectible-usernames-container {
            margin-top: 4px;
            line-height: 1.5;
        }
        #collectible-usernames-container .also-text {
            color: var(--tg-theme-hint-color);
            margin-right: 6px;
        }
        #collectible-usernames-container .collectible-username-span {
            color: var(--tg-theme-link-color);
            margin-right: 6px;
            cursor: pointer;
        }

        .profile-tabs-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }
        .profile-tabs {
            display: flex; justify-content: space-around;
            background-color: var(--tg-theme-bg-color);
            padding: 5px 0 0 0;
            align-items: center;
        }
        .profile-tabs button {
            background: none; border: none;
            color: var(--tg-theme-hint-color);
            padding: 14px 10px; font-size: 1em;
            cursor: pointer; flex-grow: 1;
            border-bottom: 3px solid transparent; position: relative;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .profile-tabs button:disabled { color: var(--tg-theme-hint-color); opacity: 0.5; cursor: not-allowed; }
        #wall-subscription-button { flex-grow: 0; padding: 10px; }
        #wall-subscription-button svg { width: 24px; height: 24px; fill: currentColor; }

        #gifts-tab-button .gift-preview-container {
            display: flex;
            align-items: center;
            margin-left: 8px;
        }
        #gifts-tab-button .gift-preview-container img {
            width: 20px;
            height: 20px;
            object-fit: contain;
            margin-left: 2px;
            background-color: rgba(0,0,0,0.1); /* Fallback */
            border-radius: 6px;
        }

        .profile-tabs button.active { color: var(--tg-theme-link-color); }
        .profile-tabs button.active::after {
            content: ''; position: absolute;
            bottom: 0px; left: 0; right: 0;
            height: 3px; background-color: var(--tg-theme-link-color);
        }
        .tab-content {
            display: none;
            flex-grow: 1;
        }
        .tab-content.active {
            display: flex;
            flex-direction: column;
        }
        
        /* Posts / Wall Styles */
        #posts-content {
            padding: 10px 15px;
            overflow-y: auto;
        }
        .post-card {
            background-color: var(--tg-theme-secondary-bg-color);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 12px;
            position: relative;
        }
        .post-menu-button {
            position: absolute; top: 10px; right: 10px;
            background: none; border: none; color: var(--tg-theme-hint-color);
            cursor: pointer; padding: 5px;
        }
        .post-content {
            font-size: 1em;
            line-height: 1.5;
            white-space: pre-wrap;
            word-wrap: break-word;
            cursor: pointer;
        }
        .post-content .text-demonic {
            color: var(--app-wall-demonic-red);
            font-size: 1.2em;
            font-weight: 600;
        }
        .post-content .text-pink { color: var(--app-wall-pink); }
        .post-content .text-green { color: var(--app-wall-green); }
        .post-content .text-blue { color: var(--app-wall-blue); }
        .post-content a.gift-link, .post-content a.user-link {
            color: var(--tg-theme-link-color);
            text-decoration: none;
        }
        .post-content a.gift-link:hover, .post-content a.user-link:hover {
            text-decoration: underline;
        }
        .post-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 12px;
            color: var(--tg-theme-hint-color);
        }
        .post-meta { font-size: 0.8em; }
        .post-reactions-container {
            display: flex; gap: 8px; flex-wrap: wrap;
        }
        .reaction-chip {
            background-color: var(--app-action-button-bg);
            padding: 4px 8px; border-radius: 12px;
            font-size: 0.9em; cursor: pointer;
            border: 1px solid transparent;
        }
        .reaction-chip.user-reacted {
            border-color: var(--tg-theme-link-color);
        }

        #reaction-popup {
            position: fixed;
            background-color: var(--tg-theme-secondary-bg-color);
            padding: 8px;
            border-radius: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            display: flex;
            gap: 8px;
            z-index: 1500;
            transform: scale(0.9);
            opacity: 0;
            transition: transform 0.1s ease-out, opacity 0.1s ease-out;
        }
        #reaction-popup.visible {
            transform: scale(1);
            opacity: 1;
        }
        .reaction-emoji {
            font-size: 1.8em;
            cursor: pointer;
            transition: transform 0.1s ease-out;
        }
        .reaction-emoji:hover { transform: scale(1.2); }
        
        .new-post-fab {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 56px;
            height: 56px;
            background-color: var(--tg-theme-button-color);
            color: var(--tg-theme-button-text-color);
            border-radius: 50%;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            font-weight: 300;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            cursor: pointer;
            z-index: 999;
        }
        /* End Wall Styles */

        /* NEW: Action bar is now a direct child of gifts-content */
        #gifts-content .profile-gifts-actions-wrapper {
            display: flex;
            align-items: center;
            background-color: var(--tg-theme-bg-color);
            padding: 12px 15px;
        }
        .profile-gifts-actions {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            width: 100%;
        }
        .profile-gifts-actions .action-button {
            background-color: var(--tg-theme-button-color);
            color: var(--tg-theme-button-text-color);
            border: none; padding: 8px 18px;
            border-radius: 20px; font-size: 0.9em; cursor: pointer;
            font-weight: 500;
        }
        #upgrade-all-gifts-button { background-color: var(--tg-theme-accent-blue); margin-right: 10px; }

        #exit-filter-mode-button, #hide-selected-gifts-button, #exit-selection-mode-button,
        #exit-reorder-mode-button, #transfer-selected-gifts-button {
            background-color: var(--tg-theme-accent-blue);
            color: var(--tg-theme-button-text-color);
            border: none;
            padding: 8px 18px;
            border-radius: 20px;
            font-size: 0.9em;
            cursor: pointer;
            font-weight: 500;
            margin-right: 10px;
        }
        
        #buy-gifts-page .buy-gifts-header-actions {
            display: flex;
            justify-content: flex-end;
        }
        
        #buy-gifts-page .buy-gifts-header-actions .action-button {
            background-color: var(--tg-theme-button-color);
            color: var(--tg-theme-button-text-color);
            border: none; padding: 8px 18px;
            border-radius: 20px; font-size: 0.9em; cursor: pointer;
            font-weight: 500;
        }

        #buy-gifts-page .page-header { justify-content: space-between; }


        .gifts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 5px;
            padding: 10px;
            flex-grow: 1;
            overflow-y: auto;
            background-color: var(--tg-theme-bg-color);
        }
        .gifts-grid.reordering .gift-card[data-pinned="true"] {
            cursor: grabbing;
        }
        .empty-grid-message {
            color: var(--tg-theme-hint-color); text-align: center;
            padding: 30px 40px; font-size: 0.95em; line-height: 1.5; width: 100%;
        }

        .gift-card, .buy-gift-item {
            background-color: var(--tg-theme-secondary-bg-color);
            border-radius: 10px;
            padding: 8px;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            aspect-ratio: 1 / 1; cursor: pointer;
            position: relative; overflow: hidden;
            transition: transform 0.1s ease-out, opacity 0.2s;
        }
        .gift-card.is-hidden {
            opacity: 0.5;
            filter: grayscale(80%);
        }
        .gift-card.is-pending .image-container::after {
            content: '';
            position: absolute; top: 50%; left: 50%;
            width: 24px; height: 24px;
            margin-left: -12px; margin-top: -12px;
            border: 3px solid rgba(255,255,255,0.3);
            border-top-color: var(--tg-theme-text-color);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        .buy-gift-item { aspect-ratio: 1/1.1; }
        .gift-card.is-updating { transform: scale(0.95); opacity: 0.7; }
        .sortable-chosen, .sortable-ghost {
            cursor: grabbing !important;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            transform: scale(1.05);
            opacity: 0.7;
        }
        .gift-card-bg-pattern, .buy-gift-item-bg-pattern {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background-size: cover; pointer-events: none; z-index: 0;
        }
        .gift-card-pattern-overlay, .buy-gift-item-pattern-overlay {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background-repeat: repeat;
            background-size: 30% auto;
            background-position: center;
            opacity: 0.1;
            pointer-events: none; z-index: 1;
        }
        .image-container {
            width: 70%; height: 70%;
            display: flex; align-items: center; justify-content: center;
            position: relative; z-index: 2;
        }
        .buy-gift-item .image-container {
            width: 65%; max-height: 60px;
            margin-bottom: 8px; height: auto;
        }

        .static-image-fallback {
            max-width: 100%; max-height: 100%;
            object-fit: contain;
        }
        .lottie-animation-container {
            width: 100%; height: 100%;
            display: flex; align-items: center; justify-content: center;
        }

        /* Rotated Label - CORRECTED */
        .gift-card .top-right-label {
            position: absolute;
            top: 10px; /* Adjusted for visual balance */
            right: -28px; /* Adjusted for visual balance */
            transform: rotate(45deg);
            transform-origin: center;
            background-color: rgba(0,0,0,0.35);
            color: var(--tg-theme-text-color);
            font-size: 0.65em;
            padding: 1px 25px;
            z-index: 4;
            font-weight: 500;
            white-space: nowrap;
        }

        .gift-card .pin-indicator {
            position: absolute; top: 5px; left: 5px;
            z-index: 3; display: flex; align-items: center; justify-content: center;
        }
        .gift-card .pin-indicator svg { width: 18px; height: 18px; fill: var(--tg-theme-link-color); opacity: 0.8; }

        /* Selection Mode Checkbox */
        .gift-card .selection-checkbox {
            position: absolute; top: 5px; right: 5px; /* Moved to right for consistency */
            width: 22px; height: 22px;
            background-color: rgba(0, 0, 0, 0.4);
            border: 2px solid #fff;
            border-radius: 50%;
            z-index: 5; /* Higher than label */
            display: flex; align-items: center; justify-content: center;
            transition: background-color 0.2s;
        }
        .gift-card.selected .selection-checkbox {
            background-color: var(--tg-theme-button-color);
        }
        .gift-card.selected .selection-checkbox::after {
            content: '✓';
            color: var(--tg-theme-button-text-color);
            font-size: 14px;
            font-weight: bold;
        }

        .buy-gift-item .gift-name {
            font-size: 0.8em; text-align: center;
            color: var(--tg-theme-text-color); margin-bottom: 6px;
            min-height: 2.4em; overflow: hidden; text-overflow: ellipsis;
            display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;
            z-index: 2;
        }
        .buy-gift-item .gift-price {
            font-size: 0.9em;
            color: var(--tg-theme-hint-color);
            z-index: 2;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            padding: 2px 8px;
            border-radius: 12px;
        }
        .buy-gift-item .gift-price.has-price::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background-image: url('https://raw.githubusercontent.com/Vasiliy-katsyka/upgrade/refs/heads/main/DMJTGStarsEmoji_AgADUhMAAk9WoVI.png');
            background-size: 16px 16px;
            background-repeat: repeat;
            opacity: 0.08;
            border-radius: 12px;
            z-index: -1;
        }

        .buy-gift-item .gift-price .star-icon {
            width: 14px;
            height: 14px;
            margin-right: 4px;
            vertical-align: middle;
        }
        .buy-gift-item .limited-label {
            position: absolute; top: 6px; right: 6px;
            background-color: var(--tg-theme-accent-blue);
            color: var(--tg-theme-button-text-color);
            font-size: 0.6em; padding: 2px 6px;
            border-radius: 8px; font-weight: 500; z-index: 3;
        }

        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background-color: var(--app-modal-backdrop-color);
            display: flex; align-items: flex-end;
            justify-content: center; z-index: 1000;
            opacity: 0; visibility: hidden;
            transition: opacity 0.25s ease, transform 0.25s ease;
            transform: translateY(100%);
        }
        .modal-overlay.active { opacity: 1; visibility: visible; transform: translateY(0%); }
        .modal-content {
            background-color: var(--tg-theme-secondary-bg-color);
            padding-top: 0;
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
            width: 100%; max-width: 600px;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.2);
            display: flex; flex-direction: column;
            max-height: 90vh;
        }
        .modal-header-bar {
            padding: 15px 20px; text-align: center;
            position: sticky; top: 0; background-color: var(--tg-theme-secondary-bg-color); z-index: 1;
        }
        .modal-header-bar h3 { font-size: 1.1em; font-weight: 500; }

        .modal-scrollable-content { overflow-y: auto; padding: 15px 20px; flex-grow: 1; }
        .modal-buttons-footer {
            padding: 15px 20px;
            background-color: var(--tg-theme-secondary-bg-color);
            position: sticky; bottom: 0; z-index: 1;
            border-top: 1px solid var(--tg-theme-bg-color);
            display: flex;
            gap: 10px;
        }
        .modal-button {
            background-color: var(--tg-theme-button-color);
            color: var(--tg-theme-button-text-color);
            border: none; padding: 13px; border-radius: 8px;
            font-size: 1em; cursor: pointer; text-align: center;
            font-weight: 500; width: 100%;
            text-decoration: none;
            display: inline-block;
            flex-grow: 1;
        }
        .modal-button.secondary {
            background-color: var(--app-action-button-bg);
            color: var(--tg-theme-link-color);
        }
        .modal-buttons-footer .modal-button.secondary {
             margin-top: 0; /* Override default */
        }
        .modal-button:disabled {
            background-color: var(--tg-theme-hint-color);
            color: var(--tg-theme-secondary-bg-color);
            cursor: not-allowed;
        }


        #gift-detail-modal .modal-gift-image-container {
            width: 120px; height: 120px;
            margin: 10px auto 15px auto; display: flex;
            align-items: center; justify-content: center;
        }
        #gift-detail-modal .modal-gift-image-static {
             max-width: 100%; max-height: 100%; object-fit: contain;
        }
        #gift-detail-modal .lottie-animation-container {
             width: 100%; height: 100%;
        }
        #gift-detail-modal .modal-gift-description {
            font-size: 0.9em; color: var(--tg-theme-hint-color);
            margin-bottom: 8px; text-align: center; line-height: 1.5;
        }
        #gift-detail-modal .modal-info-table .info-row {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px 0; font-size: 0.95em;
        }
        #gift-detail-modal .modal-info-table .info-row:not(:last-child) { margin-bottom: 2px; }
        #gift-detail-modal .modal-info-table .info-label { color: var(--tg-theme-text-color); }
        #gift-detail-modal .modal-info-table .info-value { color: var(--tg-theme-hint-color); }

        /* === COLLECTIBLE MODAL REDESIGN === */
        #collectible-detail-modal .modal-content { padding-top: 0; overflow: hidden; }
        #collectible-detail-modal .modal-scrollable-content { padding: 0; }
        #collectible-detail-modal #collectible-menu-button {
            position: absolute; top: 10px; right: 10px; z-index: 3;
            background: rgba(0,0,0,0.2); border-radius: 50%; padding: 0;
            width: 36px; height: 36px;
        }
        #collectible-detail-modal #collectible-menu-button svg { fill: white; }

        .collectible-display-area {
            padding: 40px 0 20px 0; /* Adjusted padding */
            text-align: center;
            position: relative;
            overflow: hidden;
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
        }
        #pattern-container-dynamic {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            z-index: 1;
            pointer-events: none;
        }
        .dynamic-pattern-instance {
            position: absolute;
            opacity: 0.1;
            width: 40px;
            height: auto;
            will-change: transform;
        }

        .modal-collectible-visual {
            width: 45%;
            max-width: 160px;
            aspect-ratio: 1/1;
            margin: 0 auto;
            position: relative;
            z-index: 2;
            display: flex;
            align-items: center;
            justify-content: center;
            -webkit-user-select: none; user-select: none;
        }
        .modal-collectible-visual .static-image-fallback {
             max-width: 100%;
             max-height: 100%;
             object-fit: contain;
        }
        .modal-collectible-visual .lottie-animation-container {
            width: 80%; height: 80%; object-fit: contain; z-index: 4; position: relative;
        }

        .collectible-display-area h3 {
            font-size: 1.6em; font-weight: 600; margin-top: 20px; margin-bottom: 5px;
            color: var(--tg-theme-text-color); position: relative; z-index: 2;
        }
        .collectible-display-area p {
            font-size: 1em; color: var(--tg-theme-hint-color); margin: 0;
            position: relative; z-index: 2;
        }
        .collectible-display-area p a {
            color: var(--tg-theme-link-color); text-decoration: none; cursor: pointer;
        }
        .collectible-display-area p a:hover { text-decoration: underline; }

        .modal-action-buttons-row {
            display: flex; justify-content: space-around; gap: 10px;
            padding: 20px; /* Moved padding here from display-area */
            background-color: transparent; /* No longer has its own background */
            position: relative; z-index: 2; /* Ensure buttons are on top */
        }
        .modal-action-buttons-row button {
            flex-grow: 1; padding: 10px 5px; font-size: 0.9em;
            background-color: rgba(0,0,0,0.25); /* Dark, transparent background */
            color: var(--tg-theme-text-color);
            border: none; border-radius: 8px;
            display: flex; flex-direction: column; align-items: center;
            font-weight: 500;
        }
        .modal-action-buttons-row button .icon { margin-bottom: 5px; display: flex; align-items: center; justify-content: center; }
        .modal-action-buttons-row button .icon svg { width: 22px; height: 22px; fill: var(--tg-theme-link-color); }
        .modal-action-buttons-row button .text { font-size: 0.9em; }
        /* === END COLLECTIBLE MODAL REDESIGN === */

        .collectible-info-section { padding: 0 20px; background-color: var(--tg-theme-secondary-bg-color); }
        .collectible-info-section .info-row {
            display: flex; align-items: center; justify-content: space-between;
            padding: 12px 0; font-size: 0.95em;
        }
        .collectible-info-section .info-row:not(:last-child) { border-bottom: 1px solid var(--tg-theme-bg-color); }
        .collectible-info-section .info-label { color: var(--tg-theme-text-color); }
        .collectible-info-section .info-value { color: var(--tg-theme-hint-color); display: flex; align-items: center; flex-wrap: wrap; justify-content: flex-end; }
        .collectible-info-section .info-value a {
            color: var(--tg-theme-link-color);
            text-decoration: none;
        }
        .collectible-info-section .info-value.clickable-info { cursor: pointer; }
        .collectible-info-section .info-value.clickable-info:active { opacity: 0.7; }
        .collectible-info-section .info-value img.owner-avatar { width: 24px; height: 24px; border-radius: 50%; margin-right: 8px; }
        .collectible-info-section .info-value .rarity-chip {
            background-color: var(--app-rarity-chip-bg);
            color: var(--app-rarity-chip-text);
            padding: 2px 7px; border-radius: 8px;
            font-size: 0.8em; margin-left: 8px; font-weight: 500;
        }
        .rarity-chip .one-in-x {
            font-size: 0.9em;
            opacity: 0.7;
            margin-left: 5px;
        }

        .modal-footer-message {
            text-align: center; font-size: 0.85em;
            color: var(--tg-theme-hint-color); padding: 15px 20px;
            background-color: var(--tg-theme-bg-color);
        }
        .modal-footer-message .link { color: var(--tg-theme-link-color); cursor: pointer; }

        #long-press-menu {
            position: fixed;
            background-color: var(--tg-theme-secondary-bg-color);
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            z-index: 2001; /* Higher than sidebar overlay */
            padding: 6px 0; min-width: 220px;
        }
        #long-press-menu ul { list-style: none; }
        #long-press-menu li { padding: 10px 20px; cursor: pointer; color: var(--tg-theme-text-color); font-size: 0.95em; }
        #long-press-menu li.disabled { color: var(--tg-theme-hint-color); cursor: default; }
        #long-press-menu li.danger { color: var(--app-clear-data-color); }
        #long-press-menu li:not(.disabled):hover { background-color: rgba(255,255,255,0.05); }

        #buy-multiple-quantity {
            width: 80px; padding: 10px; text-align: center; margin-bottom:15px;
            background-color: var(--tg-theme-bg-color);
            color: var(--tg-theme-text-color);
            border: 1px solid var(--tg-theme-hint-color);
            border-radius: 8px; font-size: 1em;
        }
        #buy-multiple-quantity::-webkit-outer-spin-button,
        #buy-multiple-quantity::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        #buy-multiple-quantity[type=number] { -moz-appearance: textfield; }

        .filter-section { margin-bottom: 15px; }
        .filter-section h4 {
            font-size: 0.9em; font-weight: 500; color: var(--tg-theme-hint-color);
            margin-bottom: 8px; padding-left: 5px;
        }
        .filter-options-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            gap: 8px; max-height: 150px; overflow-y: auto;
            padding: 5px; background-color: rgba(0,0,0,0.1); border-radius: 8px;
        }
        .filter-option {
            aspect-ratio: 1/1; border-radius: 6px;
            background-color: var(--tg-theme-bg-color);
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; border: 2px solid transparent;
            overflow: hidden;
            transition: border-color 0.2s;
        }
        .filter-option.selected { border-color: var(--tg-theme-link-color); }
        .filter-option img { max-width: 80%; max-height: 80%; object-fit: contain; }
        .filter-option .gradient-square { width: 100%; height: 100%; }

        #filter-popup .clear-data-button {
            background-color: transparent;
            color: var(--app-clear-data-color);
            border: none; padding: 13px; border-radius: 8px;
            font-size: 1em; cursor: pointer; text-align: center;
            font-weight: 500; width: 100%;
            display: flex; align-items: center; justify-content: center;
            margin-top: 15px;
        }
        #filter-popup .clear-data-button svg { width: 20px; height: 20px; fill: currentColor; margin-right: 8px; }

        .settings-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 5px;
            font-size: 1em;
        }
        .switch { position: relative; display: inline-block; width: 50px; height: 28px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--app-action-button-bg); transition: .4s; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: .4s; }
        input:checked + .slider { background-color: var(--tg-theme-link-color); }
        input:focus + .slider { box-shadow: 0 0 1px var(--tg-theme-link-color); }
        input:checked + .slider:before { transform: translateX(22px); }
        .slider.round { border-radius: 28px; }
        .slider.round:before { border-radius: 50%; }

        /* --- Custom Buy Modal & Multi-Gift --- */
        #custom-buy-modal .filter-section, #chances-modal .filter-section { margin-bottom: 20px; }
        #custom-buy-modal .filter-options-grid, #chances-modal .filter-options-grid {
            max-height: 200px; overflow-y: auto; padding: 5px;
            background-color: rgba(0,0,0,0.1); border-radius: 8px;
            grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
        }
        #custom-buy-modal .filter-option, #chances-modal .filter-option {
            background-color: var(--tg-theme-bg-color); border: 2px solid transparent;
            border-radius: 8px; padding: 5px; flex-direction: column;
            justify-content: flex-start; height: auto; aspect-ratio: auto;
            min-height: 80px;
        }
        #custom-buy-modal .filter-option.selected, #chances-modal .filter-option.selected { border-color: var(--tg-theme-link-color); }
        #custom-buy-modal .filter-option img, #custom-buy-modal .filter-option .gradient-square,
        #chances-modal .filter-option img, #chances-modal .filter-option .gradient-square {
            width: 100%; height: 60px; object-fit: contain;
            border-radius: 4px; margin-bottom: 5px;
            pointer-events: none; /* For long press */
        }
        #custom-buy-modal .filter-option .label, #chances-modal .filter-option .label {
            font-size: 0.75em; color: var(--tg-theme-text-color); text-align: center;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis; width: 100%;
        }
        #gift-queue-container {
            display: flex; flex-wrap: wrap; gap: 8px; padding: 10px 0;
            border-bottom: 1px solid var(--app-action-button-bg); margin-bottom: 15px;
        }
        .gift-queue-item {
            background-color: var(--app-action-button-bg); color: var(--tg-theme-text-color);
            padding: 8px 12px; border-radius: 16px; font-size: 0.9em; cursor: pointer;
            border: 2px solid transparent; display: flex; align-items: center; gap: 6px;
        }
        .gift-queue-item.active { border-color: var(--tg-theme-link-color); }
        .gift-queue-item .remove-queue-item {
            background-color: var(--tg-theme-hint-color); color: var(--tg-theme-bg-color);
            border: none; border-radius: 50%; width: 16px; height: 16px;
            display: flex; align-items: center; justify-content: center;
            font-size: 10px; font-weight: bold;
        }
        .advanced-settings-toggle {
            display: block; width: 100%; text-align: center; background: none;
            border: none; color: var(--tg-theme-link-color); font-size: 0.95em;
            padding: 8px; cursor: pointer; margin-top: 10px;
        }
        #advanced-settings-container {
            margin-top: 15px; padding-top: 15px;
            border-top: 1px solid var(--app-action-button-bg);
        }
        #advanced-settings-container input[type="number"],
        #advanced-settings-container input[type="text"] {
             width: 100%; padding: 12px; border-radius: 8px;
             border: 1px solid var(--tg-theme-bg-color); background-color: var(--tg-theme-bg-color);
             color: var(--tg-theme-text-color); font-size: 1em; margin-top: 8px;
        }
        #advanced-settings-container label {
            display: block; text-align: left; font-size: 0.9em;
            color: var(--tg-theme-hint-color); margin-bottom: 4px;
        }
        #custom-pattern-upload-label {
            display: block;
            background-color: var(--app-action-button-bg);
            color: var(--tg-theme-link-color);
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            margin-top: 10px;
        }
        #custom-pattern-preview {
            max-width: 60px; max-height: 60px;
            margin: 10px auto 0 auto;
            border-radius: 6px;
        }


        #chances-probability-display {
            background-color: var(--tg-theme-bg-color);
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            text-align: center;
        }
        #chances-probability-display .prob-value {
            font-size: 1.5em; font-weight: 600; color: var(--tg-theme-link-color);
            display: block; margin-bottom: 5px;
        }
        #chances-probability-display .prob-details {
            font-size: 0.9em; color: var(--tg-theme-hint-color);
        }

        /* Sell Gift & Transfer Gift Modal Styles */
        #sell-gift-modal .modal-gift-preview,
        #transfer-gift-modal .modal-gift-preview {
            display: flex; flex-direction: column; align-items: center; margin-bottom: 20px;
        }
        #sell-gift-modal .modal-gift-preview img,
        #transfer-gift-modal .modal-gift-preview img {
            width: 80px; height: 80px; object-fit: contain; margin-bottom: 10px;
        }
        #sell-gift-modal .modal-gift-preview h4,
        #transfer-gift-modal .modal-gift-preview h4 {
            font-size: 1.1em; font-weight: 500;
        }

        .price-input-container {
            position: relative;
            background-color: var(--tg-theme-bg-color);
            border-radius: 8px;
            padding: 12px;
            border: 1px solid var(--tg-theme-hint-color);
        }
        .price-input-container label {
            display: block; font-size: 0.8em; color: var(--tg-theme-link-color);
            margin-bottom: 5px;
        }
        .price-input-wrapper {
            display: flex; align-items: center;
        }
        .price-input-wrapper img {
            width: 24px; height: 24px; margin-right: 10px;
        }
        .price-input-wrapper input {
            background: none; border: none; color: var(--tg-theme-text-color);
            font-size: 1.2em; width: 100%; outline: none;
        }
        .price-input-wrapper input::-webkit-outer-spin-button,
        .price-input-wrapper input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .price-input-wrapper input[type=number] { -moz-appearance: textfield; }
        .price-details { text-align: center; font-size: 0.85em; color: var(--tg-theme-hint-color); margin-top: 10px; }

        #transfer-comment-input {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid var(--tg-theme-bg-color);
            background-color: var(--tg-theme-bg-color);
            color: var(--tg-theme-text-color);
            font-size: 1em;
            margin-top: 15px;
            resize: vertical;
        }


        .spinner {
            border: 4px solid var(--tg-theme-hint-color);
            border-top: 4px solid var(--tg-theme-link-color);
            border-radius: 50%; width: 30px; height: 30px;
            animation: spin 1s linear infinite; margin: 20px auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .hidden { display: none !important; }
        .placeholder-image {
            background-color: var(--tg-theme-hint-color); width: 100%; height: 100%;
            display: flex; align-items: center; justify-content: center;
            color: var(--tg-theme-bg-color); font-size: 0.8em; border-radius: 8px;
        }

        /* Collectible Numbers/Usernames Modal */
        #numbers-modal .collectible-list, #usernames-modal .collectible-list {
            list-style: none;
            padding: 0;
            margin: 0;
            max-height: 50vh;
            overflow-y: auto;
        }
        #numbers-modal .collectible-list-item, #usernames-modal .collectible-list-item {
            padding: 15px 20px;
            font-size: 1.1em;
            font-weight: 500;
            border-bottom: 1px solid var(--tg-theme-bg-color);
            cursor: pointer;
            color: var(--tg-theme-link-color);
            font-family: monospace;
        }
        #usernames-modal .collectible-list-item {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            color: var(--tg-theme-text-color);
        }
        #usernames-modal .collectible-list-item .at-symbol {
            color: var(--tg-theme-hint-color);
            margin-right: 2px;
        }
        #numbers-modal .collectible-list-item:hover, #usernames-modal .collectible-list-item:hover {
            background-color: rgba(255,255,255,0.05);
        }
        #usernames-modal .search-bar-container {
            padding: 10px 20px;
            background-color: var(--tg-theme-secondary-bg-color);
        }
        #usernames-modal #username-search-input {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid var(--tg-theme-bg-color);
            background-color: var(--tg-theme-bg-color);
            color: var(--tg-theme-text-color);
            font-size: 1em;
        }

        /* Settings Modal */
        #settings-modal .settings-row {
            display: flex; align-items: center; justify-content: space-between;
            padding: 12px 0; font-size: 1em;
            border-bottom: 1px solid var(--tg-theme-bg-color);
        }
        #settings-modal .settings-row:last-of-type { border-bottom: none; }
        #settings-modal .settings-row button {
            background: none; border: none; color: var(--tg-theme-link-color);
            font-size: 1em; cursor: pointer; text-align: left;
            padding: 0; width: auto; font-weight: 400;
        }
        #settings-modal .settings-row.danger button {
            color: var(--app-clear-data-color);
        }
        #settings-modal .settings-row button.full-width { width: 100%; text-align: center; }

        /* --- GIVEAWAY MODAL --- */
        #giveaway-setup-modal .selection-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 8px;
            max-height: 25vh;
            overflow-y: auto;
            padding: 10px;
            background-color: var(--tg-theme-bg-color);
            border-radius: 8px;
            margin-bottom: 20px;
        }
        #giveaway-setup-modal .selection-grid .gift-card {
             border: 2px solid transparent;
        }
        #giveaway-setup-modal .selection-grid .gift-card.selected {
            border-color: var(--tg-theme-link-color);
        }
        #giveaway-setup-modal .giveaway-section {
            margin-bottom: 15px;
        }
        #giveaway-setup-modal .giveaway-section h4 {
             font-size: 1em; font-weight: 500; margin-bottom: 10px;
        }
        #giveaway-setup-modal .giveaway-section label {
            display: block;
            padding: 12px;
            background-color: var(--tg-theme-bg-color);
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
        }
        #giveaway-setup-modal .giveaway-section input[type="radio"] {
            margin-right: 10px;
        }
        #giveaway-setup-modal .giveaway-section textarea {
             width: 100%;
             padding: 10px;
             background-color: var(--tg-theme-bg-color);
             border: 1px solid var(--tg-theme-hint-color);
             border-radius: 8px;
             color: var(--tg-theme-text-color);
             font-size: 0.95em;
             resize: vertical;
             min-height: 60px;
        }
        #giveaway-setup-modal .info-text {
            font-size: 0.85em; color: var(--tg-theme-hint-color); margin-top: 5px;
        }
        
        /* New Post Modal Styles */
        #new-post-modal #new-post-content {
            width: 100%;
            height: 150px;
            padding: 10px;
            background-color: var(--tg-theme-bg-color);
            color: var(--tg-theme-text-color);
            border: 1px solid var(--tg-theme-hint-color);
            border-radius: 8px;
            font-size: 1em;
            resize: vertical;
            margin-bottom: 15px;
        }
        #new-post-modal #formatting-help {
            font-size: 0.9em;
            color: var(--tg-theme-hint-color);
            background-color: var(--tg-theme-bg-color);
            padding: 10px;
            border-radius: 8px;
        }
        #new-post-modal #formatting-help-toggle {
            color: var(--tg-theme-link-color);
            cursor: pointer;
            display: block;
            margin-bottom: 10px;
        }
        #new-post-modal #formatting-help-content {
             line-height: 1.6;
        }
        #new-post-modal #formatting-help-content code {
            background: rgba(255,255,255,0.1);
            padding: 2px 4px;
            border-radius: 4px;
        }
        
        /* Subscription Modal */
        #subscription-modal .settings-row { border-bottom: none; }

        /* Image Preview Modal */
        #image-preview-modal .modal-content {
            background: transparent;
            box-shadow: none;
            max-height: 95vh;
            justify-content: center;
            align-items: center;
        }
        #image-preview-modal img {
            max-width: 95vw;
            max-height: 85vh;
            border-radius: 12px;
        }
    </style>
</head>
<body>
    <div id="loading-screen">
        <h1>Gift Upgrade Bot</h1>
        <p>@giftUpgradeRU</p>
        <div class="spinner"></div>
    </div>

    <div class="account-sidebar" id="account-sidebar">
        <div class="sidebar-header">
            <div class="user-info">
                <img id="sidebar-current-avatar" src="" alt="Avatar">
                <span id="sidebar-current-name" class="name"></span>
            </div>
            <div id="sidebar-search-container">
                <input type="search" id="sidebar-search-input" placeholder="Search @user or Gift-123...">
                <div id="sidebar-search-results" class="hidden"></div>
            </div>
        </div>
        <ul class="accounts-list" id="accounts-list"></ul>
        <div class="sidebar-footer">
            <button id="add-account-button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M15,14C12.33,14 7,15.33 7,18V20H23V18C23,15.33 17.67,14 15,14M15,12A4,4 0 0,0 19,8A4,4 0 0,0 15,4A4,4 0 0,0 11,8A4,4 0 0,0 15,12M5,13.28L1,10.72L2.41,9.31L5,11.9L9.6,7.3L11,8.72L5,14.72Z" /></svg>Add Account</button>
            <button id="admin-login-button" class="hidden"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12,1L9,4H15L12,1M19,10.5V12H17V10.5C17,9.67 16.33,9 15.5,9C14.67,9 14,9.67 14,10.5V12H10V10.5C10,9.67 9.33,9 8.5,9C7.67,9 7,9.67 7,10.5V12H5V10.5C5,8.57 6.57,7 8.5,7C10.43,7 12,8.57 12,10.5C12,8.57 13.57,7 15.5,7C17.43,7 19,8.57 19,10.5M5,21V14H19V21H5Z" /></svg>Login As User</button>
            <button id="open-filters-button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M14,12V19.88C14.04,20.18 13.94,20.5 13.71,20.71C13.32,21.1 12.69,21.1 12.3,20.71L10.29,18.7C10.06,18.47 9.96,18.16 10,17.87V12H9.97L4.21,4.62C3.87,4.19 3.95,3.56 4.38,3.22C4.57,3.08 4.78,3 5,3H19C19.22,3 19.43,3.08 19.62,3.22C20.05,3.56 20.13,4.19 19.79,4.62L14.03,12H14Z" /></svg>Filters</button>
            <button id="open-numbers-button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M6.62,10.79C8.06,13.62 10.38,15.94 13.21,17.38L15.41,15.18C15.69,14.9 16.08,14.82 16.43,14.93C17.55,15.3 18.75,15.5 20,15.5A1,1 0 0,1 21,16.5V20A1,1 0 0,1 20,21A17,17 0 0,1 3,4A1,1 0 0,1 4,3H7.5A1,1 0 0,1 8.5,4C8.5,5.25 8.7,6.45 9.07,7.57C9.18,7.92 9.1,8.31 8.82,8.59L6.62,10.79Z" /></svg>Numbers</button>
            <button id="open-usernames-button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12,12C14.21,12 16,10.21 16,8C16,5.79 14.21,4 12,4C9.79,4 8,5.79 8,8C8,10.21 9.79,12 12,12M12,14C9.33,14 4,15.33 4,18V20H20V18C20,15.33 14.67,14 12,14Z" /></svg>@ Usernames</button>
            <button id="create-giveaway-button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M22,13H20V15H18V13H16V11H18V9H20V11H22M18,3L15,6H11L13,2H9.5C9.09,2 8.75,2.3 8.6,2.65L2,13L8,18H14L21,9V4M12.5,15.5C11.67,15.5 11,14.83 11,14C11,13.17 11.67,12.5 12.5,12.5C13.33,12.5 14,13.17 14,14C14,14.83 13.33,15.5 12.5,15.5Z" /></svg>🏆 Create Giveaway</button>
        </div>
    </div>
    <div class="sidebar-overlay" id="sidebar-overlay"></div>

    <div class="app-container">
        <div id="profile-page" class="page active">
             <input type="file" id="avatar-upload-input" class="hidden" accept="image/*">
             <div class="page-header"></div>
            <div class="profile-page-content">
                <div id="profile-top-section" class="profile-top-section">
                    <div id="profile-header-pattern-overlay" class="profile-header-pattern-overlay"></div>
                    <div class="profile-header-content-wrapper">
                        <div id="profile-top-pinned-gifts" class="profile-top-pinned-gifts"></div>
                        <div id="profile-main-info-block" class="profile-main-info">
                            <img id="profile-avatar" class="profile-avatar" src="" alt="Avatar">
                            <div class="profile-name-status">
                                <div class="name-line">
                                    <h1 id="profile-name">Name</h1>
                                    <div id="worn-gift-icon-container" class="hidden lottie-animation-container"></div>
                                </div>
                                <p id="profile-gift-count-subtext">0 gifts</p>
                                <p id="profile-status" class="online">online</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="profile-details-section">
                    <div id="profile-details" class="profile-details">
                         <div class="info-block">
                            <div class="info-label">Phone</div>
                            <div class="info-value" id="profile-phone"></div>
                        </div>
                         <div class="info-block">
                            <div class="info-label">Bio</div>
                            <div class="info-value" id="profile-bio"></div>
                        </div>
                         <div class="info-block">
                            <div class="info-label">Username</div>
                            <div class="info-value collectible-value" id="profile-username"></div>
                            <div class="info-value" id="collectible-usernames-container"></div>
                        </div>
                    </div>
                </div>
                <div class="profile-tabs-content">
                    <div class="profile-tabs">
                        <button id="posts-tab-button">Wall</button>
                        <button id="buy-gifts-tab-button">Buy Gifts</button>
                        <button class="active" id="gifts-tab-button">
                            Gifts
                            <span class="gift-preview-container" id="gifts-tab-preview-container"></span>
                        </button>
                        <button id="wall-subscription-button" class="hidden"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21,19V20H3V19L5,17V11C5,7.9 7.03,5.17 10,4.29C10,4.19 10,4.1 10,4A2,2 0 0,1 12,2A2,2 0 0,1 14,4C14,4.1 14,4.19 14,4.29C16.97,5.17 19,7.9 19,11V17L21,19M14,21A2,2 0 0,1 12,23A2,2 0 0,1 10,21" /></svg></button>
                    </div>
                    <div id="posts-content" class="tab-content">
                        <p class="empty-grid-message">Nothing to see here yet.</p>
                    </div>
                    <div id="gifts-content" class="tab-content active">
                        <div id="profile-gifts-actions-wrapper" class="profile-gifts-actions-wrapper hidden">
                            <div class="profile-gifts-actions">
                                <!-- Dynamic buttons will be prepended here by JS -->
                                <button id="upgrade-all-gifts-button" class="action-button hidden">✨ Upgrade All</button>
                            </div>
                        </div>
                        <div id="gifts-grid" class="gifts-grid">
                            <div class="spinner hidden" id="gifts-loading-spinner"></div>
                        </div>
                    </div>
                </div>
            </div>
            <button id="new-post-fab" class="new-post-fab hidden">+</button>
        </div>

        <div id="buy-gifts-page" class="page">
            <div class="page-header">
                 <h2>Gift Shop</h2>
                 <div class="buy-gifts-header-actions">
                    <button id="customize-gift-button" class="action-button">Customize</button>
                 </div>
            </div>
            <div id="buy-gifts-grid" class="gifts-grid">
                <div class="spinner" id="buy-gifts-loading-spinner"></div>
            </div>
        </div>

        <!-- Modals below -->
        <div id="gift-detail-modal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header-bar">
                    <h3 id="modal-gift-name">Gift Name</h3>
                </div>
                <div class="modal-scrollable-content">
                    <div id="modal-gift-image-container" class="modal-gift-image-container">
                        <div id="modal-lottie-gift-original" class="lottie-animation-container"></div>
                        <img id="modal-gift-image-static" class="static-image-fallback" src="" alt="Gift" style="display:none;">
                    </div>
                    <p id="modal-gift-description1" class="modal-gift-description"></p>
                    <p id="modal-gift-description2" class="modal-gift-description"></p>
                    <div id="modal-gift-info" class="modal-info-table"></div>
                </div>
                <div class="modal-buttons-footer">
                    <button id="upgrade-gift-detail-modal-button" class="modal-button">✨ Upgrade</button>
                    <button id="close-gift-detail-modal-button" class="modal-button secondary">Close</button>
                </div>
            </div>
        </div>

        <div id="collectible-detail-modal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-scrollable-content">
                    <div class="collectible-display-area">
                        <button class="menu-button" id="collectible-menu-button">⋮</button>
                        <div id="pattern-container-dynamic"></div>
                        <div id="modal-collectible-visual" class="modal-collectible-visual">
                            <div id="modal-lottie-collectible-model" class="lottie-animation-container"></div>
                            <img id="modal-collectible-model-img-static" class="static-image-fallback" src="" alt="Model" style="display:none;">
                        </div>
                        <h3 id="modal-collectible-main-name">Model Name</h3>
                        <p id="modal-collectible-number-subtext">Collectible #123</p>
                        <div id="modal-collectible-actions" class="modal-action-buttons-row">
                            <button id="collectible-action-wear"><span class="icon"></span><span class="text">Wear</span></button>
                            <button id="collectible-action-sell"><span class="icon"></span><span class="text">Sell</span></button>
                            <button id="collectible-action-transfer"><span class="icon"></span><span class="text">Transfer</span></button>
                        </div>
                    </div>
                    <div class="collectible-info-section">
                        <div id="modal-collectible-info-table" class="modal-info-table"></div>
                    </div>
                    <div class="modal-footer-message">
                        This gift is visible in your profile. <span id="hide-link-in-modal" class="link">Hide ></span>
                    </div>
                </div>
                 <div class="modal-buttons-footer">
                    <button id="close-collectible-detail-modal" class="modal-button">OK</button>
                </div>
            </div>
        </div>

        <div id="too-many-pins-modal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header-bar"><h3>Too Many Pinned Gifts</h3></div>
                <div class="modal-scrollable-content" style="text-align: center;">
                    <p style="margin-bottom:15px; color: var(--tg-theme-hint-color);">Select a gift to unpin. You can pin up to 6 collectible gifts.</p>
                    <div id="unpin-selection-grid" class="gifts-grid" style="grid-template-columns: repeat(3, 1fr); max-height: 200px; overflow-y: auto; padding:0 10px;">
                    </div>
                </div>
                 <div class="modal-buttons-footer">
                    <button id="cancel-unpin-modal" class="modal-button secondary">Cancel</button>
                </div>
            </div>
        </div>

        <div id="buy-multiple-modal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header-bar"><h3 id="buy-multiple-modal-title">Buy Gift</h3></div>
                <div class="modal-scrollable-content" style="text-align: center;">
                    <p id="buy-multiple-gift-name" style="margin-bottom: 15px;"></p>
                    <label for="buy-multiple-quantity" style="display: block; margin-bottom: 8px; color: var(--tg-theme-hint-color);">Quantity:</label>
                    <input type="number" id="buy-multiple-quantity" min="1" value="1">
                </div>
                <div class="modal-buttons-footer">
                    <button id="confirm-buy-multiple" class="modal-button">Buy</button>
                    <button id="cancel-buy-multiple" class="modal-button secondary">Cancel</button>
                </div>
            </div>
        </div>

        <div id="filter-popup" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header-bar">
                    <h3>Gift Filters</h3>
                </div>
                <div class="modal-scrollable-content">
                    <div class="filter-section" id="filter-collections-section">
                        <h4>Collections</h4>
                        <div class="filter-options-grid" id="filter-options-collections"></div>
                    </div>
                    <div class="filter-section hidden" id="filter-models-section">
                        <h4>Models</h4>
                        <div class="filter-options-grid" id="filter-options-models"></div>
                    </div>
                    <div class="filter-section" id="filter-backdrops-section">
                        <h4>Backdrops</h4>
                        <div class="filter-options-grid" id="filter-options-backdrops"></div>
                    </div>
                    <div class="filter-section" id="filter-patterns-section">
                        <h4>Symbols</h4>
                        <div class="filter-options-grid" id="filter-options-patterns"></div>
                    </div>
                </div>
                <div class="modal-buttons-footer">
                    <button id="apply-filters-button" class="modal-button">Apply Filters</button>
                    <button id="clear-filters-button" class="modal-button secondary">Reset Filters</button>
                </div>
            </div>
        </div>

        <div id="settings-modal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header-bar">
                    <h3>Settings</h3>
                </div>
                <div class="modal-scrollable-content">
                     <div class="settings-row">
                        <label>Animations</label>
                        <label class="switch">
                            <input type="checkbox" id="animation-toggle" checked>
                            <span class="slider round"></span>
                        </label>
                    </div>
                    <div class="settings-row">
                        <label>Fullscreen</label>
                        <label class="switch">
                            <input type="checkbox" id="fullscreen-toggle">
                            <span class="slider round"></span>
                        </label>
                    </div>
                    <div class="settings-row">
                        <label>Custom Gifts</label>
                        <label class="switch">
                            <input type="checkbox" id="custom-gifts-toggle">
                            <span class="slider round"></span>
                        </label>
                    </div>
                    <div class="settings-row">
                        <label>Show hidden gifts</label>
                        <label class="switch">
                            <input type="checkbox" id="show-hidden-toggle">
                            <span class="slider round"></span>
                        </label>
                    </div>
                    <div class="settings-row">
                        <button id="terms-of-service-button" class="full-width">Terms Of Service</button>
                    </div>
                    <div class="settings-row">
                        <button id="hide-multiple-button" class="full-width">Hide Multiple</button>
                    </div>
                    <div class="settings-row">
                        <button id="transfer-multiple-button" class="full-width">Transfer Multiple</button>
                    </div>
                    <div class="settings-row">
                        <button id="clear-current-account-data-button" class="full-width">Clear Current Account Data</button>
                    </div>
                    <div class="settings-row danger">
                        <button id="clear-all-accounts-data-button" class="full-width">Clear All Accounts Data</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="chances-modal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header-bar">
                    <h3>Chance Calculator</h3>
                </div>
                <div class="modal-scrollable-content">
                    <p id="chances-gift-name" style="text-align: center; font-weight: 500; margin-bottom: 15px;"></p>
                    <div id="chances-probability-display"></div>
                    <div class="spinner hidden" id="chances-loading-spinner"></div>
                    <div class="filter-section hidden" id="chances-models-section">
                        <h4>Select model</h4>
                        <div class="filter-options-grid" id="chances-options-models"></div>
                    </div>
                    <div class="filter-section hidden" id="chances-backdrops-section">
                        <h4>Select backdrop</h4>
                        <div class="filter-options-grid" id="chances-options-backdrops"></div>
                    </div>
                    <div class="filter-section hidden" id="chances-patterns-section">
                        <h4>Select symbol</h4>
                        <div class="filter-options-grid" id="chances-options-patterns"></div>
                    </div>
                </div>
                <div class="modal-buttons-footer">
                    <button id="close-chances-modal" class="modal-button">Close</button>
                </div>
            </div>
        </div>

        <div id="custom-buy-modal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header-bar">
                    <h3>Create or Clone Gift</h3>
                </div>
                <div class="modal-scrollable-content">
                    <div id="gift-queue-container"></div>
                    <div id="gift-config-area">
                        <div class="filter-section">
                            <h4>Select base</h4>
                            <div class="filter-options-grid" id="custom-buy-base-gifts-grid"></div>
                        </div>
                        <div class="filter-section hidden" id="custom-buy-models-section">
                            <h4>Select model</h4>
                            <div class="filter-options-grid" id="custom-buy-models-grid"></div>
                        </div>
                        <div class="filter-section hidden" id="custom-buy-backdrops-section">
                            <h4>Select backdrop</h4>
                            <div class="filter-options-grid" id="custom-buy-backdrops-grid"></div>
                        </div>
                        <div class="filter-section hidden" id="custom-buy-patterns-section">
                            <h4>Select symbol</h4>
                            <div class="filter-options-grid" id="custom-buy-patterns-grid"></div>
                        </div>
                    </div>
                    <button id="add-another-gift-button" class="modal-button secondary" style="margin-top: 0; display: none;">+ Add Another Gift</button>
                    <button class="advanced-settings-toggle" id="advanced-settings-toggle">Advanced Settings</button>
                    <div id="advanced-settings-container" class="hidden">
                        <div>
                            <label for="custom-buy-quantity">Quantity to Create</label>
                            <input type="number" id="custom-buy-quantity" value="1" min="1">
                        </div>
                         <div id="custom-pattern-section" style="margin-top: 15px;">
                            <label for="custom-pattern-upload">Custom Symbol</label>
                            <label for="custom-pattern-upload" id="custom-pattern-upload-label">Upload .PNG Image</label>
                            <input type="file" id="custom-pattern-upload" class="hidden" accept=".png">
                            <img id="custom-pattern-preview" class="hidden" src="" alt="Custom Pattern Preview">
                        </div>
                        <div id="custom-buy-clone-section" style="margin-top: 15px;">
                            <h4>Or Clone from Link</h4>
                            <input type="text" id="clone-url-input" placeholder="t.me/nft/..., Name #Number, etc.">
                            <button id="clone-gift-button" class="modal-button secondary" style="margin-top: 10px;">Clone Gift</button>
                        </div>
                    </div>
                </div>
                <div class="modal-buttons-footer">
                    <button id="custom-buy-confirm-button" class="modal-button" disabled>Create</button>
                    <button id="custom-buy-cancel-button" class="modal-button secondary">Cancel</button>
                </div>
            </div>
        </div>

        <div id="generated-image-modal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header-bar">
                    <h3>Your Gift</h3>
                </div>
                <div class="modal-scrollable-content" style="text-align: center; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px;">
                    <div id="generated-image-container" style="width: 100%; max-width: 300px; aspect-ratio: 3 / 4; border-radius: 12px; overflow: hidden; background-color: var(--tg-theme-bg-color); display: flex; align-items: center; justify-content: center;">
                        <img id="generated-image-preview" src="" alt="Generated Gift" style="max-width: 100%; max-height: 100%; object-fit: contain;">
                    </div>
                    <p id="generated-image-message" style="margin-top: 15px; color: var(--tg-theme-hint-color); font-size: 0.9em;"></p>
                </div>
                <div class="modal-buttons-footer" id="generated-image-footer">
                    <button id="send-generated-image-button" class="modal-button" disabled>Send to Me</button>
                    <button id="close-generated-image-modal" class="modal-button secondary">Close</button>
                </div>
            </div>
        </div>
        
        <div id="image-preview-modal" class="modal-overlay">
            <div class="modal-content">
                <img src="" alt="Image Preview">
            </div>
        </div>

        <div id="sell-gift-modal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header-bar">
                    <h3>Price in Stars</h3>
                </div>
                <div class="modal-scrollable-content">
                    <div class="modal-gift-preview">
                        <img id="sell-gift-image" src="" alt="Gift Preview">
                        <h4 id="sell-gift-name"></h4>
                    </div>
                    <div class="price-input-container">
                        <label>Enter price in Stars (125 - 100,000)</label>
                        <div class="price-input-wrapper">
                            <img src="https://raw.githubusercontent.com/Vasiliy-katsyka/upgrade/refs/heads/main/DMJTGStarsEmoji_AgADUhMAAk9WoVI.png" alt="Star">
                            <input type="number" id="sell-price-input" placeholder="125" min="125" max="100000">
                        </div>
                    </div>
                    <div class="price-details">
                        <p id="sell-receive-amount">You will receive 100 Stars.</p>
                        <p id="sell-usd-amount">≈US$1.30</p>
                    </div>
                </div>
                <div class="modal-buttons-footer">
                    <button id="confirm-sell-button" class="modal-button" disabled>List for Sale</button>
                    <button id="cancel-sell-button" class="modal-button secondary">Cancel</button>
                </div>
            </div>
        </div>

        <div id="transfer-gift-modal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header-bar">
                    <h3 id="transfer-modal-title">Transfer Gift</h3>
                </div>
                <div class="modal-scrollable-content">
                    <div class="modal-gift-preview">
                        <img id="transfer-gift-image" src="" alt="Gift Preview">
                        <h4 id="transfer-gift-name"></h4>
                    </div>
                    <div class="price-input-container">
                        <label>Enter recipient's Telegram username</label>
                        <div class="price-input-wrapper">
                            <span style="font-size:1.2em; margin-right:10px; color:var(--tg-theme-text-color);">@</span>
                            <input type="text" id="transfer-username-input" placeholder="username">
                        </div>
                    </div>
                    <textarea id="transfer-comment-input" rows="2" placeholder="Add a comment... (optional)"></textarea>
                    <div class="price-details" id="transfer-status-message">
                        <p>Gift ownership will be transferred to this username.</p>
                    </div>
                </div>
                <div class="modal-buttons-footer">
                    <button id="confirm-transfer-button" class="modal-button" disabled>Confirm Transfer</button>
                    <button id="cancel-transfer-button" class="modal-button secondary">Cancel</button>
                </div>
            </div>
        </div>

        <div id="numbers-modal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header-bar"><h3>Anonymous Numbers +888</h3></div>
                <div class="modal-scrollable-content" style="padding: 0;">
                    <ul class="collectible-list" id="numbers-list">
                    </ul>
                </div>
                <div class="modal-buttons-footer">
                    <button id="close-numbers-modal" class="modal-button">Close</button>
                </div>
            </div>
        </div>

        <div id="usernames-modal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header-bar"><h3>Collectible Usernames</h3></div>
                <div class="search-bar-container">
                    <input type="text" id="username-search-input" placeholder="Search username...">
                </div>
                <div class="modal-scrollable-content" style="padding: 0;">
                    <ul class="collectible-list" id="usernames-list">
                    </ul>
                </div>
                <div class="modal-buttons-footer">
                    <button id="close-usernames-modal" class="modal-button">Close</button>
                </div>
            </div>
        </div>

        <div id="giveaway-setup-modal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header-bar"><h3>Create a Giveaway</h3></div>
                <div class="modal-scrollable-content">
                    <div class="giveaway-section">
                        <h4>1. Select Gifts to Give Away</h4>
                        <div id="giveaway-gift-selection-grid" class="selection-grid">
                            <p class="empty-grid-message">You have no collectible gifts to give away.</p>
                        </div>
                    </div>
                    <div class="giveaway-section">
                        <h4>2. Channels to Subscribe (optional)</h4>
                        <textarea id="giveaway-channels-input" placeholder="e.g., @channel1, @channel2"></textarea>
                        <p class="info-text">Bot must be an admin in these channels for the check to work.</p>
                    </div>
                    <div class="giveaway-section">
                        <h4>3. Choose Winner Rule</h4>
                        <label>
                            <input type="radio" name="winner-rule" value="single" checked>
                            One winner gets all gifts
                        </label>
                        <label>
                            <input type="radio" name="winner-rule" value="multiple">
                            One winner per gift
                        </label>
                    </div>
                </div>
                <div class="modal-buttons-footer">
                    <button id="confirm-giveaway-setup" class="modal-button" disabled>Start Setup in Bot</button>
                    <button id="cancel-giveaway-setup" class="modal-button secondary">Cancel</button>
                </div>
            </div>
        </div>
        
        <div id="new-post-modal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header-bar"><h3>New Post</h3></div>
                <div class="modal-scrollable-content">
                    <textarea id="new-post-content" placeholder="Enter content..."></textarea>
                    <div id="formatting-help">
                        <span id="formatting-help-toggle">Show Formatting Help ▼</span>
                        <div id="formatting-help-content" class="hidden">
                            <code>*word*</code> - <b>Bold</b><br>
                            <code>&word&</code> - <span class="text-demonic" style="font-weight:600;font-size:1.1em;">Bigger & Red</span><br>
                            <code>♡word♡</code> - <span class="text-pink">Pink</span><br>
                            <code>$word$</code> - <span class="text-green">Green</span><br>
                            <code>%word%</code> - <span class="text-blue">Blue</span><br>
                            <code>@username</code> - Links to profile<br>
                            <code>GiftName-123</code> - Links to gift
                        </div>
                    </div>
                </div>
                <div class="modal-buttons-footer">
                    <button id="submit-new-post-button" class="modal-button">Submit</button>
                    <button id="cancel-new-post-button" class="modal-button secondary">Cancel</button>
                </div>
            </div>
        </div>
        
        <div id="subscription-modal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header-bar"><h3>Wall Notifications</h3></div>
                <div class="modal-scrollable-content">
                    <div class="settings-row">
                        <label for="mentions-toggle">Mentions</label>
                        <label class="switch">
                            <input type="checkbox" id="mentions-toggle">
                            <span class="slider round"></span>
                        </label>
                    </div>
                    <div class="settings-row">
                        <label for="new-posts-toggle">This User's Posts</label>
                        <label class="switch">
                            <input type="checkbox" id="new-posts-toggle">
                            <span class="slider round"></span>
                        </label>
                    </div>
                </div>
                 <div class="modal-buttons-footer">
                    <button id="close-subscription-modal" class="modal-button">Close</button>
                </div>
            </div>
        </div>
        
        <div id="reaction-users-modal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header-bar"><h3 id="reaction-users-title">Reacted with ❤️</h3></div>
                <div class="modal-scrollable-content" style="padding:0">
                    <ul class="accounts-list" id="reaction-users-list" style="max-height: 50vh;">
                    </ul>
                </div>
                 <div class="modal-buttons-footer">
                    <button id="close-reaction-users-modal" class="modal-button">Close</button>
                </div>
            </div>
        </div>

    </div>

    <div id="reaction-popup" class="hidden">
        <span class="reaction-emoji">❤️</span>
        <span class="reaction-emoji">💯</span>
        <span class="reaction-emoji">🏆</span>
        <span class="reaction-emoji">🔥</span>
        <span class="reaction-emoji">👍</span>
        <span class="reaction-emoji">🤗</span>
        <span class="reaction-emoji">💔</span>
        <span class="reaction-emoji">😭</span>
        <span class="reaction-emoji">💋</span>
        <span class="reaction-emoji">🍆</span>
        <span class="reaction-emoji">🍑</span>
        <span class="reaction-emoji">🤬</span>
        <span class="reaction-emoji">🙄</span>
    </div>

    <div id="long-press-menu" class="hidden">
        <ul>
            <li id="menu-reorder-action" class="hidden">Reorder</li>
            <li id="menu-pin-action">Pin</li>
            <li id="menu-hide-action">Hide</li>
            <li id="menu-copy-link-action" class="hidden">Copy Link</li>
            <li id="menu-share-image-action" class="hidden">Share Image</li>
            <li id="menu-delete-action" class="danger">Delete</li>
        </ul>
    </div>
    
    <script>
        const BACKEND_BASE_URL = "https://upgrade-a57g.onrender.com";

        const APP_VERSION_SUFFIX = '_v16'; // Increment to reset UI preferences on major changes
        const CDN_BASE_URL = "https://cdn.changes.tg/gifts/";
        const GIFTS_JSON_URL = `${CDN_BASE_URL}id-to-name.json`;
        const PRICES_JSON_URL = "https://raw.githubusercontent.com/Vasiliy-katsyka/upgrade/refs/heads/main/prices.json";
        const STAR_ICON_URL = "https://raw.githubusercontent.com/Vasiliy-katsyka/upgrade/refs/heads/main/DMJTGStarsEmoji_AgADUhMAAk9WoVI.png";
        
        const ADMIN_TG_ID = 5146625949;
        const GIFT_LIMIT_PER_USER = 5000;
        const MAX_COLLECTIBLE_USERNAMES = 10;
        const MIN_SALE_PRICE = 125;
        const MAX_SALE_PRICE = 100000;

        const PIN_ICON_SVG = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><title>pin</title><path d="M16,12V4H17V2H7V4H8V12L6,14V16H11.2V22H12.8V16H18V14L16,12Z" /></svg>`;
        const DIAMOND_SVG = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><title>diamond-stone</title><path d="M16,9H19L14,16M10,9H14L12,17M5,9H8L10,16M5,4H19L12,1.5L5,4ZM6,2L2,8L12,22L22,8L18,2H6Z" /></svg>`;
        const CROWN_SVG = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><title>crown</title><path d="M5 16L3 5L8.5 10L12 4L15.5 10L21 5L19 16H5M19 19C19 19.6 18.6 20 18 20H6C5.4 20 5 19.6 5 19V18H19V19Z" /></svg>`;
        const LABEL_SVG = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><title>label</title><path d="M17.63,5.84C17.27,5.33 16.67,5 16,5H5A2,2 0 0,0 3,7V17A2,2 0 0,0 5,19H16C16.67,19 17.27,18.66 17.63,18.15L22,12L17.63,5.84Z" /></svg>`;
        const MENU_DOTS_SVG = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><title>dots-vertical</title><path d="M12,16A2,2 0 0,1 14,18A2,2 0 0,1 12,20A2,2 0 0,1 10,18A2,2 0 0,1 12,16M12,10A2,2 0 0,1 14,12A2,2 0 0,1 12,14A2,2 0 0,1 10,12A2,2 0 0,1 12,10M12,4A2,2 0 0,1 14,6A2,2 0 0,1 12,8A2,2 0 0,1 10,6A2,2 0 0,1 12,4Z" /></svg>`;

        // --- CUSTOM GIFT DATA ---
        const CUSTOM_GIFTS_DATA = {
            "Dildo": {
                "id": "custom_dildo",
                "defaultImage": "https://raw.githubusercontent.com/Vasiliy-katsyka/newTacos/main/BackgroundEraser_20250717_003931098.png",
                "models": [
                    {"name": "She Wants", "rarityPermille": 1, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/newTacos/main/BackgroundEraser_20250717_011319484.png"},
                    {"name": "Anal Games", "rarityPermille": 5, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/newTacos/main/BackgroundEraser_20250717_004252351.png"},
                    {"name": "Romance", "rarityPermille": 5, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/newTacos/main/BackgroundEraser_20250717_011244151.png"},
                    {"name": "Ma Boi", "rarityPermille": 5, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/newTacos/main/BackgroundEraser_20250717_012725065.png"},
                    {"name": "Twins 18", "rarityPermille": 8, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/newTacos/main/BackgroundEraser_20250717_004029718.png"},
                    {"name": "Golden Sex", "rarityPermille": 8, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/newTacos/main/BackgroundEraser_20250717_004223973.png"},
                    {"name": "Pixels", "rarityPermille": 8, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/newTacos/main/BackgroundEraser_20250717_012914349.png"},
                    {"name": "Penis Sword", "rarityPermille": 8, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/newTacos/main/BackgroundEraser_20250717_014719027.png"},
                    {"name": "Water One", "rarityPermille": 10, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/newTacos/main/BackgroundEraser_20250717_004351728.png"},
                    {"name": "Woman Place", "rarityPermille": 10, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/newTacos/main/BackgroundEraser_20250717_004416012.png"},
                    {"name": "Volcano", "rarityPermille": 10, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/newTacos/main/BackgroundEraser_20250717_011343633.png"},
                    {"name": "Telegram", "rarityPermille": 10, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/newTacos/main/BackgroundEraser_20250717_012648445.png"},
                    {"name": "Pinkie Twinkie", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/newTacos/main/BackgroundEraser_20250717_004004128.png"},
                    {"name": "Silver Glass", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/newTacos/main/BackgroundEraser_20250717_004200179.png"},
                    {"name": "Plush", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/newTacos/main/BackgroundEraser_20250717_011552827.png"},
                    {"name": "Plush Cuttie", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/newTacos/main/BackgroundEraser_20250717_011623951.png"},
                    {"name": "Spider Fun", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/newTacos/main/BackgroundEraser_20250717_012003197.png"},
                    {"name": "Horse", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/newTacos/main/BackgroundEraser_20250717_012355663.png"},
                    {"name": "Hand", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/newTacos/main/BackgroundEraser_20250717_013039090.png"},
                    {"name": "Ancient", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/newTacos/main/BackgroundEraser_20250717_014521352.png"},
                    {"name": "Minion", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/newTacos/main/BackgroundEraser_20250717_014626463.png"},
                    {"name": "Skinny Boi", "rarityPermille": 30, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/newTacos/main/BackgroundEraser_20250717_004055652.png"},
                    {"name": "Rainbow", "rarityPermille": 30, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/newTacos/main/BackgroundEraser_20250717_004125778.png"},
                    {"name": "Russian Wood", "rarityPermille": 30, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/newTacos/main/BackgroundEraser_20250717_011527878.png"},
                    {"name": "Afterparty", "rarityPermille": 30, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/newTacos/main/BackgroundEraser_20250717_011822289.png"},
                    {"name": "Neon", "rarityPermille": 30, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/newTacos/main/BackgroundEraser_20250717_012439323.png"},
                    {"name": "Black Jack", "rarityPermille": 30, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/newTacos/main/BackgroundEraser_20250717_013144671.png"},
                    {"name": "Galaxy", "rarityPermille": 30, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/newTacos/main/BackgroundEraser_20250717_014555528.png"},
                    {"name": "Hell Red", "rarityPermille": 30, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/newTacos/main/BackgroundEraser_20250717_014650858.png"}
                ],
                "backdrops_source": "Astral Shard",
                "patterns_source": "Astral Shard"
            },
            "Skebob": {
                "id": "custom_skebob",
                "defaultImage": "https://raw.githubusercontent.com/Vasiliy-katsyka/skebobs/refs/heads/main/BackgroundEraser_20250718_034626591.png",
                "models": [
                    {"name": "Nikitka", "rarityPermille": 1, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/skebobs/refs/heads/main/BackgroundEraser_20250718_145212143.png"},
                    {"name": "Gold", "rarityPermille": 5, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/skebobs/main/BackgroundEraser_20250717_220944840-min.png"},
                    {"name": "Plushy", "rarityPermille": 5, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/skebobs/main/BackgroundEraser_20250717_221053786-min.png"},
                    {"name": "XXXTentacion", "rarityPermille": 5, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/skebobs/main/BackgroundEraser_20250717_222249990-min.png"},
                    {"name": "Cactus King", "rarityPermille": 5, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/skebobs/main/BackgroundEraser_20250718_013002213-min.png"},
                    {"name": "354 KANON", "rarityPermille": 5, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/skebobs/main/BackgroundEraser_20250718_013042799-min.png"},
                    {"name": "Duck", "rarityPermille": 5, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/skebobs/main/BackgroundEraser_20250718_014036288-min.png"},
                    {"name": "Spider King", "rarityPermille": 10, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/skebobs/main/BackgroundEraser_20250717_220335725-min.png"},
                    {"name": "Bitcoin", "rarityPermille": 10, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/skebobs/main/BackgroundEraser_20250718_012502725-min.png"},
                    {"name": "Move To Heaven", "rarityPermille": 10, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/skebobs/main/BackgroundEraser_20250718_012612974-min.png"},
                    {"name": "Frogie", "rarityPermille": 10, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/skebobs/main/BackgroundEraser_20250718_012824238-min.png"},
                    {"name": "The King", "rarityPermille": 10, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/skebobs/main/BackgroundEraser_20250718_012931928-min.png"},
                    {"name": "Fire On Fire", "rarityPermille": 10, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/skebobs/main/BackgroundEraser_20250718_013941593-min.png"},
                    {"name": "Icy", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/skebobs/main/BackgroundEraser_20250717_220405846-min.png"},
                    {"name": "Pick Me", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/skebobs/main/BackgroundEraser_20250717_220906007-min.png"},
                    {"name": "Black Bird", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/skebobs/main/BackgroundEraser_20250717_221147963-min.png"},
                    {"name": "Pavel Durov", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/skebobs/main/BackgroundEraser_20250717_222706006-min.png"},
                    {"name": "Banana", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/skebobs/main/BackgroundEraser_20250718_013851152-min.png"},
                    {"name": "Mummy", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/skebobs/main/BackgroundEraser_20250718_014247708-min.png"},
                    {"name": "Police Man", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/skebobs/main/BackgroundEraser_20250718_014319952-min.png"},
                    {"name": "Electric BDSM", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/skebobs/main/BackgroundEraser_20250718_014554522-min.png"},
                    {"name": "Glassy", "rarityPermille": 30, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/skebobs/main/BackgroundEraser_20250717_221020205-min.png"},
                    {"name": "Ancient", "rarityPermille": 30, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/skebobs/main/BackgroundEraser_20250718_012541910-min.png"},
                    {"name": "Business", "rarityPermille": 30, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/skebobs/main/BackgroundEraser_20250718_013214856-min.png"},
                    {"name": "Spookie", "rarityPermille": 30, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/skebobs/main/BackgroundEraser_20250718_013308503-min.png"},
                    {"name": "Minion", "rarityPermille": 30, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/skebobs/main/BackgroundEraser_20250718_013343118-min.png"},
                    {"name": "Oh Shit", "rarityPermille": 30, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/skebobs/main/BackgroundEraser_20250718_013417326-min.png"},
                    {"name": "Emo Girl", "rarityPermille": 30, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/skebobs/main/BackgroundEraser_20250718_014533870-min.png"},
                    {"name": "Minecraft", "rarityPermille": 30, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/skebobs/main/BackgroundEraser_20250718_014750440-min.png"}
                ],
                "backdrops_source": "Snoop Dogg",
                "patterns_source": "Snoop Dogg"
            },
            "Baggin' Cat": {
                "id": "custom_baggin_cat",
                "defaultImage": "https://raw.githubusercontent.com/Vasiliy-katsyka/BagginCat/refs/heads/main/IMG_20250718_234950_164.png",
                "models": [
                    {"name": "Redo", "rarityPermille": 1, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/BagginCat/main/BackgroundEraser_20250720_154505502.png"},
                    {"name": "Bored Ape", "rarityPermille": 5, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/BagginCat/main/BackgroundEraser_20250720_153421320.png"},
                    {"name": "Snoop Dogg", "rarityPermille": 5, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/BagginCat/main/BackgroundEraser_20250720_153800346.png"},
                    {"name": "Austronaut", "rarityPermille": 10, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/BagginCat/main/BackgroundEraser_20250720_153211676.png"},
                    {"name": "Chinese Dragon", "rarityPermille": 10, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/BagginCat/main/BackgroundEraser_20250720_153332160.png"},
                    {"name": "Radioactive", "rarityPermille": 10, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/BagginCat/main/BackgroundEraser_20250720_154437815.png"},
                    {"name": "Pink Guard", "rarityPermille": 10, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/BagginCat/main/BackgroundEraser_20250720_154725761.png"},
                    {"name": "Angel", "rarityPermille": 10, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/BagginCat/main/BackgroundEraser_20250720_155859028.png"},
                    {"name": "Devil", "rarityPermille": 10, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/BagginCat/main/BackgroundEraser_20250720_155937967.png"},
                    {"name": "Minion", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/BagginCat/main/BackgroundEraser_20250720_153059849.png"},
                    {"name": "Rainbow", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/BagginCat/main/BackgroundEraser_20250720_153251813.png"},
                    {"name": "Spookie", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/BagginCat/main/BackgroundEraser_20250720_153836181.png"},
                    {"name": "Spider", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/BagginCat/main/BackgroundEraser_20250720_154055429.png"},
                    {"name": "Dying Light", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/BagginCat/main/BackgroundEraser_20250720_154537813.png"},
                    {"name": "Hippo", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/BagginCat/main/BackgroundEraser_20250720_155053345.png"},
                    {"name": "Poo", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/BagginCat/main/BackgroundEraser_20250720_155200011.png"},
                    {"name": "Pikachu", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/BagginCat/main/BackgroundEraser_20250720_155411045.png"},
                    {"name": "XXXTentacion", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/BagginCat/main/BackgroundEraser_20250720_155652114.png"},
                    {"name": "Electric", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/BagginCat/main/BackgroundEraser_20250720_155830968.png"},
                    {"name": "Glassy", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/BagginCat/main/BackgroundEraser_20250720_160036747.png"},
                    {"name": "Alien", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/BagginCat/main/BackgroundEraser_20250720_160243304.png"},
                    {"name": "Piggy", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/BagginCat/main/BackgroundEraser_20250720_160346910.png"},
                    {"name": "Panda", "rarityPermille": 30, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/BagginCat/main/BackgroundEraser_20250720_153136834.png"},
                    {"name": "Capybara", "rarityPermille": 30, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/BagginCat/main/BackgroundEraser_20250720_153629360.png"},
                    {"name": "Dolphin", "rarityPermille": 30, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/BagginCat/main/BackgroundEraser_20250720_155125393.png"},
                    {"name": "Rabbit", "rarityPermille": 30, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/BagginCat/main/BackgroundEraser_20250720_155341280.png"},
                    {"name": "Elephant", "rarityPermille": 30, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/BagginCat/main/BackgroundEraser_20250720_160003197.png"},
                    {"name": "Bee", "rarityPermille": 30, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/BagginCat/main/BackgroundEraser_20250720_160317620.png"}
                ],
                "backdrops_source": "Toy Bear",
                "patterns_source": "Toy Bear"
            }
        };


        // --- Global State ---
        let allAvailableGifts = {};
        let giftPrices = {};

        let accounts = [];
        let currentAccountTgId = null;

        let ownedGifts = [];
        let profilePosts = [];
        let currentlySortedGifts = [];
        let currentlyViewedProfile = {};
        let viewingOwnProfile = true;
        let selectionModeActive = false;
        let selectionAction = null;
        let reorderModeActive = false;
        let selectedGiftIds = new Set();

        let animationsEnabled = true;
        let showHiddenGifts = false;
        let customGiftsEnabled = false;
        let fullscreenEnabled = false;
        let activeFilters = { collection: null, model: null, backdrop: null, pattern: null };

        let tg = window.Telegram.WebApp;

        // --- DOM Elements ---
        const loadingScreen = document.getElementById('loading-screen');
        const appContainer = document.querySelector('.app-container');
        const accountSidebar = document.getElementById('account-sidebar');
        const sidebarOverlay = document.getElementById('sidebar-overlay');
        const sidebarCurrentAvatar = document.getElementById('sidebar-current-avatar');
        const sidebarCurrentName = document.getElementById('sidebar-current-name');
        const sidebarSearchInput = document.getElementById('sidebar-search-input');
        const sidebarSearchResults = document.getElementById('sidebar-search-results');
        const accountsList = document.getElementById('accounts-list');
        const addAccountButton = document.getElementById('add-account-button');
        const adminLoginButton = document.getElementById('admin-login-button');
        const openFiltersButton = document.getElementById('open-filters-button');
        const openNumbersButton = document.getElementById('open-numbers-button');
        const openUsernamesButton = document.getElementById('open-usernames-button');
        const createGiveawayButton = document.getElementById('create-giveaway-button');

        const profilePage = document.getElementById('profile-page');
        const profileTopSection = document.getElementById('profile-top-section');
        const profileHeaderPatternOverlay = document.getElementById('profile-header-pattern-overlay');
        const profileAvatar = document.getElementById('profile-avatar');
        const avatarUploadInput = document.getElementById('avatar-upload-input');
        const profileName = document.getElementById('profile-name');
        const wornGiftIconContainer = document.getElementById('worn-gift-icon-container');
        const profileGiftCountSubtext = document.getElementById('profile-gift-count-subtext');
        const profileStatus = document.getElementById('profile-status');
        const profileDetails = document.getElementById('profile-details');
        const profilePhone = document.getElementById('profile-phone');
        const profileBio = document.getElementById('profile-bio');
        const profileUsername = document.getElementById('profile-username');
        const collectibleUsernamesContainer = document.getElementById('collectible-usernames-container');
        const profileTopPinnedGifts = document.getElementById('profile-top-pinned-gifts');

        const giftsTabButton = document.getElementById('gifts-tab-button');
        const giftsTabPreviewContainer = document.getElementById('gifts-tab-preview-container');
        const postsTabButton = document.getElementById('posts-tab-button');
        const buyGiftsTabButton = document.getElementById('buy-gifts-tab-button');
        const wallSubscriptionButton = document.getElementById('wall-subscription-button');
        const giftsContent = document.getElementById('gifts-content');
        const postsContent = document.getElementById('posts-content');
        const newPostFab = document.getElementById('new-post-fab');
        
        const profileGiftsActionsWrapper = document.getElementById('profile-gifts-actions-wrapper');
        const profileGiftsActions = document.querySelector('.profile-gifts-actions');
        const upgradeAllGiftsButton = document.getElementById('upgrade-all-gifts-button');
        const giftsGrid = document.getElementById('gifts-grid');
        const giftsLoadingSpinner = document.getElementById('gifts-loading-spinner');

        const buyGiftsPage = document.getElementById('buy-gifts-page');
        const customizeGiftButton = document.getElementById('customize-gift-button');
        const buyGiftsGrid = document.getElementById('buy-gifts-grid');
        const buyGiftsLoadingSpinner = document.getElementById('buy-gifts-loading-spinner');

        const giftDetailModal = document.getElementById('gift-detail-modal');
        const modalGiftName = document.getElementById('modal-gift-name');
        const modalLottieGiftOriginal = document.getElementById('modal-lottie-gift-original');
        const modalGiftImageStatic = document.getElementById('modal-gift-image-static');
        const modalGiftDescription1 = document.getElementById('modal-gift-description1');
        const modalGiftDescription2 = document.getElementById('modal-gift-description2');
        const modalGiftInfo = document.getElementById('modal-gift-info');
        const upgradeGiftDetailModalButton = document.getElementById('upgrade-gift-detail-modal-button');
        const closeGiftDetailModalButton = document.getElementById('close-gift-detail-modal-button');

        const collectibleDetailModal = document.getElementById('collectible-detail-modal');
        const collectibleDisplayArea = collectibleDetailModal.querySelector('.collectible-display-area');
        const patternContainerDynamic = document.getElementById('pattern-container-dynamic');
        const modalCollectibleVisual = document.getElementById('modal-collectible-visual');
        const modalLottieCollectibleModel = document.getElementById('modal-lottie-collectible-model');
        const modalCollectibleModelImgStatic = document.getElementById('modal-collectible-model-img-static');
        const modalCollectibleMainName = document.getElementById('modal-collectible-main-name');
        const modalCollectibleNumberSubtext = document.getElementById('modal-collectible-number-subtext');
        const modalCollectibleInfoTable = document.getElementById('modal-collectible-info-table');
        const collectibleActionWear = document.getElementById('collectible-action-wear');
        const collectibleActionSell = document.getElementById('collectible-action-sell');
        const collectibleActionTransfer = document.getElementById('collectible-action-transfer');
        const closeCollectibleDetailModalButton = document.getElementById('close-collectible-detail-modal');
        const collectibleMenuButton = document.getElementById('collectible-menu-button');
        const hideLinkInModal = document.getElementById('hide-link-in-modal');

        const tooManyPinsModal = document.getElementById('too-many-pins-modal');
        const unpinSelectionGrid = document.getElementById('unpin-selection-grid');
        const cancelUnpinModal = document.getElementById('cancel-unpin-modal');

        const buyMultipleModal = document.getElementById('buy-multiple-modal');
        const buyMultipleModalTitle = document.getElementById('buy-multiple-modal-title');
        const buyMultipleGiftName = document.getElementById('buy-multiple-gift-name');
        const buyMultipleQuantityInput = document.getElementById('buy-multiple-quantity');
        const confirmBuyMultipleButton = document.getElementById('confirm-buy-multiple');
        const cancelBuyMultipleButton = document.getElementById('cancel-buy-multiple');

        const longPressMenu = document.getElementById('long-press-menu');
        const menuReorderAction = document.getElementById('menu-reorder-action');
        const menuPinAction = document.getElementById('menu-pin-action');
        const menuHideAction = document.getElementById('menu-hide-action');
        const menuCopyLinkAction = document.getElementById('menu-copy-link-action');
        const menuDeleteAction = document.getElementById('menu-delete-action');
        const menuShareImageAction = document.getElementById('menu-share-image-action');
        
        const imagePreviewModal = document.getElementById('image-preview-modal');

        const filterPopup = document.getElementById('filter-popup');
        const filterModelsSection = document.getElementById('filter-models-section');
        const filterOptionsCollections = document.getElementById('filter-options-collections');
        const filterOptionsModels = document.getElementById('filter-options-models');
        const filterOptionsBackdrops = document.getElementById('filter-options-backdrops');
        const filterOptionsPatterns = document.getElementById('filter-options-patterns');
        const applyFiltersButton = document.getElementById('apply-filters-button');
        const clearFiltersButton = document.getElementById('clear-filters-button');

        const settingsModal = document.getElementById('settings-modal');
        const animationToggle = document.getElementById('animation-toggle');
        const fullscreenToggle = document.getElementById('fullscreen-toggle');
        const customGiftsToggle = document.getElementById('custom-gifts-toggle');
        const showHiddenToggle = document.getElementById('show-hidden-toggle');
        const termsOfServiceButton = document.getElementById('terms-of-service-button');
        const hideMultipleButton = document.getElementById('hide-multiple-button');
        const transferMultipleButton = document.getElementById('transfer-multiple-button');
        const clearCurrentAccountDataButton = document.getElementById('clear-current-account-data-button');
        const clearAllAccountsDataButton = document.getElementById('clear-all-accounts-data-button');

        const customBuyModal = document.getElementById('custom-buy-modal');
        const giftQueueContainer = document.getElementById('gift-queue-container');
        const giftConfigArea = document.getElementById('gift-config-area');
        const customBuyBaseGiftsGrid = document.getElementById('custom-buy-base-gifts-grid');
        const customBuyModelsSection = document.getElementById('custom-buy-models-section');
        const customBuyModelsGrid = document.getElementById('custom-buy-models-grid');
        const customBuyBackdropsSection = document.getElementById('custom-buy-backdrops-section');
        const customBuyBackdropsGrid = document.getElementById('custom-buy-backdrops-grid');
        const customBuyPatternsSection = document.getElementById('custom-buy-patterns-section');
        const customBuyPatternsGrid = document.getElementById('custom-buy-patterns-grid');
        const addAnotherGiftButton = document.getElementById('add-another-gift-button');
        const advancedSettingsToggle = document.getElementById('advanced-settings-toggle');
        const advancedSettingsContainer = document.getElementById('advanced-settings-container');
        const customBuyQuantityInput = document.getElementById('custom-buy-quantity');
        const cloneUrlInput = document.getElementById('clone-url-input');
        const cloneGiftButton = document.getElementById('clone-gift-button');
        const customPatternUploadInput = document.getElementById('custom-pattern-upload');
        const customPatternPreview = document.getElementById('custom-pattern-preview');
        const customBuyConfirmButton = document.getElementById('custom-buy-confirm-button');
        const customBuyCancelButton = document.getElementById('custom-buy-cancel-button');

        const generatedImageModal = document.getElementById('generated-image-modal');
        const generatedImageFooter = document.getElementById('generated-image-footer');
        const generatedImagePreview = document.getElementById('generated-image-preview');
        const generatedImageMessage = document.getElementById('generated-image-message');
        const sendGeneratedImageButton = document.getElementById('send-generated-image-button');
        const closeGeneratedImageModalButton = document.getElementById('close-generated-image-modal');

        const chancesModal = document.getElementById('chances-modal');
        const chancesGiftName = document.getElementById('chances-gift-name');
        const chancesLoadingSpinner = document.getElementById('chances-loading-spinner');
        const chancesProbabilityDisplay = document.getElementById('chances-probability-display');
        const chancesModelsSection = document.getElementById('chances-models-section');
        const chancesOptionsModels = document.getElementById('chances-options-models');
        const chancesBackdropsSection = document.getElementById('chances-backdrops-section');
        const chancesOptionsBackdrops = document.getElementById('chances-options-backdrops');
        const chancesPatternsSection = document.getElementById('chances-patterns-section');
        const chancesOptionsPatterns = document.getElementById('chances-options-patterns');
        const closeChancesModalButton = document.getElementById('close-chances-modal');

        const sellGiftModal = document.getElementById('sell-gift-modal');
        const sellGiftImage = document.getElementById('sell-gift-image');
        const sellGiftName = document.getElementById('sell-gift-name');
        const sellPriceInput = document.getElementById('sell-price-input');
        const sellReceiveAmount = document.getElementById('sell-receive-amount');
        const sellUsdAmount = document.getElementById('sell-usd-amount');
        const confirmSellButton = document.getElementById('confirm-sell-button');
        const cancelSellButton = document.getElementById('cancel-sell-button');

        const transferGiftModal = document.getElementById('transfer-gift-modal');
        const transferModalTitle = document.getElementById('transfer-modal-title');
        const transferGiftImage = document.getElementById('transfer-gift-image');
        const transferGiftName = document.getElementById('transfer-gift-name');
        const transferUsernameInput = document.getElementById('transfer-username-input');
        const transferCommentInput = document.getElementById('transfer-comment-input');
        const transferStatusMessage = document.getElementById('transfer-status-message');
        const confirmTransferButton = document.getElementById('confirm-transfer-button');
        const cancelTransferButton = document.getElementById('cancel-transfer-button');

        const numbersModal = document.getElementById('numbers-modal');
        const numbersList = document.getElementById('numbers-list');

        const usernamesModal = document.getElementById('usernames-modal');
        const usernameSearchInput = document.getElementById('username-search-input');
        const usernamesList = document.getElementById('usernames-list');

        const giveawaySetupModal = document.getElementById('giveaway-setup-modal');
        const giveawayGiftSelectionGrid = document.getElementById('giveaway-gift-selection-grid');
        const giveawayChannelsInput = document.getElementById('giveaway-channels-input');
        const confirmGiveawaySetupButton = document.getElementById('confirm-giveaway-setup');
        
        const newPostModal = document.getElementById('new-post-modal');
        const newPostContent = document.getElementById('new-post-content');
        const submitNewPostButton = document.getElementById('submit-new-post-button');

        const subscriptionModal = document.getElementById('subscription-modal');
        const mentionsToggle = document.getElementById('mentions-toggle');
        const newPostsToggle = document.getElementById('new-posts-toggle');

        const reactionPopup = document.getElementById('reaction-popup');
        const reactionUsersModal = document.getElementById('reaction-users-modal');
        const reactionUsersTitle = document.getElementById('reaction-users-title');
        const reactionUsersList = document.getElementById('reaction-users-list');

        const exitFilterModeButton = document.createElement('button');
        exitFilterModeButton.id = 'exit-filter-mode-button';
        exitFilterModeButton.className = 'action-button hidden';
        exitFilterModeButton.textContent = 'Exit Filter Mode';
        profileGiftsActions.prepend(exitFilterModeButton);

        const exitReorderModeButton = document.createElement('button');
        exitReorderModeButton.id = 'exit-reorder-mode-button';
        exitReorderModeButton.className = 'action-button hidden';
        exitReorderModeButton.textContent = 'Done Reordering';
        profileGiftsActions.prepend(exitReorderModeButton);

        const exitSelectionModeButton = document.createElement('button');
        exitSelectionModeButton.id = 'exit-selection-mode-button';
        exitSelectionModeButton.className = 'action-button hidden';
        exitSelectionModeButton.textContent = 'Cancel';
        profileGiftsActions.prepend(exitSelectionModeButton);

        const transferSelectedGiftsButton = document.createElement('button');
        transferSelectedGiftsButton.id = 'transfer-selected-gifts-button';
        transferSelectedGiftsButton.className = 'action-button hidden';
        transferSelectedGiftsButton.textContent = 'Transfer';
        profileGiftsActions.prepend(transferSelectedGiftsButton);

        const hideSelectedGiftsButton = document.createElement('button');
        hideSelectedGiftsButton.id = 'hide-selected-gifts-button';
        hideSelectedGiftsButton.className = 'action-button hidden';
        hideSelectedGiftsButton.textContent = 'Hide';
        profileGiftsActions.prepend(hideSelectedGiftsButton);

        let currentGiftToBuyMultiple = null;
        let lottieIntersectionObserver;
        
        let giftCreationQueue = [];
        let currentlyEditingGiftIndex = -1;

        let cachedCollectibleParts = {};
        let lastTap = 0;
        let tapCount = 0;
        let currentGiftToSell = null;
        let currentGiftToTransfer = null;
        let longPressAvatarTimer;
        let sortableInstance = null;
        let modalSwipeState = { startX: 0, isSwiping: false };
        let selectedGiveawayGifts = new Set();
        let searchDebounceTimer;
        let currentlyReactingPost = null;

        // --- API Utility Function ---
        async function callBackend(endpoint, method = 'GET', data = null, params = {}) {
            const queryParams = new URLSearchParams(params).toString();
            const url = `${BACKEND_BASE_URL}${endpoint}${queryParams ? '?' + queryParams : ''}`;

            const headers = {
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            };
            
            if (endpoint.includes('/api/user_data/')) {
                headers['Authorization'] = `Bearer ${tg.initData}`; // Using a placeholder for API_KEY
            }

            const options = {
                method: method,
                headers: headers,
                body: data ? JSON.stringify(data) : null,
            };

            try {
                const response = await fetch(url, options);
                const responseData = await response.json().catch(() => ({}));

                if (!response.ok) {
                    throw { 
                        status: response.status, 
                        message: responseData.error || response.statusText || 'Unknown error',
                        reason: responseData.reason 
                    };
                }
                return response.status === 204 ? null : responseData;
            } catch (error) {
                console.error(`Backend API call failed: ${endpoint}`, error);
                if (error.status !== 403) { // Don't show generic alert for permission errors handled elsewhere
                    tg.showAlert(`Error: ${error.message}`);
                }
                throw error;
            }
        }

        function getRandomElement(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
        function generateUniqueId() { return `${Date.now().toString(36)}-${Math.random().toString(36).substring(2, 9)}`; }

        function formatRarity(permille) {
            if (!permille) return 'N/A';
            const percentage = permille / 10;
            const oneInX = Math.round(1000 / permille); // Correct calculation
            return `${percentage.toFixed(1)}% <span class="one-in-x">(1 of ${oneInX.toLocaleString('en-US')})</span>`;
        }

        function playLottieAnimation(container, path, loop = true, isGridItem = false) {
            if (!animationsEnabled) {
                destroyLottieAnimation(container);
                const parentCard = container.closest('.gift-card, .buy-gift-item, .modal-collectible-visual');
                if (parentCard) {
                    const staticFallback = parentCard.querySelector('.static-image-fallback');
                    if(staticFallback) staticFallback.style.display = 'block';
                    container.style.display = 'none';
                }
                return;
            }
            if (!container || !path) return;
            if (container.lottieInstance) { container.lottieInstance.destroy(); delete container.lottieInstance; }
            container.innerHTML = '';
            const anim = bodymovin.loadAnimation({ container: container, path: path, renderer: 'svg', loop: loop, autoplay: true });
            container.lottieInstance = anim;
            if (isGridItem && !loop) {
                anim.addEventListener('complete', () => { if (container.lottieInstance === anim) container.dataset.playedOnce = 'true'; });
            }
        }
        function destroyLottieAnimation(container) {
            if (container && container.lottieInstance) {
                container.lottieInstance.destroy();
                delete container.lottieInstance; delete container.dataset.playedOnce; container.innerHTML = '';
            }
        }
        function handleLottieIntersection(entries, observer) {
            entries.forEach(entry => {
                const cardElement = entry.target;
                const lottieContainer = cardElement.querySelector('.lottie-animation-container');
                const staticFallback = cardElement.querySelector('.static-image-fallback');
                const lottiePath = cardElement.dataset.lottiePath;
                if (entry.isIntersecting) {
                    if (animationsEnabled && lottiePath && lottieContainer) {
                        if(staticFallback) staticFallback.style.display = 'none';
                        lottieContainer.style.display = 'flex';
                        playLottieAnimation(lottieContainer, lottiePath, false, true);
                    }
                } else {
                    if (lottieContainer) {
                        destroyLottieAnimation(lottieContainer);
                        if(staticFallback) staticFallback.style.display = 'block';
                        lottieContainer.style.display = 'none';
                    }
                }
            });
        }
        function initLottieObserver() {
            lottieIntersectionObserver = new IntersectionObserver(handleLottieIntersection, { root: null, rootMargin: '100px', threshold: 0.01 });
        }
        function observeLottieElement(element) {
            if (lottieIntersectionObserver && element.dataset.lottiePath) lottieIntersectionObserver.observe(element);
        }
        function unobserveLottieElement(element) {
             if (lottieIntersectionObserver && element.dataset.lottiePath) {
                lottieIntersectionObserver.unobserve(element);
                const lottieContainer = element.querySelector('.lottie-animation-container');
                if(lottieContainer) destroyLottieAnimation(lottieContainer);
            }
        }

        async function initApp() {
            tg.ready(); tg.expand();
            initLottieObserver();

            collectibleActionWear.querySelector('.icon').innerHTML = CROWN_SVG;
            collectibleActionSell.querySelector('.icon').innerHTML = LABEL_SVG;
            collectibleActionTransfer.querySelector('.icon').innerHTML = DIAMOND_SVG;
            collectibleMenuButton.innerHTML = MENU_DOTS_SVG;

            loadClientSideState();

            if (fullscreenEnabled) {
                try { tg.requestFullscreen(); } catch (e) { console.warn("Fullscreen request failed", e); }
            }

            const startAppParam = tg.initDataUnsafe?.start_param;
            let initialAction = { type: 'default' };

            if (startAppParam) {
                if (startAppParam.startsWith('user')) {
                    const identifier = startAppParam.substring(4);
                    initialAction = { type: 'user', identifier };
                } else if (startAppParam.startsWith('gift')) {
                    const giftString = startAppParam.substring(4);
                    const lastHyphenIndex = giftString.lastIndexOf('-');
                    if (lastHyphenIndex > -1) {
                        const giftTypeId = giftString.substring(0, lastHyphenIndex);
                        const collectibleNumber = parseInt(giftString.substring(lastHyphenIndex + 1), 10);
                        if (giftTypeId && !isNaN(collectibleNumber)) {
                            initialAction = { type: 'gift', giftTypeId, collectibleNumber };
                        } else { tg.showAlert("Invalid gift format in deep link."); }
                    } else { tg.showAlert("Invalid gift format in deep link."); }
                }
            }

            await initializeTelegramUserAccount(); 

            switch (initialAction.type) {
                case 'user':
                    await displayUserProfile(initialAction.identifier);
                    break;
                case 'gift':
                    await displayDeepLinkedGift(initialAction.giftTypeId, initialAction.collectibleNumber);
                    break;
            }

            await fetchAvailableGifts();
            
            setTimeout(() => {
                loadingScreen.classList.add('hidden');
            }, 500);

            applyTheme(tg.themeParams);
            tg.onEvent('themeChanged', () => applyTheme(tg.themeParams));
            tg.SettingsButton.show();
            tg.SettingsButton.onClick(openSettingsModal);

            setupEventListeners();
        }

        async function initializeTelegramUserAccount() {
            manageBackButton(false);
            viewingOwnProfile = true;
            currentlyViewedProfile = {};
            const user = tg.initDataUnsafe?.user;
            let tg_id = user?.id;

            if (!tg_id) {
                let mockAccount = JSON.parse(localStorage.getItem('giftSimMockTgUser' + APP_VERSION_SUFFIX));
                if (!mockAccount) {
                    mockAccount = {
                        tg_id: Math.floor(Math.random() * 1e9) + 1,
                        username: `mockuser_${Math.random().toString(36).substring(2, 6)}`,
                        full_name: `Mock User ${Math.floor(Math.random() * 100)}`,
                        avatar_url: `https://i.pravatar.cc/140?u=mock_${generateUniqueId()}`
                    };
                    localStorage.setItem('giftSimMockTgUser' + APP_VERSION_SUFFIX, JSON.stringify(mockAccount));
                }
                tg_id = mockAccount.tg_id;
            }

            try {
                // Check if this account exists in local storage first
                let existingAccount = accounts.find(acc => acc.tg_id === tg_id);

                let accountData;
                if (existingAccount && accounts.length > 1) { // Avoid unnecessary backend call for simple switches
                     accountData = await callBackend(`/api/account`, 'POST', { tg_id });
                } else {
                     accountData = await callBackend('/api/account', 'POST', {
                        tg_id: tg_id,
                        username: user?.username,
                        full_name: user ? [user.first_name, user.last_name].filter(Boolean).join(' ') : 'Original User Name',
                        avatar_url: user?.photo_url || `https://i.pravatar.cc/140?u=${tg_id}`
                    });
                }


                currentAccountTgId = accountData.tg_id;
                ownedGifts = accountData.owned_gifts || [];
                profilePosts = accountData.posts || [];
                customGiftsEnabled = accountData.custom_gifts_enabled || false;

                if (existingAccount) {
                    Object.assign(existingAccount, accountData);
                } else {
                    accounts.push(accountData);
                }
                saveClientSideAccounts();
                renderAll();
            } catch (error) {
                console.error("Failed to initializeTelegramUserAccount:", error);
            }
        }

        async function displayDeepLinkedGift(giftTypeId, collectibleNumber) {
            try {
                const giftData = await callBackend(`/api/gift/${giftTypeId}/${collectibleNumber}`, 'GET', null, { viewer_id: currentAccountTgId });
                if (giftData) {
                    openModal(collectibleDetailModal, giftData);
                }
            } catch (error) {
                if (error.reason === 'custom_content_disabled') {
                    tg.showAlert("Sorry, you cannot see this gift.");
                }
                console.error("Error fetching deep-linked gift:", error);
            }
        }

        async function displayUserProfile(identifier) {
             const ownAccount = accounts.find(acc => acc.tg_id === currentAccountTgId);
             if (ownAccount && ownAccount.username && ownAccount.username.toLowerCase() === identifier.toLowerCase()) {
                 await initializeTelegramUserAccount();
                 return;
             }
             if (ownAccount && ownAccount.phone_number && ownAccount.phone_number === identifier) {
                 await initializeTelegramUserAccount();
                 return;
             }

             viewingOwnProfile = false;
             try {
                let profileData;
                if (identifier.startsWith('+888')) {
                    const userByPhone = await callBackend(`/api/user-by-phone/${identifier}`);
                    profileData = await callBackend(`/api/profile/${userByPhone.username}`, 'GET', null, { viewer_id: currentAccountTgId });
                } else {
                    profileData = await callBackend(`/api/profile/${identifier}`, 'GET', null, { viewer_id: currentAccountTgId });
                }
                
                currentlyViewedProfile = profileData;
                ownedGifts = profileData.owned_gifts || [];
                profilePosts = profileData.posts || [];

                profileName.textContent = profileData.full_name || 'User';
                profileAvatar.src = profileData.avatar_url || '';
                profileAvatar.onerror = () => { profileAvatar.src = `https://i.pravatar.cc/140?u=fallback${generateUniqueId()}`; };
                profileUsername.textContent = profileData.username ? `@${profileData.username}` : 'no username';
                profileUsername.onclick = null;
                profileBio.textContent = profileData.bio || "No bio yet";
                profilePhone.textContent = profileData.phone_number || "Not specified";

                collectibleUsernamesContainer.innerHTML = '';
                if (profileData.collectible_usernames && profileData.collectible_usernames.length > 0) {
                    const alsoSpan = document.createElement('span'); alsoSpan.className = 'also-text'; alsoSpan.textContent = 'also';
                    collectibleUsernamesContainer.appendChild(alsoSpan);
                    profileData.collectible_usernames.forEach(uname => {
                        const unameSpan = document.createElement('span'); unameSpan.className = 'collectible-username-span'; unameSpan.textContent = `@${uname}`;
                        unameSpan.addEventListener('click', () => displayUserProfile(uname));
                        collectibleUsernamesContainer.appendChild(unameSpan);
                    });
                }

                manageBackButton(true, () => initializeTelegramUserAccount());

                profileBio.style.cursor = 'default';
                profileBio.onclick = null;
                profileAvatar.style.cursor = 'default';

                renderAll();
            } catch (error) {
                console.error("Error fetching user profile:", error);
                await initializeTelegramUserAccount();
            }
        }

        function manageBackButton(visible, onClickHandler) {
            if (visible) {
                tg.BackButton.show();
                tg.BackButton.onClick(onClickHandler);
            } else {
                tg.BackButton.hide();
                if (tg._backButtonCallback) {
                     tg.BackButton.offClick(tg._backButtonCallback);
                     delete tg._backButtonCallback;
                }
                if (onClickHandler) {
                    tg._backButtonCallback = onClickHandler;
                }
            }
        }

        function applyTheme(themeParams) {
            if (themeParams && Object.keys(themeParams).length > 0) {
                const root = document.documentElement;
                const setVar = (varName, value) => { if (value) root.style.setProperty(varName, value); };
                setVar('--tg-theme-bg-color', themeParams.bg_color);
                setVar('--tg-theme-text-color', themeParams.text_color);
                setVar('--tg-theme-hint-color', themeParams.hint_color);
                setVar('--tg-theme-link-color', themeParams.link_color);
                setVar('--tg-theme-button-color', themeParams.button_color);
                setVar('--tg-theme-button-text-color', themeParams.button_text_color);
                setVar('--tg-theme-secondary-bg-color', themeParams.secondary_bg_color);
                setVar('--tg-theme-accent-blue', themeParams.accent_text_color || '#5288c1');
                document.body.style.backgroundColor = themeParams.bg_color || 'var(--tg-theme-bg-color)';
                document.body.style.color = themeParams.text_color || 'var(--tg-theme-text-color)';
                if (upgradeAllGiftsButton) upgradeAllGiftsButton.style.backgroundColor = themeParams.accent_text_color || 'var(--tg-theme-accent-blue)';
                if (exitFilterModeButton) exitFilterModeButton.style.backgroundColor = themeParams.accent_text_color || 'var(--tg-theme-accent-blue)';
                if (exitReorderModeButton) exitReorderModeButton.style.backgroundColor = themeParams.accent_text_color || 'var(--tg-theme-accent-blue)';
                applyWornGiftStyles();
            } else console.log("Using default CSS variables as themeParams are empty.");
        }

        function loadUserData() {
            const account = accounts.find(acc => acc.tg_id === currentAccountTgId);
            if (!account) return;

            profileName.textContent = account.full_name || 'User';
            profileAvatar.src = account.avatar_url || '';
            profileAvatar.onerror = () => { profileAvatar.src = `https://i.pravatar.cc/140?u=fallback${generateUniqueId()}`; };
            profileUsername.textContent = account.username ? `@${account.username}` : 'no username';
            profileUsername.onclick = () => { if(account.username) displayUserProfile(account.username); };
            profileBio.textContent = account.bio || "No bio yet";
            profilePhone.textContent = account.phone_number || "Not specified";
            profileBio.style.cursor = 'pointer';
            profileAvatar.style.cursor = 'pointer';

            collectibleUsernamesContainer.innerHTML = '';
            if (account.collectible_usernames && account.collectible_usernames.length > 0) {
                const alsoSpan = document.createElement('span');
                alsoSpan.className = 'also-text';
                alsoSpan.textContent = 'also';
                collectibleUsernamesContainer.appendChild(alsoSpan);

                account.collectible_usernames.forEach(uname => {
                    const unameSpan = document.createElement('span');
                    unameSpan.className = 'collectible-username-span';
                    unameSpan.textContent = `@${uname}`;
                    unameSpan.dataset.username = uname;
                    unameSpan.addEventListener('click', () => displayUserProfile(uname));
                    unameSpan.addEventListener('contextmenu', (e) => {
                        e.preventDefault();
                        handleDeleteCollectibleUsername(uname);
                    });

                    collectibleUsernamesContainer.appendChild(unameSpan);
                });
            }

            sidebarCurrentAvatar.src = account.avatar_url;
            sidebarCurrentName.textContent = account.full_name;
        }

        // --- Account Management ---
        function loadClientSideState() {
            animationsEnabled = JSON.parse(localStorage.getItem('animationsEnabled' + APP_VERSION_SUFFIX)) ?? true;
            showHiddenGifts = JSON.parse(localStorage.getItem('showHiddenGifts' + APP_VERSION_SUFFIX)) ?? false;
            fullscreenEnabled = JSON.parse(localStorage.getItem('fullscreenEnabled' + APP_VERSION_SUFFIX)) ?? false;
            activeFilters = JSON.parse(localStorage.getItem('activeFilters' + APP_VERSION_SUFFIX)) || { collection: null, model: null, backdrop: null, pattern: null };
            accounts = JSON.parse(localStorage.getItem('giftSimAccounts' + APP_VERSION_SUFFIX)) || [];
            currentAccountTgId = parseInt(localStorage.getItem('giftSimCurrentAccountTgId' + APP_VERSION_SUFFIX), 10);
        }

        function saveClientSideState() {
            localStorage.setItem('activeFilters' + APP_VERSION_SUFFIX, JSON.stringify(activeFilters));
            localStorage.setItem('animationsEnabled' + APP_VERSION_SUFFIX, JSON.stringify(animationsEnabled));
            localStorage.setItem('showHiddenGifts' + APP_VERSION_SUFFIX, JSON.stringify(showHiddenGifts));
            localStorage.setItem('fullscreenEnabled' + APP_VERSION_SUFFIX, JSON.stringify(fullscreenEnabled));
        }

        function saveClientSideAccounts() {
            try {
                const accountsToStore = accounts.map(acc => ({
                    tg_id: acc.tg_id,
                    username: acc.username,
                    full_name: acc.full_name,
                    avatar_url: acc.avatar_url
                }));
                localStorage.setItem('giftSimAccounts' + APP_VERSION_SUFFIX, JSON.stringify(accountsToStore));
                localStorage.setItem('giftSimCurrentAccountTgId' + APP_VERSION_SUFFIX, currentAccountTgId);
            } catch (e) {
                console.error("Error saving client side accounts:", e);
                if (e.name === 'QuotaExceededError') {
                    tg.showAlert("A storage error occurred. Please clear your browser cache or app data if the problem persists.");
                }
            }
        }

        async function handleAddAccount() {
            const newTgId = Math.floor(Math.random() * 1e12) + 1;
            const newAccountData = {
                tg_id: newTgId,
                username: `testuser_${Math.random().toString(36).substring(2, 8)}`,
                full_name: `Test User ${accounts.length + 1}`,
                avatar_url: `https://i.pravatar.cc/140?u=${newTgId}`
            };

            try {
                // Ensure this new user is created on the backend
                await callBackend('/api/account', 'POST', newAccountData);
                // The switchAccount function will fetch the full data for this new user
                await switchAccount(newAccountData.tg_id, newAccountData);
                closeSidebar();
            } catch (error) {
                console.error(error);
            }
        }

        async function switchAccount(tgId, newAccountInfo = null) {
            if (currentAccountTgId === tgId) return;

            if (newAccountInfo && !accounts.find(acc => acc.tg_id === tgId)) {
                accounts.push(newAccountInfo);
            }

            currentAccountTgId = tgId;
            saveClientSideAccounts();
            await initializeTelegramUserAccount(); // This will fetch fresh data for the new currentAccountTgId
        }

        function renderAll() {
            if (viewingOwnProfile) {
                loadUserData();
                adminLoginButton.classList.toggle('hidden', currentAccountTgId !== ADMIN_TG_ID);
                buyGiftsTabButton.disabled = false;
                wallSubscriptionButton.classList.add('hidden');
            } else {
                buyGiftsTabButton.disabled = true;
                wallSubscriptionButton.classList.remove('hidden');
            }
            renderAccountsList();
            animationToggle.checked = animationsEnabled;
            fullscreenToggle.checked = fullscreenEnabled;
            showHiddenToggle.checked = showHiddenGifts;
            customGiftsToggle.checked = customGiftsEnabled;
            applyWornGiftStyles();
            renderProfileGifts();
            renderPosts();
        }

        function renderAccountsList() {
            accountsList.innerHTML = '';
            accounts.forEach(acc => {
                const li = document.createElement('li');
                li.dataset.accountId = acc.tg_id;
                li.innerHTML = `<img src="${acc.avatar_url}" alt="Avatar"> <span>${acc.full_name}</span>`;
                if (acc.tg_id === currentAccountTgId) {
                    li.classList.add('active');
                }
                li.addEventListener('click', async () => {
                    if (acc.tg_id !== currentAccountTgId) {
                        await switchAccount(acc.tg_id);
                    }
                    closeSidebar();
                });
                accountsList.appendChild(li);
            });
        }

        function openSidebar() {
            manageBackButton(true, closeSidebar);
            renderAccountsList();
            accountSidebar.classList.add('active');
            sidebarOverlay.classList.add('active');
        }

        function closeSidebar() {
            manageBackButton(false);
            accountSidebar.classList.remove('active');
            sidebarOverlay.classList.remove('active');
        }

        function applyWornGiftStyles() {
            const wornGift = ownedGifts.find(g => g.is_worn === true);

            destroyLottieAnimation(wornGiftIconContainer);
            if (wornGift && wornGift.is_collectible && wornGift.collectible_data) {
                const cd = wornGift.collectible_data;
                if (animationsEnabled && cd.lottieModelPath) {
                    playLottieAnimation(wornGiftIconContainer, cd.lottieModelPath, true);
                } else if (cd.modelImage) {
                    wornGiftIconContainer.innerHTML = `<img src="${cd.modelImage}" style="width:100%; height:100%; object-fit:contain;">`;
                }
                wornGiftIconContainer.classList.remove('hidden');
                const colors = cd.backdropColors;
                if (colors) profileTopSection.style.background = `radial-gradient(circle at 50% 0%, ${colors.centerColor} 0%, ${colors.edgeColor} 100%)`;
                else profileTopSection.style.background = 'var(--app-profile-gradient-fallback)';
                if (cd.patternImage) {
                    profileHeaderPatternOverlay.style.backgroundImage = `url('${cd.patternImage}')`;
                    profileHeaderPatternOverlay.style.opacity = '0.07';
                } else profileHeaderPatternOverlay.style.backgroundImage = 'none';
            } else {
                wornGiftIconContainer.classList.add('hidden');
                wornGiftIconContainer.innerHTML = '';
                profileTopSection.style.background = 'var(--app-profile-gradient-fallback)';
                profileHeaderPatternOverlay.style.backgroundImage = 'none';
            }
        }

        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            if(pageId === 'buy-gifts-page') {
                renderAvailableGifts();
                manageBackButton(true, () => showPage('profile-page'));
            } else {
                manageBackButton(false);
            }
        }

        async function fetchGiftPrices() {
            try {
                const response = await fetch(PRICES_JSON_URL, { cache: 'no-cache' });
                if (!response.ok) throw new Error(`HTTP error ${response.status}`);
                giftPrices = await response.json();
            } catch (error) {
                console.error("Could not fetch gift prices:", error);
                giftPrices = {};
            }
        }

        async function fetchAvailableGifts() {
            buyGiftsLoadingSpinner.classList.remove('hidden');
            buyGiftsGrid.innerHTML = '';
            try {
                const response = await fetch(GIFTS_JSON_URL, { cache: 'no-cache' });
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                allAvailableGifts = await response.json();

                for (const giftName in CUSTOM_GIFTS_DATA) {
                    const customGift = CUSTOM_GIFTS_DATA[giftName];
                    if (customGift && customGift.id) {
                        allAvailableGifts[customGift.id] = giftName;
                    }
                }
            } catch (error) {
                console.error("Could not load available gifts:", error);
                buyGiftsGrid.innerHTML = `<p class="empty-grid-message" style="width:100%;">Could not load gifts. Please try again later.</p>`;
            } finally {
                buyGiftsLoadingSpinner.classList.add('hidden');
            }
        }

        function renderAvailableGifts() {
            buyGiftsGrid.innerHTML = '';
            let giftsToRender = { ...allAvailableGifts };

            if (!customGiftsEnabled) {
                giftsToRender = Object.fromEntries(
                    Object.entries(allAvailableGifts).filter(([id, name]) => !CUSTOM_GIFTS_DATA[name])
                );
            }

            if (Object.keys(giftsToRender).length === 0) {
                buyGiftsGrid.innerHTML = `<p class="empty-grid-message" style="width:100%;">No gifts available right now.</p>`;
                return;
            }

            for (const id in giftsToRender) {
                const name = giftsToRender[id];
                let originalImageUrl, lottiePath;

                if (CUSTOM_GIFTS_DATA[name]) {
                    originalImageUrl = CUSTOM_GIFTS_DATA[name].defaultImage;
                    lottiePath = null;
                } else {
                    originalImageUrl = `${CDN_BASE_URL}originals/${id}/Original.png`;
                    lottiePath = `${CDN_BASE_URL}originals/${id}/Original.json`;
                }

                const price = giftPrices[name];
                const item = document.createElement('div');
                item.className = 'buy-gift-item';
                item.dataset.id = id; item.dataset.name = name;
                item.dataset.originalImage = originalImageUrl;
                if (lottiePath) item.dataset.lottiePath = lottiePath;

                const priceHTML = price
                    ? `<div class="gift-price has-price"><img src="${STAR_ICON_URL}" class="star-icon" alt="Star"/> ${price}</div>`
                    : `<div class="gift-price">Free</div>`;

                item.innerHTML = `
                    <div class="image-container">
                        <div class="lottie-animation-container" style="display:none;"></div>
                        <img class="static-image-fallback" src="${originalImageUrl}" alt="${name}" loading="lazy" onerror="this.style.display='none'; this.nextElementSibling.innerHTML = '🖼️';">
                    </div>
                    <div class="gift-name">${name}</div>
                    ${priceHTML}
                    <div class="limited-label">Limited</div>
                `;
                item.addEventListener('click', () => buyGift(id, name, originalImageUrl, lottiePath, 1));
                let buyItemLongPressTimer;
                item.addEventListener('touchstart', (e) => { buyItemLongPressTimer = setTimeout(() => openBuyMultipleModal(id, name, originalImageUrl, lottiePath), 700); }, { passive: true });
                item.addEventListener('touchend', () => clearTimeout(buyItemLongPressTimer));
                item.addEventListener('touchmove', () => clearTimeout(buyItemLongPressTimer));
                item.addEventListener('contextmenu', (e) => { e.preventDefault(); openBuyMultipleModal(id, name, originalImageUrl, lottiePath); });
                observeLottieElement(item);
                buyGiftsGrid.appendChild(item);
            }
        }

        function getGiftCountText(count) {
            return count === 1 ? `${count} gift` : `${count} gifts`;
        }

        function updateAllAnimationsState() {
            document.querySelectorAll('.lottie-animation-container').forEach(container => {
                const parentCard = container.closest('[data-lottie-path]');
                const modal = container.closest('.modal-overlay.active');

                if (animationsEnabled) {
                    if (parentCard && parentCard.offsetParent !== null) { observeLottieElement(parentCard); }
                    else if (container.id === 'worn-gift-icon-container') { applyWornGiftStyles(); }
                    else if (modal) {
                         if (container.id === 'modal-lottie-gift-original' && giftDetailModal.classList.contains('active')) {
                             const gift = ownedGifts.find(g => g.instance_id === giftDetailModal.dataset.instanceId);
                             if (gift && gift.lottie_path) playLottieAnimation(container, gift.lottie_path, true);
                         }
                         if (container.id === 'modal-lottie-collectible-model' && collectibleDetailModal.classList.contains('active')) {
                             const gift = ownedGifts.find(g => g.instance_id === collectibleDetailModal.dataset.instanceId) || currentlySortedGifts.find(g => g.instance_id === collectibleDetailModal.dataset.instanceId);
                             if (gift?.collectible_data?.lottieModelPath) playLottieAnimation(container, gift.collectible_data.lottieModelPath, true);
                         }
                    } else if (container.closest('#profile-top-pinned-gifts')) { renderTopPinnedGiftsPreview(); }
                } else {
                    destroyLottieAnimation(container);
                    if (parentCard) {
                        const staticFallback = parentCard.querySelector('.static-image-fallback');
                        if (staticFallback) staticFallback.style.display = 'block';
                        container.style.display = 'none';
                    }
                }
            });
            applyWornGiftStyles();
        }

        function renderProfileGifts() {
            Array.from(giftsGrid.children).forEach(child => unobserveLottieElement(child));
            giftsGrid.innerHTML = '';

            const baseGifts = showHiddenGifts ? ownedGifts : ownedGifts.filter(g => !g.is_hidden);

            const filteredGifts = baseGifts.filter(gift => {
                if (activeFilters.collection && gift.gift_type_id !== activeFilters.collection) return false;
                if (gift.is_collectible && gift.collectible_data) {
                    if (activeFilters.model && gift.collectible_data.model?.name !== activeFilters.model) return false;
                    if (activeFilters.backdrop && gift.collectible_data.backdrop?.name !== activeFilters.backdrop) return false;
                    if (activeFilters.pattern && gift.collectible_data.pattern?.name !== activeFilters.pattern) return false;
                } else if (activeFilters.model || activeFilters.backdrop || activeFilters.pattern) return false;
                return true;
            });

            const sortedGifts = [...filteredGifts].sort((a, b) => {
                if (a.is_pinned && !b.is_pinned) return -1;
                if (!a.is_pinned && b.is_pinned) return 1;
                if (a.is_pinned && b.is_pinned) {
                    if (a.pin_order != null && b.pin_order != null) return a.pin_order - b.pin_order;
                    if (a.pin_order != null) return -1;
                    if (b.pin_order != null) return 1;
                }
                return new Date(b.acquired_date) - new Date(a.acquired_date);
            });

            currentlySortedGifts = sortedGifts;

            profileGiftCountSubtext.textContent = getGiftCountText(filteredGifts.length);
            if (ownedGifts.length > 0 && filteredGifts.length !== ownedGifts.length) {
                profileGiftCountSubtext.textContent += ` of ${ownedGifts.length}`;
            }

            if (currentlySortedGifts.length === 0) {
                giftsGrid.style.display = 'flex'; giftsGrid.style.alignItems = 'center'; giftsGrid.style.justifyContent = 'center';
                let emptyMessage = "You don't have any gifts yet.";
                if (ownedGifts.length > 0) {
                    emptyMessage = "No gifts match the selected filters.";
                    if (!showHiddenGifts && ownedGifts.some(g => g.is_hidden)) {
                        emptyMessage += " Some gifts might be hidden.";
                    }
                } else if (!viewingOwnProfile) {
                     emptyMessage = "This user hasn't received any gifts yet."
                }
                giftsGrid.innerHTML = `<p class="empty-grid-message" style="width:100%;">${emptyMessage}</p>`;
            } else {
                giftsGrid.style.display = 'grid';
                currentlySortedGifts.forEach(gift => {
                    const card = createGiftCardDOM(gift);
                    giftsGrid.appendChild(card);
                    observeLottieElement(card);
                });
            }
            renderTopPinnedGiftsPreview();
            renderGiftsTabPreview();
            updateActionToolbarVisibility();
        }

        function createGiftCardDOM(gift) {
            const card = document.createElement('div');
            card.className = 'gift-card';
            card.dataset.instanceId = gift.instance_id;
            card.dataset.pinned = gift.is_pinned;

            if (gift.is_hidden) card.classList.add('is-hidden');
            if (gift.is_pending) card.classList.add('is-pending');


            const imageContainer = document.createElement('div');
            imageContainer.className = 'image-container';
            const lottieContainer = document.createElement('div');
            lottieContainer.className = 'lottie-animation-container';
            lottieContainer.style.display = 'none';
            const staticImage = document.createElement('img');
            staticImage.className = 'static-image-fallback';
            staticImage.loading = 'lazy';
            let lottiePathForCard = null;

            if (gift.is_collectible && gift.collectible_data) {
                const cd = gift.collectible_data;
                staticImage.src = cd.modelImage || gift.original_image_url;
                staticImage.alt = cd.model?.name || gift.gift_name;
                lottiePathForCard = cd.lottieModelPath;

                const labelDiv = document.createElement('div');
                labelDiv.className = 'top-right-label';
                if (gift.is_pinned) {
                    labelDiv.textContent = `#${gift.collectible_number.toLocaleString()}`;
                } else if (cd.supply) {
                    labelDiv.textContent = `1 of ${(cd.supply / 1000).toFixed(1)}K`;
                }
                card.appendChild(labelDiv);

                const bgDiv = document.createElement('div'); bgDiv.className = 'gift-card-bg-pattern';
                if (cd.backdropColors) bgDiv.style.background = `radial-gradient(circle, ${cd.backdropColors.centerColor}, ${cd.backdropColors.edgeColor})`;
                else bgDiv.style.background = 'linear-gradient(45deg, #2a3745, #17212b)';
                card.appendChild(bgDiv);

                if (cd.patternImage) { const pOverlay = document.createElement('div'); pOverlay.className = 'gift-card-pattern-overlay'; pOverlay.style.backgroundImage = `url('${cd.patternImage}')`; card.appendChild(pOverlay); }
            } else {
                staticImage.src = gift.original_image_url; staticImage.alt = gift.gift_name;
                lottiePathForCard = gift.lottie_path;
            }
            if (lottiePathForCard) card.dataset.lottiePath = lottiePathForCard;
            staticImage.onerror = function() { this.style.display='none'; lottieContainer.innerHTML = '🖼️';};
            imageContainer.appendChild(lottieContainer); imageContainer.appendChild(staticImage);
            card.appendChild(imageContainer);
            if (gift.is_pinned && !selectionModeActive) {
                const pinDiv = document.createElement('div'); pinDiv.className = 'pin-indicator';
                pinDiv.innerHTML = PIN_ICON_SVG;
                pinDiv.querySelector('svg').style.transform = 'rotate(25deg)';
                card.appendChild(pinDiv);
            }

            if (selectionModeActive) {
                const checkbox = document.createElement('div');
                checkbox.className = 'selection-checkbox';
                card.appendChild(checkbox);
                if (selectedGiftIds.has(gift.instance_id)) {
                    card.classList.add('selected');
                }
                card.onclick = () => toggleGiftSelection(gift.instance_id);
            } else if (reorderModeActive) {
                card.style.cursor = gift.is_pinned ? 'grab' : 'default';
            } else {
                card.onclick = () => openGiftDetailByInstanceId(gift.instance_id);
                if (viewingOwnProfile) setupLongPress(card, gift);
            }

            return card;
        }

        function renderTopPinnedGiftsPreview() {
            Array.from(profileTopPinnedGifts.children).forEach(childLottieContainer => destroyLottieAnimation(childLottieContainer));
            profileTopPinnedGifts.innerHTML = '';

            const pinnedGifts = ownedGifts.filter(g => g.is_pinned && !g.is_hidden)
                                          .sort((a,b) => a.pin_order - b.pin_order);

            pinnedGifts.slice(0, 7).forEach(gift => {
                const container = document.createElement('div');
                container.className = 'pinned-gift-item';
                container.dataset.instanceId = gift.instance_id;
                container.addEventListener('click', () => openGiftDetailByInstanceId(gift.instance_id));
                let lottiePathForPinned = null, imageForPinned = gift.original_image_url;
                if (gift.is_collectible && gift.collectible_data) {
                    lottiePathForPinned = gift.collectible_data.lottieModelPath;
                    imageForPinned = gift.collectible_data.modelImage || gift.original_image_url;
                } else if (gift.lottie_path) {
                    lottiePathForPinned = gift.lottie_path;
                }
                if (animationsEnabled && lottiePathForPinned) {
                    container.classList.add('lottie-animation-container');
                    playLottieAnimation(container, lottiePathForPinned, true);
                } else {
                     container.innerHTML = `<img src="${imageForPinned}" alt="${gift.gift_name}" style="width:100%; height:100%; object-fit:contain;" onerror="this.parentElement.innerHTML = '🎁'">`;
                }
                profileTopPinnedGifts.appendChild(container);
            });
        }
        
        function renderGiftsTabPreview() {
            giftsTabPreviewContainer.innerHTML = '';
            const uniqueGiftTypes = new Set();
            const giftsToShow = [];
            
            for (const gift of currentlySortedGifts) {
                if (!uniqueGiftTypes.has(gift.gift_type_id)) {
                    uniqueGiftTypes.add(gift.gift_type_id);
                    giftsToShow.push(gift);
                }
                if (giftsToShow.length >= 3) break;
            }

            giftsToShow.forEach(gift => {
                const img = document.createElement('img');
                let imageUrl = gift.original_image_url;
                if (gift.is_collectible && gift.collectible_data) {
                    imageUrl = gift.collectible_data.modelImage || gift.original_image_url;
                }
                img.src = imageUrl;
                img.alt = gift.gift_name;
                img.onerror = () => { img.style.display = 'none'; };
                giftsTabPreviewContainer.appendChild(img);
            });
        }
        
        function updateActionToolbarVisibility() {
            const hasNonCollectible = ownedGifts.some(g => !g.is_collectible);
            const hasActiveFilter = Object.values(activeFilters).some(f => f !== null);

            const showUpgradeAll = hasNonCollectible && viewingOwnProfile && !reorderModeActive && !selectionModeActive;
            const showFilterExit = hasActiveFilter && !reorderModeActive && !selectionModeActive;

            upgradeAllGiftsButton.classList.toggle('hidden', !showUpgradeAll);
            exitFilterModeButton.classList.toggle('hidden', !showFilterExit);

            const isAnyButtonVisible = showUpgradeAll || showFilterExit || reorderModeActive || selectionModeActive;
            profileGiftsActionsWrapper.classList.toggle('hidden', !isAnyButtonVisible);
        }

        function openBuyMultipleModal(id, name, originalImage, lottiePath) {
            currentGiftToBuyMultiple = { id, name, originalImage, lottiePath };
            buyMultipleModalTitle.textContent = `Buy "${name}"`;
            buyMultipleGiftName.textContent = `Enter quantity for "${name}"`;
            buyMultipleQuantityInput.value = "1";
            openModal(buyMultipleModal);
            buyMultipleQuantityInput.focus();
        }

        async function buyGift(id, name, originalImage, lottiePath, quantity = 1) {
            if (ownedGifts.length + quantity > GIFT_LIMIT_PER_USER) {
                tg.showAlert(`Cannot buy ${quantity} gifts. You have ${ownedGifts.length} gifts and the limit is ${GIFT_LIMIT_PER_USER}.`);
                return;
            }

            // --- Asynchronous UI Update ---
            const tempGifts = [];
            for (let i = 0; i < quantity; i++) {
                const tempGift = {
                    instance_id: `temp_${generateUniqueId()}`,
                    owner_id: currentAccountTgId,
                    gift_type_id: id,
                    gift_name: name,
                    original_image_url: originalImage,
                    lottie_path: lottiePath,
                    acquired_date: new Date().toISOString(),
                    is_collectible: false,
                    is_pending: true
                };
                tempGifts.push(tempGift);
            }
            ownedGifts.unshift(...tempGifts);
            renderProfileGifts();
            showPage('profile-page');
            switchTab('gifts');
            tg.HapticFeedback.notificationOccurred('success');
            // --- End Asynchronous UI Update ---
            
            try {
                const promises = tempGifts.map((tempGift, index) => {
                    const newInstanceId = generateUniqueId();
                    return callBackend('/api/gifts', 'POST', {
                        instance_id: newInstanceId,
                        owner_id: tempGift.owner_id,
                        gift_type_id: tempGift.gift_type_id,
                        gift_name: tempGift.gift_name,
                        original_image_url: tempGift.original_image_url,
                        lottie_path: tempGift.lottie_path
                    }).then(() => {
                        const giftIndex = ownedGifts.findIndex(g => g.instance_id === tempGift.instance_id);
                        if (giftIndex !== -1) {
                            ownedGifts[giftIndex].instance_id = newInstanceId;
                            delete ownedGifts[giftIndex].is_pending;
                        }
                    });
                });
                await Promise.all(promises);
                await initializeTelegramUserAccount(); // Final sync with backend
            } catch (error) {
                tg.HapticFeedback.notificationOccurred('error');
                await initializeTelegramUserAccount(); // Re-sync to remove failed gifts
            }
        }

        async function handleConfirmBuyMultiple() {
            if (!currentGiftToBuyMultiple) return;
            const quantity = parseInt(buyMultipleQuantityInput.value, 10);
            if (isNaN(quantity) || quantity < 1) { tg.showAlert("Please enter a valid quantity."); return; }

            closeModal(buyMultipleModal);
            await buyGift(currentGiftToBuyMultiple.id, currentGiftToBuyMultiple.name, currentGiftToBuyMultiple.originalImage, currentGiftToBuyMultiple.lottiePath, quantity);
            currentGiftToBuyMultiple = null;
        }

        function getGiftDeepLink(gift) {
            const botUsername = "upgradeDemoBot";
            const appShortName = "upgrade";
            const giftTypeIdForLink = gift.gift_type_id;
            const numberForLink = gift.collectible_number;
            return `https://t.me/${botUsername}/${appShortName}?startapp=gift${giftTypeIdForLink}-${numberForLink}`;
        }

        function openGiftDetailByInstanceId(instanceId) {
            const gift = currentlySortedGifts.find(g => g.instance_id === instanceId) || ownedGifts.find(g => g.instance_id === instanceId);
            if (!gift) return;
            tapCount = 0;

            if (gift.is_collectible) {
                openModal(collectibleDetailModal, gift);
            } else {
                openModal(giftDetailModal, gift);
            }
        }

        async function upgradeSingleGiftLogic(giftToUpgrade, customPattern = null) {
            if (giftToUpgrade.is_collectible) return { status: 'skipped' };
            
            if (CUSTOM_GIFTS_DATA[giftToUpgrade.gift_name] && !customGiftsEnabled) {
                return { status: 'failed', error: "Custom Gifts disabled" };
            }

            try {
                const payload = { instance_id: giftToUpgrade.instance_id };
                if (customPattern) {
                    if (customPattern.is_base64) {
                        payload.custom_pattern_base64 = customPattern.data;
                    } else {
                        payload.custom_pattern = customPattern.data;
                    }
                }
                
                const upgradedGiftData = await callBackend('/api/gifts/upgrade', 'POST', payload);

                const giftIndex = ownedGifts.findIndex(g => g.instance_id === upgradedGiftData.instance_id);
                if(giftIndex !== -1) ownedGifts[giftIndex] = upgradedGiftData;
                
                return { ...upgradedGiftData, status: 'success' };
            } catch (error) {
                console.error(`Upgrade error for "${giftToUpgrade.gift_name}" (ID: ${giftToUpgrade.instance_id}):`, error);
                return { status: 'failed', error: error.message };
            }
        }

        async function handleSingleGiftUpgradeFromModal(instanceId) {
            const gift = ownedGifts.find(g => g.instance_id === instanceId);
            if (!gift || gift.is_collectible) return;

            if (CUSTOM_GIFTS_DATA[gift.gift_name] && !customGiftsEnabled) {
                tg.showAlert("Please enable Custom Gifts in settings to upgrade this item.");
                return;
            }

            upgradeGiftDetailModalButton.textContent = 'Upgrading...';
            upgradeGiftDetailModalButton.disabled = true;

            try {
                const result = await upgradeSingleGiftLogic(gift);
                if (result.status === 'success') {
                    renderProfileGifts();
                    tg.HapticFeedback.notificationOccurred('success');
                    closeModal(giftDetailModal);
                    openGiftDetailByInstanceId(gift.instance_id);
                }
            } catch (error) {
                console.error("Error during single gift upgrade:", error);
            } finally {
                upgradeGiftDetailModalButton.textContent = '✨ Upgrade';
                upgradeGiftDetailModalButton.disabled = false;
            }
        }

        async function handleUpgradeAllGifts() {
            const giftsToUpgrade = ownedGifts.filter(g => !g.is_collectible);
            if (giftsToUpgrade.length === 0) { tg.showAlert("No gifts to upgrade."); return; }

            if (ownedGifts.length > GIFT_LIMIT_PER_USER) {
                tg.showAlert(`Cannot upgrade all gifts. You have ${ownedGifts.length} gifts and the limit is ${GIFT_LIMIT_PER_USER}.`);
                return;
            }

            const originalButtonText = upgradeAllGiftsButton.textContent;
            upgradeAllGiftsButton.disabled = true;
            let successCount = 0, failureCount = 0;
            for (let i = 0; i < giftsToUpgrade.length; i++) {
                const gift = giftsToUpgrade[i];
                upgradeAllGiftsButton.textContent = `Upgrading (${i + 1}/${giftsToUpgrade.length})...`;
                const cardElement = giftsGrid.querySelector(`.gift-card[data-instance-id="${gift.instance_id}"]`);
                if (cardElement) cardElement.classList.add('is-updating');
                const result = await upgradeSingleGiftLogic(gift);
                if (cardElement) cardElement.classList.remove('is-updating');
                if (result.status === 'success') {
                    successCount++;
                    renderProfileGifts();
                } else if (result.status === 'failed') failureCount++;
                if (giftsToUpgrade.length > 1 && i < giftsToUpgrade.length - 1) await new Promise(resolve => setTimeout(resolve, 200));
            }

            let summaryMessage = `Upgrade complete.\nSucceeded: ${successCount}`;
            if (failureCount > 0) summaryMessage += `\nFailed: ${failureCount}`;
            tg.showAlert(summaryMessage);
            tg.HapticFeedback.notificationOccurred(successCount > 0 ? 'success' : (failureCount > 0 ? 'error' : 'warning'));
            updateActionToolbarVisibility();
            if (upgradeAllGiftsButton) { upgradeAllGiftsButton.textContent = originalButtonText; upgradeAllGiftsButton.disabled = false; }
        }

        function openModal(modalElement, data = null) {
            if (!modalElement) return;

            if(data) modalElement.dataset.instanceId = data.instance_id;

            if (modalElement.id === 'gift-detail-modal' && data) {
                populateGiftDetailModal(data);
            } else if (modalElement.id === 'collectible-detail-modal' && data) {
                populateCollectibleDetailModal(data);
            } else if (modalElement.id === 'giveaway-setup-modal') {
                 populateGiveawaySetupModal();
            } else if (modalElement.id === 'subscription-modal' && data) {
                loadSubscriptionState(data.tg_id);
            } else if (modalElement.id === 'reaction-users-modal' && data) {
                populateReactionUsersModal(data.postId, data.emoji);
            }

            modalElement.classList.add('active');
            manageBackButton(true, () => closeModal(modalElement));
        }

        function closeModal(modalElement) {
            if (!modalElement) return;
            const handler = tg._backButtonCallback;
            manageBackButton(false, handler);

            modalElement.classList.remove('active');

            if (modalElement.id === 'gift-detail-modal') destroyLottieAnimation(modalLottieGiftOriginal);
            if (modalElement.id === 'collectible-detail-modal') {
                destroyLottieAnimation(modalLottieCollectibleModel);
                if (patternContainerDynamic) patternContainerDynamic.innerHTML = '';
            }
            if (modalElement.id === 'custom-buy-modal') giftCreationQueue = [];
            if (modalElement.id === 'giveaway-setup-modal') selectedGiveawayGifts.clear();
        }

        function populateGiftDetailModal(gift) {
            modalGiftName.textContent = "Saved Gift";
            destroyLottieAnimation(modalLottieGiftOriginal);
            modalGiftImageStatic.style.display = 'block'; modalLottieGiftOriginal.style.display = 'none';
            if (animationsEnabled && gift.lottie_path) {
                playLottieAnimation(modalLottieGiftOriginal, gift.lottie_path, true);
                modalGiftImageStatic.style.display = 'none'; modalLottieGiftOriginal.style.display = 'flex';
            } else {
                modalGiftImageStatic.src = gift.original_image_url;
                modalGiftImageStatic.onerror = function() { this.src = `https://i.pravatar.cc/100?u=err${generateUniqueId()}`; };
            }
            modalGiftDescription1.textContent = `Add "${gift.gift_name}" to your profile or upgrade it.`;
            modalGiftDescription2.textContent = "Only you can see the sender's name.";
            modalGiftInfo.innerHTML = `
                <div class="info-row"><span class="info-label">Date</span><span class="info-value">${new Date(gift.acquired_date).toLocaleDateString('en-US', {day:'numeric', month:'short', year:'numeric', hour:'2-digit', minute:'2-digit'})}</span></div>
                <div class="info-row"><span class="info-label">Price</span><span class="info-value">Free</span></div>
                <div class="info-row"><span class="info-label">Availability</span><span class="info-value">Limited</span></div>`;
            
            upgradeGiftDetailModalButton.dataset.instanceId = gift.instance_id;
            upgradeGiftDetailModalButton.disabled = gift.owner_id !== currentAccountTgId;
        }
        
        function openTelegramProfile(event, username) {
            event.stopPropagation(); // Prevent parent click
            event.preventDefault();
            tg.openTelegramLink(`https://t.me/${username}`);
        }

        async function populateCollectibleDetailModal(gift) {
            const cd = gift.collectible_data;
            modalCollectibleMainName.textContent = cd.model?.name || gift.gift_name;

            const numberForLink = gift.collectible_number;
            const authorUsername = cd.author || (CUSTOM_GIFTS_DATA[gift.gift_name] ? 'Vasiliy939' : null);
            
            let subtextHTML = `Collectible #${numberForLink.toLocaleString()}`;
            if (authorUsername) {
                subtextHTML += ` by <a href="#" onclick="openTelegramProfile(event, '${authorUsername}')">@${authorUsername}</a>`;
            }
            modalCollectibleNumberSubtext.innerHTML = `<a id="collectible-link-copier" href="#">${subtextHTML}</a>`;

            document.getElementById('collectible-link-copier').onclick = (e) => { 
                if (e.target.tagName !== 'A' || e.target.id === 'collectible-link-copier') {
                    e.preventDefault(); 
                    copyGiftLink(gift); 
                }
            };

            if (patternContainerDynamic) patternContainerDynamic.innerHTML = '';

            if (collectibleDisplayArea && cd.backdropColors) {
                collectibleDisplayArea.style.background = `radial-gradient(circle at 50% 0%, ${cd.backdropColors.centerColor} 0%, ${cd.backdropColors.edgeColor} 100%)`;
            } else {
                collectibleDisplayArea.style.background = 'var(--tg-theme-secondary-bg-color)';
            }

            if (cd.patternImage && patternContainerDynamic) {
                setTimeout(() => {
                    if(!patternContainerDynamic) return;
                    const containerWidth = patternContainerDynamic.offsetWidth;
                    const containerHeight = patternContainerDynamic.offsetHeight;
                    const centerX = containerWidth / 2;
                    const centerY = containerHeight / 2 - 30;

                    const createPattern = (styles) => {
                        const img = document.createElement('img');
                        img.src = cd.patternImage;
                        img.className = 'dynamic-pattern-instance';
                        img.crossOrigin = 'Anonymous';
                        const baseRotation = -25;
                        img.style.transform = `translate(-50%, -50%) rotate(${baseRotation}deg) scale(${styles.scale || 0.9})`;
                        img.style.left = `${styles.left}px`;
                        img.style.top = `${styles.top}px`;
                        patternContainerDynamic.appendChild(img);
                    };

                    const circleRadius = Math.min(containerWidth, containerHeight) / 3.2;
                    const numCirclePatterns = 10;
                    for (let i = 0; i < numCirclePatterns; i++) {
                        const angle = (i / numCirclePatterns) * 2 * Math.PI;
                        const x = centerX + circleRadius * Math.cos(angle);
                        const y = centerY + circleRadius * Math.sin(angle);
                        createPattern({ left: x, top: y, scale: 0.9 });
                    }
                }, 50);
            }

            destroyLottieAnimation(modalLottieCollectibleModel);
            modalCollectibleModelImgStatic.style.display = 'block';
            modalLottieCollectibleModel.style.display = 'none';
            if (animationsEnabled && cd.lottieModelPath) {
                playLottieAnimation(modalLottieCollectibleModel, cd.lottieModelPath, true);
                modalCollectibleModelImgStatic.style.display = 'none';
                modalLottieCollectibleModel.style.display = 'flex';
            } else {
                 modalCollectibleModelImgStatic.src = cd.modelImage || gift.original_image_url;
                 modalCollectibleModelImgStatic.onerror = function() { this.src = `https://i.pravatar.cc/200?u=err${generateUniqueId()}`; };
            }

            let ownerName, ownerAvatar, ownerUsername;
            const isOwner = (gift.owner_id === currentAccountTgId);
            if(isOwner) {
                const myAccount = accounts.find(acc => acc.tg_id === currentAccountTgId);
                ownerName = myAccount.full_name;
                ownerAvatar = myAccount.avatar_url;
                ownerUsername = myAccount.username;
            } else {
                ownerName = gift.owner_name || 'Test Account';
                ownerAvatar = gift.owner_avatar || `https://i.pravatar.cc/140?u=${generateUniqueId()}`;
                ownerUsername = gift.owner_username;
            }

            const ownerDisplayHTML = ownerUsername
                ? `<a href="#" onclick="event.preventDefault(); displayUserProfile('${ownerUsername}')"><img src="${ownerAvatar}" alt="" class="owner-avatar">${ownerName}</a>`
                : `<span><img src="${ownerAvatar}" alt="" class="owner-avatar">${ownerName}</span>`;

            modalCollectibleInfoTable.innerHTML = `
                <div class="info-row"><span class="info-label">Owner</span><span class="info-value">${ownerDisplayHTML}</span></div>
                <div class="info-row"><span class="info-label">Model</span><span id="collectible-model-value" class="info-value clickable-info">${cd.model?.name || 'N/A'} <span class="rarity-chip">${formatRarity(cd.model?.rarityPermille || 0)}</span></span></div>
                <div class="info-row"><span class="info-label">Backdrop</span><span id="collectible-backdrop-value" class="info-value clickable-info">${cd.backdrop?.name || 'N/A'} <span class="rarity-chip">${formatRarity(cd.backdrop?.rarityPermille || 0)}</span></span></div>
                <div class="info-row"><span class="info-label">Symbol</span><span id="collectible-pattern-value" class="info-value clickable-info">${cd.pattern?.name || 'N/A'} <span class="rarity-chip">${formatRarity(cd.pattern?.rarityPermille || 0)}</span></span></div>
                <div class="info-row"><span class="info-label">Supply</span><span class="info-value">${cd.supply?.toLocaleString() || 'N/A'} issued</span></div>`;

            collectibleActionWear.style.display = isOwner ? 'flex' : 'none';
            collectibleActionSell.style.display = isOwner ? 'flex' : 'none';
            collectibleActionTransfer.style.display = isOwner ? 'flex' : 'none';
            collectibleMenuButton.style.display = isOwner ? 'flex' : 'none';
            hideLinkInModal.style.display = isOwner ? 'inline' : 'none';

            collectibleActionWear.querySelector('.text').textContent = (gift.is_worn === true) ? 'Take Off' : 'Wear';

            const modelValueEl = document.getElementById('collectible-model-value');
            const backdropValueEl = document.getElementById('collectible-backdrop-value');
            const patternValueEl = document.getElementById('collectible-pattern-value');
            if (modelValueEl) modelValueEl.addEventListener('click', (e) => handleTripleTap(e, 'model', gift.collectible_data.model?.name));
            if (backdropValueEl) backdropValueEl.addEventListener('click', (e) => handleTripleTap(e, 'backdrop', gift.collectible_data.backdrop?.name));
            if (patternValueEl) patternValueEl.addEventListener('click', (e) => handleTripleTap(e, 'pattern', gift.collectible_data.pattern?.name));
        }

        let currentLongPressGift = null; let longPressTimer;
        function setupLongPress(element, gift) {
            element.addEventListener('touchstart', (e) => {
                clearTimeout(longPressTimer);
                longPressTimer = setTimeout(() => openLongPressMenu(gift, e.touches[0]), 500);
            }, { passive: false });
            element.addEventListener('touchend', () => clearTimeout(longPressTimer));
            element.addEventListener('touchmove', () => clearTimeout(longPressTimer));
            element.addEventListener('contextmenu', (e) => { e.preventDefault(); clearTimeout(longPressTimer); openLongPressMenu(gift, e); });
        }
        function openLongPressMenu(gift, eventCoords) {
            currentLongPressGift = gift;

            const isOwner = (gift.owner_id === currentAccountTgId);

            if (!gift.is_collectible) {
                menuPinAction.textContent = 'Pin (Collectibles only)';
                menuPinAction.classList.add('disabled');
                menuShareImageAction.classList.add('hidden');
                menuCopyLinkAction.classList.add('hidden');
                menuReorderAction.classList.add('hidden');
            } else {
                const isPinned = gift.is_pinned;
                menuPinAction.textContent = isPinned ? 'Unpin' : 'Pin';
                menuPinAction.classList.toggle('disabled', !isOwner);
                menuShareImageAction.classList.remove('hidden');
                menuCopyLinkAction.classList.remove('hidden');
                menuReorderAction.classList.toggle('hidden', !isPinned || !isOwner);
            }

            menuHideAction.textContent = gift.is_hidden ? 'Unhide' : 'Hide';
            menuHideAction.classList.toggle('disabled', !isOwner);
            menuDeleteAction.classList.toggle('disabled', !isOwner);

            longPressMenu.style.top = `${Math.min(eventCoords.clientY, window.innerHeight - longPressMenu.offsetHeight - 10)}px`;
            longPressMenu.style.left = `${Math.min(eventCoords.clientX, window.innerWidth - longPressMenu.offsetWidth - 10)}px`;
            longPressMenu.classList.remove('hidden');
            document.addEventListener('click', closeLongPressMenuOnClickOutside, { once: true, capture: true });
        }

        function openCollectibleMenu(gift, eventCoords) {
            currentLongPressGift = gift;
            const isOwner = (gift.owner_id === currentAccountTgId);

            if (!gift.is_collectible) return;

            const isPinned = gift.is_pinned;
            menuPinAction.textContent = isPinned ? 'Unpin' : 'Pin';
            menuPinAction.classList.toggle('disabled', !isOwner);

            menuHideAction.textContent = gift.is_hidden ? 'Unhide' : 'Hide';
            menuHideAction.classList.toggle('disabled', !isOwner);
            menuDeleteAction.classList.toggle('disabled', !isOwner);
            menuShareImageAction.classList.remove('hidden');
            menuCopyLinkAction.classList.remove('hidden');
            menuReorderAction.classList.toggle('hidden', !isPinned || !isOwner);

            const menuWidth = longPressMenu.offsetWidth || 220;
            const menuHeight = longPressMenu.offsetHeight || 150;
            let x = window.innerWidth - menuWidth - 20;
            let y = (collectibleMenuButton.getBoundingClientRect().top + collectibleMenuButton.offsetHeight + 10);
            longPressMenu.style.top = `${Math.min(y, window.innerHeight - menuHeight - 10)}px`;
            longPressMenu.style.left = `${Math.min(x, window.innerWidth - menuWidth - 10)}px`;
            longPressMenu.classList.remove('hidden');
            document.addEventListener('click', closeLongPressMenuOnClickOutside, { once: true, capture: true });
        }

        function closeLongPressMenuOnClickOutside(event) {
            if (!longPressMenu.contains(event.target) && event.target !== longPressMenu) { longPressMenu.classList.add('hidden'); currentLongPressGift = null; }
        }

        function handlePinAction() {
            if (!currentLongPressGift || !currentLongPressGift.is_collectible) {
                tg.showAlert("Only collectible gifts can be pinned.");
                longPressMenu.classList.add('hidden'); currentLongPressGift = null; return;
            }
            if (currentLongPressGift.owner_id !== currentAccountTgId) {
                tg.showAlert("You can only pin gifts you own.");
                longPressMenu.classList.add('hidden'); currentLongPressGift = null; return;
            }
            if (currentLongPressGift.is_hidden) {
                tg.showAlert("Cannot pin a hidden gift.");
                longPressMenu.classList.add('hidden'); return;
            }

            const giftInstanceId = currentLongPressGift.instance_id;
            const isCurrentlyPinned = currentLongPressGift.is_pinned;
            const giftToUpdate = ownedGifts.find(g => g.instance_id === giftInstanceId);
            if (!giftToUpdate) return;

            const currentlyPinnedCount = ownedGifts.filter(g => g.is_pinned && g.owner_id === currentAccountTgId).length;

            if (!isCurrentlyPinned && currentlyPinnedCount >= 6) {
                showTooManyPinsModal();
                longPressMenu.classList.add('hidden');
                return;
            }

            longPressMenu.classList.add('hidden');

            giftToUpdate.is_pinned = !isCurrentlyPinned;
            renderProfileGifts();
            tg.HapticFeedback.impactOccurred(isCurrentlyPinned ? 'light' : 'medium');

            callBackend(`/api/gifts/${giftInstanceId}`, 'PUT', { action: 'pin', value: !isCurrentlyPinned })
                .catch(error => {
                    giftToUpdate.is_pinned = isCurrentlyPinned;
                    renderProfileGifts();
                });

            currentLongPressGift = null;
        }

        function handleHideAction() {
            const giftToUpdate = currentLongPressGift || currentlySortedGifts.find(g => g.instance_id === collectibleDetailModal.dataset.instanceId) || ownedGifts.find(g => g.instance_id === collectibleDetailModal.dataset.instanceId);
            if (!giftToUpdate) return;

            if (giftToUpdate.owner_id !== currentAccountTgId) {
                tg.showAlert("You can only hide gifts you own.");
                longPressMenu.classList.add('hidden'); currentLongPressGift = null; return;
            }

            const isCurrentlyHidden = giftToUpdate.is_hidden;
            longPressMenu.classList.add('hidden');
            closeModal(collectibleDetailModal);

            giftToUpdate.is_hidden = !isCurrentlyHidden;
            if (giftToUpdate.is_pinned && giftToUpdate.is_hidden) {
                giftToUpdate.is_pinned = false;
            }
            if (giftToUpdate.is_worn && giftToUpdate.is_hidden) {
                giftToUpdate.is_worn = false;
            }
            renderProfileGifts();
            applyWornGiftStyles();
            tg.HapticFeedback.impactOccurred('light');

            callBackend(`/api/gifts/${giftToUpdate.instance_id}`, 'PUT', { action: 'hide', value: !isCurrentlyHidden })
                .catch(error => {
                    giftToUpdate.is_hidden = isCurrentlyHidden;
                    renderProfileGifts();
                });
            currentLongPressGift = null;
        }

        function handleDeleteAction() {
            if (!currentLongPressGift || currentLongPressGift.owner_id !== currentAccountTgId) {
                if(currentLongPressGift) tg.showAlert("You can only delete gifts you own.");
                longPressMenu.classList.add('hidden'); currentLongPressGift = null; return;
            }

            const giftToDelete = currentLongPressGift;
            longPressMenu.classList.add('hidden');
            closeModal(collectibleDetailModal);

            tg.showConfirm("Are you sure you want to delete this gift? This action cannot be undone.", (confirmed) => {
                if (confirmed) {
                    const giftIndex = ownedGifts.findIndex(g => g.instance_id === giftToDelete.instance_id);
                    if (giftIndex === -1) return;

                    const removedGift = ownedGifts.splice(giftIndex, 1)[0];
                    renderProfileGifts();
                    tg.HapticFeedback.notificationOccurred('success');

                    callBackend(`/api/gifts/${giftToDelete.instance_id}`, 'DELETE')
                        .catch(error => {
                            tg.HapticFeedback.notificationOccurred('error');
                            ownedGifts.splice(giftIndex, 0, removedGift);
                            renderProfileGifts();
                        });
                }
                currentLongPressGift = null;
            });
        }

        async function showTooManyPinsModal() {
            unpinSelectionGrid.innerHTML = '';
            const pinnedGifts = ownedGifts.filter(g => g.is_pinned && !g.is_hidden && g.owner_id === currentAccountTgId);

            pinnedGifts.forEach(pinnedGift => {
                const card = createGiftCardDOM(pinnedGift);
                card.onclick = null; // Remove default click
                card.addEventListener('click', async () => {
                    try {
                        await callBackend(`/api/gifts/${pinnedGift.instance_id}`, 'PUT', { action: 'pin', value: false });
                        if (currentLongPressGift && currentLongPressGift.is_collectible) {
                             await callBackend(`/api/gifts/${currentLongPressGift.instance_id}`, 'PUT', { action: 'pin', value: true });
                        }
                        await initializeTelegramUserAccount();
                        tg.HapticFeedback.impactOccurred('medium');
                    } catch (error) {
                       console.error(error);
                    } finally {
                        closeModal(tooManyPinsModal);
                        currentLongPressGift = null;
                    }
                });
                unpinSelectionGrid.appendChild(card);
                observeLottieElement(card);
            });
            openModal(tooManyPinsModal);
        }

        function handleWearAction() {
            const currentModalInstanceId = collectibleDetailModal.dataset.instanceId;
            if (!currentModalInstanceId) return;

            const giftToUpdate = ownedGifts.find(g => g.instance_id === currentModalInstanceId);
            if (!giftToUpdate || giftToUpdate.owner_id !== currentAccountTgId) return;
            if (giftToUpdate.is_hidden) { tg.showAlert("Cannot wear a hidden gift."); return; }

            const isCurrentlyWorn = giftToUpdate.is_worn === true;

            const previouslyWornGift = ownedGifts.find(g => g.is_worn);
            if(previouslyWornGift) previouslyWornGift.is_worn = false;

            giftToUpdate.is_worn = !isCurrentlyWorn;
            collectibleActionWear.querySelector('.text').textContent = giftToUpdate.is_worn ? 'Take Off' : 'Wear';
            applyWornGiftStyles();
            tg.HapticFeedback.impactOccurred('light');

            callBackend(`/api/gifts/${currentModalInstanceId}`, 'PUT', { action: 'wear', value: !isCurrentlyWorn })
                .catch(error => {
                    giftToUpdate.is_worn = isCurrentlyWorn;
                    if(previouslyWornGift) previouslyWornGift.is_worn = true;
                    collectibleActionWear.querySelector('.text').textContent = isCurrentlyWorn ? 'Take Off' : 'Wear';
                    applyWornGiftStyles();
                });
        }
        
        function openFilterPopup() { 
            closeSidebar();
            populateFilterOptions();
            openModal(filterPopup); 
        }
        
        function populateFilterOptions() {
            const uniqueCollections = [...new Map(ownedGifts.map(item => [item.gift_type_id, {id: item.gift_type_id, name: item.gift_name, image: item.original_image_url}])).values()];
            renderFilterOptions(filterOptionsCollections, uniqueCollections, 'collection', (item) => `<img src="${item.image}" alt="${item.name}">`);

            if (activeFilters.collection) {
                const giftsInCollection = ownedGifts.filter(g => g.gift_type_id === activeFilters.collection && g.is_collectible && g.collectible_data?.model);
                const uniqueModels = [...new Map(giftsInCollection.map(item => [item.collectible_data.model.name, {name: item.collectible_data.model.name, image: item.collectible_data.modelImage}])).values()];
                renderFilterOptions(filterOptionsModels, uniqueModels, 'model', (item) => `<img src="${item.image}" alt="${item.name}">`);
                filterModelsSection.classList.remove('hidden');
            } else { filterModelsSection.classList.add('hidden'); filterOptionsModels.innerHTML = ''; }

            const collectibleGifts = ownedGifts.filter(g => g.is_collectible && g.collectible_data?.backdrop);
            const uniqueBackdrops = [...new Map(collectibleGifts.map(item => [item.collectible_data.backdrop.name, {name: item.collectible_data.backdrop.name, colors: item.collectible_data.backdropColors}])).values()];
            renderFilterOptions(filterOptionsBackdrops, uniqueBackdrops, 'backdrop', (item) => `<div class="gradient-square" style="background: radial-gradient(circle, ${item.colors.centerColor}, ${item.colors.edgeColor});"></div>`);

            const uniquePatterns = [...new Map(ownedGifts.filter(g => g.is_collectible && g.collectible_data && g.collectible_data.pattern).map(item => [item.collectible_data.pattern.name, {name: item.collectible_data.pattern.name, image: item.collectible_data.patternImage}])).values()];
            renderFilterOptions(filterOptionsPatterns, uniquePatterns, 'pattern', (item) => `<img src="${item.image}" alt="${item.name}">`);
        }
        function renderFilterOptions(container, items, filterType, displayFn) {
            container.innerHTML = '';
            items.forEach(item => {
                const optionEl = document.createElement('div'); optionEl.className = 'filter-option';
                optionEl.innerHTML = displayFn(item);
                const valueToCompare = filterType === 'collection' ? item.id : item.name;
                if (activeFilters[filterType] === valueToCompare) optionEl.classList.add('selected');
                optionEl.addEventListener('click', () => {
                    if (activeFilters[filterType] === valueToCompare) {
                        activeFilters[filterType] = null;
                        if (filterType === 'collection') activeFilters.model = null;
                    } else {
                        activeFilters[filterType] = valueToCompare;
                        if (filterType === 'collection') activeFilters.model = null;
                    }
                    populateFilterOptions();
                });
                container.appendChild(optionEl);
            });
        }
        function handleApplyFilters() {
            saveClientSideState();
            renderProfileGifts();
            closeModal(filterPopup);
            updateActionToolbarVisibility();
        }
        function handleClearFilters() {
            activeFilters = { collection: null, model: null, backdrop: null, pattern: null };
            populateFilterOptions(); renderProfileGifts(); saveClientSideState(); updateActionToolbarVisibility();
        }

        async function handleClearCurrentAccountData() {
            if (!currentAccountTgId) return;

            tg.showConfirm(`Are you sure you want to delete all gifts and data for the CURRENT account? This cannot be undone.`, async (confirmed) => {
                if (confirmed) {
                    try {
                        for(const gift of [...ownedGifts]) {
                            await callBackend(`/api/gifts/${gift.instance_id}`, 'DELETE');
                        }

                        const currentAccount = accounts.find(acc => acc.tg_id === currentAccountTgId);
                        if (currentAccount && currentAccount.collectible_usernames) {
                            for(const uname of [...currentAccount.collectible_usernames]) {
                                await callBackend(`/api/collectible_usernames/${uname}`, 'DELETE', { owner_id: currentAccountTgId });
                            }
                        }

                        await callBackend('/api/account', 'PUT', {
                            tg_id: currentAccountTgId,
                            phone_number: "Not specified",
                            bio: "My first account!",
                        });

                        await initializeTelegramUserAccount();

                        activeFilters = { collection: null, model: null, backdrop: null, pattern: null };
                        animationsEnabled = true; showHiddenGifts = false;

                        saveClientSideState();
                        saveClientSideAccounts();

                        tg.HapticFeedback.notificationOccurred('success');
                        tg.showAlert("Current account data cleared.");
                        closeModal(settingsModal);
                    } catch (error) {
                        tg.HapticFeedback.notificationOccurred('error');
                    }
                }
            });
        }

        async function handleClearAllAccountsData() {
            tg.showConfirm("Are you sure you want to delete ALL accounts and data from this simulator? This cannot be undone.", async (confirmed) => {
                if (confirmed) {
                    // This is a client-side only operation as requested
                    accounts = [];
                    currentAccountTgId = null;

                    activeFilters = { collection: null, model: null, backdrop: null, pattern: null };
                    animationsEnabled = true; showHiddenGifts = false;

                    localStorage.clear();

                    await initApp();
                    tg.HapticFeedback.notificationOccurred('success');
                    tg.showAlert("All simulator data cleared. Please restart the app.");
                    closeModal(settingsModal);
                }
            });
        }

        function handleAnimationToggle() {
            animationsEnabled = animationToggle.checked;
            tg.HapticFeedback.impactOccurred('light');
            updateAllAnimationsState();
            saveClientSideState();
        }

        function handleFullscreenToggle() {
            fullscreenEnabled = fullscreenToggle.checked;
            try {
                if (fullscreenEnabled) {
                    tg.requestFullscreen();
                } else {
                    tg.exitFullscreen();
                }
            } catch (e) { console.warn("Fullscreen API not available.", e); }
            saveClientSideState();
        }

        function handleShowHiddenToggle() {
            showHiddenGifts = showHiddenToggle.checked;
            tg.HapticFeedback.impactOccurred('light');
            renderProfileGifts();
            saveClientSideState();
        }
        
        async function handleCustomGiftsToggle() {
            const isEnabling = customGiftsToggle.checked;
            
            if (isEnabling) {
                tg.showAlert("By enabling, you confirm you're over 18.");
            }
            
            customGiftsEnabled = isEnabling;
            tg.HapticFeedback.impactOccurred('light');

            try {
                await updateCustomGiftsSetting(isEnabling);
                await initializeTelegramUserAccount(); 
            } catch (error) {
                customGiftsEnabled = !isEnabling;
                customGiftsToggle.checked = !isEnabling;
            }
        }

        async function updateCustomGiftsSetting(enabled) {
            return await callBackend('/api/account/settings', 'POST', {
                tg_id: currentAccountTgId,
                custom_gifts_enabled: enabled
            });
        }

        // --- CUSTOM BUY & CLONE ---
        async function openCustomBuyModal() {
            try {
                const res = await callBackend('/api/customization/check_access', 'GET', null, { user_id: currentAccountTgId });
                if (res.access) {
                    if (!customGiftsEnabled) {
                        tg.showAlert("Please enable Custom Gifts in settings first.");
                        return;
                    }
                    giftCreationQueue = [];
                    currentlyEditingGiftIndex = -1;
                    addGiftToQueue();
                    cloneUrlInput.value = '';
                    advancedSettingsContainer.classList.add('hidden');
                    populateBaseGiftOptions();
                    openModal(customBuyModal);
                } else {
                    tg.showConfirm("To use this feature, please subscribe to @CompactTelegram first.", (confirmed) => {
                        if (confirmed) {
                            tg.openTelegramLink("https://t.me/CompactTelegram");
                        }
                    });
                }
            } catch (error) {
                tg.showAlert("Could not check access. Please try again.");
            }
        }

        function addGiftToQueue() {
            const newGift = {
                id: null, name: null, originalImage: null, lottiePath: null,
                model: null, backdrop: null, pattern: null, quantity: 1, customPatternBase64: null
            };
            giftCreationQueue.push(newGift);
            currentlyEditingGiftIndex = giftCreationQueue.length - 1;
            renderGiftQueue();
            resetAndPrepareConfigArea();
        }

        function resetAndPrepareConfigArea() {
            ['custom-buy-models-grid', 'custom-buy-backdrops-grid', 'custom-buy-patterns-grid'].forEach(id => document.getElementById(id).innerHTML = '');
            ['custom-buy-models-section', 'custom-buy-backdrops-section', 'custom-buy-patterns-section'].forEach(id => document.getElementById(id).classList.add('hidden'));
            
            const currentGift = giftCreationQueue[currentlyEditingGiftIndex];
            if (currentGift && currentGift.id) {
                 selectCustomBaseGift(currentGift.id, currentGift.name, currentGift.originalImage, false); 
            } else {
                populateBaseGiftOptions();
                document.getElementById('custom-buy-base-gifts-grid').classList.remove('hidden');
            }
        }

        function populateBaseGiftOptions() {
            customBuyBaseGiftsGrid.innerHTML = '';
            for (const id in allAvailableGifts) {
                const name = allAvailableGifts[id];
                const customGiftData = CUSTOM_GIFTS_DATA[name];
                
                if (customGiftData && !customGiftsEnabled) continue;
                
                const originalImageUrl = customGiftData
                    ? customGiftData.defaultImage
                    : `${CDN_BASE_URL}originals/${id}/Original.png`;

                const item = document.createElement('div');
                item.className = 'filter-option'; item.dataset.id = id;
                item.innerHTML = `<img src="${originalImageUrl}" alt="${name}" loading="lazy"><div class="label">${name}</div>`;
                item.addEventListener('click', () => selectCustomBaseGift(id, name, originalImageUrl));
                customBuyBaseGiftsGrid.appendChild(item);
            }
        }

        function renderGiftQueue() {
            giftQueueContainer.innerHTML = '';
            giftCreationQueue.forEach((gift, index) => {
                const item = document.createElement('button');
                item.className = 'gift-queue-item';
                item.textContent = gift.name || `Gift ${index + 1}`;
                if (index === currentlyEditingGiftIndex) {
                    item.classList.add('active');
                }
                
                const removeBtn = document.createElement('span');
                removeBtn.className = 'remove-queue-item';
                removeBtn.textContent = '×';
                removeBtn.onclick = (e) => {
                    e.stopPropagation();
                    removeGiftFromQueue(index);
                };
                
                item.appendChild(removeBtn);
                item.onclick = () => editGiftInQueue(index);
                giftQueueContainer.appendChild(item);
            });
            updateCreateButtonState();
        }
        
        function removeGiftFromQueue(index) {
            giftCreationQueue.splice(index, 1);
            if (currentlyEditingGiftIndex >= index) {
                currentlyEditingGiftIndex = Math.max(0, currentlyEditingGiftIndex - 1);
            }
            if (giftCreationQueue.length === 0) {
                addGiftToQueue();
            } else {
                renderGiftQueue();
                editGiftInQueue(currentlyEditingGiftIndex);
            }
        }
        
        function editGiftInQueue(index) {
            if (currentlyEditingGiftIndex === index) return;
            if (currentlyEditingGiftIndex > -1) {
                giftCreationQueue[currentlyEditingGiftIndex].quantity = parseInt(customBuyQuantityInput.value, 10) || 1;
            }
            
            currentlyEditingGiftIndex = index;
            renderGiftQueue();

            const allSections = document.querySelectorAll('#gift-config-area .filter-section');
            allSections.forEach(s => s.classList.add('hidden'));

            const giftToEdit = giftCreationQueue[index];
            customBuyQuantityInput.value = giftToEdit.quantity || 1;
            customPatternPreview.classList.toggle('hidden', !giftToEdit.customPatternBase64);
            if (giftToEdit.customPatternBase64) customPatternPreview.src = giftToEdit.customPatternBase64;
            
            if (giftToEdit.id) {
                selectCustomBaseGift(giftToEdit.id, giftToEdit.name, giftToEdit.originalImage, false);
            } else {
                resetAndPrepareConfigArea();
            }
        }
        
        function updateCurrentGiftInQueue(updates) {
            if (currentlyEditingGiftIndex > -1) {
                Object.assign(giftCreationQueue[currentlyEditingGiftIndex], updates);
                renderGiftQueue();
            }
            updateCreateButtonState();
        }

        async function selectCustomBaseGift(id, name, originalImage, resetParts = true) {
            const currentGift = giftCreationQueue[currentlyEditingGiftIndex];
            
            if (resetParts) {
                currentGift.model = null;
                currentGift.backdrop = null;
                currentGift.pattern = null;
                currentGift.customPatternBase64 = null;
            }
            updateCurrentGiftInQueue({ id, name, originalImage });

            customBuyModelsGrid.innerHTML = ''; customBuyBackdropsGrid.innerHTML = ''; customBuyPatternsGrid.innerHTML = '';
            
            const customGiftInfo = CUSTOM_GIFTS_DATA[name];
            updateCurrentGiftInQueue({lottiePath: customGiftInfo ? null : `${CDN_BASE_URL}originals/${id}/Original.json`});

            if (!cachedCollectibleParts[id]) {
                 if (customGiftInfo) {
                    const backdropsSourceName = customGiftInfo.backdrops_source;
                    const patternsSourceName = customGiftInfo.patterns_source;
                    try {
                        const parts = await Promise.all([
                            fetch(`${CDN_BASE_URL}backdrops/${encodeURIComponent(backdropsSourceName)}/backdrops.json`).then(res => res.ok ? res.json() : []),
                            fetch(`${CDN_BASE_URL}patterns/${encodeURIComponent(patternsSourceName)}/patterns.json`).then(res => res.ok ? res.json() : [])
                        ]);
                        cachedCollectibleParts[id] = { models: customGiftInfo.models, backdrops: parts[0], patterns: parts[1] };
                    } catch (e) { cachedCollectibleParts[id] = { models: customGiftInfo.models, backdrops: [], patterns: [] }; }
                } else {
                    try {
                        const giftNameEncoded = encodeURIComponent(name);
                        const partsData = await Promise.all([
                            fetch(`${CDN_BASE_URL}models/${giftNameEncoded}/models.json`).then(res => res.ok ? res.json() : []),
                            fetch(`${CDN_BASE_URL}backdrops/${giftNameEncoded}/backdrops.json`).then(res => res.ok ? res.json() : []),
                            fetch(`${CDN_BASE_URL}patterns/${giftNameEncoded}/patterns.json`).then(res => res.ok ? res.json() : [])
                        ]);
                        cachedCollectibleParts[id] = { models: partsData[0], backdrops: partsData[1], patterns: partsData[2] };
                    } catch (e) { cachedCollectibleParts[id] = { models: [], backdrops: [], patterns: [] }; }
                }
            }

            populatePartSelector(id, name);
            
            if (resetParts && cachedCollectibleParts[id].patterns.length > 0) {
                const randomPattern = getRandomElement(cachedCollectibleParts[id].patterns);
                if (randomPattern) {
                    selectCustomPart('pattern', randomPattern);
                }
            }
        }
        
        function populatePartSelector(id, name) {
            let { models, backdrops, patterns } = cachedCollectibleParts[id];
            
            models = [...models].sort((a, b) => (a.rarityPermille || 999) - (b.rarityPermille || 999));
            
            const pinnedBackdropNames = ['Black', 'Onyx Black', 'Midnight Blue', 'Electric Purple', 'Amber', 'Cyberpunk'];
            backdrops = [...backdrops].sort((a, b) => {
                const aIndex = pinnedBackdropNames.indexOf(a.name);
                const bIndex = pinnedBackdropNames.indexOf(b.name);
                if (aIndex !== -1 && bIndex !== -1) return aIndex - bIndex;
                if (aIndex !== -1) return -1;
                if (bIndex !== -1) return 1; 
                return a.name.localeCompare(b.name);
            });

            const customData = CUSTOM_GIFTS_DATA[name];
            const patternSourceName = customData ? customData.patterns_source : name;
            const currentGift = giftCreationQueue[currentlyEditingGiftIndex];

            const populateGrid = (grid, section, items, type, getImagePathFn) => {
                grid.innerHTML = '';
                if (items.length > 0) {
                    section.classList.remove('hidden');
                    items.forEach(item => {
                        const itemEl = document.createElement('div');
                        itemEl.className = 'filter-option';
                        itemEl.dataset.name = item.name;
                        const imagePath = getImagePathFn(item);
                        itemEl.innerHTML = type === 'backdrop' 
                            ? `<div class="gradient-square" style="background: radial-gradient(circle, ${item.hex.centerColor}, ${item.hex.edgeColor});"></div><div class="label">${item.name}</div>`
                            : `<img src="${imagePath}" alt="${item.name}" loading="lazy"><div class="label">${item.name}</div>`;
                        
                        if (currentGift[type] && currentGift[type].name === item.name) {
                            itemEl.classList.add('selected');
                        }
                        
                        itemEl.addEventListener('click', () => selectCustomPart(type, item));
                        itemEl.addEventListener('contextmenu', (e) => {
                            e.preventDefault();
                            if (type !== 'backdrop') openImagePreview(imagePath);
                        });
                        grid.appendChild(itemEl);
                    });
                } else {
                    section.classList.add('hidden');
                }
            };
            
            populateGrid(customBuyModelsGrid, customBuyModelsSection, models, 'model', (item) => item.image || `${CDN_BASE_URL}models/${encodeURIComponent(name)}/png/${encodeURIComponent(item.name)}.png`);
            populateGrid(customBuyBackdropsGrid, customBuyBackdropsSection, backdrops, 'backdrop', (item) => null);
            populateGrid(customBuyPatternsGrid, customBuyPatternsSection, patterns, 'pattern', (item) => `${CDN_BASE_URL}patterns/${encodeURIComponent(patternSourceName)}/png/${encodeURIComponent(item.name)}.png`);
            
            document.getElementById('custom-buy-base-gifts-grid').classList.add('hidden');
            addAnotherGiftButton.style.display = 'block';
            updateCreateButtonState();
        }

        function selectCustomPart(type, data) {
            const grid = document.getElementById(`custom-buy-${type}s-grid`);
            Array.from(grid.children).forEach(el => el.classList.remove('selected'));
            const selectedElement = grid.querySelector(`[data-name="${data.name}"]`);
            if(selectedElement) selectedElement.classList.add('selected');
            const updates = { [type]: data };
            if (type === 'pattern') {
                updates.customPatternBase64 = null;
                customPatternPreview.src = '';
                customPatternPreview.classList.add('hidden');
            }
            updateCurrentGiftInQueue(updates);
        }
        
        function updateCreateButtonState() {
            const allGiftsValid = giftCreationQueue.every(gift => {
                if (!gift.id) return false;
                const partsInfo = cachedCollectibleParts[gift.id];
                if (!partsInfo) return false;
                const patternIsValid = (partsInfo.patterns.length === 0 || !!gift.pattern || !!gift.customPatternBase64);
                return (partsInfo.models.length === 0 || !!gift.model) &&
                       (partsInfo.backdrops.length === 0 || !!gift.backdrop) &&
                       patternIsValid;
            });
            
            customBuyConfirmButton.disabled = !allGiftsValid;
            const total = giftCreationQueue.length;
            customBuyConfirmButton.textContent = `Create ${total > 1 ? `${total} Gifts` : 'Gift'}`;
        }

        async function handleCloneGift() {
            const userInput = cloneUrlInput.value.trim();
            if (!userInput) { tg.showAlert("Please provide a link or gift name and number."); return; }
            if (ownedGifts.length >= GIFT_LIMIT_PER_USER) {
                tg.showAlert(`Cannot clone gift. Your inventory is full.`);
                return;
            }
            cloneGiftButton.disabled = true;
            cloneGiftButton.textContent = "Cloning...";
            try {
                const clonedGift = await callBackend('/api/gifts/clone', 'POST', {
                    url: userInput,
                    owner_id: currentAccountTgId
                });
                ownedGifts.unshift(clonedGift);
                renderProfileGifts();
                tg.HapticFeedback.notificationOccurred('success');
                tg.showAlert("Gift cloned successfully!");
                closeModal(customBuyModal);
                showPage('profile-page');
            } catch (error) {
                 // Error is shown by callBackend
            } finally {
                cloneGiftButton.disabled = false;
                cloneGiftButton.textContent = "Clone Gift";
            }
        }
        
        async function handleCustomBuyConfirm() {
            if (customBuyConfirmButton.disabled) return;
            
            if (currentlyEditingGiftIndex > -1) {
                giftCreationQueue[currentlyEditingGiftIndex].quantity = parseInt(customBuyQuantityInput.value, 10) || 1;
            }

            const totalToCreate = giftCreationQueue.reduce((sum, gift) => sum + gift.quantity, 0);
            if (ownedGifts.length + totalToCreate > GIFT_LIMIT_PER_USER) {
                tg.showAlert(`Cannot create ${totalToCreate} gifts. Your inventory is full.`);
                return;
            }

            customBuyConfirmButton.disabled = true;
            customBuyConfirmButton.textContent = 'Creating...';
            closeModal(customBuyModal); 

            // --- Asynchronous UI Update ---
            const allTempGifts = [];
            giftCreationQueue.forEach(giftConfig => {
                for (let i = 0; i < giftConfig.quantity; i++) {
                    const tempGift = {
                        instance_id: `temp_${generateUniqueId()}`,
                        owner_id: currentAccountTgId,
                        gift_type_id: giftConfig.id,
                        gift_name: giftConfig.name,
                        original_image_url: giftConfig.originalImage,
                        lottie_path: giftConfig.lottiePath,
                        acquired_date: new Date().toISOString(),
                        is_collectible: false,
                        is_pending: true
                    };
                    allTempGifts.push({ tempGift, config: giftConfig });
                }
            });

            ownedGifts.unshift(...allTempGifts.map(item => item.tempGift));
            renderProfileGifts();
            showPage('profile-page');
            tg.HapticFeedback.notificationOccurred('success');
            // --- End Asynchronous UI Update ---

            try {
                const creationPromises = allTempGifts.map(({ tempGift, config }) => {
                    const payload = {
                        owner_id: tempGift.owner_id,
                        gift_name: config.name,
                        gift_type_id: config.id,
                        custom_model: config.model,
                        custom_backdrop: config.backdrop,
                    };
                    if (config.customPatternBase64) {
                        payload.custom_pattern_base64 = config.customPatternBase64;
                    } else {
                        payload.custom_pattern = config.pattern;
                    }
                    return callBackend('/api/gifts/create_collectible', 'POST', payload);
                });
                
                await Promise.all(creationPromises);
                await initializeTelegramUserAccount(); // Final sync
                tg.showAlert(`${totalToCreate} gift(s) created successfully!`);

            } catch (error) {
                tg.showAlert('An error occurred while creating gifts. Your inventory will be re-synced.');
                await initializeTelegramUserAccount();
            }
        }

        function handleCustomPatternUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                const base64String = e.target.result;
                customPatternPreview.src = base64String;
                customPatternPreview.classList.remove('hidden');

                // Deselect any existing pattern
                const grid = document.getElementById('custom-buy-patterns-grid');
                Array.from(grid.children).forEach(el => el.classList.remove('selected'));

                updateCurrentGiftInQueue({ customPatternBase64: base64String, pattern: null });
            };
            reader.readAsDataURL(file);
        }

        function handleTripleTap(e, filterType, value) {
            const now = Date.now(); const DURATION = 300;
            if (now - lastTap < DURATION) tapCount++; else tapCount = 1;
            lastTap = now;
            if (tapCount === 3) {
                tapCount = 0; tg.HapticFeedback.impactOccurred('medium');
                activeFilters = { collection: null, model: null, backdrop: null, pattern: null };
                if (value) { activeFilters[filterType] = value; tg.showAlert(`Showing gifts with ${filterType}: "${value}"`); }
                else { tg.showAlert(`Cannot apply filter: ${filterType} is undefined.`); return; }
                saveClientSideState(); renderProfileGifts(); updateActionToolbarVisibility(); closeModal(collectibleDetailModal);
            }
        }
        
        async function preloadImage(url) {
            return new Promise((resolve) => {
                if (!url) { resolve(); return; }
                const img = new Image(); img.crossOrigin = 'Anonymous'; img.src = url;
                img.onload = resolve;
                img.onerror = () => { console.warn(`Failed to preload image: ${url}`); resolve(); };
            });
        }

        async function handleShareImageAction() {
            longPressMenu.classList.add('hidden');
            if (!currentLongPressGift || !currentLongPressGift.is_collectible) { tg.showAlert("Cannot share an image for this gift."); return; }

            const giftForImage = currentLongPressGift;

            sendGeneratedImageButton.disabled = true;
            sendGeneratedImageButton.textContent = "Send to Me";
            generatedImageMessage.textContent = 'Generating image...';
            generatedImagePreview.src = '';
            openModal(generatedImageModal);

            const imageDataUrl = await generateGiftImage(giftForImage);

            if (imageDataUrl) {
                generatedImagePreview.src = imageDataUrl;
                generatedImageMessage.textContent = 'Image is ready. Click "Send to Me" to receive it via bot.';
                sendGeneratedImageButton.disabled = false;
                sendGeneratedImageButton.onclick = () => sendGeneratedImage(imageDataUrl, giftForImage);
                tg.HapticFeedback.notificationOccurred('success');
            } else {
                generatedImageMessage.textContent = 'Failed to generate image.';
                tg.HapticFeedback.notificationOccurred('error');
            }
            currentLongPressGift = null;
        }

        async function sendGeneratedImage(imageDataUrl, gift) {
            sendGeneratedImageButton.disabled = true;
            sendGeneratedImageButton.textContent = "Sending...";
            try {
                await callBackend('/api/gifts/send_image', 'POST', {
                    imageDataUrl: imageDataUrl,
                    userId: currentAccountTgId,
                    caption: `Your generated image for ${gift.gift_name} #${gift.collectible_number.toLocaleString()}`
                });
                tg.HapticFeedback.notificationOccurred('success');
                tg.showAlert("Image sent! Check your chat with the bot.");
                closeModal(generatedImageModal);
            } catch (error) {
                sendGeneratedImageButton.disabled = false;
                sendGeneratedImageButton.textContent = "Send to Me";
            }
        }

        async function generateGiftImage(gift) {
            const cd = gift.collectible_data; if (!cd) return null;
            await Promise.all([ preloadImage(cd.modelImage || gift.original_image_url), preloadImage(cd.patternImage) ]);
            const tempContainer = document.createElement('div');
            tempContainer.style.position = 'absolute'; tempContainer.style.left = '-9999px'; tempContainer.style.top = '-9999px';
            tempContainer.style.width = '450px'; tempContainer.style.height = '600px';
            tempContainer.style.display = 'flex'; tempContainer.style.flexDirection = 'column';
            tempContainer.style.alignItems = 'center'; tempContainer.style.justifyContent = 'flex-start';
            tempContainer.style.padding = '30px'; tempContainer.style.boxSizing = 'border-box';
            tempContainer.style.fontFamily = '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif';
            if (cd.backdropColors) tempContainer.style.background = `radial-gradient(circle at 50% 0%, ${cd.backdropColors.centerColor} 0%, ${cd.backdropColors.edgeColor} 100%)`;
            else tempContainer.style.background = 'linear-gradient(45deg, #2a3745, #17212b)';
            const textColor = '#ffffff';
            if (cd.patternImage) {
                const patternOverlay = document.createElement('div');
                patternOverlay.style.position = 'absolute'; patternOverlay.style.top = '0'; patternOverlay.style.left = '0';
                patternOverlay.style.width = '100%'; patternOverlay.style.height = '100%';
                patternOverlay.style.backgroundImage = `url('${cd.patternImage}')`;
                patternOverlay.style.backgroundRepeat = 'repeat'; patternOverlay.style.backgroundSize = '30% auto';
                patternOverlay.style.opacity = '0.07'; tempContainer.appendChild(patternOverlay);
            }
            const giftModelContainer = document.createElement('div');
            giftModelContainer.style.width = '70%'; giftModelContainer.style.height = 'auto'; giftModelContainer.style.aspectRatio = '1 / 1';
            giftModelContainer.style.display = 'flex'; giftModelContainer.style.alignItems = 'center'; giftModelContainer.style.justifyContent = 'center';
            giftModelContainer.style.position = 'relative'; giftModelContainer.style.zIndex = '10'; giftModelContainer.style.marginBottom = '20px';
            const modelImageEl = document.createElement('img'); modelImageEl.src = cd.modelImage || gift.original_image_url;
            modelImageEl.style.maxWidth = '100%'; modelImageEl.style.maxHeight = '100%'; modelImageEl.style.objectFit = 'contain';
            giftModelContainer.appendChild(modelImageEl); tempContainer.appendChild(giftModelContainer);
            const upgradedGiftText = document.createElement('div');
            upgradedGiftText.textContent = 'Upgraded Gift'; upgradedGiftText.style.fontSize = '2.2em'; upgradedGiftText.style.fontWeight = '600';
            upgradedGiftText.style.color = textColor; upgradedGiftText.style.marginBottom = '10px'; upgradedGiftText.style.position = 'relative';
            upgradedGiftText.style.zIndex = '10'; tempContainer.appendChild(upgradedGiftText);
            const giftNameAndNumber = document.createElement('div');
            giftNameAndNumber.textContent = `${gift.gift_name} #${gift.collectible_number}`; giftNameAndNumber.style.fontSize = '1.8em'; giftNameAndNumber.style.fontWeight = '500';
            giftNameAndNumber.style.color = textColor; giftNameAndNumber.style.opacity = '0.9'; giftNameAndNumber.style.marginBottom = '25px';
            giftNameAndNumber.style.position = 'relative'; giftNameAndNumber.style.zIndex = '10'; tempContainer.appendChild(giftNameAndNumber);
            const infoSection = document.createElement('div');
            infoSection.style.display = 'flex'; infoSection.style.flexDirection = 'column'; infoSection.style.alignItems = 'flex-start';
            infoSection.style.width = '80%'; infoSection.style.position = 'relative'; infoSection.style.zIndex = '10';
            const createInfoRow = (label, value) => {
                const row = document.createElement('div'); row.style.display = 'flex'; row.style.justifyContent = 'space-between';
                row.style.width = '100%'; row.style.marginBottom = '10px';
                const labelEl = document.createElement('span'); labelEl.textContent = label; labelEl.style.fontSize = '1.2em';
                labelEl.style.fontWeight = 'normal'; labelEl.style.color = textColor; row.appendChild(labelEl);
                const valueEl = document.createElement('span'); valueEl.textContent = value; valueEl.style.fontSize = '1.2em';
                valueEl.style.fontWeight = '500'; valueEl.style.color = textColor; valueEl.style.opacity = '0.7'; row.appendChild(valueEl);
                return row;
            };
            infoSection.appendChild(createInfoRow('Model', cd.model?.name || 'N/A'));
            infoSection.appendChild(createInfoRow('Backdrop', cd.backdrop?.name || 'N/A'));
            infoSection.appendChild(createInfoRow('Symbol', cd.pattern?.name || 'N/A'));
            tempContainer.appendChild(infoSection); document.body.appendChild(tempContainer);
            let dataUrl = null;
            try {
                const canvas = await html2canvas(tempContainer, { backgroundColor: null, scale: 1.5, useCORS: true });
                dataUrl = canvas.toDataURL('image/png');
            } catch (error) { console.error("Error generating image:", error); }
            finally { document.body.removeChild(tempContainer); }
            return dataUrl;
        }

        let currentGiftForChances = null; let selectedChances = { model: null, backdrop: null, pattern: null };
        async function openChancesModal(gift) {
            closeModal(giftDetailModal); currentGiftForChances = gift;
            selectedChances = { model: null, backdrop: null, pattern: null };
            chancesGiftName.textContent = `For gift: "${gift.gift_name}"`;
            chancesLoadingSpinner.classList.remove('hidden');
            chancesModelsSection.classList.add('hidden'); chancesBackdropsSection.classList.add('hidden');
            chancesPatternsSection.classList.add('hidden'); chancesProbabilityDisplay.innerHTML = '';
            openModal(chancesModal); calculateAndDisplayChances();

            if (!cachedCollectibleParts[gift.gift_type_id]) {
                await selectCustomBaseGift(gift.gift_type_id, gift.gift_name);
            }
            chancesLoadingSpinner.classList.add('hidden');
            populateChancesOptions(gift.gift_type_id, gift.gift_name);
        }

        function populateChancesOptions(giftTypeId, giftName) {
            const { models, backdrops, patterns } = cachedCollectibleParts[giftTypeId];
            if (models.length > 0) { renderChanceOptions(chancesOptionsModels, models, 'model', giftName); chancesModelsSection.classList.remove('hidden'); }
            if (backdrops.length > 0) { renderChanceOptions(chancesOptionsBackdrops, backdrops, 'backdrop', giftName); chancesBackdropsSection.classList.remove('hidden'); }
            if (patterns.length > 0) { renderChanceOptions(chancesOptionsPatterns, patterns, 'pattern', giftName); chancesPatternsSection.classList.remove('hidden'); }
        }
        function renderChanceOptions(container, items, type, giftName) {
            container.innerHTML = '';
            const customData = CUSTOM_GIFTS_DATA[giftName];
            const patternSourceName = customData ? customData.patterns_source : giftName;

            items.forEach(itemData => {
                const optionEl = document.createElement('div');
                optionEl.className = 'filter-option';
                let innerHTML = '';
                if (type === 'model') {
                     const modelImage = itemData.image || `${CDN_BASE_URL}models/${encodeURIComponent(giftName)}/png/${encodeURIComponent(itemData.name)}.png`;
                     innerHTML = `<img src="${modelImage}" alt="${itemData.name}" loading="lazy"><div class="label">${itemData.name}</div>`;
                } else if (type === 'backdrop') {
                     innerHTML = `<div class="gradient-square" style="background: radial-gradient(circle, ${itemData.hex.centerColor}, ${itemData.hex.edgeColor});"></div><div class="label">${itemData.name}</div>`;
                } else if (type === 'pattern') {
                     const patternImage = `${CDN_BASE_URL}patterns/${encodeURIComponent(patternSourceName)}/png/${encodeURIComponent(itemData.name)}.png`;
                     innerHTML = `<img src="${patternImage}" alt="${itemData.name}" loading="lazy"><div class="label">${itemData.name}</div>`;
                }
                optionEl.innerHTML = innerHTML;
                optionEl.addEventListener('click', () => handleChanceSelection(optionEl, container, type, itemData));
                container.appendChild(optionEl);
            });
        }

        function handleChanceSelection(element, container, type, data) {
            const isSelected = element.classList.contains('selected');
            Array.from(container.children).forEach(el => el.classList.remove('selected'));

            if(isSelected) {
                selectedChances[type] = null;
            } else {
                element.classList.add('selected');
                selectedChances[type] = data;
            }
            calculateAndDisplayChances();
        }

        function calculateAndDisplayChances() {
            let totalProbability = 1.0;
            const selectedParts = [];

            if (selectedChances.model) {
                totalProbability *= ((selectedChances.model.rarityPermille || 1) / 1000);
                selectedParts.push(`Model: ${selectedChances.model.name}`);
            }
             if (selectedChances.backdrop) {
                totalProbability *= ((selectedChances.backdrop.rarityPermille || 1) / 1000);
                selectedParts.push(`Backdrop: ${selectedChances.backdrop.name}`);
            }
             if (selectedChances.pattern) {
                totalProbability *= ((selectedChances.pattern.rarityPermille || 1) / 1000);
                selectedParts.push(`Symbol: ${selectedChances.pattern.name}`);
            }

            if (selectedParts.length === 0) {
                 chancesProbabilityDisplay.innerHTML = `<span class="prob-details">Select one or more parts to calculate the chance of getting them together.</span>`;
            } else {
                const probabilityPercent = totalProbability * 100;
                const oneInX = Math.round(1 / totalProbability);
                let displayPercent = probabilityPercent.toExponential(2);
                if (probabilityPercent > 0.0001) {
                    displayPercent = probabilityPercent.toPrecision(3) + '%';
                } else {
                    displayPercent += '%';
                }

                chancesProbabilityDisplay.innerHTML = `
                    <span class="prob-value">${displayPercent}</span>
                    <span class="prob-details">1 in ${oneInX.toLocaleString('en-US')}<br>${selectedParts.join('<br>')}</span>`;
            }
        }

        function openSellModal(gift) {
            if (!gift || !gift.is_collectible) return;
            if (gift.owner_id !== currentAccountTgId) return;
            currentGiftToSell = gift;
            closeModal(collectibleDetailModal);

            sellGiftImage.src = gift.collectible_data.modelImage || gift.original_image_url;
            sellGiftName.textContent = `${gift.gift_name} #${gift.collectible_number}`;
            sellPriceInput.value = '';
            sellReceiveAmount.textContent = 'You will receive...';
            sellUsdAmount.textContent = '';
            confirmSellButton.disabled = true;

            openModal(sellGiftModal);
            setTimeout(() => sellPriceInput.focus(), 250);
        }

        function updateSellPriceDetails() {
            const price = parseInt(sellPriceInput.value, 10);
            if (!isNaN(price) && price >= MIN_SALE_PRICE && price <= MAX_SALE_PRICE) {
                const commission = 0.20;
                const received = Math.floor(price * (1 - commission));
                const usdEquivalent = (price * 0.013).toFixed(2);

                sellReceiveAmount.textContent = `You will receive ${received} Stars.`;
                sellUsdAmount.textContent = `≈US$${usdEquivalent}`;
                confirmSellButton.disabled = false;
            } else {
                sellReceiveAmount.textContent = 'You will receive...';
                sellUsdAmount.textContent = '';
                confirmSellButton.disabled = true;
            }
        }

        function handleConfirmSell() {
            if (!currentGiftToSell || confirmSellButton.disabled) return;
            const price = parseInt(sellPriceInput.value, 10);

            const giftIndex = ownedGifts.findIndex(g => g.instance_id === currentGiftToSell.instance_id);
            if (giftIndex === -1) return;

            const removedGift = ownedGifts.splice(giftIndex, 1)[0];
            renderProfileGifts();
            closeModal(sellGiftModal);
            tg.HapticFeedback.notificationOccurred('success');
            tg.showAlert(`Gift "${currentGiftToSell.gift_name}" listed for sale. It will be removed from your profile until sold or cancelled.`);

            callBackend('/api/gifts/sell', 'POST', {
                instance_id: currentGiftToSell.instance_id,
                price: price,
                owner_id: currentAccountTgId
            }).catch(error => {
                tg.HapticFeedback.notificationOccurred('error');
                ownedGifts.splice(giftIndex, 0, removedGift);
                renderProfileGifts();
            });
        }

        function openTransferModal(gift) {
            if (!gift || !gift.is_collectible) return;
            if (gift.owner_id !== currentAccountTgId) return;
            currentGiftToTransfer = gift;
            closeModal(collectibleDetailModal);

            transferModalTitle.textContent = "Transfer Gift";
            transferGiftImage.src = gift.collectible_data.modelImage || gift.original_image_url;
            transferGiftImage.classList.remove('hidden');
            transferGiftName.classList.remove('hidden');
            transferUsernameInput.value = '';
            transferCommentInput.value = '';
            confirmTransferButton.disabled = true;
            transferStatusMessage.innerHTML = '<p>Gift ownership will be transferred to this username.</p>';

            openModal(transferGiftModal);
            setTimeout(() => transferUsernameInput.focus(), 250);
        }

        function handleConfirmTransfer() {
            if (!currentGiftToTransfer || confirmTransferButton.disabled) return;
            const receiverUsername = transferUsernameInput.value.trim();
            const comment = transferCommentInput.value.trim();

            if (!receiverUsername) { transferStatusMessage.innerHTML = '<p style="color:red;">Please enter a username.</p>'; return; }
            const currentAccount = accounts.find(acc => acc.tg_id === currentAccountTgId);
            if (receiverUsername.toLowerCase() === currentAccount?.username.toLowerCase()) {
                transferStatusMessage.innerHTML = '<p style="color:red;">Cannot transfer to yourself.</p>';
                return;
            }

            confirmTransferButton.disabled = true;
            confirmTransferButton.textContent = 'Transferring...';

            const giftIndex = ownedGifts.findIndex(g => g.instance_id === currentGiftToTransfer.instance_id);
            if (giftIndex === -1) {
                confirmTransferButton.disabled = false;
                confirmTransferButton.textContent = 'Confirm Transfer';
                return;
            }

            const removedGift = ownedGifts.splice(giftIndex, 1)[0];
            renderProfileGifts();
            closeModal(transferGiftModal);

            callBackend('/api/gifts/transfer', 'POST', {
                instance_id: currentGiftToTransfer.instance_id,
                receiver_username: receiverUsername,
                sender_id: currentAccountTgId,
                comment: comment
            }).then(() => {
                tg.HapticFeedback.notificationOccurred('success');
                tg.showAlert(`Gift transferred to @${receiverUsername}!`);
            }).catch(error => {
                tg.HapticFeedback.notificationOccurred('error');
                ownedGifts.splice(giftIndex, 0, removedGift);
                renderProfileGifts();
            });
        }

        // --- Collectible Numbers & Usernames ---
        async function handleOpenNumbersModal() {
            numbersList.innerHTML = '<div class="spinner"></div>';
            closeSidebar();
            openModal(numbersModal);
            // This is a mock implementation. For a real system, you'd fetch available numbers.
            const response = await callBackend('/api/stats');
            const availableNumbers = response?.general_metrics?.collectible_items || 1000;
            
            numbersList.innerHTML = '';
            const coolNumbers = ["+888 8888 8888", "+888 0000 0001", "+888 1234 5678"];
            coolNumbers.forEach(num => {
                const li = document.createElement('li');
                li.className = 'collectible-list-item';
                li.textContent = num;
                li.addEventListener('click', () => buyNumber(num));
                numbersList.appendChild(li);
            });
        }

        async function buyNumber(number) {
            tg.showConfirm(`Are you sure you want to purchase the number ${number}?`, async (confirmed) => {
                if(confirmed) {
                    try {
                        await callBackend(`/api/account`, 'PUT', {
                            tg_id: currentAccountTgId,
                            phone_number: number
                        });

                        await initializeTelegramUserAccount();
                        tg.HapticFeedback.notificationOccurred('success');
                        tg.showAlert(`Number ${number} purchased successfully!`);
                        closeModal(numbersModal);
                    } catch (error) {
                         // Error is handled by callBackend
                    }
                }
            });
        }

        async function handleOpenUsernamesModal() {
            await populateUsernamesList();
            usernameSearchInput.value = '';
            closeSidebar();
            openModal(usernamesModal);
        }

        async function populateUsernamesList(searchTerm = '') {
            usernamesList.innerHTML = '<div class="spinner"></div>';
            const coolUsernames = ["durov", "admin", "king", "wallet", "crypto", "elon", "boss", "premium", "gift", "star", "diamond", "anonymous", "market", "bank", "news", "pessi", "penaldo", "token", "exchange", "ceo", "founder", "investor"];
            let listToShow = [];

            if (searchTerm) {
                listToShow = [searchTerm.toLowerCase().replace(/[^a-z0-9_]/g, '')].filter(Boolean);
            } else {
                const shuffled = [...coolUsernames].sort(() => 0.5 - Math.random());
                listToShow = shuffled.slice(0, 25);
            }
            
            usernamesList.innerHTML = '';
            if (listToShow.length === 0 && !searchTerm) {
                usernamesList.innerHTML = '<p class="empty-grid-message">No usernames available.</p>';
                return;
            }
            
            listToShow.forEach(uname => {
                const li = document.createElement('li');
                li.className = 'collectible-list-item';
                li.innerHTML = `<span class="at-symbol">@</span>${uname}`;
                li.addEventListener('click', () => buyUsername(uname));
                usernamesList.appendChild(li);
            });
        }

        async function buyUsername(username) {
            const currentAccount = accounts.find(acc => acc.tg_id === currentAccountTgId);
            if (!currentAccount || (currentAccount.collectible_usernames && currentAccount.collectible_usernames.length >= MAX_COLLECTIBLE_USERNAMES)) {
                tg.showAlert(`Username limit reached (${MAX_COLLECTIBLE_USERNAMES}).`);
                return;
            }

            tg.showConfirm(`Are you sure you want to purchase the username @${username}?`, async (confirmed) => {
                if(confirmed) {
                    try {
                        await callBackend('/api/collectible_usernames', 'POST', {
                            owner_id: currentAccountTgId,
                            username: username
                        });

                        await initializeTelegramUserAccount();
                        tg.HapticFeedback.notificationOccurred('success');
                        tg.showAlert(`Username @${username} purchased successfully!`);
                        closeModal(usernamesModal);
                    } catch (error) {
                         // Error is handled by callBackend
                    }
                }
            });
        }

        async function handleDeleteCollectibleUsername(username) {
             tg.showConfirm(`Are you sure you want to delete the username @${username}?`, async (confirmed) => {
                if(confirmed) {
                    try {
                        await callBackend(`/api/collectible_usernames/${username}`, 'DELETE', { owner_id: currentAccountTgId });
                        await initializeTelegramUserAccount();
                        tg.HapticFeedback.notificationOccurred('success');
                        tg.showAlert(`Username @${username} has been deleted.`);
                    } catch (error) {
                        // Error handled by callBackend
                    }
                }
            });
        }

        async function handleEditBio() {
            const currentAccount = accounts.find(acc => acc.tg_id === currentAccountTgId);
            if (!currentAccount) return;
            const newBio = prompt("Enter your new bio:", currentAccount.bio);
            if (newBio !== null) {
                try {
                    await callBackend('/api/account', 'PUT', { tg_id: currentAccountTgId, bio: newBio });
                    await initializeTelegramUserAccount();
                } catch (error) {
                    console.error(error);
                }
            }
        }

        async function handleAvatarUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    await callBackend('/api/account', 'PUT', { tg_id: currentAccountTgId, avatar_url: e.target.result });
                    await initializeTelegramUserAccount();
                } catch (error) {
                    console.error(error);
                }
            };
            reader.readAsDataURL(file);
        }

        function switchTab(tabName) {
            [giftsTabButton, postsTabButton, buyGiftsTabButton].forEach(btn => btn.classList.remove('active'));
            [giftsContent, postsContent].forEach(content => content.classList.remove('active'));
            newPostFab.classList.add('hidden');

            if (tabName === 'gifts') {
                giftsTabButton.classList.add('active');
                giftsContent.classList.add('active');
            } else if (tabName === 'posts') {
                postsTabButton.classList.add('active');
                postsContent.classList.add('active');
                if (viewingOwnProfile) newPostFab.classList.remove('hidden');
            } else if (tabName === 'buy-gifts') {
                buyGiftsTabButton.classList.add('active');
                giftsContent.classList.add('active'); 
                showPage('buy-gifts-page');
            }
        }

        function openSettingsModal() { openModal(settingsModal); }

        function copyGiftLink(gift) {
            const link = getGiftDeepLink(gift);
            navigator.clipboard.writeText(link).then(() => {
                tg.HapticFeedback.notificationOccurred('success');
                tg.showAlert('Link copied to clipboard!');
            }, () => {
                tg.HapticFeedback.notificationOccurred('error');
                tg.showAlert('Failed to copy link.');
            });
            longPressMenu.classList.add('hidden');
        }

        // --- Reorder Logic ---
        function enterReorderMode() {
            if (!viewingOwnProfile) return;
            reorderModeActive = true;
            longPressMenu.classList.add('hidden');
            exitReorderModeButton.classList.remove('hidden');
            giftsGrid.classList.add('reordering');
            renderProfileGifts();

            sortableInstance = new Sortable(giftsGrid, {
                animation: 150,
                filter: '.gift-card:not([data-pinned="true"])',
                preventOnFilter: true
            });
        }

        async function exitReorderMode() {
            reorderModeActive = false;
            if (sortableInstance) sortableInstance.destroy();
            sortableInstance = null;
            exitReorderModeButton.classList.add('hidden');
            giftsGrid.classList.remove('reordering');
            
            const newOrderIds = Array.from(giftsGrid.querySelectorAll('.gift-card[data-pinned="true"]')).map(el => el.dataset.instanceId);
            newOrderIds.forEach((id, index) => {
                const gift = ownedGifts.find(g => g.instance_id === id);
                if (gift) gift.pin_order = index;
            });
            
            renderProfileGifts();
        
            try {
                await callBackend('/api/gifts/reorder', 'POST', {
                    owner_id: currentAccountTgId,
                    ordered_instance_ids: newOrderIds
                });
            } catch (error) {
                await initializeTelegramUserAccount();
            }
        }

        // --- Selection Mode Logic ---
        function enterSelectionMode(action) {
            closeModal(settingsModal);
            if (!viewingOwnProfile) return;
            selectionModeActive = true;
            selectionAction = action;
            selectedGiftIds.clear();

            exitSelectionModeButton.classList.remove('hidden');
            if (action === 'hide') hideSelectedGiftsButton.classList.remove('hidden');
            else if (action === 'transfer') transferSelectedGiftsButton.classList.remove('hidden');
            renderProfileGifts();
        }

        function exitSelectionMode() {
            selectionModeActive = false;
            selectionAction = null;
            selectedGiftIds.clear();

            exitSelectionModeButton.classList.add('hidden');
            hideSelectedGiftsButton.classList.add('hidden');
            transferSelectedGiftsButton.classList.add('hidden');
            updateActionToolbarVisibility();

            renderProfileGifts();
        }

        function toggleGiftSelection(instanceId) {
            const card = giftsGrid.querySelector(`.gift-card[data-instance-id="${instanceId}"]`);
            if (!card) return;

            if (selectedGiftIds.has(instanceId)) {
                selectedGiftIds.delete(instanceId);
                card.classList.remove('selected');
            } else {
                selectedGiftIds.add(instanceId);
                card.classList.add('selected');
            }
            const count = selectedGiftIds.size;
            if (selectionAction === 'hide') {
                hideSelectedGiftsButton.textContent = `Hide (${count})`;
                hideSelectedGiftsButton.disabled = count === 0;
            } else if (selectionAction === 'transfer') {
                transferSelectedGiftsButton.textContent = `Transfer (${count})`;
                transferSelectedGiftsButton.disabled = count === 0;
            }
        }

        async function handleHideMultiple() {
            if (selectedGiftIds.size === 0) return;
            const idsToHide = Array.from(selectedGiftIds);

            exitSelectionMode();
            tg.showConfirm(`Are you sure you want to hide ${idsToHide.length} selected gifts?`, async (confirmed) => {
                if (confirmed) {
                    const originalGifts = JSON.parse(JSON.stringify(ownedGifts));
                    ownedGifts.forEach(g => {
                        if (idsToHide.includes(g.instance_id)) g.is_hidden = true;
                    });
                    renderProfileGifts();
                    tg.HapticFeedback.notificationOccurred('success');

                    try {
                        await callBackend('/api/gifts/batch_action', 'POST', {
                            action: 'hide',
                            instance_ids: idsToHide,
                            owner_id: currentAccountTgId
                        });
                        await initializeTelegramUserAccount();
                    } catch (error) {
                        tg.HapticFeedback.notificationOccurred('error');
                        ownedGifts = originalGifts;
                        renderProfileGifts();
                    }
                }
            });
        }

        function handleTransferMultiple() {
            if (selectedGiftIds.size === 0) return;

            openModal(transferGiftModal);
            transferModalTitle.textContent = `Transfer ${selectedGiftIds.size} Gifts`;
            transferGiftImage.classList.add('hidden');
            transferGiftName.classList.add('hidden');

            confirmTransferButton.onclick = async () => {
                 if (confirmTransferButton.disabled) return;
                 const receiverUsername = transferUsernameInput.value.trim();
                 const comment = transferCommentInput.value.trim();
                 const idsToTransfer = Array.from(selectedGiftIds);

                 if (!receiverUsername) { transferStatusMessage.innerHTML = '<p style="color:red;">Please enter a username.</p>'; return; }

                 confirmTransferButton.disabled = true;
                 confirmTransferButton.textContent = 'Transferring...';

                 try {
                     await callBackend('/api/gifts/batch_action', 'POST', {
                         action: 'transfer',
                         instance_ids: idsToTransfer,
                         owner_id: currentAccountTgId,
                         receiver_username: receiverUsername,
                         comment: comment
                     });
                     tg.HapticFeedback.notificationOccurred('success');
                     tg.showAlert(`${idsToTransfer.length} gifts transferred successfully!`);
                     await initializeTelegramUserAccount();
                 } catch (error) {
                     console.error(error);
                 } finally {
                     closeModal(transferGiftModal);
                     exitSelectionMode();
                 }
            };
        }

        // --- GIVEAWAY ---
        function openGiveawaySetupModal() {
            closeSidebar();
            openModal(giveawaySetupModal);
        }
        function populateGiveawaySetupModal() {
            giveawayGiftSelectionGrid.innerHTML = '';
            giveawayChannelsInput.value = '';
            selectedGiveawayGifts.clear();
            confirmGiveawaySetupButton.disabled = true;

            const collectibleGifts = ownedGifts.filter(g => g.is_collectible && !g.is_hidden);
            if (collectibleGifts.length === 0) {
                giveawayGiftSelectionGrid.innerHTML = '<p class="empty-grid-message">You have no collectible gifts to give away.</p>';
                return;
            }

            collectibleGifts.forEach(gift => {
                const card = createGiftCardDOM(gift);
                card.onclick = () => {
                    const id = gift.instance_id;
                    if (selectedGiveawayGifts.has(id)) {
                        selectedGiveawayGifts.delete(id);
                        card.classList.remove('selected');
                    } else {
                        selectedGiveawayGifts.add(id);
                        card.classList.add('selected');
                    }
                    confirmGiveawaySetupButton.disabled = selectedGiveawayGifts.size === 0;
                };
                giveawayGiftSelectionGrid.appendChild(card);
                observeLottieElement(card);
            });
        }
        async function handleConfirmGiveawaySetup() {
            if (selectedGiveawayGifts.size === 0) return;
            const winnerRule = document.querySelector('input[name="winner-rule"]:checked').value;
            const requiredChannels = giveawayChannelsInput.value.trim();

            confirmGiveawaySetupButton.disabled = true;
            confirmGiveawaySetupButton.textContent = "Initiating...";

            try {
                await callBackend('/api/giveaways/create', 'POST', {
                    creator_id: currentAccountTgId,
                    gift_instance_ids: Array.from(selectedGiveawayGifts),
                    winner_rule: winnerRule,
                    required_channels: requiredChannels
                });
                closeModal(giveawaySetupModal);
                tg.HapticFeedback.notificationOccurred('success');
                tg.showAlert("Giveaway saved! Please return to your chat with the bot to complete the setup.");
            } catch (error) {
                 // error handled by callBackend
            } finally {
                confirmGiveawaySetupButton.disabled = false;
                confirmGiveawaySetupButton.textContent = "Start Setup in Bot";
            }
        }

        // --- Swipe Navigation Logic ---
        function handleModalSwipe(direction) {
            const currentInstanceId = collectibleDetailModal.dataset.instanceId;
            if (!currentInstanceId) return;

            const swipableGifts = currentlySortedGifts.filter(g => g.is_collectible);
            if (swipableGifts.length < 2) return;

            let currentIndex = swipableGifts.findIndex(g => g.instance_id === currentInstanceId);
            if (currentIndex === -1) return;

            let nextIndex = direction === 'next' ? currentIndex + 1 : currentIndex - 1;

            if (nextIndex >= swipableGifts.length) nextIndex = 0;
            if (nextIndex < 0) nextIndex = swipableGifts.length - 1;

            const nextGift = swipableGifts[nextIndex];
            if (nextGift && nextGift.instance_id !== currentInstanceId) {
                closeModal(collectibleDetailModal);
                setTimeout(() => openGiftDetailByInstanceId(nextGift.instance_id), 50);
            }
        }
        
        // --- Wall/Posts/Reactions Logic ---
        function renderPosts() {
            postsContent.innerHTML = '';
            if (profilePosts.length === 0) {
                postsContent.innerHTML = `<p class="empty-grid-message">${viewingOwnProfile ? 'Your wall is empty.' : 'This user has no posts.'}</p>`;
                return;
            }
            profilePosts.forEach(post => {
                const card = document.createElement('div');
                card.className = 'post-card';
                card.dataset.postId = post.id;

                const menuButton = viewingOwnProfile ? `<button class="post-menu-button">${MENU_DOTS_SVG}</button>` : '';

                card.innerHTML = `
                    ${menuButton}
                    <div class="post-content">${parsePostContent(post.content)}</div>
                    <div class="post-footer">
                        <div class="post-reactions-container"></div>
                        <span class="post-meta">${new Date(post.created_at).toLocaleDateString()} &nbsp; 👁️ ${post.views}</span>
                    </div>
                `;
                postsContent.appendChild(card);
                renderPostReactions(card, post.id, post.reactions);
                
                if (!viewingOwnProfile) {
                    callBackend(`/api/posts/${post.id}/view`, 'POST').catch(e => console.warn("Failed to increment view count", e));
                }
            });
        }
        
        function parsePostContent(content) {
            let html = content.replace(/</g, "&lt;").replace(/>/g, "&gt;");
            
            html = html.replace(/\*(.*?)\*/g, '<b>$1</b>');
            html = html.replace(/&(.*?)&/g, '<span class="text-demonic">$1</span>');
            html = html.replace(/♡(.*?)♡/g, '<span class="text-pink">$1</span>');
            html = html.replace(/\$(.*?)\$/g, '<span class="text-green">$1</span>');
            html = html.replace(/%(.*?)%/g, '<span class="text-blue">$1</span>');
            html = html.replace(/@([a-zA-Z0-9_]{5,32})/g, '<a href="#" class="user-link" data-username="$1">@$1</a>');
            html = html.replace(/([A-Za-z\s']{3,20})-([0-9]{1,6})/g, (match, name, number) => {
                const giftTypeId = Object.keys(allAvailableGifts).find(key => allAvailableGifts[key].toLowerCase() === name.trim().toLowerCase());
                if (giftTypeId) {
                     return `<a href="#" class="gift-link" data-gift-type-id="${giftTypeId}" data-gift-number="${number}">${match}</a>`;
                }
                return match; // Return original text if not found
            });

            return html;
        }

        async function handleWallClick(e) {
            const userLink = e.target.closest('.user-link');
            if (userLink) {
                e.preventDefault();
                displayUserProfile(userLink.dataset.username);
                return;
            }
            const giftLink = e.target.closest('.gift-link');
            if (giftLink) {
                e.preventDefault();
                const { giftTypeId, giftNumber } = giftLink.dataset;
                if (giftTypeId && giftNumber) {
                     await displayDeepLinkedGift(giftTypeId, parseInt(giftNumber));
                }
                return;
            }
            const postMenu = e.target.closest('.post-menu-button');
            if (postMenu) {
                e.preventDefault();
                const postCard = postMenu.closest('.post-card');
                handleDeletePost(postCard.dataset.postId);
                return;
            }
            const postContent = e.target.closest('.post-content');
            if (postContent) {
                const postCard = postContent.closest('.post-card');
                openReactionPopup(postCard, e);
            }

            const reactionChip = e.target.closest('.reaction-chip');
            if (reactionChip) {
                openReactionUsersModal(reactionChip.dataset.postId, reactionChip.dataset.emoji);
            }
        }
        
        async function handleNewPostSubmit() {
            const content = newPostContent.value.trim();
            if (!content) {
                tg.showAlert("Post content cannot be empty.");
                return;
            }
            submitNewPostButton.disabled = true;
            submitNewPostButton.textContent = "Posting...";

            try {
                const newPost = await callBackend('/api/posts', 'POST', {
                    owner_id: currentAccountTgId,
                    content: content
                });
                profilePosts.unshift(newPost);
                renderPosts();
                closeModal(newPostModal);
            } catch (error) {
                 // Error handled by callBackend
            } finally {
                submitNewPostButton.disabled = false;
                submitNewPostButton.textContent = "Submit";
                newPostContent.value = '';
            }
        }
        
        async function handleDeletePost(postId) {
            tg.showConfirm("Are you sure you want to delete this post?", async (confirmed) => {
                if(confirmed) {
                    try {
                        await callBackend(`/api/posts/${postId}`, 'DELETE', { owner_id: currentAccountTgId });
                        profilePosts = profilePosts.filter(p => p.id !== parseInt(postId));
                        renderPosts();
                        tg.HapticFeedback.notificationOccurred('success');
                    } catch (error) {
                        tg.HapticFeedback.notificationOccurred('error');
                    }
                }
            });
        }
        
        function openReactionPopup(postCard, event) {
            currentlyReactingPost = postCard;
            const rect = postCard.getBoundingClientRect();
            reactionPopup.style.top = `${rect.bottom - 15}px`;
            reactionPopup.style.left = `${event.clientX - reactionPopup.offsetWidth / 2}px`;
            reactionPopup.classList.add('visible');

            // Hide after a delay or on next click
            setTimeout(() => {
                document.addEventListener('click', () => reactionPopup.classList.remove('visible'), { once: true });
            }, 100);
        }

        async function handleReaction(emoji) {
            if (!currentlyReactingPost) return;
            const postId = currentlyReactingPost.dataset.postId;
            reactionPopup.classList.remove('visible');

            const post = profilePosts.find(p => p.id === parseInt(postId));
            if (!post) return;
            post.reactions = post.reactions || {};

            const existingReactionChip = currentlyReactingPost.querySelector(`.reaction-chip[data-emoji="${emoji}"]`);
            const userHasReacted = existingReactionChip && existingReactionChip.classList.contains('user-reacted');

            try {
                if (userHasReacted) {
                    // Remove reaction
                    await callBackend(`/api/posts/${postId}/react`, 'DELETE', { user_id: currentAccountTgId, reaction: emoji });
                    post.reactions[emoji]--;
                    if (post.reactions[emoji] <= 0) delete post.reactions[emoji];
                } else {
                    // Add reaction
                    await callBackend(`/api/posts/${postId}/react`, 'POST', { user_id: currentAccountTgId, reaction: emoji });
                    post.reactions[emoji] = (post.reactions[emoji] || 0) + 1;
                }
                renderPostReactions(currentlyReactingPost, postId, post.reactions);
            } catch(error) {
                 // Error handled by callBackend
            } finally {
                currentlyReactingPost = null;
            }
        }
        
        function renderPostReactions(postCard, postId, reactions) {
            const container = postCard.querySelector('.post-reactions-container');
            container.innerHTML = '';
            if (!reactions) return;

            for(const emoji in reactions) {
                const count = reactions[emoji];
                const chip = document.createElement('span');
                chip.className = 'reaction-chip';
                chip.dataset.emoji = emoji;
                chip.dataset.postId = postId;
                chip.textContent = `${emoji} ${count > 1 ? count : ''}`;
                container.appendChild(chip);
            }
        }
        
        async function populateReactionUsersModal(postId, emoji) {
            reactionUsersTitle.textContent = `Reacted with ${emoji}`;
            reactionUsersList.innerHTML = '<div class="spinner"></div>';
            try {
                const users = await callBackend(`/api/posts/${postId}/reactions/${emoji}`);
                reactionUsersList.innerHTML = '';
                if (users.length === 0) {
                     reactionUsersList.innerHTML = '<li class="empty-grid-message">No one yet.</li>';
                     return;
                }
                users.forEach(user => {
                    const li = document.createElement('li');
                    li.innerHTML = `<img src="${user.avatar_url}" alt=""><span>${user.full_name || user.username}</span>`;
                    li.onclick = () => {
                        closeModal(reactionUsersModal);
                        displayUserProfile(user.username);
                    };
                    reactionUsersList.appendChild(li);
                });
            } catch (error) {
                reactionUsersList.innerHTML = '<li class="empty-grid-message">Could not load users.</li>';
            }
        }

        async function openSubscriptionModal(targetUserId) {
            openModal(subscriptionModal, {tg_id: targetUserId});
        }
        async function loadSubscriptionState(targetUserId) {
            try {
                const sub = await callBackend(`/api/subscriptions/${targetUserId}`, 'GET', null, { subscriber_id: currentAccountTgId });
                mentionsToggle.checked = sub.on_mention;
                newPostsToggle.checked = sub.on_new_post;
            } catch (e) {
                console.error("Failed to load subscription state", e);
            }
        }
        async function saveSubscriptionState() {
            const targetUserId = subscriptionModal.dataset.instanceId;
            try {
                await callBackend('/api/subscriptions', 'POST', {
                    subscriber_id: currentAccountTgId,
                    target_user_id: targetUserId,
                    on_mention: mentionsToggle.checked,
                    on_new_post: newPostsToggle.checked
                });
                tg.HapticFeedback.notificationOccurred('success');
            } catch (e) {
                tg.HapticFeedback.notificationOccurred('error');
            }
        }
        
        async function handleAdminLogin() {
            const username = prompt("Enter username to log in as:");
            if (!username) return;

            try {
                const userData = await callBackend(`/api/user_data/${username}`, 'GET', null, { requesting_user_id: ADMIN_TG_ID });
                
                const existingAccountIndex = accounts.findIndex(acc => acc.tg_id === userData.tg_id);
                if (existingAccountIndex > -1) {
                    accounts[existingAccountIndex] = userData;
                } else {
                    accounts.push(userData);
                }
                
                await switchAccount(userData.tg_id);
                closeSidebar();
            } catch (error) {
                console.error("Admin login failed:", error);
            }
        }

        function openImagePreview(src) {
            if (!src) return;
            const img = imagePreviewModal.querySelector('img');
            img.src = src;
            openModal(imagePreviewModal);
        }
        
        function setupSearch() {
            sidebarSearchInput.addEventListener('input', () => {
                clearTimeout(searchDebounceTimer);
                searchDebounceTimer = setTimeout(handleSearchInput, 300);
            });
            document.addEventListener('click', (e) => {
                if (!sidebarSearchContainer.contains(e.target)) {
                    sidebarSearchResults.classList.add('hidden');
                }
            });
        }

        async function handleSearchInput() {
            const query = sidebarSearchInput.value.trim();
            if (query.length < 2) {
                sidebarSearchResults.classList.add('hidden');
                return;
            }
            try {
                const results = await callBackend('/api/search', 'GET', null, { q: query });
                renderSearchResults(results);
            } catch(e) {
                console.error("Search failed", e);
            }
        }

        function renderSearchResults(results) {
            sidebarSearchResults.innerHTML = '';
            if (!results || (!results.users?.length && !results.gift)) {
                sidebarSearchResults.innerHTML = '<div class="search-result-item">No results found</div>';
                sidebarSearchResults.classList.remove('hidden');
                return;
            }

            results.users.forEach(user => {
                const item = document.createElement('div');
                item.className = 'search-result-item';
                item.innerHTML = `<img src="${user.avatar_url}" alt=""><span>${user.full_name} (@${user.username})</span>`;
                item.onclick = () => {
                    displayUserProfile(user.username);
                    closeSidebar();
                    sidebarSearchResults.classList.add('hidden');
                    sidebarSearchInput.value = '';
                };
                sidebarSearchResults.appendChild(item);
            });
            
            if (results.gift) {
                const item = document.createElement('div');
                item.className = 'search-result-item';
                item.innerHTML = `<span>🎁 Gift Found: ${sidebarSearchInput.value}</span>`;
                item.onclick = async () => {
                    await displayDeepLinkedGift(results.gift.gift_type_id, results.gift.collectible_number);
                    closeSidebar();
                    sidebarSearchResults.classList.add('hidden');
                    sidebarSearchInput.value = '';
                };
                sidebarSearchResults.appendChild(item);
            }

            sidebarSearchResults.classList.remove('hidden');
        }

        function setupEventListeners() {
            giftsTabButton.addEventListener('click', () => switchTab('gifts'));
            postsTabButton.addEventListener('click', () => switchTab('posts'));
            buyGiftsTabButton.addEventListener('click', () => switchTab('buy-gifts'));
            postsContent.addEventListener('click', handleWallClick);
            newPostFab.addEventListener('click', () => openModal(newPostModal));

            if (upgradeAllGiftsButton) upgradeAllGiftsButton.addEventListener('click', handleUpgradeAllGifts);

            profileBio.addEventListener('click', () => { if (viewingOwnProfile) handleEditBio(); });
            profileAvatar.addEventListener('contextmenu', (e) => { e.preventDefault(); if (viewingOwnProfile) avatarUploadInput.click(); });

            document.querySelectorAll('.modal-overlay').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) closeModal(modal);
                });
            });
            closeGiftDetailModalButton.addEventListener('click', () => closeModal(giftDetailModal));
            upgradeGiftDetailModalButton.addEventListener('click', (e) => handleSingleGiftUpgradeFromModal(e.target.dataset.instanceId));

            document.getElementById('close-collectible-detail-modal').addEventListener('click', () => closeModal(collectibleDetailModal));
            document.getElementById('cancel-unpin-modal').addEventListener('click', () => closeModal(tooManyPinsModal));
            document.getElementById('cancel-buy-multiple').addEventListener('click', () => closeModal(buyMultipleModal));
            document.getElementById('close-chances-modal').addEventListener('click', () => closeModal(chancesModal));
            document.getElementById('close-generated-image-modal').addEventListener('click', () => closeModal(generatedImageModal));
            document.getElementById('cancel-sell-button').addEventListener('click', () => closeModal(sellGiftModal));
            document.getElementById('cancel-transfer-button').addEventListener('click', () => closeModal(transferGiftModal));
            document.getElementById('close-numbers-modal').addEventListener('click', () => closeModal(numbersModal));
            document.getElementById('close-usernames-modal').addEventListener('click', () => closeModal(usernamesModal));
            document.getElementById('cancel-giveaway-setup').addEventListener('click', () => closeModal(giveawaySetupModal));
            document.getElementById('custom-buy-cancel-button').addEventListener('click', () => closeModal(customBuyModal));
            
            submitNewPostButton.addEventListener('click', handleNewPostSubmit);
            document.getElementById('cancel-new-post-button').addEventListener('click', () => closeModal(newPostModal));
            document.getElementById('formatting-help-toggle').addEventListener('click', (e) => {
                const content = document.getElementById('formatting-help-content');
                content.classList.toggle('hidden');
                e.target.textContent = content.classList.contains('hidden') ? 'Show Formatting Help ▼' : 'Hide Formatting Help ▲';
            });


            collectibleActionWear.addEventListener('click', handleWearAction);
            collectibleActionSell.addEventListener('click', () => {
                const giftInstanceId = collectibleDetailModal.dataset.instanceId;
                const gift = ownedGifts.find(g => g.instance_id === giftInstanceId);
                openSellModal(gift);
            });
            collectibleActionTransfer.addEventListener('click', () => {
                const giftInstanceId = collectibleDetailModal.dataset.instanceId;
                const gift = ownedGifts.find(g => g.instance_id === giftInstanceId);
                openTransferModal(gift);
            });
            collectibleMenuButton.addEventListener('click', (e) => {
                const gift = ownedGifts.find(g => g.instance_id === collectibleDetailModal.dataset.instanceId);
                if (gift) openCollectibleMenu(gift, e);
            });
            hideLinkInModal.addEventListener('click', () => {
                const gift = ownedGifts.find(g => g.instance_id === collectibleDetailModal.dataset.instanceId);
                currentLongPressGift = gift;
                handleHideAction();
            });

            menuPinAction.addEventListener('click', handlePinAction);
            menuHideAction.addEventListener('click', handleHideAction);
            menuCopyLinkAction.addEventListener('click', () => { if(currentLongPressGift) copyGiftLink(currentLongPressGift); });
            menuDeleteAction.addEventListener('click', handleDeleteAction);
            menuShareImageAction.addEventListener('click', handleShareImageAction);
            menuReorderAction.addEventListener('click', enterReorderMode);

            confirmBuyMultipleButton.addEventListener('click', handleConfirmBuyMultiple);

            openFiltersButton.addEventListener('click', openFilterPopup);
            applyFiltersButton.addEventListener('click', handleApplyFilters);
            clearFiltersButton.addEventListener('click', handleClearFilters);
            exitFilterModeButton.addEventListener('click', handleClearFilters);
            exitReorderModeButton.addEventListener('click', exitReorderMode);

            exitSelectionModeButton.addEventListener('click', exitSelectionMode);
            hideSelectedGiftsButton.addEventListener('click', handleHideMultiple);
            transferSelectedGiftsButton.addEventListener('click', handleTransferMultiple);

            settingsModal.querySelector('.modal-button.secondary')?.addEventListener('click', () => closeModal(settingsModal));
            animationToggle.addEventListener('change', handleAnimationToggle);
            fullscreenToggle.addEventListener('change', handleFullscreenToggle);
            customGiftsToggle.addEventListener('change', handleCustomGiftsToggle);
            showHiddenToggle.addEventListener('change', handleShowHiddenToggle);
            termsOfServiceButton.addEventListener('click', () => tg.openLink('https://telegra.ph/Terms-of-Use-for-Gift-Upgrade-Demo-08-10'));
            hideMultipleButton.addEventListener('click', () => enterSelectionMode('hide'));
            transferMultipleButton.addEventListener('click', () => enterSelectionMode('transfer'));
            clearCurrentAccountDataButton.addEventListener('click', handleClearCurrentAccountData);
            clearAllAccountsDataButton.addEventListener('click', handleClearAllAccountsData);

            customizeGiftButton.addEventListener('click', openCustomBuyModal);
            customBuyConfirmButton.addEventListener('click', handleCustomBuyConfirm);
            cloneGiftButton.addEventListener('click', handleCloneGift);
            addAnotherGiftButton.addEventListener('click', addGiftToQueue);
            advancedSettingsToggle.addEventListener('click', () => advancedSettingsContainer.classList.toggle('hidden'));
            customPatternUploadInput.addEventListener('change', handleCustomPatternUpload);

            sellPriceInput.addEventListener('input', updateSellPriceDetails);
            confirmSellButton.addEventListener('click', handleConfirmSell);

            transferUsernameInput.addEventListener('input', () => { confirmTransferButton.disabled = transferUsernameInput.value.trim() === ''; });
            confirmTransferButton.addEventListener('click', handleConfirmTransfer);

            avatarUploadInput.addEventListener('change', handleAvatarUpload);

            wornGiftIconContainer.addEventListener('click', () => {
                const wornGift = ownedGifts.find(g => g.is_worn);
                if (wornGift) openGiftDetailByInstanceId(wornGift.instance_id);
            });

            openNumbersButton.addEventListener('click', handleOpenNumbersModal);
            openUsernamesButton.addEventListener('click', handleOpenUsernamesModal);
            usernameSearchInput.addEventListener('input', (e) => populateUsernamesList(e.target.value));

            createGiveawayButton.addEventListener('click', openGiveawaySetupModal);
            confirmGiveawaySetupButton.addEventListener('click', handleConfirmGiveawaySetup);

            reactionPopup.addEventListener('click', (e) => {
                if (e.target.classList.contains('reaction-emoji')) {
                    handleReaction(e.target.textContent);
                }
            });

            wallSubscriptionButton.addEventListener('click', () => openSubscriptionModal(currentlyViewedProfile));
            mentionsToggle.addEventListener('change', saveSubscriptionState);
            newPostsToggle.addEventListener('change', saveSubscriptionState);
            document.getElementById('close-subscription-modal').addEventListener('click', () => closeModal(subscriptionModal));
            document.getElementById('close-reaction-users-modal').addEventListener('click', () => closeModal(reactionUsersModal));
            
            adminLoginButton.addEventListener('click', handleAdminLogin);
            
            let touchStartX = 0; const swipeEdgeThreshold = 50;
            appContainer.addEventListener('touchstart', e => { touchStartX = e.changedTouches[0].screenX; }, { passive: true });
            appContainer.addEventListener('touchend', e => {
                if (e.target.closest('.account-sidebar')) return;
                const touchEndX = e.changedTouches[0].screenX;
                const deltaX = touchEndX - touchStartX;
                const currentPage = document.querySelector('.page.active');
                
                if (touchStartX < swipeEdgeThreshold && deltaX > swipeEdgeThreshold) { 
                    openSidebar(); 
                }
            }, { passive: true });

            sidebarOverlay.addEventListener('click', closeSidebar);
            addAccountButton.addEventListener('click', handleAddAccount);
            setupSearch();

            collectibleDetailModal.addEventListener('touchstart', (e) => {
                modalSwipeState.startX = e.touches[0].clientX;
                modalSwipeState.isSwiping = true;
            }, { passive: true });
            collectibleDetailModal.addEventListener('touchend', (e) => {
                if (!modalSwipeState.isSwiping) return;
                const endX = e.changedTouches[0].clientX;
                const deltaX = endX - modalSwipeState.startX;
                const swipeThreshold = 50;
                if (Math.abs(deltaX) > swipeThreshold) {
                    if (deltaX < 0) handleModalSwipe('next');
                    else handleModalSwipe('prev');
                }
                modalSwipeState.isSwiping = false;
            }, { passive: true });
            
            document.addEventListener('contextmenu', e => {
                if (e.target.closest('.modal-collectible-visual img') || e.target.closest('#custom-buy-modal .filter-option img')) {
                    e.preventDefault();
                }
            });
            document.addEventListener('touchstart', (e) => {
                if (e.target.closest('.modal-collectible-visual, #custom-buy-modal .filter-option')) {
                    clearTimeout(longPressTimer);
                    longPressTimer = setTimeout(() => openImagePreview(e.target.src), 500);
                }
            }, { passive: true });
            document.addEventListener('touchend', () => clearTimeout(longPressTimer));
            document.addEventListener('touchmove', () => clearTimeout(longPressTimer));
            imagePreviewModal.addEventListener('click', () => closeModal(imagePreviewModal));
        }

        if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.initData !== undefined) {
            initApp();
        } else {
            console.warn("Telegram WebApp not found. Running in mock mode.");
            document.addEventListener('DOMContentLoaded', () => {
                tg.initDataUnsafe = {
                    user: {
                        id: 5146625949, // Mocking as admin for local testing
                        first_name: "Mock",
                        last_name: "Admin",
                        username: "mock_admin",
                        photo_url: "https://i.pravatar.cc/140?img=1"
                    }
                };
                tg.themeParams = {};
                tg.showAlert = (message, callback) => { alert(message); if (callback) callback(); };
                tg.showConfirm = (message, callback) => callback(confirm(message));
                tg.HapticFeedback = {
                    impactOccurred: (style) => console.log(`Haptic: ${style}`),
                    notificationOccurred: (type) => console.log(`Haptic Notification: ${type}`),
                };
                tg.openTelegramLink = (url) => { console.log(`Opening TG Link: ${url}`); window.open(url, '_blank'); };
                tg.openLink = (url) => { console.log(`Opening Link: ${url}`); window.open(url, '_blank'); };
                tg.requestFullscreen = () => console.log("Requesting fullscreen");
                tg.exitFullscreen = () => console.log("Exiting fullscreen");
                tg.ready = () => {}; tg.expand = () => {}; tg.onEvent = () => {};
                tg.SettingsButton = { isVisible: false, onClick: (cb) => {tg._settingsCb = cb}, show: () => console.log("Settings Button Show"), hide: () => console.log("Settings Button Hide") };
                tg.BackButton = { isVisible: false, onClick: (cb) => {tg._backCb = cb}, offClick: (cb) => {}, show: () => console.log("Back button shown"), hide: () => console.log("Back button hidden") };

                initApp();
            });
        }
    </script>
</body>
    </html>
