<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Telegram Gift Simulator</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.2/Sortable.min.js"></script>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-F3KPE0SD07"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-F3KPE0SD07');
    </script>
    <style>
        :root {
            --tg-theme-bg-color: #0e1621;
            --tg-theme-text-color: #ffffff;
            --tg-theme-hint-color: #708499;
            --tg-theme-link-color: #62bcf9;
            --tg-theme-button-color: #3e97f0;
            --tg-theme-button-text-color: #ffffff;
            --tg-theme-secondary-bg-color: #17212b;
            --tg-theme-accent-blue: #5288c1;

            --app-modal-backdrop-color: rgba(0,0,0,0.7);
            --app-rarity-chip-bg: rgba(0,0,0,0.2);
            --app-rarity-chip-text: var(--tg-theme-text-color);
            --app-action-button-bg: #232e3a;
            --app-action-button-text: var(--tg-theme-link-color);
            --app-profile-gradient-fallback: var(--tg-theme-secondary-bg-color);
            --app-clear-data-color: #ff3b30;

            /* Wall Colors */
            --app-wall-demonic-red: #ff3b30;
            --app-wall-pink: #ff80ab;
            --app-wall-green: #4caf50;
            --app-wall-blue: #2196f3;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--tg-theme-bg-color);
            color: var(--tg-theme-text-color);
            overscroll-behavior-y: none;
            line-height: 1.4;
            font-size: 16px;
            overflow-x: hidden;
        }

        .app-container {
            max-width: 600px;
            margin: 0 auto;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        /* Account Sidebar Styles */
        .account-sidebar {
            position: fixed;
            top: 0;
            left: 0;
            bottom: 0;
            width: 80%;
            max-width: 320px;
            background-color: var(--tg-theme-bg-color);
            z-index: 2000;
            transform: translateX(-100%);
            transition: transform 0.3s ease-in-out;
            display: flex;
            flex-direction: column;
            box-shadow: 2px 0 15px rgba(0,0,0,0.3);
        }
        .account-sidebar.active {
            transform: translateX(0);
        }
        .sidebar-header {
            padding: 15px;
            background-color: var(--tg-theme-secondary-bg-color);
            display: flex;
            align-items: center;
        }
        .sidebar-header img {
            width: 50px; height: 50px;
            border-radius: 50%;
            margin-right: 15px;
        }
        .sidebar-header .name {
            font-size: 1.1em;
            font-weight: 500;
        }
        .accounts-list {
            list-style: none;
            flex-grow: 1;
            overflow-y: auto;
        }
        .gift-card .bottom-price-label {
            position: absolute;
            bottom: 5px;
            left: 50%; /* Center horizontally */
            transform: translateX(-50%); /* Adjust for element's own width */
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 4px;
            z-index: 4;
        }
        .gift-card .bottom-price-label img {
            width: 12px;
            height: 12px;
        }
        .accounts-list li {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            cursor: pointer;
            border-bottom: 1px solid var(--tg-theme-secondary-bg-color);
        }
        .accounts-list li:hover {
            background-color: rgba(255,255,255,0.05);
        }
        .accounts-list li.active {
            background-color: var(--tg-theme-link-color);
            color: var(--tg-theme-button-text-color);
        }
        .accounts-list li img {
            width: 40px; height: 40px;
            border-radius: 50%;
            margin-right: 15px;
        }
        .sidebar-footer {
            padding: 10px 15px;
            border-top: 1px solid var(--tg-theme-secondary-bg-color);
            overflow-y: auto;
        }
        .sidebar-footer button {
             width: 100%;
             padding: 12px;
             background: none;
             border: none;
             color: var(--tg-theme-link-color);
             text-align: left;
             font-size: 1em;
             cursor: pointer;
             border-radius: 8px;
             display: flex; align-items: center;
        }
        .sidebar-footer button svg {
            margin-right: 12px;
            width: 22px; height: 22px;
            fill: currentColor;
        }
        .sidebar-footer button:hover {
            background-color: rgba(255,255,255,0.05);
        }
        .sidebar-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0,0,0,0.5);
            z-index: 1999;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out;
        }
        .sidebar-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        /* End Account Sidebar */

        .page {
            display: none;
            flex-direction: column;
            flex-grow: 1;
            background-color: var(--tg-theme-bg-color);
        }

        .page.active {
            display: flex;
        }

        .page-header {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            background-color: var(--tg-theme-secondary-bg-color);
            min-height: 56px;
            position: sticky; top: 0; z-index: 10;
        }
        #profile-page > .page-header {
            background-color: transparent;
            position: absolute;
            top: 0; left:0; right:0;
            z-index: 100;
            display: flex;
            justify-content: space-between; /* Space out left/right icons */
            width: 100%;
        }
        .page-header h2 {
            font-size: 1.15em;
            color: var(--tg-theme-text-color);
            font-weight: 500;
        }

        .profile-page-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        
        /* Replace .profile-top-section */
        .profile-top-section {
            position: relative;
            padding-top: 56px;
            padding-bottom: 20px;
            background: var(--app-profile-gradient-fallback);
            transition: background 0.3s ease;
            width: 100%;
            /* This helps center the main content block */
            display: flex;
            justify-content: center;
        }
        .profile-header-pattern-overlay {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            pointer-events: none;
            z-index: 0;
            overflow: hidden; /* Keep patterns within the header bounds */
        }
        .header-pattern-item {
            position: absolute;
            /* CHANGED: Drastically reduced opacity for a subtle effect */
            opacity: 0.15;
            /* NEW: This filter creates the dark silhouette effect from any image */
            filter: brightness(0);
            transform-origin: center center;
            transform: translate(-50%, -50%);
            transition: transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275), opacity 0.5s ease;
            width: 40px;
            height: 40px;
            object-fit: contain;
        }
        .profile-header-content-wrapper {
             position: relative; z-index: 1;
             padding: 0 15px;
        }
        #profile-top-pinned-gifts {
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 420px; /* A bit wider for the gift spread */
            height: 320px; /* Taller to accommodate lower gifts */
            pointer-events: none;
        }


        .profile-top-pinned-gifts .pinned-gift-item {
            width: 44px; height: 44px; /* Slightly larger gifts */
            border-radius: 12px;
            background-color: rgba(0,0,0,0.1);
            overflow: hidden;
            cursor: pointer;
            position: absolute;
            /* We remove old positioning logic; it will be set by JS */
            pointer-events: auto;
            transition: transform 0.3s ease, top 0.3s ease, left 0.3s ease;
            transform: translate(-50%, -50%); /* Center the item on its coordinates */
        }
        /* Replace .profile-main-info */
        .profile-main-info {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 45px; /* Drastically reduce top margin to remove empty space */
            position: relative; 
            z-index: 10;
        }
        
        /* Replace .profile-avatar */
        .profile-avatar {
            width: 130px; height: 130px; /* Even bigger avatar to match the image */
            border-radius: 50%;
            background-color: var(--tg-theme-hint-color);
            margin-bottom: 15px;
            object-fit: cover;
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        /* Replace .profile-name-status */
        .profile-name-status {
            display: flex;
            flex-direction: column;
            align-items: center; /* Center the name and status line */
        }
        .profile-name-status .name-line { display: flex; align-items: center; }
        .profile-name-status h1 {
            font-size: 1.4em; font-weight: 600;
            color: var(--tg-theme-text-color);
        }
        #worn-gift-icon-container {
            width: 24px; height: 24px; margin-left: 8px;
            overflow: hidden;
            cursor: pointer;
        }
        .profile-name-status p { font-size: 0.95em; color: var(--tg-theme-text-color); opacity: 0.7; margin-top: 3px; }
        .profile-name-status p.online { opacity: 1; color: var(--tg-theme-link-color); }

        .profile-details-section {
            background-color: var(--tg-theme-bg-color);
            padding: 15px 15px 5px 15px;
        }
        .profile-details .info-block {
            margin-bottom: 16px;
        }
        .profile-details .info-value {
            font-size: 0.95em;
            color: var(--tg-theme-text-color);
            white-space: pre-wrap;
            word-break: break-word;
        }
        .profile-details .info-label {
            font-size: 0.9em;
            color: var(--tg-theme-hint-color);
            margin-bottom: 3px;
            display: block;
        }
        .profile-details .info-value.collectible-value {
            color: var(--tg-theme-link-color);
            cursor: pointer;
        }
        #profile-bio {
             cursor: pointer;
        }
        #collectible-usernames-container {
            margin-top: 4px;
            line-height: 1.5;
        }
        #collectible-usernames-container .also-text {
            color: var(--tg-theme-hint-color);
            margin-right: 6px;
        }
        #collectible-usernames-container .collectible-username-span {
            color: var(--tg-theme-link-color);
            margin-right: 6px;
            cursor: pointer;
        }

        .profile-tabs-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }
        .profile-tabs {
            display: flex; justify-content: space-around;
            background-color: var(--tg-theme-bg-color);
            padding: 5px 0 0 0;
        }
        .profile-tabs button {
            background: none; border: none;
            color: var(--tg-theme-hint-color);
            padding: 14px 10px; font-size: 1em;
            cursor: pointer; flex-grow: 1;
            border-bottom: 3px solid transparent; position: relative;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #gifts-tab-button .gift-preview-container {
            display: flex;
            align-items: center;
            margin-left: 8px;
        }
        #gifts-tab-button .gift-preview-container img {
            width: 20px;
            height: 20px;
            object-fit: contain;
            margin-left: 2px;
            background-color: rgba(0,0,0,0.1); /* Fallback */
            border-radius: 6px;
        }

        .profile-tabs button.active { color: var(--tg-theme-link-color); }
        .profile-tabs button.active::after {
            content: ''; position: absolute;
            bottom: 0px; left: 0; right: 0;
            height: 3px; background-color: var(--tg-theme-link-color);
        }
        .tab-content {
            display: none;
            flex-grow: 1;
        }
        .tab-content.active {
            display: flex;
            flex-direction: column;
        }
        
        /* Posts / Wall Styles */
        #posts-content {
            padding: 10px 15px;
            overflow-y: auto;
        }
        .post-card {
            background-color: var(--tg-theme-secondary-bg-color);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 12px;
        }
        .post-content {
            font-size: 1em;
            line-height: 1.5;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .post-content .text-demonic {
            color: var(--app-wall-demonic-red);
            font-size: 1.2em;
            font-weight: 600;
        }
        .post-content .text-pink { color: var(--app-wall-pink); }
        .post-content .text-green { color: var(--app-wall-green); }
        .post-content .text-blue { color: var(--app-wall-blue); }
        .post-content a.gift-link, .post-content a.user-link {
            color: var(--tg-theme-link-color);
            text-decoration: none;
            cursor: pointer;
        }
        .post-content a.gift-link:hover, .post-content a.user-link:hover {
            text-decoration: underline;
        }
        .post-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 12px;
            font-size: 0.8em;
            color: var(--tg-theme-hint-color);
        }
        
        .new-post-fab {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 56px;
            height: 56px;
            background-color: var(--tg-theme-button-color);
            color: var(--tg-theme-button-text-color);
            border-radius: 50%;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            font-weight: 300;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            cursor: pointer;
            z-index: 999;
        }
        /* End Wall Styles */

        /* NEW: Action bar is now a direct child of gifts-content */
        #gifts-content .profile-gifts-actions-wrapper {
            display: flex;
            align-items: center;
            background-color: var(--tg-theme-bg-color);
            padding: 12px 15px;
        }
        .profile-gifts-actions {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            width: 100%;
        }
        .profile-gifts-actions .action-button {
            background-color: var(--tg-theme-button-color);
            color: var(--tg-theme-button-text-color);
            border: none; padding: 8px 18px;
            border-radius: 20px; font-size: 0.9em; cursor: pointer;
            font-weight: 500;
        }
        #upgrade-all-gifts-button { background-color: var(--tg-theme-accent-blue); margin-right: 10px; }

        #exit-filter-mode-button, #hide-selected-gifts-button, #exit-selection-mode-button,
        #exit-reorder-mode-button, #transfer-selected-gifts-button {
            background-color: var(--tg-theme-accent-blue);
            color: var(--tg-theme-button-text-color);
            border: none;
            padding: 8px 18px;
            border-radius: 20px;
            font-size: 0.9em;
            cursor: pointer;
            font-weight: 500;
            margin-right: 10px;
        }
        
        #buy-gifts-page .buy-gifts-header-actions {
            display: flex;
            justify-content: flex-end;
        }
        
        #buy-gifts-page .buy-gifts-header-actions .action-button {
            background-color: var(--tg-theme-button-color);
            color: var(--tg-theme-button-text-color);
            border: none; padding: 8px 18px;
            border-radius: 20px; font-size: 0.9em; cursor: pointer;
            font-weight: 500;
        }

        #buy-gifts-page .page-header { justify-content: space-between; }


        .gifts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            /* Slightly smaller gap for a tighter feel */
            gap: 8px; 
            padding: 10px;
            flex-grow: 1;
            overflow-y: auto;
            background-color: var(--tg-theme-bg-color);
        }
        .gifts-grid.reordering .gift-card[data-pinned="true"] {
            cursor: grabbing;
        }
        .empty-grid-message {
            color: var(--tg-theme-hint-color); text-align: center;
            padding: 30px 40px; font-size: 0.95em; line-height: 1.5; width: 100%;
        }

        .gift-card, .buy-gift-item {
            background-color: var(--tg-theme-secondary-bg-color);
            border-radius: 10px;
            padding: 8px;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            aspect-ratio: 1 / 1; cursor: pointer;
            position: relative; overflow: hidden;
            transition: transform 0.1s ease-out, opacity 0.2s;
        }
        .gift-card.is-hidden {
            opacity: 0.5;
            filter: grayscale(80%);
        }
        .buy-gift-item { aspect-ratio: 1/1.3; }
        .gift-card.is-updating { transform: scale(0.95); opacity: 0.7; }
        .sortable-chosen, .sortable-ghost {
            cursor: grabbing !important;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            transform: scale(1.05);
            opacity: 0.7;
        }
        .gift-card-bg-pattern, .buy-gift-item-bg-pattern {
            position: absolute; 
            top: 0; left: 0; right: 0; bottom: 0;
            background-size: cover; 
            pointer-events: none; 
            z-index: 0;
            /* REMOVE overflow: hidden; and position: relative; */
        }
        .dynamic-pattern-container {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            overflow: hidden; /* Keep symbols inside the card */
            z-index: 1; /* Place it just above the background gradient */
            pointer-events: none;
        }
        .card-pattern-symbol {
            position: absolute;
            opacity: 0.17; /* Lowered opacity for subtlety */
            transform-origin: center center; 
        }
        .image-container {
            width: 70%; height: 70%;
            display: flex; align-items: center; justify-content: center;
            position: relative; z-index: 2;
        }
        .buy-gift-item .image-container {
            width: 65%; max-height: 60px;
            margin-bottom: 8px; height: auto;
        }
        .image-container .static-image-fallback,
        .image-container .lottie-animation-container {
             /* Add a drop shadow for depth */
            filter: drop-shadow(0 3px 6px rgba(0,0,0,0.2));
        }

        .static-image-fallback {
            max-width: 100%; max-height: 100%;
            object-fit: contain;
        }
        .lottie-animation-container {
            width: 100%; height: 100%;
            display: flex; align-items: center; justify-content: center;
        }

        /* Rotated Label - CORRECTED */
        .gift-card .top-right-label {
            position: absolute;
            top: 12px;      /* Tweak to position vertically */
            right: -34px;     /* Tweak to position horizontally */
            transform: rotate(45deg);
            transform-origin: center;
            background: linear-gradient(to bottom, rgba(0,0,0,0.45), rgba(0,0,0,0.35));
            color: var(--tg-theme-text-color);
            font-size: 0.65em;
            padding: 2px 35px; /* Wide padding makes the ribbon long */
            z-index: 4;
            font-weight: 500;
            white-space: nowrap;
            box-shadow: inset 0 1px 1px rgba(255, 255, 255, 0.1);
            border-top: 1px solid rgba(255,255,255,0.1);
            border-bottom: 1px solid rgba(0,0,0,0.2);
        }

        .gift-card .pin-indicator {
            position: absolute; top: 5px; left: 5px;
            z-index: 3; display: flex; align-items: center; justify-content: center;
        }
        .gift-card .pin-indicator svg {
            width: 18px; 
            height: 18px; 
            fill: #FFFFFF; /* Changed from variable to solid white */
            opacity: 0.9;
            filter: drop-shadow(0 1px 2px rgba(0,0,0,0.5)); /* Adds depth */
        }

        /* Selection Mode Checkbox */
        .gift-card .selection-checkbox {
            position: absolute; top: 5px; right: 5px; /* Moved to right for consistency */
            width: 22px; height: 22px;
            background-color: rgba(0, 0, 0, 0.4);
            border: 2px solid #fff;
            border-radius: 50%;
            z-index: 5; /* Higher than label */
            display: flex; align-items: center; justify-content: center;
            transition: background-color 0.2s;
        }
        .gift-card.selected .selection-checkbox {
            background-color: var(--tg-theme-button-color);
        }
        .gift-card.selected .selection-checkbox::after {
            content: '✓';
            color: var(--tg-theme-button-text-color);
            font-size: 14px;
            font-weight: bold;
        }

        .buy-gift-item .gift-name {
            font-size: 0.8em; text-align: center;
            color: var(--tg-theme-text-color); margin-bottom: 6px;
            min-height: 2.4em; overflow: hidden; text-overflow: ellipsis;
            display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;
            z-index: 2;
        }
        .buy-gift-item .gift-price {
            font-size: 0.9em;
            color: var(--tg-theme-hint-color);
            z-index: 2;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            padding: 2px 8px;
            border-radius: 12px;
        }
        .buy-gift-item .gift-price.has-price::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background-image: url('https://raw.githubusercontent.com/Vasiliy-katsyka/upgrade/refs/heads/main/DMJTGStarsEmoji_AgADUhMAAk9WoVI.png');
            background-size: 16px 16px;
            background-repeat: repeat;
            opacity: 0.08;
            border-radius: 12px;
            z-index: -1;
        }

        .buy-gift-item .gift-price .star-icon {
            width: 14px;
            height: 14px;
            margin-right: 4px;
            vertical-align: middle;
        }
        .buy-gift-item .limited-label {
            position: absolute; top: 6px; right: 6px;
            background-color: var(--tg-theme-accent-blue);
            color: var(--tg-theme-button-text-color);
            font-size: 0.6em; padding: 2px 6px;
            border-radius: 8px; font-weight: 500; z-index: 3;
        }

        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background-color: var(--app-modal-backdrop-color);
            display: flex; align-items: flex-end;
            justify-content: center; z-index: 1000;
            opacity: 0; visibility: hidden;
            transition: opacity 0.25s ease, transform 0.25s ease;
            transform: translateY(100%);
        }
        .modal-overlay.active { opacity: 1; visibility: visible; transform: translateY(0%); }
        .modal-content {
            background-color: var(--tg-theme-secondary-bg-color);
            padding-top: 0;
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
            width: 100%; max-width: 600px;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.2);
            display: flex; flex-direction: column;
            max-height: 90vh;
        }
        .modal-header-bar {
            padding: 15px 20px; text-align: center;
            position: sticky; top: 0; background-color: var(--tg-theme-secondary-bg-color); z-index: 1;
        }
        .modal-header-bar h3 { font-size: 1.1em; font-weight: 500; }

        .modal-scrollable-content { overflow-y: auto; padding: 15px 20px; flex-grow: 1; }
        .modal-buttons-footer {
            padding: 15px 20px;
            background-color: var(--tg-theme-secondary-bg-color);
            position: sticky; bottom: 0; z-index: 1;
            border-top: 1px solid var(--tg-theme-bg-color);
            display: flex;
            gap: 10px;
        }
        .modal-button {
            background-color: var(--tg-theme-button-color);
            color: var(--tg-theme-button-text-color);
            border: none; padding: 13px; border-radius: 8px;
            font-size: 1em; cursor: pointer; text-align: center;
            font-weight: 500; width: 100%;
            text-decoration: none;
            display: inline-block;
            flex-grow: 1;
        }
        .modal-button.secondary {
            background-color: var(--app-action-button-bg);
            color: var(--tg-theme-link-color);
        }
        .modal-buttons-footer .modal-button.secondary {
             margin-top: 0; /* Override default */
        }
        .modal-button:disabled {
            background-color: var(--tg-theme-hint-color);
            color: var(--tg-theme-secondary-bg-color);
            cursor: not-allowed;
        }


        #gift-detail-modal .modal-gift-image-container {
            width: 120px; height: 120px;
            margin: 10px auto 15px auto; display: flex;
            align-items: center; justify-content: center;
        }
        #gift-detail-modal .modal-gift-image-static {
             max-width: 100%; max-height: 100%; object-fit: contain;
        }
        #gift-detail-modal .lottie-animation-container {
             width: 100%; height: 100%;
        }
        #gift-detail-modal .modal-gift-description {
            font-size: 0.9em; color: var(--tg-theme-hint-color);
            margin-bottom: 8px; text-align: center; line-height: 1.5;
        }
        #gift-detail-modal .modal-info-table .info-row {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px 0; font-size: 0.95em;
        }
        #gift-detail-modal .modal-info-table .info-row:not(:last-child) { margin-bottom: 2px; }
        #gift-detail-modal .modal-info-table .info-label { color: var(--tg-theme-text-color); }
        #gift-detail-modal .modal-info-table .info-value { color: var(--tg-theme-hint-color); }

        /* === COLLECTIBLE MODAL REDESIGN === */
        #collectible-detail-modal .modal-content { padding-top: 0; overflow: hidden; }
        #collectible-detail-modal .modal-scrollable-content { padding: 0; }
        #collectible-detail-modal #collectible-menu-button {
            position: absolute; top: 10px; right: 10px; z-index: 3;
            background: rgba(0,0,0,0.2); border-radius: 50%; padding: 0;
            width: 36px; height: 36px;
        }
        #collectible-detail-modal #collectible-menu-button svg { fill: white; }

        #collectible-detail-modal .collectible-display-area {
            padding: 40px 0 20px 0; /* More vertical space */
            text-align: center;
            position: relative;
            overflow: hidden;
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
        }
        #pattern-container-dynamic {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            z-index: 1;
            pointer-events: none;
        }
        .dynamic-pattern-instance {
            position: absolute;
            opacity: 0.1; /* Fainter pattern */
            will-change: transform;
        }

        .modal-collectible-visual {
            width: 45%;
            max-width: 160px;
            aspect-ratio: 1/1;
            margin: 0 auto;
            position: relative;
            z-index: 2;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-collectible-visual .static-image-fallback {
             max-width: 100%;
             max-height: 100%;
             object-fit: contain;
        }
        .modal-collectible-visual .lottie-animation-container {
            width: 80%; height: 80%; object-fit: contain; z-index: 4; position: relative;
        }

        .collectible-display-area h3 {
            font-size: 1.6em; font-weight: 600; margin-top: 20px; margin-bottom: 5px;
            color: var(--tg-theme-text-color); position: relative; z-index: 2;
        }
        .collectible-display-area p {
            font-size: 1em; color: var(--tg-theme-hint-color); margin: 0;
            position: relative; z-index: 2;
        }
        .collectible-display-area p a {
            color: var(--tg-theme-link-color); text-decoration: none; cursor: pointer;
        }
        .collectible-display-area p a:hover { text-decoration: underline; }

        .modal-action-buttons-row {
            display: flex; justify-content: space-around; gap: 10px;
            padding: 20px; /* Moved padding here from display-area */
            background-color: transparent; /* No longer has its own background */
            position: relative; z-index: 2; /* Ensure buttons are on top */
        }
        .modal-action-buttons-row button {
            flex: 1; /* This is the key change: forces equal width */
            padding: 10px 5px;
            font-size: 0.9em;
            background-color: rgba(0, 0, 0, 0.25);
            color: var(--tg-theme-text-color);
            border: none;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            font-weight: 500;
        }
        .modal-action-buttons-row button .icon {
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 28px; /* A good fixed size */
            height: 28px;
        }
        .modal-action-buttons-row button .icon svg { width: 22px; height: 22px; fill: var(--tg-theme-link-color); }
        .modal-action-buttons-row button .text { font-size: 0.9em; }
        /* === END COLLECTIBLE MODAL REDESIGN === */

        .collectible-info-section { padding: 0 20px; background-color: var(--tg-theme-secondary-bg-color); }
        .collectible-info-section .info-row {
            display: flex; align-items: center; justify-content: space-between;
            padding: 12px 0;
            font-size: 0.95em; /* Slightly smaller text */
        }
        .collectible-info-section .info-row:not(:last-child) {
            border-bottom: 1px solid var(--tg-theme-bg-color);
        }
        .collectible-info-section .info-value img.owner-avatar {
            width: 24px; height: 24px; border-radius: 50%; margin-right: 8px;
        }
        .modal-footer-message {
            text-align: center; font-size: 0.85em;
            color: var(--tg-theme-hint-color); padding: 15px 20px;
            background-color: var(--tg-theme-bg-color); /* Matches Telegram's color break */
        }
        .modal-footer-message .link {
            color: var(--tg-theme-link-color); cursor: pointer;
        }
        .collectible-info-section .info-label { color: var(--tg-theme-text-color); }
        .collectible-info-section .info-value { color: var(--tg-theme-hint-color); display: flex; align-items: center; flex-wrap: wrap; justify-content: flex-end; }
        .collectible-info-section .info-value a {
            color: var(--tg-theme-link-color);
            text-decoration: none;
        }
        .collectible-info-section .info-value.clickable-info { cursor: pointer; }
        .collectible-info-section .info-value.clickable-info:active { opacity: 0.7; }
        .collectible-info-section .info-value img.owner-avatar { width: 24px; height: 24px; border-radius: 50%; margin-right: 8px; }
        .collectible-info-section .info-value .rarity-chip {
            background-color: var(--app-rarity-chip-bg);
            color: var(--app-rarity-chip-text);
            padding: 2px 7px; border-radius: 8px;
            font-size: 0.8em; margin-left: 8px; font-weight: 500;
        }
        .rarity-chip .one-in-x {
            font-size: 0.9em;
            opacity: 0.7;
            margin-left: 5px;
        }

        .modal-footer-message {
            text-align: center; font-size: 0.85em;
            color: var(--tg-theme-hint-color); padding: 15px 20px;
            background-color: var(--tg-theme-bg-color);
        }
        .modal-footer-message .link { color: var(--tg-theme-link-color); cursor: pointer; }

        #long-press-menu {
            position: fixed;
            background-color: var(--tg-theme-secondary-bg-color);
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            z-index: 2001; /* Higher than sidebar overlay */
            padding: 6px 0; min-width: 220px;
        }
        #long-press-menu ul { list-style: none; }
        #long-press-menu li { padding: 10px 20px; cursor: pointer; color: var(--tg-theme-text-color); font-size: 0.95em; }
        #long-press-menu li.disabled { color: var(--tg-theme-hint-color); cursor: default; }
        #long-press-menu li.danger { color: var(--app-clear-data-color); }
        #long-press-menu li:not(.disabled):hover { background-color: rgba(255,255,255,0.05); }

        #buy-multiple-quantity {
            width: 80px; padding: 10px; text-align: center; margin-bottom:15px;
            background-color: var(--tg-theme-bg-color);
            color: var(--tg-theme-text-color);
            border: 1px solid var(--tg-theme-hint-color);
            border-radius: 8px; font-size: 1em;
        }
        #buy-multiple-quantity::-webkit-outer-spin-button,
        #buy-multiple-quantity::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        #buy-multiple-quantity[type=number] { -moz-appearance: textfield; }

        .filter-section { margin-bottom: 15px; }
        .filter-section h4 {
            font-size: 0.9em; font-weight: 500; color: var(--tg-theme-hint-color);
            margin-bottom: 8px; padding-left: 5px;
        }
        .filter-options-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            gap: 8px; max-height: 150px; overflow-y: auto;
            padding: 5px; background-color: rgba(0,0,0,0.1); border-radius: 8px;
        }
        .filter-option {
            aspect-ratio: 1/1; border-radius: 6px;
            background-color: var(--tg-theme-bg-color);
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; border: 2px solid transparent;
            overflow: hidden;
            transition: border-color 0.2s;
        }
        .filter-option.selected { border-color: var(--tg-theme-link-color); }
        .filter-option img { max-width: 80%; max-height: 80%; object-fit: contain; }
        .filter-option .gradient-square { width: 100%; height: 100%; }

        #filter-popup .clear-data-button {
            background-color: transparent;
            color: var(--app-clear-data-color);
            border: none; padding: 13px; border-radius: 8px;
            font-size: 1em; cursor: pointer; text-align: center;
            font-weight: 500; width: 100%;
            display: flex; align-items: center; justify-content: center;
            margin-top: 15px;
        }
        #filter-popup .clear-data-button svg { width: 20px; height: 20px; fill: currentColor; margin-right: 8px; }

        #filter-popup .settings-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 5px;
            font-size: 1em;
        }
        .switch { position: relative; display: inline-block; width: 50px; height: 28px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--app-action-button-bg); transition: .4s; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: .4s; }
        input:checked + .slider { background-color: var(--tg-theme-link-color); }
        input:focus + .slider { box-shadow: 0 0 1px var(--tg-theme-link-color); }
        input:checked + .slider:before { transform: translateX(22px); }
        .slider.round { border-radius: 28px; }
        .slider.round:before { border-radius: 50%; }

        /* --- Custom Buy Modal & Multi-Gift --- */
        #custom-buy-modal .filter-section, #chances-modal .filter-section { margin-bottom: 20px; }
        #custom-buy-modal .filter-options-grid, #chances-modal .filter-options-grid {
            max-height: 200px; overflow-y: auto; padding: 5px;
            background-color: rgba(0,0,0,0.1); border-radius: 8px;
            grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
        }
        #custom-buy-modal .filter-option, #chances-modal .filter-option {
            background-color: var(--tg-theme-bg-color); border: 2px solid transparent;
            border-radius: 8px; padding: 5px; flex-direction: column;
            justify-content: flex-start; height: auto; aspect-ratio: auto;
            min-height: 80px;
        }
        #custom-buy-modal .filter-option.selected, #chances-modal .filter-option.selected { border-color: var(--tg-theme-link-color); }
        #custom-buy-modal .filter-option img, #custom-buy-modal .filter-option .gradient-square,
        #chances-modal .filter-option img, #chances-modal .filter-option .gradient-square {
            width: 100%; height: 60px; object-fit: contain;
            border-radius: 4px; margin-bottom: 5px;
        }
        #custom-buy-modal .filter-option .label, #chances-modal .filter-option .label {
            font-size: 0.75em; color: var(--tg-theme-text-color); text-align: center;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis; width: 100%;
        }
        #gift-queue-container {
            display: flex; flex-wrap: wrap; gap: 8px; padding: 10px 0;
            border-bottom: 1px solid var(--app-action-button-bg); margin-bottom: 15px;
        }
        .gift-queue-item {
            background-color: var(--app-action-button-bg); color: var(--tg-theme-text-color);
            padding: 8px 12px; border-radius: 16px; font-size: 0.9em; cursor: pointer;
            border: 2px solid transparent; display: flex; align-items: center; gap: 6px;
        }
        .gift-queue-item.active { border-color: var(--tg-theme-link-color); }
        .gift-queue-item .remove-queue-item {
            background-color: var(--tg-theme-hint-color); color: var(--tg-theme-bg-color);
            border: none; border-radius: 50%; width: 16px; height: 16px;
            display: flex; align-items: center; justify-content: center;
            font-size: 10px; font-weight: bold;
        }
        .advanced-settings-toggle {
            display: block; width: 100%; text-align: center; background: none;
            border: none; color: var(--tg-theme-link-color); font-size: 0.95em;
            padding: 8px; cursor: pointer; margin-top: 10px;
        }
        #advanced-settings-container {
            margin-top: 15px; padding-top: 15px;
            border-top: 1px solid var(--app-action-button-bg);
        }
        #advanced-settings-container input {
             width: 100%; padding: 12px; border-radius: 8px;
             border: 1px solid var(--tg-theme-bg-color); background-color: var(--tg-theme-bg-color);
             color: var(--tg-theme-text-color); font-size: 1em; margin-top: 8px;
        }
        #advanced-settings-container label {
            display: block; text-align: left; font-size: 0.9em;
            color: var(--tg-theme-hint-color); margin-bottom: 4px;
        }


        #chances-probability-display {
            background-color: var(--tg-theme-bg-color);
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            text-align: center;
        }
        #chances-probability-display .prob-value {
            font-size: 1.5em; font-weight: 600; color: var(--tg-theme-link-color);
            display: block; margin-bottom: 5px;
        }
        #chances-probability-display .prob-details {
            font-size: 0.9em; color: var(--tg-theme-hint-color);
        }

        /* Sell Gift & Transfer Gift Modal Styles */
        #sell-gift-modal .modal-gift-preview,
        #transfer-gift-modal .modal-gift-preview {
            display: flex; flex-direction: column; align-items: center; margin-bottom: 20px;
        }
        #sell-gift-modal .modal-gift-preview img,
        #transfer-gift-modal .modal-gift-preview img {
            width: 80px; height: 80px; object-fit: contain; margin-bottom: 10px;
        }
        #sell-gift-modal .modal-gift-preview h4,
        #transfer-gift-modal .modal-gift-preview h4 {
            font-size: 1.1em; font-weight: 500;
        }

        .price-input-container {
            position: relative;
            background-color: var(--tg-theme-bg-color);
            border-radius: 8px;
            padding: 12px;
            border: 1px solid var(--tg-theme-hint-color);
        }
        .price-input-container label {
            display: block; font-size: 0.8em; color: var(--tg-theme-link-color);
            margin-bottom: 5px;
        }
        .price-input-wrapper {
            display: flex; align-items: center;
        }
        .price-input-wrapper img {
            width: 24px; height: 24px; margin-right: 10px;
        }
        .price-input-wrapper input {
            background: none; border: none; color: var(--tg-theme-text-color);
            font-size: 1.2em; width: 100%; outline: none;
        }
        .price-input-wrapper input::-webkit-outer-spin-button,
        .price-input-wrapper input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .price-input-wrapper input[type=number] { -moz-appearance: textfield; }
        .price-details { text-align: center; font-size: 0.85em; color: var(--tg-theme-hint-color); margin-top: 10px; }

        #transfer-comment-input {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid var(--tg-theme-bg-color);
            background-color: var(--tg-theme-bg-color);
            color: var(--tg-theme-text-color);
            font-size: 1em;
            margin-top: 15px;
            resize: vertical;
        }


        .spinner {
            border: 4px solid var(--tg-theme-hint-color);
            border-top: 4px solid var(--tg-theme-link-color);
            border-radius: 50%; width: 30px; height: 30px;
            animation: spin 1s linear infinite; margin: 20px auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .hidden { display: none !important; }
        .placeholder-image {
            background-color: var(--tg-theme-hint-color); width: 100%; height: 100%;
            display: flex; align-items: center; justify-content: center;
            color: var(--tg-theme-bg-color); font-size: 0.8em; border-radius: 8px;
        }

        /* Collectible Numbers/Usernames Modal */
        #numbers-modal .collectible-list, #usernames-modal .collectible-list {
            list-style: none;
            padding: 0;
            margin: 0;
            max-height: 50vh;
            overflow-y: auto;
        }
        .gift-card {
            background-color: var(--tg-theme-secondary-bg-color);
            /* Larger border-radius for a softer, modern look */
            border-radius: 14px; 
            padding: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            aspect-ratio: 1 / 1;
            cursor: pointer;
            position: relative;
            /* This is crucial to contain the rotated label */
            overflow: hidden; 
            transition: transform 0.1s ease-out, opacity 0.2s;
        }
        #numbers-modal .collectible-list-item, #usernames-modal .collectible-list-item {
            padding: 15px 20px;
            font-size: 1.1em;
            font-weight: 500;
            border-bottom: 1px solid var(--tg-theme-bg-color);
            cursor: pointer;
            color: var(--tg-theme-link-color);
            font-family: monospace;
        }
        #usernames-modal .collectible-list-item {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            color: var(--tg-theme-text-color);
        }
        #usernames-modal .collectible-list-item .at-symbol {
            color: var(--tg-theme-hint-color);
            margin-right: 2px;
        }
        #numbers-modal .collectible-list-item:hover, #usernames-modal .collectible-list-item:hover {
            background-color: rgba(255,255,255,0.05);
        }
        #usernames-modal .search-bar-container {
            padding: 10px 20px;
            background-color: var(--tg-theme-secondary-bg-color);
        }
        #usernames-modal #username-search-input {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid var(--tg-theme-bg-color);
            background-color: var(--tg-theme-bg-color);
            color: var(--tg-theme-text-color);
            font-size: 1em;
        }

        /* Settings Modal */
        #settings-modal .settings-row {
            display: flex; align-items: center; justify-content: space-between;
            padding: 12px 0; font-size: 1em;
            border-bottom: 1px solid var(--tg-theme-bg-color);
        }
        #settings-modal .settings-row:last-of-type { border-bottom: none; }
        #settings-modal .settings-row button {
            background: none; border: none; color: var(--tg-theme-link-color);
            font-size: 1em; cursor: pointer; text-align: left;
            padding: 0; width: auto; font-weight: 400;
        }
        #settings-modal .settings-row.danger button {
            color: var(--app-clear-data-color);
        }
        #settings-modal .settings-row button.full-width { width: 100%; text-align: center; }

        /* --- GIVEAWAY MODAL --- */
        #giveaway-setup-modal .selection-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 8px;
            max-height: 25vh;
            overflow-y: auto;
            padding: 10px;
            background-color: var(--tg-theme-bg-color);
            border-radius: 8px;
            margin-bottom: 20px;
        }
        #giveaway-setup-modal .selection-grid .gift-card {
             border: 2px solid transparent;
        }
        #giveaway-setup-modal .selection-grid .gift-card.selected {
            border-color: var(--tg-theme-link-color);
        }
        #giveaway-setup-modal .giveaway-section {
            margin-bottom: 15px;
        }
        #giveaway-setup-modal .giveaway-section h4 {
             font-size: 1em; font-weight: 500; margin-bottom: 10px;
        }
        #giveaway-setup-modal .giveaway-section label {
            display: block;
            padding: 12px;
            background-color: var(--tg-theme-bg-color);
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
        }
        #giveaway-setup-modal .giveaway-section input[type="radio"] {
            margin-right: 10px;
        }
        #giveaway-setup-modal .giveaway-section textarea {
             width: 100%;
             padding: 10px;
             background-color: var(--tg-theme-bg-color);
             border: 1px solid var(--tg-theme-hint-color);
             border-radius: 8px;
             color: var(--tg-theme-text-color);
             font-size: 0.95em;
             resize: vertical;
             min-height: 60px;
        }
        #giveaway-setup-modal .info-text {
            font-size: 0.85em; color: var(--tg-theme-hint-color); margin-top: 5px;
        }
        
        /* New Post Modal Styles */
        #new-post-modal #new-post-content {
            width: 100%;
            height: 150px;
            padding: 10px;
            background-color: var(--tg-theme-bg-color);
            color: var(--tg-theme-text-color);
            border: 1px solid var(--tg-theme-hint-color);
            border-radius: 8px;
            font-size: 1em;
            resize: vertical;
            margin-bottom: 15px;
        }
        #new-post-modal #formatting-help {
            font-size: 0.9em;
            color: var(--tg-theme-hint-color);
            background-color: var(--tg-theme-bg-color);
            padding: 10px;
            border-radius: 8px;
        }
        #new-post-modal #formatting-help-toggle {
            color: var(--tg-theme-link-color);
            cursor: pointer;
            display: block;
            margin-bottom: 10px;
        }
        #new-post-modal #formatting-help-content {
             line-height: 1.6;
        }
        #new-post-modal #formatting-help-content code {
            background: rgba(255,255,255,0.1);
            padding: 2px 4px;
            border-radius: 4px;
        }

        /* Style for the new notification bell */
        #notification-bell-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            margin-left: auto;
            padding: 10px;
        }
        
        /* Styles for post reactions */
        .post-reactions {
            margin-top: 12px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        .reaction-chip {
            background-color: rgba(255, 255, 255, 0.1);
            padding: 4px 10px;
            border-radius: 16px;
            font-size: 0.9em;
            cursor: pointer;
            border: 1px solid transparent;
            transition: background-color 0.2s, border-color 0.2s;
        }
        .reaction-chip.reacted-by-user {
            background-color: rgba(var(--tg-theme-link-color-rgb), 0.2);
            border-color: var(--tg-theme-link-color);
        }
        .reaction-chip:hover {
             background-color: rgba(255, 255, 255, 0.15);
        }
        
        /* Styles for post menu */
        .post-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: var(--tg-theme-hint-color);
            font-size: 0.8em;
            margin-bottom: 8px;
        }
        .post-menu-btn {
            background: none;
            border: none;
            color: var(--tg-theme-hint-color);
            font-size: 1.2em;
            cursor: pointer;
        }

        /* Styles for the reaction selection popup */
        .reaction-popup {
            position: absolute;
            background-color: var(--tg-theme-secondary-bg-color);
            border-radius: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            padding: 8px;
            display: flex;
            gap: 5px;
            z-index: 100;
            transform: translateY(-100%); /* Position above the click point */
        }
        .reaction-popup span {
            font-size: 24px;
            cursor: pointer;
            padding: 4px;
            border-radius: 50%;
            transition: background-color 0.2s;
        }
        .reaction-popup span:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        /* Styles for the displayed reaction chips under a post */
        .post-reactions {
            margin-top: 12px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        .reaction-chip {
            background-color: var(--app-action-button-bg);
            padding: 4px 10px;
            border-radius: 16px;
            font-size: 0.9em;
            cursor: pointer;
            border: 1px solid transparent;
            transition: background-color 0.2s, border-color 0.2s;
            color: var(--tg-theme-text-color);
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .reaction-chip.reacted-by-user {
            background-color: rgba(var(--tg-theme-link-color-rgb, 82, 136, 193), 0.25);
            border-color: var(--tg-theme-link-color);
        }
        .reaction-chip:hover {
             background-color: var(--tg-theme-hint-color);
        }

        .profile-top-pinned-gifts .pinned-gift-item {
            width: 44px; height: 44px;
            border-radius: 12px;
            background-color: rgba(0,0,0,0.1);
            overflow: hidden;
            cursor: pointer;
            position: absolute;
            pointer-events: auto;
            transition: transform 0.3s ease, top 0.3s ease, left 0.3s ease;
            /* This centers the item on its given coordinates */
            transform: translate(-50%, -50%); 
        }
        
        #profile-status-line {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 8px;
        }
        
        #profile-level-bubble {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            background-color: var(--app-action-button-bg);
            color: var(--tg-theme-text-color);
            border-radius: 50%;
            font-size: 0.9em;
            font-weight: 500;
            margin-right: 8px;
            cursor: pointer; /* Make it clickable */
        }
        
        #profile-status {
            font-size: 0.95em;
            color: var(--tg-theme-text-color);
            opacity: 0.7;
            margin-top: 0; /* Reset margin */
        }
        
        .header-icons-right {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .header-icon-btn {
            background: none;
            border: none;
            color: var(--tg-theme-text-color);
            padding: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .header-icon-btn svg {
            width: 24px;
            height: 24px;
            fill: currentColor;
        }

        /* --- START: Add these new CSS rules --- */
        
        #level-modal-gift-count {
            text-align: center;
            font-size: 1.1em;
            font-weight: 500;
            color: var(--tg-theme-text-color);
            margin-bottom: 20px;
        }
        
        .level-info-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        .level-info-list li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            font-size: 1em;
            border-bottom: 1px solid var(--tg-theme-bg-color);
        }
        
        .level-info-list li:last-child {
            border-bottom: none;
        }
        
        .level-info-list li span:last-child {
            color: var(--tg-theme-hint-color);
            font-weight: 400;
        }
        
        .level-info-list li.current-level {
            color: var(--tg-theme-link-color);
            font-weight: 600;
        }
        
        .level-info-list li.current-level span:last-child {
            color: inherit; /* Inherit the link color for the current level's range */
        }
        
        .sidebar-footer button .btn-icon-container {
            margin-right: 12px;
            width: 22px; height: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .sidebar-footer button .btn-icon-container img {
            max-width: 100%;
            max-height: 100%;
        }
        
        .modal-action-buttons-row button .icon {
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 28px; /* Give icon a fixed size */
            height: 28px;
        }
        .modal-action-buttons-row button .icon img {
            max-width: 100%;
            max-height: 100%;
            /* The filter property has been REMOVED */
        }
        .modal-action-buttons-row button {
            /* Ensure text is white to match the target */
            color: var(--tg-theme-text-color);
        }

        .gift-card .top-right-label.on-sale {
            background: #4caf50; /* A nice green for "on sale" */
            color: white;
            box-shadow: none; /* A flatter look for this label */
            border: none;
            padding: 2px 25px;
            font-weight: 600;
        }
        /* Price display for Grid View */
        .gift-card .bottom-left-price {
            position: absolute;
            bottom: 5px;
            left: 5px;
            background-color: rgba(0,0,0,0.5);
            color: white;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 4px;
            z-index: 4;
        }
        .gift-card .bottom-left-price img {
            width: 12px;
            height: 12px;
        }

        .gift-card .bottom-price-label, .buy-gift-item .bottom-price-label {
            position: absolute;
            bottom: 5px;
            left: 50%; /* Center horizontally */
            transform: translateX(-50%); /* Adjust for element's own width */
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 4px;
            z-index: 4;
        }
        .gift-card .bottom-price-label img, .buy-gift-item .bottom-price-label img {
            width: 12px;
            height: 12px;
        }

        .buy-gift-item .top-right-label.on-sale {
            background: #4caf50;
            color: white;
            box-shadow: none;
            border: none;
            padding: 2px 35px;
            font-weight: 600;
            top: 12px;
            right: -34px;
            transform: rotate(45deg);
        }

        .market-card .bottom-price-label {
            position: absolute;
            bottom: 8px; /* More padding from bottom */
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.6);
            color: white;
            padding: 4px 10px;
            border-radius: 16px;
            font-size: 0.9em;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 5px;
            z-index: 4;
        }
        .market-card .bottom-price-label img {
            width: 14px;
            height: 14px;
        }

        .market-card {
             position: relative;
             overflow: hidden; /* This is the key to clipping the banner */
        }
        
        .market-card .resale-banner {
            position: absolute;
            top: 10px;      /* Tweak to position vertically */
            right: -38px;     /* Tweak to position horizontally */
            transform: rotate(45deg);
            background: #4caf50; /* Green color from your screenshot */
            color: white;
            font-size: 0.75em; /* Smaller font */
            padding: 3px 40px; /* Adjust padding for length */
            z-index: 3;
            font-weight: 600;
            white-space: nowrap;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        #market-summary-grid {
            /* Adjusted to ensure 3 columns on most mobile screens with slightly smaller cards */
            grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
            gap: 5px;
            padding: 10px;
        }

        #exit-move-mode-button {
            background-color: var(--tg-theme-accent-blue);
            color: var(--tg-theme-button-text-color);
            border: none;
            padding: 8px 18px;
            border-radius: 20px;
            font-size: 0.9em;
            cursor: pointer;
            font-weight: 500;
            margin-right: 10px;
        }
        
        .gifts-grid.moving .gift-card:not(.movable) {
            opacity: 0.3;
            filter: grayscale(100%);
            pointer-events: none;
        }
        .gifts-grid.moving .gift-card.movable {
            cursor: pointer;
            border: 2px solid var(--tg-theme-link-color);
        }
        .gifts-grid.moving .gift-card.movable:active {
            transform: scale(0.95);
            opacity: 0.8;
        }

        /* --- START UPDATE: Customization Studio Styles --- */
        #custom-buy-modal .modal-content {
            display: flex;
            flex-direction: column;
            max-height: 95vh; /* Taller modal */
        }
        
        #custom-buy-preview-area {
            padding: 15px;
            background-color: var(--tg-theme-bg-color);
            border-bottom: 1px solid var(--app-action-button-bg);
        }
        
        #live-preview-container {
            width: 200px;
            height: 200px;
            margin: 0 auto;
            border-radius: 12px;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        #live-preview-backdrop, #live-preview-pattern {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
        }
        #live-preview-pattern {
            background-repeat: repeat;
            background-size: 25% auto;
            opacity: 0.1;
        }
        #live-preview-model {
            position: relative;
            z-index: 2;
            max-width: 80%;
            max-height: 80%;
            object-fit: contain;
            filter: drop-shadow(0 4px 8px rgba(0,0,0,0.3));
        }
        
        .studio-controls-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
        }
        .studio-icon-button {
            background: none; border: none; font-size: 1.5em;
            color: var(--tg-theme-text-color); cursor: pointer;
        }
        #studio-queue-label {
            font-size: 0.9em; color: var(--tg-theme-hint-color);
        }
        
        #queue-grid-preview-container {
            margin-top: 15px;
        }
        #queue-grid-preview-container h4 {
            font-size: 0.9em; color: var(--tg-theme-hint-color); margin-bottom: 8px;
        }
        #queue-grid-preview {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            gap: 8px;
            max-height: 140px; overflow-y: auto;
            background: rgba(0,0,0,0.1); padding: 8px; border-radius: 8px;
        }
        .queue-grid-item {
            aspect-ratio: 1/1; border-radius: 6px; position: relative;
            background-color: var(--tg-theme-secondary-bg-color);
            cursor: pointer; border: 2px solid transparent; overflow: hidden;
        }
        .queue-grid-item.active { border-color: var(--tg-theme-link-color); }
        .queue-grid-item img { width: 100%; height: 100%; object-fit: contain; }
        
        #quick-pick-bar-container { margin-top: 15px; }
        #quick-pick-bar-container h4 { font-size: 0.9em; color: var(--tg-theme-hint-color); margin-bottom: 8px; }
        #quick-pick-bar { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 5px; }
        .quick-pick-item {
            flex-shrink: 0; width: 50px; height: 50px;
            border-radius: 8px; background-color: var(--tg-theme-secondary-bg-color);
            border: 1px solid var(--app-action-button-bg); cursor: pointer;
        }
        .quick-pick-item img, .quick-pick-item .gradient-square { width: 100%; height: 100%; object-fit: contain; border-radius: 8px; }
        
        #studio-parts-selector { padding: 10px 15px; }
        #quick-create-container { display: flex; flex-direction: column; gap: 8px; margin-bottom: 15px; }
        #quick-create-container input {
            width: 100%; padding: 10px; border-radius: 8px;
            border: 1px solid var(--tg-theme-bg-color); background-color: var(--tg-theme-bg-color);
            color: var(--tg-theme-text-color); font-size: 0.9em;
        }
        
        .studio-section { margin-bottom: 10px; }
        .studio-section-header {
            background-color: var(--app-action-button-bg);
            padding: 10px; border-radius: 8px;
            cursor: pointer; font-size: 1em; font-weight: 500;
        }
        .studio-section-content {
            padding: 10px 0;
        }
        .studio-section-content.hidden { display: none; }
        
        .studio-parts-controls { margin-bottom: 10px; display: flex; flex-direction: column; gap: 8px; }
        .part-search-bar { width: 100%; padding: 10px; /* same style as quick-create input */ }
        #backdrop-color-palette { display: flex; gap: 5px; justify-content: center; }
        .color-swatch { width: 24px; height: 24px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; }
        .color-swatch.active { border-color: var(--tg-theme-text-color); }
        
        .studio-parts-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
            gap: 8px; max-height: 200px; overflow-y: auto;
        }
        .studio-parts-grid .filter-option { /* Use existing filter-option styles but ensure they apply */
            background-color: var(--tg-theme-bg-color); border: 2px solid transparent;
            border-radius: 8px; padding: 5px; flex-direction: column;
            justify-content: flex-start; height: auto; aspect-ratio: auto;
            min-height: 80px; position: relative;
        }
        .studio-parts-grid .filter-option.selected { border-color: var(--tg-theme-link-color); }
        .studio-parts-grid .filter-option .pin-part-btn {
            position: absolute; top: 2px; right: 2px;
            background: rgba(0,0,0,0.4); color: white;
            border: none; border-radius: 50%;
            width: 20px; height: 20px; font-size: 14px;
            display: flex; align-items: center; justify-content: center; z-index: 5;
        }
        .studio-parts-grid .filter-option .pin-part-btn.pinned { background-color: var(--tg-theme-link-color); }
        
        #templates-tab-content .template-card {
            background-color: var(--tg-theme-bg-color);
            border-radius: 8px; padding: 10px; margin-bottom: 10px;
            display: flex; align-items: center; gap: 15px; cursor: pointer;
        }
        #templates-tab-content .template-preview {
            width: 60px; height: 60px; border-radius: 6px;
            background-color: var(--tg-theme-secondary-bg-color);
            flex-shrink: 0;
        }
        #templates-tab-content .template-info { flex-grow: 1; }
        #templates-tab-content .template-info h4 { font-size: 1em; font-weight: 500; }
        #templates-tab-content .template-delete-btn {
            background: none; border: none; color: var(--app-clear-data-color);
            font-size: 1.2em;
        }
        /* --- END UPDATE: Customization Studio Styles --- */
    </style>
</head>
<body>
    <div class="account-sidebar" id="account-sidebar">
        <div class="sidebar-header">
            <img id="sidebar-current-avatar" src="" alt="Avatar">
            <span id="sidebar-current-name" class="name"></span>
        </div>
        <ul class="accounts-list" id="accounts-list"></ul>
        <div class="sidebar-footer">
            <button id="open-filters-button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M14,12V19.88C14.04,20.18 13.94,20.5 13.71,20.71C13.32,21.1 12.69,21.1 12.3,20.71L10.29,18.7C10.06,18.47 9.96,18.16 10,17.87V12H9.97L4.21,4.62C3.87,4.19 3.95,3.56 4.38,3.22C4.57,3.08 4.78,3 5,3H19C19.22,3 19.43,3.08 19.62,3.22C20.05,3.56 20.13,4.19 19.79,4.62L14.03,12H14Z" /></svg>Filters</button>
            <button id="open-numbers-button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M6.62,10.79C8.06,13.62 10.38,15.94 13.21,17.38L15.41,15.18C15.69,14.9 16.08,14.82 16.43,14.93C17.55,15.3 18.75,15.5 20,15.5A1,1 0 0,1 21,16.5V20A1,1 0 0,1 20,21A17,17 0 0,1 3,4A1,1 0 0,1 4,3H7.5A1,1 0 0,1 8.5,4C8.5,5.25 8.7,6.45 9.07,7.57C9.18,7.92 9.1,8.31 8.82,8.59L6.62,10.79Z" /></svg>Numbers</button>
            <button id="open-usernames-button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12,12C14.21,12 16,10.21 16,8C16,5.79 14.21,4 12,4C9.79,4 8,5.79 8,8C8,10.21 9.79,12 12,12M12,14C9.33,14 4,15.33 4,18V20H20V18C20,15.33 14.67,14 12,14Z" /></svg>Usernames</button>
            <button id="create-giveaway-button"><span id="giveaway-btn-icon-container" class="btn-icon-container"></span>Create Giveaway</button>
        </div>
    </div>
    <div class="sidebar-overlay" id="sidebar-overlay"></div>

    <div class="app-container">
        <div id="profile-page" class="page active">
            <input type="file" id="avatar-upload-input" class="hidden" accept="image/*">
            <div class="page-header">
                <div class="header-icons-left">
                    <button id="hamburger-btn" class="header-icon-btn">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3,6H21V8H3V6M3,11H21V13H3V11M3,16H21V18H3V16Z" /></svg>
                    </button>
                </div>
                <div class="header-icons-right">
                    <button id="profile-edit-btn" class="header-icon-btn hidden">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71,7.04C21.1,6.65 21.1,6 20.71,5.63L18.37,3.29C18,2.9 17.35,2.9 16.96,3.29L15.12,5.12L18.87,8.87M3,17.25V21H6.75L17.81,9.93L14.06,6.18L3,17.25Z" /></svg>
                    </button>
                    <!-- The dots menu (SettingsButton) is controlled by Telegram's script -->
                </div>
            </div>
            <div class="profile-page-content">
                <div id="profile-top-section" class="profile-top-section">
                    <div id="profile-header-pattern-overlay" class="profile-header-pattern-overlay"></div>
                    <div id="profile-top-pinned-gifts" class="profile-top-pinned-gifts"></div>
                    <div class="profile-header-content-wrapper">
                        <div id="profile-main-info-block" class="profile-main-info">
                            <img id="profile-avatar" class="profile-avatar" src="" alt="Avatar">
                            <div class="profile-name-status">
                                <div class="name-line">
                                    <h1 id="profile-name">Name</h1>
                                    <div id="worn-gift-icon-container" class="hidden lottie-animation-container"></div>
                                </div>
                                <div id="profile-status-line">
                                    <span id="profile-level-bubble">0</span>
                                    <span id="profile-status" class="online">online</span>
                                </div>
                                <!-- NEW MUSIC STATUS ELEMENT -->
                                <div id="profile-music-status" class="hidden" style="margin-top: 12px; color: var(--tg-theme-hint-color); display: flex; align-items: center; font-size: 0.9em;">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" style="width: 16px; height: 16px; fill: currentColor; margin-right: 8px;"><title>music</title><path d="M12,3V12.26C11.5,12.09 11,12 10.5,12C8,12 6,14 6,16.5C6,19 8,21 10.5,21C13,21 15,19 15,16.5V6H19V3H12Z" /></svg>
                                    <span id="profile-music-text"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="profile-details-section">
                    <div id="profile-details" class="profile-details">
                         <div class="info-block">
                            <div class="info-label">Phone</div>
                            <div class="info-value" id="profile-phone"></div>
                        </div>
                         <div class="info-block">
                            <div class="info-label">Bio</div>
                            <div class="info-value" id="profile-bio"></div>
                        </div>
                         <div class="info-block">
                            <div class="info-label">Username</div>
                            <div class="info-value collectible-value" id="profile-username"></div>
                            <div class="info-value" id="collectible-usernames-container"></div>
                        </div>
                    </div>
                </div>
                <div class="profile-tabs-content">
                    <div class="profile-tabs">
                        <button id="posts-tab-button">Wall</button>
                        <button id="buy-gifts-tab-button">Buy Gifts</button>
                        <button class="active" id="gifts-tab-button">
                            Gifts
                            <span class="gift-preview-container" id="gifts-tab-preview-container"></span>
                        </button>
                    </div>
                    <div id="posts-content" class="tab-content">
                        <!-- Posts will be rendered here by JS -->
                        <p class="empty-grid-message">Nothing to see here yet.</p>
                    </div>
                    <div id="gifts-content" class="tab-content active">
                        <div id="profile-gifts-actions-wrapper" class="profile-gifts-actions-wrapper hidden">
                            <div class="profile-gifts-actions">
                                <!-- Dynamic buttons will be prepended here by JS -->
                                <button id="upgrade-all-gifts-button" class="action-button hidden">✨ Upgrade All</button>
                            </div>
                        </div>
                        <div id="gifts-grid" class="gifts-grid">
                            <div class="spinner hidden" id="gifts-loading-spinner"></div>
                        </div>
                    </div>
                </div>
            </div>
            <button id="new-post-fab" class="new-post-fab hidden">+</button>
        </div>

        <div id="buy-gifts-page" class="page">
            <div class="page-header">
                 <h2>Gift Shop</h2>
                 <div class="buy-gifts-header-actions">
                    <button id="customize-gift-button" class="action-button">Customize</button>
                 </div>
            </div>
            <div id="buy-gifts-grid" class="gifts-grid">
                <div class="spinner" id="buy-gifts-loading-spinner"></div>
            </div>
        </div>

        <!-- Modals below -->
        <div id="gift-detail-modal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header-bar">
                    <h3 id="modal-gift-name">Gift Name</h3>
                </div>
                <div class="modal-scrollable-content">
                    <div id="modal-gift-image-container" class="modal-gift-image-container">
                        <div id="modal-lottie-gift-original" class="lottie-animation-container"></div>
                        <img id="modal-gift-image-static" class="static-image-fallback" src="" alt="Gift" style="display:none;">
                    </div>
                    <p id="modal-gift-description1" class="modal-gift-description"></p>
                    <p id="modal-gift-description2" class="modal-gift-description"></p>
                    <div id="modal-gift-info" class="modal-info-table"></div>
                </div>
                <div class="modal-buttons-footer">
                    <button id="upgrade-gift-detail-modal-button" class="modal-button">✨ Upgrade</button>
                    <button id="close-gift-detail-modal-button" class="modal-button secondary">Close</button>
                </div>
            </div>
        </div>

        <div id="collectible-detail-modal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-scrollable-content">
                    <div class="collectible-display-area">
                        <button class="menu-button" id="collectible-menu-button">⋮</button>
                        <div id="pattern-container-dynamic"></div>
                        <div id="modal-collectible-visual" class="modal-collectible-visual">
                            <div id="modal-lottie-collectible-model" class="lottie-animation-container"></div>
                            <img id="modal-collectible-model-img-static" class="static-image-fallback" src="" alt="Model" style="display:none;">
                        </div>
                        <h3 id="modal-collectible-main-name">Model Name</h3>
                        <p id="modal-collectible-number-subtext">Collectible #123</p>
                        <div id="modal-collectible-actions" class="modal-action-buttons-row">
                            <button id="collectible-action-transfer"><span class="icon"><img src=""/></span><span class="text">Transfer</span></button>
                            <button id="collectible-action-wear"><span class="icon"><img src=""/></span><span class="text">Wear</span></button>
                            <button id="collectible-action-sell"><span class="icon"><img src=""/></span><span class="text">Sell</span></button>
                        </div>
                    </div>
                    <div class="collectible-info-section">
                        <div id="modal-collectible-info-table" class="modal-info-table"></div>
                    </div>
                    <div class="modal-footer-message">
                        This gift is visible in your profile. <span id="hide-link-in-modal" class="link">Hide ></span>
                    </div>
                </div>
                 <div class="modal-buttons-footer">
                    <button id="close-collectible-detail-modal" class="modal-button">OK</button>
                </div>
            </div>
        </div>

        <div id="too-many-pins-modal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header-bar"><h3>Too Many Pinned Gifts</h3></div>
                <div class="modal-scrollable-content" style="text-align: center;">
                    <p style="margin-bottom:15px; color: var(--tg-theme-hint-color);">Select a gift to unpin. You can pin up to 6 collectible gifts.</p>
                    <div id="unpin-selection-grid" class="gifts-grid" style="grid-template-columns: repeat(3, 1fr); max-height: 200px; overflow-y: auto; padding:0 10px;">
                    </div>
                </div>
                 <div class="modal-buttons-footer">
                    <button id="cancel-unpin-modal" class="modal-button secondary">Cancel</button>
                </div>
            </div>
        </div>

        <div id="buy-multiple-modal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header-bar"><h3 id="buy-multiple-modal-title">Buy Gift</h3></div>
                <div class="modal-scrollable-content" style="text-align: center;">
                    <p id="buy-multiple-gift-name" style="margin-bottom: 15px;"></p>
                    <label for="buy-multiple-quantity" style="display: block; margin-bottom: 8px; color: var(--tg-theme-hint-color);">Quantity:</label>
                    <input type="number" id="buy-multiple-quantity" min="1" value="1">
                </div>
                <div class="modal-buttons-footer">
                    <button id="confirm-buy-multiple" class="modal-button">Buy</button>
                    <button id="cancel-buy-multiple" class="modal-button secondary">Cancel</button>
                </div>
            </div>
        </div>

        <div id="filter-popup" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header-bar">
                    <h3>Gift Filters</h3>
                </div>
                <div class="modal-scrollable-content">
                    <div class="filter-section" id="filter-collections-section">
                        <h4>Collections</h4>
                        <div class="filter-options-grid" id="filter-options-collections"></div>
                    </div>
                    <div class="filter-section hidden" id="filter-models-section">
                        <h4>Models</h4>
                        <div class="filter-options-grid" id="filter-options-models"></div>
                    </div>
                    <div class="filter-section" id="filter-backdrops-section">
                        <h4>Backdrops</h4>
                        <div class="filter-options-grid" id="filter-options-backdrops"></div>
                    </div>
                    <div class="filter-section" id="filter-patterns-section">
                        <h4>Symbols</h4>
                        <div class="filter-options-grid" id="filter-options-patterns"></div>
                    </div>
                    <hr style="border-color: rgba(255,255,255,0.1); border-style: solid; border-width: 1px 0 0 0; margin: 20px 0;">
                </div>
                <div class="modal-buttons-footer">
                    <button id="apply-filters-button" class="modal-button">Apply Filters</button>
                    <button id="clear-filters-button" class="modal-button secondary">Reset Filters</button>
                </div>
            </div>
        </div>

        <div id="settings-modal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header-bar">
                    <h3>Settings</h3>
                </div>
                <div class="modal-scrollable-content">
                     <div class="settings-row">
                        <label>Animations</label>
                        <label class="switch">
                            <input type="checkbox" id="animation-toggle" checked>
                            <span class="slider round"></span>
                        </label>
                    </div>
                    <div class="settings-row">
                        <label>Custom Gifts</label>
                        <label class="switch">
                            <input type="checkbox" id="custom-gifts-toggle">
                            <span class="slider round"></span>
                        </label>
                    </div>
                    <div class="settings-row">
                        <label>Show hidden gifts</label>
                        <label class="switch">
                            <input type="checkbox" id="show-hidden-toggle">
                            <span class="slider round"></span>
                        </label>
                    </div>
                    <div class="settings-row">
                        <label>Fullscreen</label>
                        <label class="switch">
                            <input type="checkbox" id="fullscreen-toggle">
                            <span class="slider round"></span>
                        </label>
                    </div>
                    <div class="settings-row">
                        <button id="hide-multiple-button" class="full-width">Hide Multiple</button>
                    </div>
                    <div class="settings-row">
                        <button id="transfer-multiple-button" class="full-width">Transfer Multiple</button>
                    </div>
                    <div class="settings-row">
                        <button id="organize-gifts-button" class="full-width">Organize Gifts</button>
                    </div>
                    <div class="settings-row">
                        <button id="clear-current-account-data-button" class="full-width">Clear Current Account Data</button>
                    </div>
                    <div class="settings-row danger">
                        <button id="clear-all-accounts-data-button" class="full-width">Clear All Accounts Data</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="chances-modal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header-bar">
                    <h3>Chance Calculator</h3>
                </div>
                <div class="modal-scrollable-content">
                    <p id="chances-gift-name" style="text-align: center; font-weight: 500; margin-bottom: 15px;"></p>
                    <div id="chances-probability-display"></div>
                    <div class="spinner hidden" id="chances-loading-spinner"></div>
                    <div class="filter-section hidden" id="chances-models-section">
                        <h4>Select model</h4>
                        <div class="filter-options-grid" id="chances-options-models"></div>
                    </div>
                    <div class="filter-section hidden" id="chances-backdrops-section">
                        <h4>Select backdrop</h4>
                        <div class="filter-options-grid" id="chances-options-backdrops"></div>
                    </div>
                    <div class="filter-section hidden" id="chances-patterns-section">
                        <h4>Select symbol</h4>
                        <div class="filter-options-grid" id="chances-options-patterns"></div>
                    </div>
                </div>
                <div class="modal-buttons-footer">
                    <button id="close-chances-modal" class="modal-button">Close</button>
                </div>
            </div>
        </div>
        
        <div id="custom-buy-modal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header-bar" style="display: flex; justify-content: space-between; align-items: center;">
                    <h3 id="custom-buy-modal-title">Gift Creation Studio</h3>
                    <div id="custom-buy-tabs" style="display:flex; gap: 5px;">
                        <button id="studio-tab-button" class="modal-button secondary active" style="padding: 5px 10px; font-size: 0.9em;">Studio</button>
                        <button id="templates-tab-button" class="modal-button secondary" style="padding: 5px 10px; font-size: 0.9em;">Templates</button>
                    </div>
                </div>
        
                <div id="studio-tab-content" class="active">
                    <div id="custom-buy-preview-area">
                        <div id="live-preview-container">
                            <div id="live-preview-backdrop"></div>
                            <div id="live-preview-pattern"></div>
                            <img id="live-preview-model" src="" alt="Live Preview">
                        </div>
                        <div class="studio-controls-top">
                            <button id="undo-button" class="studio-icon-button" title="Undo">↩</button>
                            <span id="studio-queue-label">Editing Gift 1 of 1</span>
                            <button id="redo-button" class="studio-icon-button" title="Redo">↪</button>
                        </div>
        
                        <div id="queue-grid-preview-container" class="hidden">
                            <h4>Creation Queue</h4>
                            <div id="queue-grid-preview"></div>
                        </div>
        
                        <div id="quick-pick-bar-container">
                            <h4>Quick Picks</h4>
                            <div id="quick-pick-bar"></div>
                        </div>
                    </div>
        
                    <div class="modal-scrollable-content" id="studio-parts-selector">
                        <div id="quick-create-container">
                            <input type="text" id="quick-create-input" placeholder="Quick Create: Model, Backdrop, Symbol">
                            <input type="text" id="clone-url-input-studio" placeholder="Or paste gift link/ID to clone">
                        </div>
        
                        <div class="studio-section">
                            <h4 class="studio-section-header">1. Select Model</h4>
                            <div class="studio-section-content">
                                <div class="studio-parts-controls">
                                    <input type="search" class="part-search-bar" placeholder="Search models...">
                                </div>
                                <div class="studio-parts-grid" id="custom-buy-models-grid"></div>
                            </div>
                        </div>
                        <div class="studio-section">
                            <h4 class="studio-section-header">2. Select Backdrop</h4>
                            <div class="studio-section-content">
                                <div class="studio-parts-controls">
                                    <input type="search" class="part-search-bar" placeholder="Search backdrops...">
                                    <div id="backdrop-color-palette"></div>
                                </div>
                                <div class="studio-parts-grid" id="custom-buy-backdrops-grid"></div>
                            </div>
                        </div>
                        <div class="studio-section">
                            <h4 class="studio-section-header">3. Select Symbol</h4>
                            <div class="studio-section-content">
                                <div class="studio-parts-controls">
                                    <input type="search" class="part-search-bar" placeholder="Search symbols...">
                                </div>
                                <div class="studio-parts-grid" id="custom-buy-patterns-grid"></div>
                            </div>
                        </div>
                    </div>
                </div>
        
                <div id="templates-tab-content" class="hidden">
                     <div class="modal-scrollable-content" id="template-library-container">
                        <!-- Templates will be rendered here by JS -->
                        <p class="empty-grid-message">You have no saved templates.</p>
                     </div>
                </div>
        
                <div class="modal-buttons-footer">
                    <button id="add-another-gift-button" class="modal-button secondary">⊕ Add</button>
                    <button id="apply-last-button" class="modal-button secondary">Apply Last</button>
                    <button id="save-template-button" class="modal-button secondary">Save Template</button>
                    <button id="custom-buy-confirm-button" class="modal-button" disabled>Create Gift</button>
                </div>
            </div>
        </div>

        <div id="generated-image-modal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header-bar">
                    <h3>Your Gift</h3>
                </div>
                <div class="modal-scrollable-content" style="text-align: center; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px;">
                    <div id="generated-image-container" style="width: 100%; max-width: 300px; aspect-ratio: 3 / 4; border-radius: 12px; overflow: hidden; background-color: var(--tg-theme-bg-color); display: flex; align-items: center; justify-content: center;">
                        <img id="generated-image-preview" src="" alt="Generated Gift" style="max-width: 100%; max-height: 100%; object-fit: contain;">
                    </div>
                    <p id="generated-image-message" style="margin-top: 15px; color: var(--tg-theme-hint-color); font-size: 0.9em;"></p>
                </div>
                <div class="modal-buttons-footer" id="generated-image-footer">
                    <button id="send-generated-image-button" class="modal-button" disabled>Send to Me</button>
                    <button id="close-generated-image-modal" class="modal-button secondary">Close</button>
                </div>
            </div>
        </div>

        <div id="edit-profile-modal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header-bar"><h3>Edit Profile</h3></div>
                <div class="modal-scrollable-content">
                    <div class="info-block">
                        <label class="info-label" for="edit-profile-name">Name</label>
                        <input type="text" id="edit-profile-name" class="price-input-wrapper" style="width: 100%; padding: 12px; border: none; background: var(--tg-theme-bg-color); color: var(--tg-theme-text-color); border-radius: 8px;">
                    </div>
                    <div class="info-block">
                        <label class="info-label" for="edit-profile-bio">Bio</label>
                        <textarea id="edit-profile-bio" rows="3" style="width: 100%; padding: 12px; border: none; background: var(--tg-theme-bg-color); color: var(--tg-theme-text-color); border-radius: 8px; resize: vertical;"></textarea>
                    </div>
                    <div class="info-block">
                        <label class="info-label" for="edit-profile-music">Music Status</label>
                        <input type="text" id="edit-profile-music" class="price-input-wrapper" placeholder="Artist - Song Title" style="width: 100%; padding: 12px; border: none; background: var(--tg-theme-bg-color); color: var(--tg-theme-text-color); border-radius: 8px;">
                    </div>
                </div>
                <div class="modal-buttons-footer">
                    <button id="save-profile-button" class="modal-button">Save</button>
                    <button id="cancel-edit-profile-button" class="modal-button secondary">Cancel</button>
                </div>
            </div>
        </div>
        
        <div id="sell-gift-modal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header-bar">
                    <h3>Price in Stars</h3>
                </div>
                <div class="modal-scrollable-content">
                    <div class="modal-gift-preview">
                        <img id="sell-gift-image" src="" alt="Gift Preview">
                        <h4 id="sell-gift-name"></h4>
                    </div>
                    <div class="price-input-container">
                        <label>Enter price in Stars (125 - 100,000)</label>
                        <div class="price-input-wrapper">
                            <img src="https://raw.githubusercontent.com/Vasiliy-katsyka/upgrade/refs/heads/main/DMJTGStarsEmoji_AgADUhMAAk9WoVI.png" alt="Star">
                            <input type="number" id="sell-price-input" placeholder="125" min="125" max="100000">
                        </div>
                    </div>
                    <div class="price-details">
                        <p id="sell-receive-amount">You will receive 100 Stars.</p>
                        <p id="sell-usd-amount">≈US$1.30</p>
                    </div>
                </div>
                <div class="modal-buttons-footer">
                    <button id="confirm-sell-button" class="modal-button" disabled>List for Sale</button>
                    <button id="cancel-sell-button" class="modal-button secondary">Cancel</button>
                </div>
            </div>
        </div>

        <div id="transfer-gift-modal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header-bar">
                    <h3 id="transfer-modal-title">Transfer Gift</h3>
                </div>
                <div class="modal-scrollable-content">
                    <div class="modal-gift-preview">
                        <img id="transfer-gift-image" src="" alt="Gift Preview">
                        <h4 id="transfer-gift-name"></h4>
                    </div>
                    <div class="price-input-container">
                        <label>Enter recipient's Telegram username</label>
                        <div class="price-input-wrapper">
                            <span style="font-size:1.2em; margin-right:10px; color:var(--tg-theme-text-color);">@</span>
                            <input type="text" id="transfer-username-input" placeholder="username">
                        </div>
                    </div>
                    <textarea id="transfer-comment-input" rows="2" placeholder="Add a comment... (optional)"></textarea>
                    <div class="price-details" id="transfer-status-message">
                        <p>Gift ownership will be transferred to this username.</p>
                    </div>
                </div>
                <div class="modal-buttons-footer">
                    <button id="confirm-transfer-button" class="modal-button" disabled>Confirm Transfer</button>
                    <button id="cancel-transfer-button" class="modal-button secondary">Cancel</button>
                </div>
            </div>
        </div>

        <!-- START: Add this new modal HTML -->
        <div id="level-info-modal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header-bar">
                    <h3>User Level</h3>
                </div>
                <div class="modal-scrollable-content">
                    <p id="level-modal-gift-count"></p>
                    <ul id="level-modal-list" class="level-info-list">
                        <!-- Level rows will be generated here by JS -->
                    </ul>
                </div>
                <div class="modal-buttons-footer">
                    <button id="close-level-modal" class="modal-button">Close</button>
                </div>
            </div>
        </div>
        <!-- END: New modal HTML -->
        
        <div id="numbers-modal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header-bar"><h3>Anonymous Numbers +888</h3></div>
                <div class="modal-scrollable-content" style="padding: 0;">
                    <ul class="collectible-list" id="numbers-list">
                    </ul>
                </div>
                <div class="modal-buttons-footer">
                    <button id="close-numbers-modal" class="modal-button">Close</button>
                </div>
            </div>
        </div>

        <div id="usernames-modal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header-bar"><h3>Collectible Usernames</h3></div>
                <div class="search-bar-container">
                    <input type="text" id="username-search-input" placeholder="Search username...">
                </div>
                <div class="modal-scrollable-content" style="padding: 0;">
                    <ul class="collectible-list" id="usernames-list">
                    </ul>
                </div>
                <div class="modal-buttons-footer">
                    <button id="close-usernames-modal" class="modal-button">Close</button>
                </div>
            </div>
        </div>

        <div id="giveaway-setup-modal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header-bar"><h3>Create a Giveaway</h3></div>
                <div class="modal-scrollable-content">
                    <div class="giveaway-section">
                        <h4>1. Select Gifts to Give Away</h4>
                        <div id="giveaway-gift-selection-grid" class="selection-grid">
                            <p class="empty-grid-message">You have no collectible gifts to give away.</p>
                        </div>
                    </div>
                    <div class="giveaway-section">
                        <h4>2. Channels to Subscribe (optional)</h4>
                        <textarea id="giveaway-channels-input" placeholder="e.g., @channel1, @channel2"></textarea>
                        <p class="info-text">Bot must be an admin in these channels for the check to work.</p>
                    </div>
                    <div class="giveaway-section">
                        <h4>3. Choose Winner Rule</h4>
                        <label>
                            <input type="radio" name="winner-rule" value="single" checked>
                            One winner gets all gifts
                        </label>
                        <label>
                            <input type="radio" name="winner-rule" value="multiple">
                            One winner per gift
                        </label>
                    </div>
                </div>
                <div class="modal-buttons-footer">
                    <button id="confirm-giveaway-setup" class="modal-button" disabled>Start Setup in Bot</button>
                    <button id="cancel-giveaway-setup" class="modal-button secondary">Cancel</button>
                </div>
            </div>
        </div>
        
        <div id="new-post-modal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header-bar"><h3>New Post</h3></div>
                <div class="modal-scrollable-content">
                    <textarea id="new-post-content" placeholder="Enter content..."></textarea>
                    <div id="formatting-help">
                        <span id="formatting-help-toggle">Show Formatting Help ▼</span>
                        <div id="formatting-help-content" class="hidden">
                            <code>*word*</code> - <b>Bold</b><br>
                            <code>&word&</code> - <span class="text-demonic" style="font-weight:600;font-size:1.1em;">Bigger & Red</span><br>
                            <code>♡word♡</code> - <span class="text-pink">Pink</span><br>
                            <code>$word$</code> - <span class="text-green">Green</span><br>
                            <code>%word%</code> - <span class="text-blue">Blue</span><br>
                            <code>@username</code> - Links to profile<br>
                            <code>GiftName-123</code> - Links to gift
                        </div>
                    </div>
                </div>
                <div class="modal-buttons-footer">
                    <button id="submit-new-post-button" class="modal-button">Submit</button>
                    <button id="cancel-new-post-button" class="modal-button secondary">Cancel</button>
                </div>
            </div>
        </div>

        <div id="subscription-modal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header-bar"><h3>Notifications</h3></div>
                <div class="modal-scrollable-content">
                     <div class="settings-row">
                        <label>Mentions</label>
                        <label class="switch">
                            <input type="checkbox" id="mentions-toggle">
                            <span class="slider round"></span>
                        </label>
                    </div>
                     <div class="settings-row">
                        <label>New Posts from this User</label>
                        <label class="switch">
                            <input type="checkbox" id="new-posts-toggle">
                            <span class="slider round"></span>
                        </label>
                    </div>
                </div>
                <div class="modal-buttons-footer">
                    <button id="close-subscription-modal" class="modal-button">Done</button>
                </div>
            </div>
        </div>

        <div id="collection-price-modal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header-bar">
                    <h3>My Collection Price</h3>
                </div>
                <div class="modal-scrollable-content">
                    <div id="collection-price-summary" style="text-align: center; margin-bottom: 20px;">
                        <div class="spinner hidden" id="collection-price-spinner"></div>
                        <h2 id="collection-price-total" style="font-size: 2em; font-weight: 600; color: var(--tg-theme-link-color);"></h2>
                        <p id="collection-price-info" style="color: var(--tg-theme-hint-color);"></p>
                    </div>
                    <ul id="collection-price-list" class="level-info-list">
                        <!-- Priced gifts will be listed here by JS -->
                    </ul>
                </div>
                <div class="modal-buttons-footer">
                    <button id="close-collection-price-modal" class="modal-button">Close</button>
                </div>
            </div>
        </div>

        <div id="stars-modal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header-bar"><h3>Stars</h3></div>
                <div class="modal-scrollable-content" style="text-align: center; padding-top: 20px;">
                    <img src="https://raw.githubusercontent.com/Vasiliy-katsyka/upgrade/refs/heads/main/DMJTGStarsEmoji_AgADUhMAAk9WoVI.png" alt="Star" style="width: 100px; height: 100px; margin-bottom: 20px;">
                    <h2>Telegram Stars</h2>
                    <p style="color: var(--tg-theme-hint-color); margin: 10px 0 30px;">Buy Stars to unlock gifts and services in the app.</p>
                    
                    <div id="stars-balance-display">
                        <span style="font-size: 2em; font-weight: 600;">
                            <img src="https://raw.githubusercontent.com/Vasiliy-katsyka/upgrade/refs/heads/main/DMJTGStarsEmoji_AgADUhMAAk9WoVI.png" alt="Star" style="width: 28px; height: 28px; vertical-align: bottom; margin-right: 5px;">
                            <span id="stars-balance-amount">0</span>
                        </span>
                        <p style="color: var(--tg-theme-hint-color);">your balance</p>
                    </div>
                </div>
                <div class="modal-buttons-footer">
                    <button id="topup-stars-button" class="modal-button">⊕ Top Up</button>
                </div>
            </div>
        </div>
        
        <div id="topup-modal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header-bar"><h3>Top Up Stars</h3></div>
                <div class="modal-scrollable-content" style="text-align: center;">
                    <p id="topup-level-info" style="margin-bottom: 15px; color: var(--tg-theme-hint-color);"></p>
                    <div class="price-input-container">
                        <label>Enter amount to add</label>
                        <div class="price-input-wrapper">
                            <img src="https://raw.githubusercontent.com/Vasiliy-katsyka/upgrade/refs/heads/main/DMJTGStarsEmoji_AgADUhMAAk9WoVI.png" alt="Star">
                            <input type="number" id="topup-amount-input" placeholder="0">
                        </div>
                    </div>
                </div>
                <div class="modal-buttons-footer">
                    <button id="confirm-topup-button" class="modal-button" disabled>Confirm Top Up</button>
                    <button id="cancel-topup-button" class="modal-button secondary">Cancel</button>
                </div>
            </div>
        </div>
        
        <div id="market-summary-page" class="page">
            <div class="page-header"><h2>Market</h2></div>
            <div id="market-summary-grid" class="gifts-grid">
                <div class="spinner"></div>
            </div>
        </div>
        
        <div id="market-listings-page" class="page">
            <div class="page-header">
                <h2 id="market-listings-title">Gift Listings</h2>
            </div>
            <div class="profile-gifts-actions-wrapper" style="display: flex; padding: 10px; gap: 8px;">
                <!-- Filters will go here -->
            </div>
            <div id="market-listings-grid" class="gifts-grid">
                <div class="spinner"></div>
            </div>
        </div>
        
        <!-- Add this new modal for the loading screen -->
        <div id="loading-overlay" class="modal-overlay active" style="align-items: center; justify-content: center; background-color: var(--tg-theme-bg-color); z-index: 9999;">
            <div style="text-align: center; color: var(--tg-theme-text-color);">
                <div id="loading-animation-container" style="width: 150px; height: 150px; margin: 0 auto;"></div>
                <h2 style="font-weight: 500; margin-top: 15px;">Gift Upgrade Bot</h2>
                <p style="color: var(--tg-theme-hint-color);">@giftUpgradeRU</p>
            </div>
        </div>

    </div>

    <div id="long-press-menu" class="hidden">
        <ul>
            <li id="menu-reorder-action" class="hidden">Reorder</li>
            <li id="menu-pin-action">Pin</li>
            <li id="menu-hide-action">Hide</li>
            <li id="menu-copy-link-action" class="hidden">Copy Link</li>
            <li id="menu-share-image-action" class="hidden">Share Image</li>
            <li id="menu-delete-action" class="danger">Delete</li>
        </ul>
    </div>
    <script>
        const BACKEND_BASE_URL = "https://upgrade-a57g.onrender.com";

        const APP_VERSION_SUFFIX = '_v15'; // Increment to reset UI preferences on major changes
        const CDN_BASE_URL = "https://cdn.changes.tg/gifts/";
        const GIFTS_JSON_URL = `${CDN_BASE_URL}id-to-name.json`;
        const PRICES_JSON_URL = "https://raw.githubusercontent.com/Vasiliy-katsyka/upgrade/refs/heads/main/prices.json";
        const STAR_ICON_URL = "https://raw.githubusercontent.com/Vasiliy-katsyka/upgrade/refs/heads/main/DMJTGStarsEmoji_AgADUhMAAk9WoVI.png";
        
        const TRANSFER_GIFT_IMG = "https://github.com/Vasiliy-katsyka/upgrade/blob/main/transfer-gift.png?raw=true";
        const WEAR_GIFT_IMG = "https://github.com/Vasiliy-katsyka/upgrade/blob/main/wear-gift.png?raw=true";
        const UNWEAR_GIFT_IMG = "https://github.com/Vasiliy-katsyka/upgrade/blob/main/unwear-gift.png?raw=true";
        const SELL_GIFT_IMG = "https://github.com/Vasiliy-katsyka/upgrade/blob/main/sell-gift.png?raw=true";
        const UNSELL_GIFT_IMG = "https://github.com/Vasiliy-katsyka/upgrade/blob/main/unsell-gift.png?raw=true";
        const GIVEAWAY_BUTTON_IMG = "https://github.com/Vasiliy-katsyka/upgrade/blob/main/giveaway.png?raw=true";
        
        const GIFT_LIMIT_PER_USER = 500000;
        const MAX_COLLECTIBLE_USERNAMES = 10;
        const MIN_SALE_PRICE = 10;
        const MAX_SALE_PRICE = 24000000;
        let profileNameTapCount = 0;
        let lastProfileNameTap = 0;
        let limitedGiftStock = {};

        const PIN_ICON_SVG = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><title>pin</title><path d="M16,12V4H17V2H7V4H8V12L6,14V16H11.2V22H12.8V16H18V14L16,12Z" /></svg>`;
        const DIAMOND_SVG = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><title>diamond-stone</title><path d="M16,9H19L14,16M10,9H14L12,17M5,9H8L10,16M5,4H19L12,1.5L5,4ZM6,2L2,8L12,22L22,8L18,2H6Z" /></svg>`;
        const CROWN_SVG = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><title>crown</title><path d="M5 16L3 5L8.5 10L12 4L15.5 10L21 5L19 16H5M19 19C19 19.6 18.6 20 18 20H6C5.4 20 5 19.6 5 19V18H19V19Z" /></svg>`;
        const LABEL_SVG = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><title>label</title><path d="M17.63,5.84C17.27,5.33 16.67,5 16,5H5A2,2 0 0,0 3,7V17A2,2 0 0,0 5,19H16C16.67,19 17.27,18.66 17.63,18.15L22,12L17.63,5.84Z" /></svg>`;
        const MENU_DOTS_SVG = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><title>dots-vertical</title><path d="M12,16A2,2 0 0,1 14,18A2,2 0 0,1 12,20A2,2 0 0,1 10,18A2,2 0 0,1 12,16M12,10A2,2 0 0,1 14,12A2,2 0 0,1 12,14A2,2 0 0,1 10,12A2,2 0 0,1 12,10M12,4A2,2 0 0,1 14,6A2,2 0 0,1 12,8A2,2 0 0,1 10,6A2,2 0 0,1 12,4Z" /></svg>`;

        let savedTemplates = [];
        let recentCreations = [];
        let pinnedParts = { model: [], backdrop: [], pattern: [] };
        let undoHistory = [];
        let redoHistory = [];
        let backdropColorFilter = null;
        
        // --- CUSTOM GIFT DATA ---
        const CUSTOM_GIFTS_DATA = {
            "Skebob": {
                "id": "custom_skebob",
                "defaultImage": "https://raw.githubusercontent.com/Vasiliy-katsyka/skebobs/refs/heads/main/BackgroundEraser_20250718_034626591.png",
                "models": [
                    {"name": "Nikitka", "rarityPermille": 1, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/skebobs/refs/heads/main/BackgroundEraser_20250718_145212143.png"},
                    {"name": "Gold", "rarityPermille": 5, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/skebobs/main/BackgroundEraser_20250717_220944840-min.png"},
                    {"name": "Plushy", "rarityPermille": 5, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/skebobs/main/BackgroundEraser_20250717_221053786-min.png"},
                    {"name": "XXXTentacion", "rarityPermille": 5, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/skebobs/main/BackgroundEraser_20250717_222249990-min.png"},
                    {"name": "Cactus King", "rarityPermille": 5, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/skebobs/main/BackgroundEraser_20250718_013002213-min.png"},
                    {"name": "354 KANON", "rarityPermille": 5, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/skebobs/main/BackgroundEraser_20250718_013042799-min.png"},
                    {"name": "Duck", "rarityPermille": 5, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/skebobs/main/BackgroundEraser_20250718_014036288-min.png"},
                    {"name": "Spider King", "rarityPermille": 10, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/skebobs/main/BackgroundEraser_20250717_220335725-min.png"},
                    {"name": "Bitcoin", "rarityPermille": 10, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/skebobs/main/BackgroundEraser_20250718_012502725-min.png"},
                    {"name": "Move To Heaven", "rarityPermille": 10, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/skebobs/main/BackgroundEraser_20250718_012612974-min.png"},
                    {"name": "Frogie", "rarityPermille": 10, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/skebobs/main/BackgroundEraser_20250718_012824238-min.png"},
                    {"name": "The King", "rarityPermille": 10, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/skebobs/main/BackgroundEraser_20250718_012931928-min.png"},
                    {"name": "Fire On Fire", "rarityPermille": 10, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/skebobs/main/BackgroundEraser_20250718_013941593-min.png"},
                    {"name": "Icy", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/skebobs/main/BackgroundEraser_20250717_220405846-min.png"},
                    {"name": "Pick Me", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/skebobs/main/BackgroundEraser_20250717_220906007-min.png"},
                    {"name": "Black Bird", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/skebobs/main/BackgroundEraser_20250717_221147963-min.png"},
                    {"name": "Pavel Durov", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/skebobs/main/BackgroundEraser_20250717_222706006-min.png"},
                    {"name": "Banana", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/skebobs/main/BackgroundEraser_20250718_013851152-min.png"},
                    {"name": "Mummy", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/skebobs/main/BackgroundEraser_20250718_014247708-min.png"},
                    {"name": "Police Man", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/skebobs/main/BackgroundEraser_20250718_014319952-min.png"},
                    {"name": "Electric BDSM", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/skebobs/main/BackgroundEraser_20250718_014554522-min.png"},
                    {"name": "Glassy", "rarityPermille": 30, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/skebobs/main/BackgroundEraser_20250717_221020205-min.png"},
                    {"name": "Ancient", "rarityPermille": 30, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/skebobs/main/BackgroundEraser_20250718_012541910-min.png"},
                    {"name": "Business", "rarityPermille": 30, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/skebobs/main/BackgroundEraser_20250718_013214856-min.png"},
                    {"name": "Spookie", "rarityPermille": 30, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/skebobs/main/BackgroundEraser_20250718_013308503-min.png"},
                    {"name": "Minion", "rarityPermille": 30, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/skebobs/main/BackgroundEraser_20250718_013343118-min.png"},
                    {"name": "Oh Shit", "rarityPermille": 30, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/skebobs/main/BackgroundEraser_20250718_013417326-min.png"},
                    {"name": "Emo Girl", "rarityPermille": 30, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/skebobs/main/BackgroundEraser_20250718_014533870-min.png"},
                    {"name": "Minecraft", "rarityPermille": 30, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/skebobs/main/BackgroundEraser_20250718_014750440-min.png"}
                ],
                "backdrops_source": "Snoop Dogg",
                "patterns_source": "Snoop Dogg"
            },
            "Baggin' Cat": {
                "id": "custom_baggin_cat",
                "defaultImage": "https://raw.githubusercontent.com/Vasiliy-katsyka/BagginCat/refs/heads/main/IMG_20250718_234950_164.png",
                "models": [
                    {"name": "Redo", "rarityPermille": 1, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/BagginCat/main/BackgroundEraser_20250720_154505502.png"},
                    {"name": "Bored Ape", "rarityPermille": 5, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/BagginCat/main/BackgroundEraser_20250720_153421320.png"},
                    {"name": "Snoop Dogg", "rarityPermille": 5, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/BagginCat/main/BackgroundEraser_20250720_153800346.png"},
                    {"name": "Austronaut", "rarityPermille": 10, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/BagginCat/main/BackgroundEraser_20250720_153211676.png"},
                    {"name": "Chinese Dragon", "rarityPermille": 10, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/BagginCat/main/BackgroundEraser_20250720_153332160.png"},
                    {"name": "Radioactive", "rarityPermille": 10, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/BagginCat/main/BackgroundEraser_20250720_154437815.png"},
                    {"name": "Pink Guard", "rarityPermille": 10, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/BagginCat/main/BackgroundEraser_20250720_154725761.png"},
                    {"name": "Angel", "rarityPermille": 10, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/BagginCat/main/BackgroundEraser_20250720_155859028.png"},
                    {"name": "Devil", "rarityPermille": 10, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/BagginCat/main/BackgroundEraser_20250720_155937967.png"},
                    {"name": "Minion", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/BagginCat/main/BackgroundEraser_20250720_153059849.png"},
                    {"name": "Rainbow", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/BagginCat/main/BackgroundEraser_20250720_153251813.png"},
                    {"name": "Spookie", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/BagginCat/main/BackgroundEraser_20250720_153836181.png"},
                    {"name": "Spider", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/BagginCat/main/BackgroundEraser_20250720_154055429.png"},
                    {"name": "Dying Light", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/BagginCat/main/BackgroundEraser_20250720_154537813.png"},
                    {"name": "Hippo", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/BagginCat/main/BackgroundEraser_20250720_155053345.png"},
                    {"name": "Poo", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/BagginCat/main/BackgroundEraser_20250720_155200011.png"},
                    {"name": "Pikachu", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/BagginCat/main/BackgroundEraser_20250720_155411045.png"},
                    {"name": "XXXTentacion", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/BagginCat/main/BackgroundEraser_20250720_155652114.png"},
                    {"name": "Electric", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/BagginCat/main/BackgroundEraser_20250720_155830968.png"},
                    {"name": "Glassy", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/BagginCat/main/BackgroundEraser_20250720_160036747.png"},
                    {"name": "Alien", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/BagginCat/main/BackgroundEraser_20250720_160243304.png"},
                    {"name": "Piggy", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/BagginCat/main/BackgroundEraser_20250720_160346910.png"},
                    {"name": "Panda", "rarityPermille": 30, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/BagginCat/main/BackgroundEraser_20250720_153136834.png"},
                    {"name": "Capybara", "rarityPermille": 30, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/BagginCat/main/BackgroundEraser_20250720_153629360.png"},
                    {"name": "Dolphin", "rarityPermille": 30, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/BagginCat/main/BackgroundEraser_20250720_155125393.png"},
                    {"name": "Rabbit", "rarityPermille": 30, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/BagginCat/main/BackgroundEraser_20250720_155341280.png"},
                    {"name": "Elephant", "rarityPermille": 30, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/BagginCat/main/BackgroundEraser_20250720_160003197.png"},
                    {"name": "Bee", "rarityPermille": 30, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/BagginCat/main/BackgroundEraser_20250720_160317620.png"}
                ],
                "backdrops_source": "Toy Bear",
                "patterns_source": "Toy Bear"
            },
            "Keychain Dog": {
                "id": "custom_keychain_dog",
                "defaultImage": "https://github.com/Vasiliy-katsyka/KeychainDog/blob/main/IMG_20250814_001025_847.png?raw=true",
                "models": [
                    {"name": "Eyes Closed", "rarityPermille": 1, "image": "https://github.com/Vasiliy-katsyka/KeychainDog/blob/main/BackgroundEraser_20250814_224650949.png?raw=true"},
                    {"name": "Golden Dog", "rarityPermille": 5, "image": "https://github.com/Vasiliy-katsyka/KeychainDog/blob/main/BackgroundEraser_20250814_224121131.png?raw=true"},
                    {"name": "Sapphire", "rarityPermille": 5, "image": "https://github.com/Vasiliy-katsyka/KeychainDog/blob/main/BackgroundEraser_20250814_224146402.png?raw=true"},
                    {"name": "Pavel Du Rove", "rarityPermille": 5, "image": "https://github.com/Vasiliy-katsyka/KeychainDog/blob/main/BackgroundEraser_20250814_224244337.png?raw=true"},
                    {"name": "Dogugu", "rarityPermille": 5, "image": "https://github.com/Vasiliy-katsyka/KeychainDog/blob/main/BackgroundEraser_20250814_224952768.png?raw=true"},
                    {"name": "Fridge", "rarityPermille": 10, "image": "https://github.com/Vasiliy-katsyka/KeychainDog/blob/main/BackgroundEraser_20250814_223539864.png?raw=true"},
                    {"name": "Cabbage", "rarityPermille": 10, "image": "https://github.com/Vasiliy-katsyka/KeychainDog/blob/main/BackgroundEraser_20250814_223714257.png?raw=true"},
                    {"name": "Hot Peach", "rarityPermille": 10, "image": "https://github.com/Vasiliy-katsyka/KeychainDog/blob/main/BackgroundEraser_20250814_223954489.png?raw=true"},
                    {"name": "Emelard", "rarityPermille": 10, "image": "https://github.com/Vasiliy-katsyka/KeychainDog/blob/main/BackgroundEraser_20250814_224215512.png?raw=true"},
                    {"name": "Mathematics", "rarityPermille": 10, "image": "https://github.com/Vasiliy-katsyka/KeychainDog/blob/main/BackgroundEraser_20250814_224336692.png?raw=true"},
                    {"name": "Duck", "rarityPermille": 10, "image": "https://github.com/Vasiliy-katsyka/KeychainDog/blob/main/BackgroundEraser_20250814_224759233.png?raw=true"},
                    {"name": "Hop Nai-Ni-Nai", "rarityPermille": 10, "image": "https://github.com/Vasiliy-katsyka/KeychainDog/blob/main/BackgroundEraser_20250814_225034482.png?raw=true"},
                    {"name": "Hippo", "rarityPermille": 20, "image": "https://github.com/Vasiliy-katsyka/KeychainDog/blob/main/BackgroundEraser_20250814_223609273.png?raw=true"},
                    {"name": "Pikachu", "rarityPermille": 20, "image": "https://github.com/Vasiliy-katsyka/KeychainDog/blob/main/BackgroundEraser_20250814_223642208.png?raw=true"},
                    {"name": "Bad Doggy", "rarityPermille": 20, "image": "https://github.com/Vasiliy-katsyka/KeychainDog/blob/main/BackgroundEraser_20250814_223841940.png?raw=true"},
                    {"name": "Demonic Dog", "rarityPermille": 20, "image": "https://github.com/Vasiliy-katsyka/KeychainDog/blob/main/BackgroundEraser_20250814_224026427.png?raw=true"},
                    {"name": "Angelic Dog", "rarityPermille": 20, "image": "https://github.com/Vasiliy-katsyka/KeychainDog/blob/main/BackgroundEraser_20250814_224054677.png?raw=true"},
                    {"name": "Frogie", "rarityPermille": 20, "image": "https://github.com/Vasiliy-katsyka/KeychainDog/blob/main/BackgroundEraser_20250814_224626535.png?raw=true"},
                    {"name": "Pick Me", "rarityPermille": 20, "image": "https://github.com/Vasiliy-katsyka/KeychainDog/blob/main/BackgroundEraser_20250814_224726881.png?raw=true"},
                    {"name": "Dying Light", "rarityPermille": 20, "image": "https://github.com/Vasiliy-katsyka/KeychainDog/blob/main/BackgroundEraser_20250814_224830054.png?raw=true"},
                    {"name": "Halloween", "rarityPermille": 20, "image": "https://github.com/Vasiliy-katsyka/KeychainDog/blob/main/BackgroundEraser_20250814_224929413.png?raw=true"},
                    {"name": "Invisible", "rarityPermille": 20, "image": "https://github.com/Vasiliy-katsyka/KeychainDog/blob/main/BackgroundEraser_20250814_225502804.png?raw=true"},
                    {"name": "Kitten", "rarityPermille": 30, "image": "https://github.com/Vasiliy-katsyka/KeychainDog/blob/main/BackgroundEraser_20250814_223514941.png?raw=true"},
                    {"name": "Tiger", "rarityPermille": 30, "image": "https://github.com/Vasiliy-katsyka/KeychainDog/blob/main/BackgroundEraser_20250814_223743205.png?raw=true"},
                    {"name": "Spider", "rarityPermille": 30, "image": "https://github.com/Vasiliy-katsyka/KeychainDog/blob/main/BackgroundEraser_20250814_223907805.png?raw=true"},
                    {"name": "Elephant", "rarityPermille": 30, "image": "https://github.com/Vasiliy-katsyka/KeychainDog/blob/main/BackgroundEraser_20250814_224405798.png?raw=true"},
                    {"name": "Ghosty", "rarityPermille": 30, "image": "https://github.com/Vasiliy-katsyka/KeychainDog/blob/main/BackgroundEraser_20250814_224443074.png?raw=true"},
                    {"name": "Banana", "rarityPermille": 30, "image": "https://github.com/Vasiliy-katsyka/KeychainDog/blob/main/BackgroundEraser_20250814_224857672.png?raw=true"},
                    {"name": "Rainbow", "rarityPermille": 30, "image": "https://github.com/Vasiliy-katsyka/KeychainDog/blob/main/BackgroundEraser_20250814_225055413.png?raw=true"},
                    {"name": "I Don't Care", "rarityPermille": 30, "image": "https://github.com/Vasiliy-katsyka/KeychainDog/blob/main/BackgroundEraser_20250814_225130675.png?raw=true"}
                ],
                "backdrops_source": "Toy Bear",
                "patterns_source": "Toy Bear"
            },
            "Taped Eggplant": {
                "id": "custom_taped_eggplant",
                "defaultImage": "https://github.com/Vasiliy-katsyka/Taped-Eggplant/blob/main/PremiumGifts_AgADDgAD0HLwTA.png?raw=true",
                "models": [
                    {"name": "Gold Sneaker", "rarityPermille": 5, "image": "https://github.com/Vasiliy-katsyka/Taped-Eggplant/blob/main/BackgroundEraser_20250827_200715791.png?raw=true"},
                    {"name": "Paul The Eggplant", "rarityPermille": 5, "image": "https://github.com/Vasiliy-katsyka/Taped-Eggplant/blob/main/BackgroundEraser_20250827_201628865.png?raw=true"},
                    {"name": "Adult Toy", "rarityPermille": 5, "image": "https://github.com/Vasiliy-katsyka/Taped-Eggplant/blob/main/BackgroundEraser_20250827_201700100.png?raw=true"},
                    {"name": "Golden", "rarityPermille": 8, "image": "https://github.com/Vasiliy-katsyka/Taped-Eggplant/blob/main/BackgroundEraser_20250827_195914455.png?raw=true"},
                    {"name": "Silver", "rarityPermille": 8, "image": "https://github.com/Vasiliy-katsyka/Taped-Eggplant/blob/main/BackgroundEraser_20250827_200004319.png?raw=true"},
                    {"name": "Sapphire", "rarityPermille": 8, "image": "https://github.com/Vasiliy-katsyka/Taped-Eggplant/blob/main/BackgroundEraser_20250827_200031197.png?raw=true"},
                    {"name": "Ducky", "rarityPermille": 10, "image": "https://github.com/Vasiliy-katsyka/Taped-Eggplant/blob/main/BackgroundEraser_20250827_200202226.png?raw=true"},
                    {"name": "Rich", "rarityPermille": 10, "image": "https://github.com/Vasiliy-katsyka/Taped-Eggplant/blob/main/BackgroundEraser_20250827_200532079.png?raw=true"},
                    {"name": "Cigars", "rarityPermille": 10, "image": "https://github.com/Vasiliy-katsyka/Taped-Eggplant/blob/main/BackgroundEraser_20250827_200822737.png?raw=true"},
                    {"name": "Red Bull", "rarityPermille": 10, "image": "https://github.com/Vasiliy-katsyka/Taped-Eggplant/blob/main/BackgroundEraser_20250827_201008559.png?raw=true"},
                    {"name": "iPhone", "rarityPermille": 10, "image": "https://github.com/Vasiliy-katsyka/Taped-Eggplant/blob/main/BackgroundEraser_20250827_201115777.png?raw=true"},
                    {"name": "To The Moon", "rarityPermille": 10, "image": "https://github.com/Vasiliy-katsyka/Taped-Eggplant/blob/main/BackgroundEraser_20250827_201544571.png?raw=true"},
                    {"name": "Wooden", "rarityPermille": 20, "image": "https://github.com/Vasiliy-katsyka/Taped-Eggplant/blob/main/BackgroundEraser_20250827_195940841.png?raw=true"},
                    {"name": "French Baguete", "rarityPermille": 20, "image": "https://github.com/Vasiliy-katsyka/Taped-Eggplant/blob/main/BackgroundEraser_20250827_200121211.png?raw=true"},
                    {"name": "Wild Eggplant", "rarityPermille": 20, "image": "https://github.com/Vasiliy-katsyka/Taped-Eggplant/blob/main/BackgroundEraser_20250827_200229914.png?raw=true"},
                    {"name": "Spray Can", "rarityPermille": 20, "image": "https://github.com/Vasiliy-katsyka/Taped-Eggplant/blob/main/BackgroundEraser_20250827_200601835.png?raw=true"},
                    {"name": "Bowling", "rarityPermille": 20, "image": "https://github.com/Vasiliy-katsyka/Taped-Eggplant/blob/main/BackgroundEraser_20250827_200851078.png?raw=true"},
                    {"name": "Brick", "rarityPermille": 20, "image": "https://github.com/Vasiliy-katsyka/Taped-Eggplant/blob/main/BackgroundEraser_20250827_200927659.png?raw=true"},
                    {"name": "Minion", "rarityPermille": 20, "image": "https://github.com/Vasiliy-katsyka/Taped-Eggplant/blob/main/BackgroundEraser_20250827_201042405.png?raw=true"},
                    {"name": "Pasta", "rarityPermille": 20, "image": "https://github.com/Vasiliy-katsyka/Taped-Eggplant/blob/main/BackgroundEraser_20250827_201518384.png?raw=true"},
                    {"name": "Banana", "rarityPermille": 30, "image": "https://github.com/Vasiliy-katsyka/Taped-Eggplant/blob/main/BackgroundEraser_20250827_195534071.png?raw=true"},
                    {"name": "Musical", "rarityPermille": 30, "image": "https://github.com/Vasiliy-katsyka/Taped-Eggplant/blob/main/BackgroundEraser_20250827_195604308.png?raw=true"},
                    {"name": "Bug", "rarityPermille": 30, "image": "https://github.com/Vasiliy-katsyka/Taped-Eggplant/blob/main/BackgroundEraser_20250827_195644493.png?raw=true"},
                    {"name": "Mop", "rarityPermille": 30, "image": "https://github.com/Vasiliy-katsyka/Taped-Eggplant/blob/main/BackgroundEraser_20250827_195719096.png?raw=true"},
                    {"name": "Mango", "rarityPermille": 30, "image": "https://github.com/Vasiliy-katsyka/Taped-Eggplant/blob/main/BackgroundEraser_20250827_195739251.png?raw=true"},
                    {"name": "Tooth Brush", "rarityPermille": 30, "image": "https://github.com/Vasiliy-katsyka/Taped-Eggplant/blob/main/BackgroundEraser_20250827_195800972.png?raw=true"},
                    {"name": "Newspaper", "rarityPermille": 30, "image": "https://github.com/Vasiliy-katsyka/Taped-Eggplant/blob/main/BackgroundEraser_20250827_195826700.png?raw=true"},
                    {"name": "Kebab", "rarityPermille": 30, "image": "https://github.com/Vasiliy-katsyka/Taped-Eggplant/blob/main/BackgroundEraser_20250827_200259658.png?raw=true"},
                    {"name": "Power Strip", "rarityPermille": 30, "image": "https://github.com/Vasiliy-katsyka/Taped-Eggplant/blob/main/BackgroundEraser_20250827_201451237.png?raw=true"}
                ],
                "backdrops_source": "Plush Pepe",
                "patterns_source": "Plush Pepe"
            },
            "Vintage Ferrari": {
                "id": "custom_vintage_ferrari",
                "defaultImage": "https://raw.githubusercontent.com/Vasiliy-katsyka/Vintage-Ferrari/main/099.png",
                "models": [
                    {"name": "Bored Ape", "rarityPermille": 1, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/Vintage-Ferrari/main/BackgroundEraser_20250829_232837620.png"},
                    {"name": "Diamond", "rarityPermille": 5, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/Vintage-Ferrari/main/BackgroundEraser_20250829_230807795.png"},
                    {"name": "Ford Mustang", "rarityPermille": 5, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/Vintage-Ferrari/main/BackgroundEraser_20250829_230929829.png"},
                    {"name": "The Swamp", "rarityPermille": 5, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/Vintage-Ferrari/main/BackgroundEraser_20250829_231349161.png"},
                    {"name": "North Korea", "rarityPermille": 8, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/Vintage-Ferrari/main/BackgroundEraser_20250829_232859265.png"},
                    {"name": "Gold Ferrari", "rarityPermille": 10, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/Vintage-Ferrari/main/BackgroundEraser_20250829_230022017.png"},
                    {"name": "Leclerc F1", "rarityPermille": 10, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/Vintage-Ferrari/main/BackgroundEraser_20250829_230353227.png"},
                    {"name": "Tsunoda F1", "rarityPermille": 10, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/Vintage-Ferrari/main/BackgroundEraser_20250829_230633177.png"},
                    {"name": "Rothmans Porsche", "rarityPermille": 10, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/Vintage-Ferrari/main/BackgroundEraser_20250829_231207311.png"},
                    {"name": "Cybertruck", "rarityPermille": 10, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/Vintage-Ferrari/main/BackgroundEraser_20250829_232446458.png"},
                    // {"name": "Shaiba", "rarityPermille": 10, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/Vintage-Ferrari/main/BackgroundEraser_20250829_232614195.png"},
                    {"name": "American", "rarityPermille": 10, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/Vintage-Ferrari/main/BackgroundEraser_20250829_232648128.png"},
                    {"name": "Hell Car", "rarityPermille": 10, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/Vintage-Ferrari/main/BackgroundEraser_20250829_232813077.png"},
                    {"name": "Lamborghini", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/Vintage-Ferrari/main/BackgroundEraser_20250829_225824432.png"},
                    {"name": "Motorcycle", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/Vintage-Ferrari/main/BackgroundEraser_20250829_230108359.png"},
                    {"name": "Helicopter", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/Vintage-Ferrari/main/BackgroundEraser_20250829_230841030.png"},
                    {"name": "Bugatti", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/Vintage-Ferrari/main/BackgroundEraser_20250829_230952790.png"},
                    {"name": "Aerostat", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/Vintage-Ferrari/main/BackgroundEraser_20250829_231323581.png"},
                    {"name": "Beetle", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/Vintage-Ferrari/main/BackgroundEraser_20250829_231520676.png"},
                    {"name": "Take Me Back To London", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/Vintage-Ferrari/main/BackgroundEraser_20250829_231715347.png"},
                    {"name": "Beautiful People", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/Vintage-Ferrari/main/BackgroundEraser_20250829_231955163.png"},
                    {"name": "Roller Coaster", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/Vintage-Ferrari/main/BackgroundEraser_20250829_232330112.png"},
                    {"name": "Future", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/Vintage-Ferrari/main/BackgroundEraser_20250829_232356807.png"},
                    {"name": "Upside Down", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/Vintage-Ferrari/main/BackgroundEraser_20250829_232716367.png"},
                    {"name": "Accident", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/Vintage-Ferrari/main/BackgroundEraser_20250829_232746147.png"},
                    {"name": "Golf Cart", "rarityPermille": 30, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/Vintage-Ferrari/main/BackgroundEraser_20250829_230709859.png"},
                    {"name": "Taxi", "rarityPermille": 30, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/Vintage-Ferrari/main/BackgroundEraser_20250829_230905043.png"},
                    {"name": "Back To The Future", "rarityPermille": 30, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/Vintage-Ferrari/main/BackgroundEraser_20250829_231014793.png"},
                    {"name": "Tractor", "rarityPermille": 30, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/Vintage-Ferrari/main/BackgroundEraser_20250829_231244911.png"},
                    {"name": "Despicable Me", "rarityPermille": 30, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/Vintage-Ferrari/main/BackgroundEraser_20250829_231414903.png"},
                    {"name": "Ghostbusters", "rarityPermille": 30, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/Vintage-Ferrari/main/BackgroundEraser_20250829_231520676.png"},
                    {"name": "Mr. Bean", "rarityPermille": 30, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/Vintage-Ferrari/main/BackgroundEraser_20250829_232118455.png"},
                    {"name": "Ducky", "rarityPermille": 30, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/Vintage-Ferrari/main/BackgroundEraser_20250829_232300190.png"},
                    {"name": "Transporter T1", "rarityPermille": 30, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/Vintage-Ferrari/main/BackgroundEraser_20250829_232513956.png"},
                    {"name": "Watermelon", "rarityPermille": 30, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/Vintage-Ferrari/main/BackgroundEraser_20250829_232543790.png"}
                ],
                "backdrops_source": "Snoop Dogg",
                "patterns_source": "Snoop Dogg"
            },
            "Rich Frog": {
                "id": "custom_rich_frog",
                "limit": 300,
                "defaultImage": "https://raw.githubusercontent.com/Vasiliy-katsyka/sheeranGifts/main/PremiumGifts_AgADCgADgyaRTA.png",
                "models": [
                    {"name": "Old Movie", "rarityPermille": 5, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/sheeranGifts/main/BackgroundEraser_20250911_012742001.png"},
                    {"name": "Diamond", "rarityPermille": 10, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/sheeranGifts/main/BackgroundEraser_20250911_012429267.png"},
                    {"name": "Red Diamond", "rarityPermille": 10, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/sheeranGifts/main/BackgroundEraser_20250911_012455524.png"},
                    {"name": "Business", "rarityPermille": 10, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/sheeranGifts/main/BackgroundEraser_20250911_012520124.png"},
                    {"name": "Telegram", "rarityPermille": 10, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/sheeranGifts/main/BackgroundEraser_20250911_013004928.png"},
                    {"name": "Pepe", "rarityPermille": 10, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/sheeranGifts/main/BackgroundEraser_20250911_013048306.png"},
                    {"name": "Galaxy", "rarityPermille": 10, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/sheeranGifts/main/BackgroundEraser_20250911_013237557.png"},
                    // {"name": "Shaiba", "rarityPermille": 10, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/sheeranGifts/main/BackgroundEraser_20250911_013427809.png"},
                    {"name": "Silver", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/sheeranGifts/main/BackgroundEraser_20250911_012356530.png"},
                    {"name": "From The Hell", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/sheeranGifts/main/BackgroundEraser_20250911_012409591.png"},
                    {"name": "Old", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/sheeranGifts/main/BackgroundEraser_20250911_012443079.png"},
                    {"name": "Soldier", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/sheeranGifts/main/BackgroundEraser_20250911_012558144.png"},
                    {"name": "Poker", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/sheeranGifts/main/BackgroundEraser_20250911_012757225.png"},
                    {"name": "Zombie", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/sheeranGifts/main/BackgroundEraser_20250911_013004928.png"},
                    {"name": "Satoshi Natokama", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/sheeranGifts/main/BackgroundEraser_20250911_013017488.png"},
                    {"name": "The Open Network", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/sheeranGifts/main/BackgroundEraser_20250911_013033825.png"},
                    {"name": "BDSM", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/sheeranGifts/main/BackgroundEraser_20250911_013107410.png"},
                    {"name": "Angelic", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/sheeranGifts/main/BackgroundEraser_20250911_013121916.png"},
                    {"name": "Rapper", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/sheeranGifts/main/BackgroundEraser_20250911_013335968.png"},
                    {"name": "Mermaid", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/sheeranGifts/main/BackgroundEraser_20250911_013354933.png"},
                    {"name": "Freddy's Frog", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/sheeranGifts/main/BackgroundEraser_20250911_013459472.png"},
                    {"name": "Umbrella", "rarityPermille": 30, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/sheeranGifts/main/BackgroundEraser_20250911_012540549.png"},
                    {"name": "Wooden", "rarityPermille": 30, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/sheeranGifts/main/BackgroundEraser_20250911_012623191.png"},
                    {"name": "Bad Quality", "rarityPermille": 30, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/sheeranGifts/main/BackgroundEraser_20250911_012643696.png"},
                    {"name": "Pink", "rarityPermille": 30, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/sheeranGifts/main/BackgroundEraser_20250911_012815025.png"},
                    {"name": "Butterfly", "rarityPermille": 30, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/sheeranGifts/main/BackgroundEraser_20250911_012831763.png"},
                    {"name": "Rainbow", "rarityPermille": 30, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/sheeranGifts/main/BackgroundEraser_20250911_012857269.png"},
                    {"name": "Hawaii", "rarityPermille": 30, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/sheeranGifts/main/BackgroundEraser_20250911_013140547.png"},
                    {"name": "Gamer", "rarityPermille": 30, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/sheeranGifts/main/BackgroundEraser_20250911_013207148.png"},
                    {"name": "Pickme", "rarityPermille": 30, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/sheeranGifts/main/BackgroundEraser_20250911_013221620.png"},
                    {"name": "Watermelon", "rarityPermille": 30, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/sheeranGifts/main/BackgroundEraser_20250911_013250229.png"},
                    {"name": "Cactus", "rarityPermille": 30, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/sheeranGifts/main/BackgroundEraser_20250911_013304943.png"},
                    {"name": "Red", "rarityPermille": 30, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/sheeranGifts/main/BackgroundEraser_20250911_013441382.png"},
                    {"name": "Snowy", "rarityPermille": 30, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/sheeranGifts/main/BackgroundEraser_20250911_013518774.png"},
                    {"name": "Tiger", "rarityPermille": 30, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/sheeranGifts/main/BackgroundEraser_20250911_013900673.png"}
                ],
                "backdrops_source": "Snoop Dogg",
                "patterns_source": "Snoop Dogg"
            },
            "Sheeran Guitar": {
                "id": "custom_sheeran_guitar",
                "limit": 500,
                "defaultImage": "https://raw.githubusercontent.com/Vasiliy-katsyka/sheeranGifts/main/20250908_012216.png",
                "models": [
                    {"name": "Minion", "rarityPermille": 5, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/sheeranGifts/main/BackgroundEraser_20250911_010828869.png"},
                    {"name": "Darkness", "rarityPermille": 5, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/sheeranGifts/main/BackgroundEraser_20250911_010917671.png"},
                    {"name": "Sponge Bob", "rarityPermille": 5, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/sheeranGifts/main/BackgroundEraser_20250911_011122889.png"},
                    {"name": "Emelard", "rarityPermille": 5, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/sheeranGifts/main/BackgroundEraser_20250911_011206969.png"},
                    {"name": "Golden", "rarityPermille": 5, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/sheeranGifts/main/BackgroundEraser_20250911_022612251.png"},
                    {"name": "Sapphire", "rarityPermille": 8, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/sheeranGifts/main/BackgroundEraser_20250911_022557588.png"},
                    {"name": "Electric", "rarityPermille": 10, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/sheeranGifts/main/BackgroundEraser_20250911_010415814.png"},
                    {"name": "Watery", "rarityPermille": 10, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/sheeranGifts/main/BackgroundEraser_20250911_010543207.png"},
                    {"name": "Lava Stone", "rarityPermille": 10, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/sheeranGifts/main/BackgroundEraser_20250911_010608356.png"},
                    {"name": "Old", "rarityPermille": 10, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/sheeranGifts/main/BackgroundEraser_20250911_010725595.png"},
                    {"name": "Banjo", "rarityPermille": 10, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/sheeranGifts/main/BackgroundEraser_20250911_010740321.png"},
                    {"name": "Russian", "rarityPermille": 10, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/sheeranGifts/main/BackgroundEraser_20250911_010843719.png"},
                    {"name": "Slipknot", "rarityPermille": 10, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/sheeranGifts/main/BackgroundEraser_20250911_010943972.png"},
                    {"name": "Yellow Wood", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/sheeranGifts/main/BackgroundEraser_20250911_005818708.png"},
                    {"name": "Virus", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/sheeranGifts/main/BackgroundEraser_20250911_005851841.png"},
                    {"name": "Mathematics", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/sheeranGifts/main/BackgroundEraser_20250911_005949661.png"},
                    {"name": "Divide", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/sheeranGifts/main/BackgroundEraser_20250911_010004362.png"},
                    {"name": "Multiply", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/sheeranGifts/main/BackgroundEraser_20250911_010049483.png"},
                    {"name": "Plus", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/sheeranGifts/main/BackgroundEraser_20250911_010142885.png"},
                    {"name": "Equals", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/sheeranGifts/main/BackgroundEraser_20250911_010221112.png"},
                    {"name": "Subtract", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/sheeranGifts/main/BackgroundEraser_20250911_010314441.png"},
                    {"name": "Emo", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/sheeranGifts/main/BackgroundEraser_20250911_010440657.png"},
                    {"name": "Poopie", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/sheeranGifts/main/BackgroundEraser_20250911_010630535.png"},
                    {"name": "Stickers", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/sheeranGifts/main/BackgroundEraser_20250911_010654844.png"},
                    {"name": "Mexican", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/sheeranGifts/main/BackgroundEraser_20250911_010756062.png"},
                    {"name": "Chinese", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/sheeranGifts/main/BackgroundEraser_20250911_010810805.png"},
                    {"name": "Fire On Fire", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/sheeranGifts/main/BackgroundEraser_20250911_011024645.png"},
                    {"name": "Witch", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/sheeranGifts/main/BackgroundEraser_20250911_011107534.png"},
                    {"name": "Hawaii", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/sheeranGifts/main/BackgroundEraser_20250911_011136893.png"},
                    {"name": "Minecraft", "rarityPermille": 30, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/sheeranGifts/main/BackgroundEraser_20250911_005837327.png"},
                    {"name": "Ancient", "rarityPermille": 30, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/sheeranGifts/main/BackgroundEraser_20250911_005913329.png"},
                    {"name": "Greenwood", "rarityPermille": 30, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/sheeranGifts/main/BackgroundEraser_20250911_005933291.png"},
                    {"name": "Fluffy", "rarityPermille": 30, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/sheeranGifts/main/BackgroundEraser_20250911_010330086.png"},
                    {"name": "Electric Purple", "rarityPermille": 30, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/sheeranGifts/main/BackgroundEraser_20250911_010519545.png"},
                    {"name": "Lego House", "rarityPermille": 30, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/sheeranGifts/main/BackgroundEraser_20250911_011041563.png"}
                ],
                "backdrops_source": "Snoop Dogg",
                "patterns_source": "Snoop Dogg"
            },
            "Dancing Cactus": {
                "id": "custom_dancing_cactus",
                "limit": 1000,
                "defaultImage": "https://raw.githubusercontent.com/Vasiliy-katsyka/sheeranGifts/main/IMG_20250908_020437_814.png",
                "models": [
                    {"name": "Golden", "rarityPermille": 5, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/sheeranGifts/main/BackgroundEraser_20250911_011316070.png"},
                    {"name": "Diamonds", "rarityPermille": 10, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/sheeranGifts/main/BackgroundEraser_20250911_011350480.png"},
                    {"name": "Rainbow", "rarityPermille": 10, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/sheeranGifts/main/BackgroundEraser_20250911_011445647.png"},
                    {"name": "Drought", "rarityPermille": 10, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/sheeranGifts/main/BackgroundEraser_20250911_011516035.png"},
                    {"name": "Electric", "rarityPermille": 10, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/sheeranGifts/main/BackgroundEraser_20250911_011559687.png"},
                    {"name": "Silver", "rarityPermille": 10, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/sheeranGifts/main/BackgroundEraser_20250911_011754280.png"},
                    {"name": "Virus", "rarityPermille": 10, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/sheeranGifts/main/BackgroundEraser_20250911_011906408.png"},
                    {"name": "Milfa", "rarityPermille": 10, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/sheeranGifts/main/BackgroundEraser_20250911_012304698.png"},
                    {"name": "Arabic", "rarityPermille": 10, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/sheeranGifts/main/BackgroundEraser_20250911_012318660.png"},
                    {"name": "Plushy", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/sheeranGifts/main/BackgroundEraser_20250911_011410903.png"},
                    {"name": "Sky", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/sheeranGifts/main/BackgroundEraser_20250911_011626338.png"},
                    {"name": "Egypt", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/sheeranGifts/main/BackgroundEraser_20250911_011640892.png"},
                    {"name": "Chinese", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/sheeranGifts/main/BackgroundEraser_20250911_011707770.png"},
                    {"name": "Greek", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/sheeranGifts/main/BackgroundEraser_20250911_011723289.png"},
                    {"name": "Owww", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/sheeranGifts/main/BackgroundEraser_20250911_011821198.png"},
                    {"name": "Business", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/sheeranGifts/main/BackgroundEraser_20250911_011834166.png"},
                    {"name": "Skeleton", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/sheeranGifts/main/BackgroundEraser_20250911_011925666.png"},
                    {"name": "Cabels", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/sheeranGifts/main/BackgroundEraser_20250911_011942350.png"},
                    {"name": "Creepy", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/sheeranGifts/main/BackgroundEraser_20250911_012014199.png"},
                    {"name": "Budni Cowboya", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/sheeranGifts/main/BackgroundEraser_20250911_012028668.png"},
                    {"name": "Marble", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/sheeranGifts/main/BackgroundEraser_20250911_012132211.png"},
                    {"name": "Hawaii", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/sheeranGifts/main/BackgroundEraser_20250911_012157170.png"},
                    {"name": "Ed Sheeran", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/sheeranGifts/main/BackgroundEraser_20250911_012210326.png"},
                    {"name": "Pandemic", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/sheeranGifts/main/BackgroundEraser_20250911_012223282.png"},
                    {"name": "Play", "rarityPermille": 30, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/sheeranGifts/main/BackgroundEraser_20250911_011302760.png"},
                    {"name": "Ancient", "rarityPermille": 30, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/sheeranGifts/main/BackgroundEraser_20250911_011335854.png"},
                    {"name": "Wooden", "rarityPermille": 30, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/sheeranGifts/main/BackgroundEraser_20250911_011500397.png"},
                    {"name": "Pink", "rarityPermille": 30, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/sheeranGifts/main/BackgroundEraser_20250911_011530016.png"},
                    {"name": "In Pain", "rarityPermille": 30, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/sheeranGifts/main/BackgroundEraser_20250911_011740171.png"},
                    {"name": "Sandy", "rarityPermille": 30, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/sheeranGifts/main/BackgroundEraser_20250911_011959216.png"},
                    {"name": "Kissed", "rarityPermille": 30, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/sheeranGifts/main/BackgroundEraser_20250911_012044125.png"},
                    {"name": "Blue", "rarityPermille": 30, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/sheeranGifts/main/BackgroundEraser_20250911_012059061.png"},
                    {"name": "Robotic", "rarityPermille": 30, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/sheeranGifts/main/BackgroundEraser_20250911_012112591.png"},
                    {"name": "Sapphire", "rarityPermille": 30, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/sheeranGifts/main/BackgroundEraser_20250911_012236420.png"},
                    {"name": "Gray", "rarityPermille": 30, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/sheeranGifts/main/BackgroundEraser_20250911_012250549.png"}
                ],
                "backdrops_source": "Snoop Dogg",
                "patterns_source": "Snoop Dogg"
            },
            "Precious Capybara": {
                "id": "custom_precious_capybara",
                "limit": 500,
                "defaultImage": "https://raw.githubusercontent.com/Vasiliy-katsyka/capybara/main/IMG_20251015_175716_923.png",
                "models": [
                    {"name": "Jacuzzi", "rarityPermille": 2, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/capybara/main/BackgroundEraser_20251015_210307885.png"},
                    {"name": "Golden", "rarityPermille": 5, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/capybara/main/BackgroundEraser_20251015_210240489.png"},
                    {"name": "Adult One", "rarityPermille": 5, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/capybara/main/BackgroundEraser_20251015_225206788.png"},
                    {"name": "Pumpkin", "rarityPermille": 5, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/capybara/main/BackgroundEraser_20251015_225544940.png"},
                    {"name": "Forggy", "rarityPermille": 8, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/capybara/main/BackgroundEraser_20251015_210319839.png"},
                    {"name": "Rapper", "rarityPermille": 10, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/capybara/main/BackgroundEraser_20251015_210330068.png"},
                    {"name": "Frankenstein", "rarityPermille": 10, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/capybara/main/BackgroundEraser_20251015_225554989.png"},
                    {"name": "Glassy", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/capybara/main/BackgroundEraser_20251015_210253371.png"},
                    {"name": "Way Of Water", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/capybara/main/BackgroundEraser_20251015_210352147.png"},
                    {"name": "Galaxy", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/capybara/main/BackgroundEraser_20251015_210404469.png"},
                    {"name": "Spider", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/capybara/main/BackgroundEraser_20251015_225231111.png"},
                    {"name": "Toddler", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/capybara/main/BackgroundEraser_20251015_225240417.png"},
                    {"name": "Santa", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/capybara/main/BackgroundEraser_20251015_225336333.png"},
                    {"name": "Poseidon", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/capybara/main/BackgroundEraser_20251015_225414819.png"},
                    {"name": "Angel", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/capybara/main/BackgroundEraser_20251015_225423656.png"},
                    {"name": "Pickme", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/capybara/main/BackgroundEraser_20251015_225441409.png"},
                    {"name": "Toxic", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/capybara/main/BackgroundEraser_20251015_225452770.png"},
                    {"name": "Firing", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/capybara/main/BackgroundEraser_20251015_225503008.png"},
                    {"name": "Biohazard", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/capybara/main/BackgroundEraser_20251015_225512435.png"},
                    {"name": "Orange", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/capybara/main/BackgroundEraser_20251015_225522038.png"},
                    {"name": "Trapped", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/capybara/main/BackgroundEraser_20251015_225605504.png"},
                    {"name": "Bee", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/capybara/main/BackgroundEraser_20251015_225615944.png"},
                    {"name": "Astronaut", "rarityPermille": 30, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/capybara/main/BackgroundEraser_20251015_210418934.png"},
                    {"name": "Fog", "rarityPermille": 30, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/capybara/main/BackgroundEraser_20251015_210434612.png"},
                    {"name": "Octopus", "rarityPermille": 30, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/capybara/main/BackgroundEraser_20251015_225218187.png"},
                    {"name": "Lava", "rarityPermille": 30, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/capybara/main/BackgroundEraser_20251015_225249443.png"},
                    {"name": "Halloween", "rarityPermille": 30, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/capybara/main/BackgroundEraser_20251015_225259219.png"},
                    {"name": "Clown", "rarityPermille": 30, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/capybara/main/BackgroundEraser_20251015_225309107.png"},
                    {"name": "Wooden", "rarityPermille": 30, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/capybara/main/BackgroundEraser_20251015_225318227.png"},
                    {"name": "Ancient", "rarityPermille": 30, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/capybara/main/BackgroundEraser_20251015_225327084.png"},
                    {"name": "Indian", "rarityPermille": 30, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/capybara/main/BackgroundEraser_20251015_225346205.png"},
                    {"name": "Egypt", "rarityPermille": 30, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/capybara/main/BackgroundEraser_20251015_225355579.png"},
                    {"name": "Chinese", "rarityPermille": 30, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/capybara/main/BackgroundEraser_20251015_225405044.png"},
                    {"name": "Cherry", "rarityPermille": 30, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/capybara/main/BackgroundEraser_20251015_225432503.png"},
                    {"name": "Icy", "rarityPermille": 30, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/capybara/main/BackgroundEraser_20251015_225532869.png"}
                ],
                "backdrops_source": "Toy Bear",
                "patterns_source": "Toy Bear"
            },
        };


        // --- Global State ---
        let allAvailableGifts = {};
        let giftPrices = {};

        let currentPublicProfileData = null;
        const AVAILABLE_REACTIONS = ['❤️', '💯', '🏆', '🔥', '👍', '🤗', '💔', '😭', '💋', '🍆', '🍑', '🤬', '🙄'];
        let currentAccountUsername = null; // We'll set this when the user logs in
        
        let accounts = [];
        let currentAccountTgId = null;

        let ownedGifts = [];
        let profilePosts = [];
        let currentlySortedGifts = [];
        let viewingOwnProfile = true;
        let selectionModeActive = false;
        let selectionAction = null;
        let reorderModeActive = false;
        let selectedGiftIds = new Set();

        let animationsEnabled = true;
        let showHiddenGifts = false;
        let customGiftsEnabled = false;
        let activeFilters = { collection: null, model: null, backdrop: null, pattern: null };

        let tg = window.Telegram.WebApp;

        // --- DOM Elements ---
        const appContainer = document.querySelector('.app-container');
        const accountSidebar = document.getElementById('account-sidebar');
        const sidebarOverlay = document.getElementById('sidebar-overlay');
        const sidebarCurrentAvatar = document.getElementById('sidebar-current-avatar');
        const sidebarCurrentName = document.getElementById('sidebar-current-name');
        const accountsList = document.getElementById('accounts-list');
        const openFiltersButton = document.getElementById('open-filters-button');
        const openNumbersButton = document.getElementById('open-numbers-button');
        const openUsernamesButton = document.getElementById('open-usernames-button');
        const createGiveawayButton = document.getElementById('create-giveaway-button');

        const profileEditBtn = document.getElementById('profile-edit-btn');
        const profilePage = document.getElementById('profile-page');
        const profileTopSection = document.getElementById('profile-top-section');
        const profileHeaderPatternOverlay = document.getElementById('profile-header-pattern-overlay');
        const profileAvatar = document.getElementById('profile-avatar');
        const avatarUploadInput = document.getElementById('avatar-upload-input');
        const profileName = document.getElementById('profile-name');
        const wornGiftIconContainer = document.getElementById('worn-gift-icon-container');
        const profileGiftCountSubtext = document.getElementById('profile-gift-count-subtext');
        const profileStatus = document.getElementById('profile-status');
        const profileDetails = document.getElementById('profile-details');
        const profilePhone = document.getElementById('profile-phone');
        const profileBio = document.getElementById('profile-bio');
        const profileUsername = document.getElementById('profile-username');
        const collectibleUsernamesContainer = document.getElementById('collectible-usernames-container');
        const profileTopPinnedGifts = document.getElementById('profile-top-pinned-gifts');

        const giftsTabButton = document.getElementById('gifts-tab-button');
        const giftsTabPreviewContainer = document.getElementById('gifts-tab-preview-container');
        const postsTabButton = document.getElementById('posts-tab-button');
        const buyGiftsTabButton = document.getElementById('buy-gifts-tab-button');
        const giftsContent = document.getElementById('gifts-content');
        const postsContent = document.getElementById('posts-content');
        const newPostFab = document.getElementById('new-post-fab');

        const profileGiftsActionsWrapper = document.getElementById('profile-gifts-actions-wrapper');
        const profileGiftsActions = document.querySelector('.profile-gifts-actions');
        const upgradeAllGiftsButton = document.getElementById('upgrade-all-gifts-button');
        const giftsGrid = document.getElementById('gifts-grid');
        const giftsLoadingSpinner = document.getElementById('gifts-loading-spinner');

        const buyGiftsPage = document.getElementById('buy-gifts-page');
        const customizeGiftButton = document.getElementById('customize-gift-button');
        const buyGiftsGrid = document.getElementById('buy-gifts-grid');
        const buyGiftsLoadingSpinner = document.getElementById('buy-gifts-loading-spinner');

        const giftDetailModal = document.getElementById('gift-detail-modal');
        const modalGiftName = document.getElementById('modal-gift-name');
        const modalLottieGiftOriginal = document.getElementById('modal-lottie-gift-original');
        const modalGiftImageStatic = document.getElementById('modal-gift-image-static');
        const modalGiftDescription1 = document.getElementById('modal-gift-description1');
        const modalGiftDescription2 = document.getElementById('modal-gift-description2');
        const modalGiftInfo = document.getElementById('modal-gift-info');
        const upgradeGiftDetailModalButton = document.getElementById('upgrade-gift-detail-modal-button');
        const closeGiftDetailModalButton = document.getElementById('close-gift-detail-modal-button');

        const profileLevelBubble = document.getElementById('profile-level-bubble');
        const collectibleDetailModal = document.getElementById('collectible-detail-modal');
        const collectibleDisplayArea = collectibleDetailModal.querySelector('.collectible-display-area');
        const patternContainerDynamic = document.getElementById('pattern-container-dynamic');
        const modalCollectibleVisual = document.getElementById('modal-collectible-visual');
        const modalLottieCollectibleModel = document.getElementById('modal-lottie-collectible-model');
        const modalCollectibleModelImgStatic = document.getElementById('modal-collectible-model-img-static');
        const modalCollectibleMainName = document.getElementById('modal-collectible-main-name');
        const modalCollectibleNumberSubtext = document.getElementById('modal-collectible-number-subtext');
        const modalCollectibleInfoTable = document.getElementById('modal-collectible-info-table');
        const collectibleActionWear = document.getElementById('collectible-action-wear');
        const collectibleActionSell = document.getElementById('collectible-action-sell');
        const collectibleActionTransfer = document.getElementById('collectible-action-transfer');
        const closeCollectibleDetailModalButton = document.getElementById('close-collectible-detail-modal');
        const collectibleMenuButton = document.getElementById('collectible-menu-button');
        const hideLinkInModal = document.getElementById('hide-link-in-modal');

        const tooManyPinsModal = document.getElementById('too-many-pins-modal');
        const unpinSelectionGrid = document.getElementById('unpin-selection-grid');
        const cancelUnpinModal = document.getElementById('cancel-unpin-modal');

        const buyMultipleModal = document.getElementById('buy-multiple-modal');
        const buyMultipleModalTitle = document.getElementById('buy-multiple-modal-title');
        const buyMultipleGiftName = document.getElementById('buy-multiple-gift-name');
        const buyMultipleQuantityInput = document.getElementById('buy-multiple-quantity');
        const confirmBuyMultipleButton = document.getElementById('confirm-buy-multiple');
        const cancelBuyMultipleButton = document.getElementById('cancel-buy-multiple');

        const longPressMenu = document.getElementById('long-press-menu');
        const menuReorderAction = document.getElementById('menu-reorder-action');
        const menuPinAction = document.getElementById('menu-pin-action');
        const menuHideAction = document.getElementById('menu-hide-action');
        const menuCopyLinkAction = document.getElementById('menu-copy-link-action');
        const menuDeleteAction = document.getElementById('menu-delete-action');
        const menuShareImageAction = document.getElementById('menu-share-image-action');

        const filterPopup = document.getElementById('filter-popup');
        const filterModelsSection = document.getElementById('filter-models-section');
        const filterOptionsCollections = document.getElementById('filter-options-collections');
        const filterOptionsModels = document.getElementById('filter-options-models');
        const filterOptionsBackdrops = document.getElementById('filter-options-backdrops');
        const filterOptionsPatterns = document.getElementById('filter-options-patterns');
        const applyFiltersButton = document.getElementById('apply-filters-button');
        const clearFiltersButton = document.getElementById('clear-filters-button');

        const settingsModal = document.getElementById('settings-modal');
        const animationToggle = document.getElementById('animation-toggle');
        const customGiftsToggle = document.getElementById('custom-gifts-toggle');
        const showHiddenToggle = document.getElementById('show-hidden-toggle');
        const hideMultipleButton = document.getElementById('hide-multiple-button');
        const transferMultipleButton = document.getElementById('transfer-multiple-button');
        const clearCurrentAccountDataButton = document.getElementById('clear-current-account-data-button');
        const clearAllAccountsDataButton = document.getElementById('clear-all-accounts-data-button');

        const customBuyModal = document.getElementById('custom-buy-modal');
        const giftQueueContainer = document.getElementById('gift-queue-container');
        const giftConfigArea = document.getElementById('gift-config-area');
        const customBuyModelsSection = document.getElementById('custom-buy-models-section');
        const customBuyModelsGrid = document.getElementById('custom-buy-models-grid');
        const customBuyBackdropsSection = document.getElementById('custom-buy-backdrops-section');
        const customBuyBackdropsGrid = document.getElementById('custom-buy-backdrops-grid');
        const customBuyPatternsSection = document.getElementById('custom-buy-patterns-section');
        const customBuyPatternsGrid = document.getElementById('custom-buy-patterns-grid');
        const addAnotherGiftButton = document.getElementById('add-another-gift-button');
        const advancedSettingsContainer = document.getElementById('advanced-settings-container');
        const customBuyQuantityInput = document.getElementById('custom-buy-quantity');
        const cloneUrlInput = document.getElementById('clone-url-input');
        const customBuyConfirmButton = document.getElementById('custom-buy-confirm-button');
        const customBuyCancelButton = document.getElementById('custom-buy-cancel-button');

        const generatedImageModal = document.getElementById('generated-image-modal');
        const generatedImageFooter = document.getElementById('generated-image-footer');
        const generatedImagePreview = document.getElementById('generated-image-preview');
        const generatedImageMessage = document.getElementById('generated-image-message');
        const sendGeneratedImageButton = document.getElementById('send-generated-image-button');
        const closeGeneratedImageModalButton = document.getElementById('close-generated-image-modal');

        const chancesModal = document.getElementById('chances-modal');
        const chancesGiftName = document.getElementById('chances-gift-name');
        const chancesLoadingSpinner = document.getElementById('chances-loading-spinner');
        const chancesProbabilityDisplay = document.getElementById('chances-probability-display');
        const chancesModelsSection = document.getElementById('chances-models-section');
        const chancesOptionsModels = document.getElementById('chances-options-models');
        const chancesBackdropsSection = document.getElementById('chances-backdrops-section');
        const chancesOptionsBackdrops = document.getElementById('chances-options-backdrops');
        const chancesPatternsSection = document.getElementById('chances-patterns-section');
        const chancesOptionsPatterns = document.getElementById('chances-options-patterns');
        const closeChancesModalButton = document.getElementById('close-chances-modal');

        const sellGiftModal = document.getElementById('sell-gift-modal');
        const sellGiftImage = document.getElementById('sell-gift-image');
        const sellGiftName = document.getElementById('sell-gift-name');
        const sellPriceInput = document.getElementById('sell-price-input');
        const sellReceiveAmount = document.getElementById('sell-receive-amount');
        const sellUsdAmount = document.getElementById('sell-usd-amount');
        const confirmSellButton = document.getElementById('confirm-sell-button');
        const cancelSellButton = document.getElementById('cancel-sell-button');

        const transferGiftModal = document.getElementById('transfer-gift-modal');
        const transferModalTitle = document.getElementById('transfer-modal-title');
        const transferGiftImage = document.getElementById('transfer-gift-image');
        const transferGiftName = document.getElementById('transfer-gift-name');
        const transferUsernameInput = document.getElementById('transfer-username-input');
        const transferCommentInput = document.getElementById('transfer-comment-input');
        const transferStatusMessage = document.getElementById('transfer-status-message');
        const confirmTransferButton = document.getElementById('confirm-transfer-button');
        const cancelTransferButton = document.getElementById('cancel-transfer-button');

        const collectionPriceModal = document.getElementById('collection-price-modal');
        const collectionPriceSpinner = document.getElementById('collection-price-spinner');
        const collectionPriceTotal = document.getElementById('collection-price-total');
        const collectionPriceInfo = document.getElementById('collection-price-info');
        const collectionPriceList = document.getElementById('collection-price-list');
        const closeCollectionPriceModal = document.getElementById('close-collection-price-modal');
        
        const numbersModal = document.getElementById('numbers-modal');
        const numbersList = document.getElementById('numbers-list');

        const usernamesModal = document.getElementById('usernames-modal');
        const usernameSearchInput = document.getElementById('username-search-input');
        const usernamesList = document.getElementById('usernames-list');

        const giveawaySetupModal = document.getElementById('giveaway-setup-modal');
        const giveawayGiftSelectionGrid = document.getElementById('giveaway-gift-selection-grid');
        const giveawayChannelsInput = document.getElementById('giveaway-channels-input');
        const confirmGiveawaySetupButton = document.getElementById('confirm-giveaway-setup');
        
        const newPostModal = document.getElementById('new-post-modal');
        const newPostContent = document.getElementById('new-post-content');
        const submitNewPostButton = document.getElementById('submit-new-post-button');

        let moveModeActive = false;
        let longPressAvatarTimer;
        const exitMoveModeButton = document.createElement('button');
        exitMoveModeButton.id = 'exit-move-mode-button';
        exitMoveModeButton.className = 'action-button hidden';
        exitMoveModeButton.textContent = 'Done Organizing';
        profileGiftsActions.prepend(exitMoveModeButton);
        
        const exitFilterModeButton = document.createElement('button');
        exitFilterModeButton.id = 'exit-filter-mode-button';
        exitFilterModeButton.className = 'action-button hidden';
        exitFilterModeButton.textContent = 'Exit Filter Mode';
        profileGiftsActions.prepend(exitFilterModeButton);

        const exitReorderModeButton = document.createElement('button');
        exitReorderModeButton.id = 'exit-reorder-mode-button';
        exitReorderModeButton.className = 'action-button hidden';
        exitReorderModeButton.textContent = 'Done Reordering';
        profileGiftsActions.prepend(exitReorderModeButton);

        const exitSelectionModeButton = document.createElement('button');
        exitSelectionModeButton.id = 'exit-selection-mode-button';
        exitSelectionModeButton.className = 'action-button hidden';
        exitSelectionModeButton.textContent = 'Cancel';
        profileGiftsActions.prepend(exitSelectionModeButton);

        const transferSelectedGiftsButton = document.createElement('button');
        transferSelectedGiftsButton.id = 'transfer-selected-gifts-button';
        transferSelectedGiftsButton.className = 'action-button hidden';
        transferSelectedGiftsButton.textContent = 'Transfer';
        profileGiftsActions.prepend(transferSelectedGiftsButton);

        const hideSelectedGiftsButton = document.createElement('button');
        hideSelectedGiftsButton.id = 'hide-selected-gifts-button';
        hideSelectedGiftsButton.className = 'action-button hidden';
        hideSelectedGiftsButton.textContent = 'Hide';
        profileGiftsActions.prepend(hideSelectedGiftsButton);

        const coolNumbers = ["+888 8888 8888", "+888 0000 0001", "+888 1234 5678", "+888 1111 1111", "+888 7777 7777", "+888 0707 6969", "+888 1337 1337", "+888 2024 2025", "+888 1000 0001", "+888 0808 0808"];
        const coolUsernames = ["durov", "admin", "king", "wallet", "crypto", "elon", "boss", "premium", "gift", "star", "diamond", "anonymous", "market", "bank", "news", "pessi", "penaldo", "token", "exchange", "ceo", "founder", "investor"];

        let currentGiftToBuyMultiple = null;
        let lottieIntersectionObserver;
        
        let giftCreationQueue = [];
        let currentlyEditingGiftIndex = -1;

        let cachedCollectibleParts = {};
        let lastTap = 0;
        let tapCount = 0;
        let currentGiftToSell = null;
        let currentGiftToTransfer = null;

        
        let sortableInstance = null;
        let modalSwipeState = { startX: 0, isSwiping: false };
        let selectedGiveawayGifts = new Set();

        // --- API Utility Function ---
        async function callBackend(endpoint, method = 'GET', data = null, params = {}) {
            const queryParams = new URLSearchParams(params).toString();
            const url = `${BACKEND_BASE_URL}${endpoint}${queryParams ? '?' + queryParams : ''}`;

            const options = {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: data ? JSON.stringify(data) : null,
            };

            try {
                const response = await fetch(url, options);
                const responseData = await response.json().catch(() => ({}));

                if (!response.ok) {
                    throw { 
                        status: response.status, 
                        message: responseData.error || response.statusText || 'Unknown error',
                        reason: responseData.reason 
                    };
                }
                return response.status === 204 ? null : responseData;
            } catch (error) {
                console.error(`Backend API call failed: ${endpoint}`, error);
                if (error.status !== 403) { // Don't show generic alert for permission errors handled elsewhere
                    tg.showAlert(`Error: ${error.message}`);
                }
                throw error;
            }
        }

        async function handleProfileNameTap() {
            if (!viewingOwnProfile) return;

            const now = Date.now();
            const DURATION = 1000; // 1 second between taps to count

            if (now - lastProfileNameTap > DURATION) {
                profileNameTapCount = 1;
            } else {
                profileNameTapCount++;
            }
            lastProfileNameTap = now;

            if (profileNameTapCount === 10) {
                profileNameTapCount = 0; // Reset counter
                tg.HapticFeedback.notificationOccurred('success');
                try {
                    await callBackend('/api/request_test_env', 'POST', {
                        tg_id: currentAccountTgId
                    });
                    tg.showAlert("Check your chat with the bot for the test environment link.");
                } catch (error) {
                    console.error("Failed to request test env link:", error);
                    // Error alert is handled by callBackend
                }
            } else if (profileNameTapCount > 5) {
                // Give user feedback that something is happening
                tg.HapticFeedback.impactOccurred('light');
            }
        }
        
        const LEVEL_THRESHOLDS = [
            { level: 1, min: 0, max: 20 },
            { level: 2, min: 20, max: 50 },
            { level: 3, min: 50, max: 100 },
            { level: 4, min: 100, max: 200 },
            { level: 5, min: 200, max: 300 },
            { level: 6, min: 300, max: 400 },
            { level: 7, min: 400, max: 500 },
            { level: 8, min: 500, max: 600 },
            { level: 9, min: 600, max: 700 },
            { level: 10, min: 700, max: 800 },
            { level: 11, min: 800, max: 900 },
            { level: 12, min: 900, max: 1000 },
            // Add more levels as needed, following the pattern
        ];
        for (let i = 1; i < 10; i++) {
            LEVEL_THRESHOLDS.push({level: 12 + i, min: i * 1000, max: (i + 1) * 1000});
        }
        // You can continue this pattern up to level 100
        
        const PINNED_GIFT_POSITIONS = [
            // These coordinates are manually adjusted to match your image exactly
            { top: '22%', left: '30%' },  // Position 1
            { top: '45%', left: '15%' },  // Position 2
            { top: '75%', left: '33%' },  // Position 3
            { top: '22%', left: '70%' },  // Position 4
            { top: '45%', left: '85%' },  // Position 5
            { top: '75%', left: '67%' },  // Position 6
        ];
        
        function calculateUserLevel(giftCount) {
            for (let i = LEVEL_THRESHOLDS.length - 1; i >= 0; i--) {
                if (giftCount >= LEVEL_THRESHOLDS[i].min) {
                    return LEVEL_THRESHOLDS[i];
                }
            }
            return LEVEL_THRESHOLDS[0];
        }
        
        // --- START: Replace this entire function ---
        function showLevelInfoPopup() {
            const levelModal = document.getElementById('level-info-modal');
            const giftCountEl = document.getElementById('level-modal-gift-count');
            const levelListEl = document.getElementById('level-modal-list');
        
            const totalGiftCount = ownedGifts.length; // Includes hidden gifts
            const currentLevelData = calculateUserLevel(totalGiftCount);
            const currentIndex = LEVEL_THRESHOLDS.findIndex(l => l.level === currentLevelData.level);
        
            giftCountEl.textContent = `You have ${totalGiftCount.toLocaleString()} gifts!`;
            levelListEl.innerHTML = ''; // Clear previous content
        
            const createLevelRow = (levelData, isCurrent = false) => {
                const li = document.createElement('li');
                if (isCurrent) {
                    li.className = 'current-level';
                }
                const levelName = isCurrent ? `Your Level ${levelData.level}` : `Level ${levelData.level}`;
                const giftRange = `${levelData.min.toLocaleString()}-${levelData.max.toLocaleString()} gifts`;
                li.innerHTML = `<span>${levelName}</span><span>${giftRange}</span>`;
                levelListEl.appendChild(li);
            };
        
            // Previous Level
            if (currentIndex > 0) {
                createLevelRow(LEVEL_THRESHOLDS[currentIndex - 1]);
            }
        
            // Current Level
            createLevelRow(currentLevelData, true);
        
            // Next Level
            if (currentIndex < LEVEL_THRESHOLDS.length - 1) {
                createLevelRow(LEVEL_THRESHOLDS[currentIndex + 1]);
            }
            
            openModal(levelModal);
        }
        // --- END: Function replacement ---
        
        function getRandomElement(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
        function generateUniqueId() { return `${Date.now().toString(36)}-${Math.random().toString(36).substring(2, 9)}`; }

        function formatRarity(permille) {
            if (!permille) return 'N/A';
            const percentage = permille / 10;
            const oneInX = Math.round(1000 / permille); // Correct calculation
            return `${percentage.toFixed(1)}% <span class="one-in-x">(1 of ${oneInX.toLocaleString('en-US')})</span>`;
        }

        function playLottieAnimation(container, path, loop = true, isGridItem = false) {
            if (!animationsEnabled) {
                destroyLottieAnimation(container);
                const parentCard = container.closest('.gift-card, .buy-gift-item, .modal-collectible-visual');
                if (parentCard) {
                    const staticFallback = parentCard.querySelector('.static-image-fallback');
                    if(staticFallback) staticFallback.style.display = 'block';
                    container.style.display = 'none';
                }
                return;
            }
            if (!container || !path) return;
            if (container.lottieInstance) { container.lottieInstance.destroy(); delete container.lottieInstance; }
            container.innerHTML = '';
            const anim = bodymovin.loadAnimation({ container: container, path: path, renderer: 'svg', loop: loop, autoplay: true });
            container.lottieInstance = anim;
            if (isGridItem && !loop) {
                anim.addEventListener('complete', () => { if (container.lottieInstance === anim) container.dataset.playedOnce = 'true'; });
            }
        }
        function destroyLottieAnimation(container) {
            if (container && container.lottieInstance) {
                container.lottieInstance.destroy();
                delete container.lottieInstance; delete container.dataset.playedOnce; container.innerHTML = '';
            }
        }
        function handleLottieIntersection(entries, observer) {
            entries.forEach(entry => {
                const cardElement = entry.target;
                const lottieContainer = cardElement.querySelector('.lottie-animation-container');
                const staticFallback = cardElement.querySelector('.static-image-fallback');
                const lottiePath = cardElement.dataset.lottiePath;
                if (entry.isIntersecting) {
                    if (animationsEnabled && lottiePath && lottieContainer) {
                        if(staticFallback) staticFallback.style.display = 'none';
                        lottieContainer.style.display = 'flex';
                        playLottieAnimation(lottieContainer, lottiePath, false, true);
                    }
                } else {
                    if (lottieContainer) {
                        destroyLottieAnimation(lottieContainer);
                        if(staticFallback) staticFallback.style.display = 'block';
                        lottieContainer.style.display = 'none';
                    }
                }
            });
        }
        function initLottieObserver() {
            lottieIntersectionObserver = new IntersectionObserver(handleLottieIntersection, { root: null, rootMargin: '100px', threshold: 0.01 });
        }
        function observeLottieElement(element) {
            if (lottieIntersectionObserver && element.dataset.lottiePath) lottieIntersectionObserver.observe(element);
        }
        function unobserveLottieElement(element) {
             if (lottieIntersectionObserver && element.dataset.lottiePath) {
                lottieIntersectionObserver.unobserve(element);
                const lottieContainer = element.querySelector('.lottie-animation-container');
                if(lottieContainer) destroyLottieAnimation(lottieContainer);
            }
        }
        function renderProfileHeaderPatterns(patternUrl) {
            const container = document.getElementById('profile-header-pattern-overlay');
            container.innerHTML = ''; // Clear previous patterns
        
            if (!patternUrl) {
                return; // No pattern to render
            }
        
            setTimeout(() => {
                const avatarElement = document.getElementById('profile-avatar');
                if (!container || !avatarElement) return;
        
                const containerRect = container.getBoundingClientRect();
                const avatarRect = avatarElement.getBoundingClientRect();
        
                const centerX = (avatarRect.left - containerRect.left) + (avatarRect.width / 2);
                const centerY = (avatarRect.top - containerRect.top) + (avatarRect.height / 2);
        
                const circles = [
                    { count: 8, radius: 100, size: 40 }, // Inner circle
                    { count: 10, radius: 150, size: 36 }  // Outer circle
                ];
        
                circles.forEach(circleConfig => {
                    for (let i = 0; i < circleConfig.count; i++) {
                        const angle = (i / circleConfig.count) * 2 * Math.PI;
                        // REMOVED: The random offset that caused overlapping visuals
                        const radius = circleConfig.radius; 
                        const x = centerX + radius * Math.cos(angle);
                        const y = centerY + radius * Math.sin(angle);
        
                        const patternEl = document.createElement('img');
                        patternEl.src = patternUrl;
                        patternEl.className = 'header-pattern-item';
                        patternEl.style.width = `${circleConfig.size}px`;
                        patternEl.style.height = `${circleConfig.size}px`;
                        patternEl.style.left = `${x}px`;
                        patternEl.style.top = `${y}px`;
                        
                        const randomRotation = Math.random() * 90 - 45;
                        patternEl.style.transform = `translate(-50%, -50%) rotate(${randomRotation}deg) scale(0)`;
                        patternEl.style.transitionDelay = `${i * 0.03}s`;
        
                        container.appendChild(patternEl);
        
                        requestAnimationFrame(() => {
                            patternEl.style.transform = `translate(-50%, -50%) rotate(${randomRotation}deg) scale(1)`;
                        });
                    }
                });
            }, 50);
        }
        async function fetchLimitedGiftStock() {
            try {
                limitedGiftStock = await callBackend('/api/gifts/stock');
            } catch (error) {
                console.error("Could not fetch limited gift stock:", error);
                limitedGiftStock = {};
            }
        }
        async function initApp() {
            tg.ready();
            tg.expand();
            initLottieObserver();
        
            if (localStorage.getItem('fullscreenEnabled' + APP_VERSION_SUFFIX) === 'true') {
                Telegram.WebApp.requestFullscreen();
                document.getElementById('fullscreen-toggle').checked = true;
            }
        
            playLottieAnimation(
                document.getElementById('loading-animation-container'),
                'https://cdn.changes.tg/gifts/models/Spring%20Basket/lottie/Ritual%20Goat.json'
            );
            
            // The problematic lines that set the old SVG icons have been REMOVED from here.
            // This allows the populateCollectibleDetailModal function to correctly set the new PNG images.
            
            collectibleMenuButton.innerHTML = MENU_DOTS_SVG;
        
            const giveawayBtnIconContainer = document.getElementById('giveaway-btn-icon-container');
            if (giveawayBtnIconContainer) {
                giveawayBtnIconContainer.innerHTML = `<img src="${GIVEAWAY_BUTTON_IMG}" alt="Giveaway Icon">`;
            }
        
            loadClientSideState();
        
            const startAppParam = tg.initDataUnsafe?.start_param;
            if (startAppParam) {
                await initializeTelegramUserAccount(); // Always init own account first
                if (startAppParam.startsWith('user')) {
                    const collectibleIdentifier = startAppParam.substring(4);
                    // Check for @username or +888... number format
                    if (collectibleIdentifier.startsWith('@') || collectibleIdentifier.startsWith('+')) {
                        try {
                            const response = await callBackend(`/api/profile_by_collectible/${encodeURIComponent(collectibleIdentifier)}`);
                            if (response.username) {
                                await displayUserProfile(response.username);
                            } else {
                                tg.showAlert(`Could not find a profile for ${collectibleIdentifier}.`);
                            }
                        } catch (error) {
                            tg.showAlert(`Could not find a profile for ${collectibleIdentifier}.`);
                        }
                    } else {
                        // Fallback for old username format without @
                        await displayUserProfile(collectibleIdentifier);
                    }
                } else if (startAppParam.startsWith('gift')) {
                    const giftString = startAppParam.substring(4);
                    const lastHyphenIndex = giftString.lastIndexOf('-');
                    if (lastHyphenIndex > -1) {
                        // This now correctly passes the name (e.g., "PlushPepe") instead of an ID
                        const giftIdentifier = giftString.substring(0, lastHyphenIndex);
                        const collectibleNumber = parseInt(giftString.substring(lastHyphenIndex + 1), 10);
                        if (giftIdentifier && !isNaN(collectibleNumber)) {
                            await displayDeepLinkedGift(giftIdentifier, collectibleNumber);
                        } else {
                            tg.showAlert("Invalid gift format in deep link.");
                        }
                    } else {
                        tg.showAlert("Invalid gift format in deep link.");
                    }
                }
            } else {
                await initializeTelegramUserAccount();
            }
        
            applyTheme(tg.themeParams);
            tg.onEvent('themeChanged', () => applyTheme(tg.themeParams));
            tg.SettingsButton.show();
            tg.SettingsButton.onClick(openSettingsModal);
        
            setupEventListeners();
            await fetchGiftPrices();
            await fetchLimitedGiftStock();
            await fetchAvailableGifts();
        
            document.getElementById('loading-overlay').classList.remove('active');
        }

        async function initializeTelegramUserAccount() {
            manageBackButton(false);
            viewingOwnProfile = true;
            const user = tg.initDataUnsafe?.user;
            let tg_id = user?.id;

            buyGiftsTabButton.style.display = 'flex';
            currentPublicProfileData = null; // Clear public profile data
            
            if (!tg_id) {
                let mockAccount = JSON.parse(localStorage.getItem('giftSimMockTgUser' + APP_VERSION_SUFFIX));
                if (!mockAccount) {
                    mockAccount = {
                        tg_id: Math.floor(Math.random() * 1e9) + 1,
                        username: `mockuser_${Math.random().toString(36).substring(2, 6)}`,
                        full_name: `Mock User ${Math.floor(Math.random() * 100)}`,
                        avatar_url: `https://i.pravatar.cc/140?u=mock_${generateUniqueId()}`
                    };
                    localStorage.setItem('giftSimMockTgUser' + APP_VERSION_SUFFIX, JSON.stringify(mockAccount));
                }
                tg_id = mockAccount.tg_id;
            }

            try {
                const accountData = await callBackend('/api/account', 'POST', {
                    tg_id: tg_id,
                    username: user?.username,
                    full_name: user ? [user.first_name, user.last_name].filter(Boolean).join(' ') : 'Original User Name',
                    avatar_url: user?.photo_url || `https://i.pravatar.cc/140?u=${tg_id}`
                });

                currentAccountTgId = accountData.tg_id;
                ownedGifts = accountData.owned_gifts || [];
                profilePosts = accountData.posts || [];
                customGiftsEnabled = accountData.custom_gifts_enabled || false;
                currentAccountUsername = accountData.username;

                let existingAccount = accounts.find(acc => acc.tg_id === currentAccountTgId);
                if (existingAccount) {
                    Object.assign(existingAccount, accountData);
                } else {
                    accounts.push(accountData);
                }
                saveClientSideAccounts();
                renderAll();
                console.log("Account data loaded successfully.");
            } catch (error) {
                console.error("Failed to initializeTelegramUserAccount:", error);
            }
        }

        async function displayDeepLinkedGift(giftTypeId, collectibleNumber) {
            try {
                // The URL now uses the generic 'gift_identifier' which can be a name or ID
                const giftData = await callBackend(`/api/gift/${giftIdentifier}/${collectibleNumber}`, 'GET', null, { viewer_id: currentAccountTgId });
                if (giftData) {
                    openModal(collectibleDetailModal, giftData);
                }
            } catch (error) {
                if (error.reason === 'custom_content_disabled') {
                    tg.showAlert("Sorry, you cannot see this gift.");
                }
                console.error("Error fetching deep-linked gift:", error);
            }
        }

        async function displayUserProfile(username) {
             const ownAccount = accounts.find(acc => acc.tg_id === currentAccountTgId);
             if (ownAccount && ownAccount.username && ownAccount.username.toLowerCase() === username.toLowerCase()) {
                 await initializeTelegramUserAccount();
                 return;
             }
        
             viewingOwnProfile = false;
             try {
                const profileData = await callBackend(`/api/profile/${username}`, 'GET', null, { viewer_id: currentAccountTgId });
                ownedGifts = profileData.owned_gifts || [];
                profilePosts = profileData.posts || [];
        
                profileName.textContent = profileData.full_name || 'User';
                profileAvatar.src = profileData.avatar_url || '';
                profileAvatar.onerror = () => { profileAvatar.src = `https://i.pravatar.cc/140?u=fallback${generateUniqueId()}`; };
                profileUsername.textContent = profileData.username ? `@${profileData.username}` : 'no username';
                profileUsername.onclick = null;
                profileBio.textContent = profileData.bio || "No bio yet";
                profilePhone.textContent = profileData.phone_number || "Not specified";
                document.getElementById('profile-edit-btn').classList.add('hidden');
                buyGiftsTabButton.style.display = 'none'; // Hide buy gifts button
        
                collectibleUsernamesContainer.innerHTML = '';
                if (profileData.collectible_usernames && profileData.collectible_usernames.length > 0) {
                    const alsoSpan = document.createElement('span'); alsoSpan.className = 'also-text'; alsoSpan.textContent = 'also';
                    collectibleUsernamesContainer.appendChild(alsoSpan);
                    profileData.collectible_usernames.forEach(uname => {
                        const unameSpan = document.createElement('span'); unameSpan.className = 'collectible-username-span'; unameSpan.textContent = `@${uname}`;
                        collectibleUsernamesContainer.appendChild(unameSpan);
                    });
                }

                // --- START: Add this new code block ---
                const musicStatusContainer = document.getElementById('profile-music-status');
                const musicText = document.getElementById('profile-music-text');
                if (profileData.music_status) {
                    // If the user being viewed has a music status, show it.
                    musicText.textContent = profileData.music_status;
                    musicStatusContainer.classList.remove('hidden');
                } else {
                    // This is the crucial part: if they have no music, HIDE the container.
                    musicStatusContainer.classList.add('hidden');
                }
                // --- END: Add this new code block ---
        
                manageBackButton(true, () => initializeTelegramUserAccount());
        
                profileBio.style.cursor = 'default';
                profileBio.onclick = null;
                profileAvatar.style.cursor = 'default';
        
                renderAll();
            } catch (error) {
                console.error("Error fetching user profile:", error);
                await initializeTelegramUserAccount();
            }
        }

        function manageBackButton(visible, onClickHandler) {
            if (visible) {
                tg.BackButton.show();
                tg.BackButton.onClick(onClickHandler);
            } else {
                tg.BackButton.hide();
                if (tg._backButtonCallback) {
                     tg.BackButton.offClick(tg._backButtonCallback);
                     delete tg._backButtonCallback;
                }
                if (onClickHandler) {
                    tg._backButtonCallback = onClickHandler;
                }
            }
        }

        function applyTheme(themeParams) {
            if (themeParams && Object.keys(themeParams).length > 0) {
                const root = document.documentElement;
                const setVar = (varName, value) => { if (value) root.style.setProperty(varName, value); };
                setVar('--tg-theme-bg-color', themeParams.bg_color);
                setVar('--tg-theme-text-color', themeParams.text_color);
                setVar('--tg-theme-hint-color', themeParams.hint_color);
                setVar('--tg-theme-link-color', themeParams.link_color);
                setVar('--tg-theme-button-color', themeParams.button_color);
                setVar('--tg-theme-button-text-color', themeParams.button_text_color);
                setVar('--tg-theme-secondary-bg-color', themeParams.secondary_bg_color);
                setVar('--tg-theme-accent-blue', themeParams.accent_text_color || '#5288c1');
                document.body.style.backgroundColor = themeParams.bg_color || 'var(--tg-theme-bg-color)';
                document.body.style.color = themeParams.text_color || 'var(--tg-theme-text-color)';
                if (upgradeAllGiftsButton) upgradeAllGiftsButton.style.backgroundColor = themeParams.accent_text_color || 'var(--tg-theme-accent-blue)';
                if (exitFilterModeButton) exitFilterModeButton.style.backgroundColor = themeParams.accent_text_color || 'var(--tg-theme-accent-blue)';
                if (exitReorderModeButton) exitReorderModeButton.style.backgroundColor = themeParams.accent_text_color || 'var(--tg-theme-accent-blue)';
                applyWornGiftStyles();
            } else console.log("Using default CSS variables as themeParams are empty.");
        }

        function loadUserData() {
            const account = accounts.find(acc => acc.tg_id === currentAccountTgId);
            if (!account) return;
        
            profileName.textContent = account.full_name || 'User';
            profileAvatar.src = account.avatar_url || '';
            profileAvatar.onerror = () => { profileAvatar.src = `https://i.pravatar.cc/140?u=fallback${generateUniqueId()}`; };
            profileUsername.textContent = account.username ? `@${account.username}` : 'no username';
            profileUsername.onclick = () => { if(account.username) displayUserProfile(account.username); };
            profileBio.textContent = account.bio || "No bio yet";
            profilePhone.textContent = account.phone_number || "Not specified";
            profileBio.style.cursor = 'pointer';
            profileAvatar.style.cursor = 'pointer';
            
            document.getElementById('profile-edit-btn').classList.remove('hidden');
            profileName.addEventListener('click', handleProfileNameTap);
        
            collectibleUsernamesContainer.innerHTML = '';
            if (account.collectible_usernames && account.collectible_usernames.length > 0) {
                const alsoSpan = document.createElement('span');
                alsoSpan.className = 'also-text';
                alsoSpan.textContent = 'also';
                collectibleUsernamesContainer.appendChild(alsoSpan);
        
                account.collectible_usernames.forEach(uname => {
                    const unameSpan = document.createElement('span');
                    unameSpan.className = 'collectible-username-span';
                    unameSpan.textContent = `@${uname}`;
                    unameSpan.dataset.username = uname;
                    unameSpan.addEventListener('click', () => displayUserProfile(uname));
                    unameSpan.addEventListener('contextmenu', (e) => {
                        e.preventDefault();
                        handleDeleteCollectibleUsername(uname);
                    });
        
                    collectibleUsernamesContainer.appendChild(unameSpan);
                });
            }

            const musicStatusContainer = document.getElementById('profile-music-status');
            const musicText = document.getElementById('profile-music-text');
            if (account.music_status) {
                musicText.textContent = account.music_status;
                musicStatusContainer.classList.remove('hidden');
            } else {
                musicStatusContainer.classList.add('hidden');
            }
            
            sidebarCurrentAvatar.src = account.avatar_url;
            sidebarCurrentName.textContent = account.full_name;
        }

        // --- Account Management ---
        function loadClientSideState() {
            animationsEnabled = JSON.parse(localStorage.getItem('animationsEnabled' + APP_VERSION_SUFFIX)) ?? true;
            showHiddenGifts = JSON.parse(localStorage.getItem('showHiddenGifts' + APP_VERSION_SUFFIX)) ?? false;
            activeFilters = JSON.parse(localStorage.getItem('activeFilters' + APP_VERSION_SUFFIX)) || { collection: null, model: null, backdrop: null, pattern: null };
            accounts = JSON.parse(localStorage.getItem('giftSimAccounts' + APP_VERSION_SUFFIX)) || [];
            currentAccountTgId = localStorage.getItem('giftSimCurrentAccountTgId' + APP_VERSION_SUFFIX);
        }

        function saveClientSideState() {
            localStorage.setItem('activeFilters' + APP_VERSION_SUFFIX, JSON.stringify(activeFilters));
            localStorage.setItem('animationsEnabled' + APP_VERSION_SUFFIX, JSON.stringify(animationsEnabled));
            localStorage.setItem('showHiddenGifts' + APP_VERSION_SUFFIX, JSON.stringify(showHiddenGifts));
        }

        function saveClientSideAccounts() {
            try {
                const accountsToStore = accounts.map(acc => ({
                    tg_id: acc.tg_id,
                    username: acc.username,
                    full_name: acc.full_name,
                    avatar_url: acc.avatar_url
                }));
                localStorage.setItem('giftSimAccounts' + APP_VERSION_SUFFIX, JSON.stringify(accountsToStore));
                localStorage.setItem('giftSimCurrentAccountTgId' + APP_VERSION_SUFFIX, currentAccountTgId);
            } catch (e) {
                console.error("Error saving client side accounts:", e);
                if (e.name === 'QuotaExceededError') {
                    tg.showAlert("A storage error occurred. Please clear your browser cache or app data if the problem persists.");
                }
            }
        }

        // --- START UPDATE: Move Mode Functions ---
        function enterMoveMode() {
            closeModal(settingsModal);
            if (!viewingOwnProfile) return;
        
            moveModeActive = true;
            exitMoveModeButton.classList.remove('hidden');
            updateActionToolbarVisibility(); // This will show the actions wrapper
            giftsGrid.classList.add('moving');
            renderProfileGifts(); // Re-render to apply new classes and listeners
        }
        
        function exitMoveMode() {
            moveModeActive = false;
            exitMoveModeButton.classList.add('hidden');
            updateActionToolbarVisibility();
            giftsGrid.classList.remove('moving');
            renderProfileGifts(); // Re-render to restore normal state
        }
        
        async function handleMoveGiftTap(instanceId) {
            const giftToMove = ownedGifts.find(g => g.instance_id === instanceId);
            if (!giftToMove || giftToMove.is_pinned) return;
        
            const cardElement = giftsGrid.querySelector(`.gift-card[data-instance-id="${instanceId}"]`);
            if (cardElement) cardElement.classList.add('is-updating');
            tg.HapticFeedback.impactOccurred('light');
        
            try {
                // Optimistic UI update
                const newAcquiredDate = new Date().toISOString();
                giftToMove.acquired_date = newAcquiredDate;
                
                // Re-sort and re-render the unpinned gifts
                renderProfileGifts();
        
                // Send update to the backend
                await callBackend(`/api/gifts/${instanceId}`, 'PUT', {
                    action: 'bump',
                    value: newAcquiredDate // Send the new date to ensure consistency
                });
        
            } catch (error) {
                // On failure, revert by re-fetching all data
                tg.HapticFeedback.notificationOccurred('error');
                await initializeTelegramUserAccount();
            } finally {
                if (cardElement) cardElement.classList.remove('is-updating');
            }
        }
        // --- END UPDATE: Move Mode Functions ---
        
        async function handleAddAccount() {
            const newTgId = Math.floor(Math.random() * 1e12) + 1;
            const newAccountData = {
                tg_id: newTgId,
                username: `testuser_${Math.random().toString(36).substring(2, 8)}`,
                full_name: `Test User ${accounts.length + 1}`,
                avatar_url: `https://i.pravatar.cc/140?u=${newTgId}`
            };

            try {
                const createdAccount = await callBackend('/api/account', 'POST', newAccountData);
                accounts.push(createdAccount);
                await switchAccount(createdAccount.tg_id);
                closeSidebar();
            } catch (error) {
                console.error(error);
            }
        }

        async function switchAccount(tgId) {
            if (currentAccountTgId === tgId) return;
            currentAccountTgId = tgId;
            saveClientSideAccounts();
            await initializeTelegramUserAccount();
        }

        function renderAll() {
            if (viewingOwnProfile) {
                loadUserData();
            }
            renderAccountsList();
            animationToggle.checked = animationsEnabled;
            showHiddenToggle.checked = showHiddenGifts;
            customGiftsToggle.checked = customGiftsEnabled;
            applyWornGiftStyles();
            renderProfileGifts();
            renderPosts();
        }

        function renderAccountsList() {
            accountsList.innerHTML = '';
            accounts.forEach(acc => {
                const li = document.createElement('li');
                li.dataset.accountId = acc.tg_id;
                li.innerHTML = `<img src="${acc.avatar_url}" alt="Avatar"> <span>${acc.full_name}</span>`;
                if (acc.tg_id === currentAccountTgId) {
                    li.classList.add('active');
                }
                li.addEventListener('click', async () => {
                    if (acc.tg_id !== currentAccountTgId) {
                        await switchAccount(acc.tg_id);
                    }
                    closeSidebar();
                });
                accountsList.appendChild(li);
            });
        }

        function openSidebar() {
            manageBackButton(true, closeSidebar);
            renderAccountsList();
            accountSidebar.classList.add('active');
            sidebarOverlay.classList.add('active');
        }

        function closeSidebar() {
            manageBackButton(false);
            accountSidebar.classList.remove('active');
            sidebarOverlay.classList.remove('active');
        }

        function openStarsPopup() {
            closeSidebar();
            const currentAccount = accounts.find(acc => acc.tg_id === currentAccountTgId);
            if (currentAccount) {
                document.getElementById('stars-balance-amount').textContent = parseFloat(currentAccount.stars_balance || 0).toLocaleString();
            }
            openModal(document.getElementById('stars-modal'));
        }
        
        function openTopUpModal() {
            const level = calculateUserLevel(ownedGifts.length).level;
            // You would have the full table here
            const maxBuy = [0, 10, 50, 100, 500, 1000, 5000, 10000, 15000, 20000, 30000, 40000, 50000][level] || 50000;
            
            document.getElementById('topup-level-info').textContent = `Your Level: ${level}. Maximum top up: ${maxBuy.toLocaleString()} Stars.`;
            document.getElementById('topup-amount-input').value = '';
            document.getElementById('confirm-topup-button').disabled = true;
            
            closeModal(document.getElementById('stars-modal'));
            openModal(document.getElementById('topup-modal'));
        }
        
        async function handleSimulateTopUp() {
            const amountInput = document.getElementById('topup-amount-input');
            const amount = parseInt(amountInput.value, 10);
            if (isNaN(amount) || amount <= 0) {
                tg.showAlert("Please enter a valid positive amount.");
                return;
            }
            
            const confirmBtn = document.getElementById('confirm-topup-button');
            confirmBtn.disabled = true;
            confirmBtn.textContent = "Processing...";
        
            try {
                const response = await callBackend('/api/stars/topup', 'POST', {
                    user_id: currentAccountTgId,
                    amount: amount
                });
                const currentAccount = accounts.find(acc => acc.tg_id === currentAccountTgId);
                if (currentAccount) {
                    currentAccount.stars_balance = response.new_balance;
                }
                tg.HapticFeedback.notificationOccurred('success');
                closeModal(document.getElementById('topup-modal'));
            } catch (error) {
                // Error is handled by callBackend
            } finally {
                confirmBtn.disabled = false;
                confirmBtn.textContent = "Confirm Top Up";
            }
        }
        
        function applyWornGiftStyles() {
            const wornGift = ownedGifts.find(g => g.is_worn === true);
        
            destroyLottieAnimation(wornGiftIconContainer);
            
            // Clear the old repeating background style just in case
            const patternOverlay = document.getElementById('profile-header-pattern-overlay');
            patternOverlay.style.backgroundImage = 'none';
        
            if (wornGift && wornGift.is_collectible && wornGift.collectible_data) {
                const cd = wornGift.collectible_data;
                if (animationsEnabled && cd.lottieModelPath) {
                    playLottieAnimation(wornGiftIconContainer, cd.lottieModelPath, true);
                } else if (cd.modelImage) {
                    wornGiftIconContainer.innerHTML = `<img src="${cd.modelImage}" style="width:100%; height:100%; object-fit:contain;">`;
                }
                wornGiftIconContainer.classList.remove('hidden');
                
                const colors = cd.backdropColors;
                if (colors) {
                    profileTopSection.style.background = `radial-gradient(circle at 50% 0%, ${colors.centerColor} 0%, ${colors.edgeColor} 100%)`;
                } else {
                    profileTopSection.style.background = 'var(--app-profile-gradient-fallback)';
                }
                
                // **REPLACED LOGIC**: Call the new function to render circular patterns
                renderProfileHeaderPatterns(cd.patternImage || null);
        
            } else {
                wornGiftIconContainer.classList.add('hidden');
                wornGiftIconContainer.innerHTML = '';
                profileTopSection.style.background = 'var(--app-profile-gradient-fallback)';
                
                // **REPLACED LOGIC**: Clear any existing patterns if no gift is worn
                renderProfileHeaderPatterns(null);
            }
        }

        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            
            // Clear selection/reorder modes when changing pages
            if (selectionModeActive) exitSelectionMode();
            if (reorderModeActive) exitReorderMode();
        
            if (pageId === 'buy-gifts-page') {
                renderAvailableGifts();
                manageBackButton(true, () => showPage('profile-page'));
            } else if (pageId === 'market-summary-page') {
                manageBackButton(true, () => showPage('profile-page'));
            } else if (pageId === 'market-listings-page') {
                manageBackButton(true, () => showPage('market-summary-page'));
            } else {
                // Default back button behavior (hides it)
                manageBackButton(false);
            }
        }

        async function fetchGiftPrices() {
            try {
                const response = await fetch(PRICES_JSON_URL, { cache: 'no-cache' });
                if (!response.ok) throw new Error(`HTTP error ${response.status}`);
                giftPrices = await response.json();
            } catch (error) {
                console.error("Could not fetch gift prices:", error);
                giftPrices = {};
            }
        }

        async function fetchAvailableGifts() {
            buyGiftsLoadingSpinner.classList.remove('hidden');
            buyGiftsGrid.innerHTML = '';
            try {
                const response = await fetch(GIFTS_JSON_URL, { cache: 'no-cache' });
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                allAvailableGifts = await response.json();

                for (const giftName in CUSTOM_GIFTS_DATA) {
                    const customGift = CUSTOM_GIFTS_DATA[giftName];
                    if (customGift && customGift.id) {
                        allAvailableGifts[customGift.id] = giftName;
                    }
                }

                populateFilterOptions();
            } catch (error) {
                console.error("Could not load available gifts:", error);
                buyGiftsGrid.innerHTML = `<p class="empty-grid-message" style="width:100%;">Could not load gifts. Please try again later.</p>`;
            } finally {
                buyGiftsLoadingSpinner.classList.add('hidden');
            }
        }

        function renderAvailableGifts() {
            buyGiftsGrid.innerHTML = '';
            let giftsToRender = { ...allAvailableGifts };
        
            if (!customGiftsEnabled) {
                giftsToRender = Object.fromEntries(
                    Object.entries(allAvailableGifts).filter(([id, name]) => !CUSTOM_GIFTS_DATA[name])
                );
            }
        
            if (Object.keys(giftsToRender).length === 0) {
                buyGiftsGrid.innerHTML = `<p class="empty-grid-message" style="width:100%;">No gifts available right now.</p>`;
                return;
            }
        
            for (const id in giftsToRender) {
                const name = giftsToRender[id];
                const customGiftData = CUSTOM_GIFTS_DATA[name];
                let originalImageUrl, lottiePath;
        
                if (customGiftData) {
                    originalImageUrl = customGiftData.defaultImage;
                    lottiePath = null;
                } else {
                    originalImageUrl = `${CDN_BASE_URL}originals/${id}/Original.png`;
                    lottiePath = `${CDN_BASE_URL}originals/${id}/Original.json`;
                }
        
                // --- NEW/UPDATED LOGIC for stock ---
                const isLimited = customGiftData && customGiftData.limit;
                const stockInfo = isLimited ? limitedGiftStock[id] : null;
                const isSoldOut = isLimited && stockInfo && stockInfo.remaining <= 0;
        
                let availabilityLabel = '<div class="limited-label">Limited</div>';
                if (isLimited) {
                    if (isSoldOut) {
                        availabilityLabel = '<div class="limited-label" style="background-color: var(--app-wall-demonic-red);">Sold Out</div>';
                    } else if (stockInfo) {
                        availabilityLabel = `<div class="limited-label" style="background-color: var(--tg-theme-accent-blue);">${stockInfo.remaining} of ${stockInfo.total} left</div>`;
                    }
                }
                // --- END OF UPDATE ---
        
                const price = giftPrices[name];
                const item = document.createElement('div');
                item.className = 'buy-gift-item';
                item.dataset.id = id; item.dataset.name = name;
                item.dataset.originalImage = originalImageUrl;
                if (lottiePath) item.dataset.lottiePath = lottiePath;
        
                const priceHTML = price
                    ? `<div class="gift-price has-price"><img src="${STAR_ICON_URL}" class="star-icon" alt="Star"/> ${price}</div>`
                    : `<div class="gift-price">Free</div>`;
        
                item.innerHTML = `
                    <div class="image-container">
                        <div class="lottie-animation-container" style="display:none;"></div>
                        <img class="static-image-fallback" src="${originalImageUrl}" alt="${name}" loading="lazy" onerror="this.style.display='none'; this.nextElementSibling.innerHTML = '🖼️';">
                    </div>
                    <div class="gift-name">${name}</div>
                    ${priceHTML}
                    ${availabilityLabel}
                `;
                
                if (isSoldOut) {
                    item.style.opacity = '0.5';
                    item.style.cursor = 'not-allowed';
                } else {
                    item.addEventListener('click', () => buyGift(id, name, originalImageUrl, lottiePath, 1));
                    let buyItemLongPressTimer;
                    item.addEventListener('touchstart', (e) => { buyItemLongPressTimer = setTimeout(() => openBuyMultipleModal(id, name, originalImageUrl, lottiePath), 700); }, { passive: true });
                    item.addEventListener('touchend', () => clearTimeout(buyItemLongPressTimer));
                    item.addEventListener('touchmove', () => clearTimeout(buyItemLongPressTimer));
                    item.addEventListener('contextmenu', (e) => { e.preventDefault(); openBuyMultipleModal(id, name, originalImageUrl, lottiePath); });
                }
                observeLottieElement(item);
                buyGiftsGrid.appendChild(item);
            }
        }

        function getGiftCountText(count) {
            return count === 1 ? `${count} gift` : `${count} gifts`;
        }

        function updateAllAnimationsState() {
            document.querySelectorAll('.lottie-animation-container').forEach(container => {
                const parentCard = container.closest('[data-lottie-path]');
                const modal = container.closest('.modal-overlay.active');

                if (animationsEnabled) {
                    if (parentCard && parentCard.offsetParent !== null) { observeLottieElement(parentCard); }
                    else if (container.id === 'worn-gift-icon-container') { applyWornGiftStyles(); }
                    else if (modal) {
                         if (container.id === 'modal-lottie-gift-original' && giftDetailModal.classList.contains('active')) {
                             const gift = ownedGifts.find(g => g.instance_id === giftDetailModal.dataset.instanceId);
                             if (gift && gift.lottie_path) playLottieAnimation(container, gift.lottie_path, true);
                         }
                         if (container.id === 'modal-lottie-collectible-model' && collectibleDetailModal.classList.contains('active')) {
                             const gift = ownedGifts.find(g => g.instance_id === collectibleDetailModal.dataset.instanceId) || currentlySortedGifts.find(g => g.instance_id === collectibleDetailModal.dataset.instanceId);
                             if (gift?.collectible_data?.lottieModelPath) playLottieAnimation(container, gift.collectible_data.lottieModelPath, true);
                         }
                    } else if (container.closest('#profile-top-pinned-gifts')) { renderTopPinnedGiftsPreview(); }
                } else {
                    destroyLottieAnimation(container);
                    if (parentCard) {
                        const staticFallback = parentCard.querySelector('.static-image-fallback');
                        if (staticFallback) staticFallback.style.display = 'block';
                        container.style.display = 'none';
                    }
                }
            });
            applyWornGiftStyles();
        }

        function renderProfileGifts() {
            Array.from(giftsGrid.children).forEach(child => unobserveLottieElement(child));
            giftsGrid.innerHTML = '';
        
            const baseGifts = showHiddenGifts ? ownedGifts : ownedGifts.filter(g => !g.is_hidden);
        
            const filteredGifts = baseGifts.filter(gift => {
                if (activeFilters.collection && gift.gift_type_id !== activeFilters.collection) return false;
                if (gift.is_collectible && gift.collectible_data) {
                    if (activeFilters.model && gift.collectible_data.model?.name !== activeFilters.model) return false;
                    if (activeFilters.backdrop && gift.collectible_data.backdrop?.name !== activeFilters.backdrop) return false;
                    if (activeFilters.pattern && gift.collectible_data.pattern?.name !== activeFilters.pattern) return false;
                } else if (activeFilters.model || activeFilters.backdrop || activeFilters.pattern) return false;
                return true;
            });
        
            // --- THIS SORTING LOGIC IS THE KEY TO "ALWAYS ON TOP" ---
            const sortedGifts = [...filteredGifts].sort((a, b) => {
                const aIsPinned = a.is_pinned;
                const bIsPinned = b.is_pinned;
        
                if (aIsPinned && !bIsPinned) return -1; // a comes first
                if (!aIsPinned && bIsPinned) return 1;  // b comes first
                if (aIsPinned && bIsPinned) {
                    // Both are pinned, sort by their pin_order
                    return (a.pin_order || 0) - (b.pin_order || 0);
                }
                // Neither is pinned, sort by acquired date (newest first)
                return new Date(b.acquired_date) - new Date(a.acquired_date);
            });
            // --- END OF SORTING LOGIC ---
        
            currentlySortedGifts = sortedGifts;
        
            const totalGiftCount = ownedGifts.length;
            const userLevel = calculateUserLevel(totalGiftCount).level;
            const levelBubble = document.getElementById('profile-level-bubble');
            if (levelBubble) {
                levelBubble.textContent = userLevel;
            }
            
            if(profileGiftCountSubtext) profileGiftCountSubtext.classList.add('hidden');
        
            if (currentlySortedGifts.length === 0) {
                giftsGrid.style.display = 'flex';
                giftsGrid.style.alignItems = 'center';
                giftsGrid.style.justifyContent = 'center';
                let emptyMessage = "You don't have any gifts yet.";
                if (ownedGifts.length > 0) {
                    emptyMessage = "No gifts match the selected filters.";
                    if (!showHiddenGifts && ownedGifts.some(g => g.is_hidden)) {
                        emptyMessage += " Some gifts might be hidden.";
                    }
                } else if (!viewingOwnProfile) {
                     emptyMessage = "This user hasn't received any gifts yet."
                }
                giftsGrid.innerHTML = `<p class="empty-grid-message" style="width:100%;">${emptyMessage}</p>`;
            } else {
                giftsGrid.style.display = 'grid';
                currentlySortedGifts.forEach(gift => {
                    const card = createGiftCardDOM(gift);
                    giftsGrid.appendChild(card);
                    observeLottieElement(card);
                });
            }
            renderTopPinnedGiftsPreview();
            renderGiftsTabPreview();
            updateActionToolbarVisibility();
        }

        // --- START REPLACEMENT: Full createGiftCardDOM function ---
        function createGiftCardDOM(gift) {
            const card = document.createElement('div');
            card.className = 'gift-card';
            card.dataset.instanceId = gift.instance_id;
            card.dataset.pinned = gift.is_pinned;
        
            if (gift.is_hidden) card.classList.add('is-hidden');
        
            // New Move Mode logic
            if (moveModeActive) {
                if (!gift.is_pinned) {
                    card.classList.add('movable');
                    card.onclick = () => handleMoveGiftTap(gift.instance_id);
                } else {
                    card.classList.add('not-movable');
                }
            }
        
            const imageContainer = document.createElement('div');
            imageContainer.className = 'image-container';
            const lottieContainer = document.createElement('div');
            lottieContainer.className = 'lottie-animation-container';
            lottieContainer.style.display = 'none';
            const staticImage = document.createElement('img');
            staticImage.className = 'static-image-fallback';
            staticImage.loading = 'lazy';
            let lottiePathForCard = null;
        
            if (gift.is_collectible && gift.collectible_data) {
                const cd = gift.collectible_data;
                staticImage.src = cd.modelImage || gift.original_image_url;
                staticImage.alt = cd.model?.name || gift.gift_name;
                lottiePathForCard = cd.lottieModelPath;
                
                if (gift.is_on_sale && gift.sale_price) {
                    card.style.overflow = 'hidden';
                    const saleLabel = document.createElement('div');
                    saleLabel.className = 'top-right-label on-sale';
                    saleLabel.textContent = 'resale';
                    card.appendChild(saleLabel);
        
                    const priceLabel = document.createElement('div');
                    priceLabel.className = 'bottom-price-label';
                    priceLabel.innerHTML = `<img src="${STAR_ICON_URL}" alt="Star"/> ${gift.sale_price.toLocaleString()}`;
                    card.appendChild(priceLabel);
                } else {
                     const labelDiv = document.createElement('div');
                     labelDiv.className = 'top-right-label';
                     if (cd.supply) {
                         const supplyNum = cd.supply;
                         labelDiv.textContent = `1 of ${supplyNum > 1000 ? `${(supplyNum / 1000).toFixed(1)}K` : supplyNum.toLocaleString()}`;
                     } else if (gift.collectible_number) {
                         labelDiv.textContent = `#${gift.collectible_number.toLocaleString()}`;
                     } else {
                         labelDiv.textContent = 'Limitless';
                     }
                     card.appendChild(labelDiv);
                }
        
                const bgDiv = document.createElement('div');
                bgDiv.className = 'gift-card-bg-pattern';
                if (cd.backdropColors) {
                    bgDiv.style.background = `radial-gradient(circle, ${cd.backdropColors.centerColor}, ${cd.backdropColors.edgeColor})`;
                } else {
                    bgDiv.style.background = 'linear-gradient(45deg, #2a3745, #17212b)';
                }
                card.appendChild(bgDiv);
        
                if (cd.patternImage) {
                    const patternContainer = document.createElement('div');
                    patternContainer.className = 'dynamic-pattern-container';
                    card.appendChild(patternContainer);
                    const patternConfig = [
                        { count: 8, radius: 38, size: 12 }, 
                        { count: 8, radius: 62, size: 10, rotationOffset: 22.5 }
                    ];
                    setTimeout(() => generateCircularPattern(patternContainer, cd.patternImage, patternConfig), 0);
                }
        
            } else {
                staticImage.src = gift.original_image_url;
                staticImage.alt = gift.gift_name;
                lottiePathForCard = gift.lottie_path;
            }
        
            if (lottiePathForCard) card.dataset.lottiePath = lottiePathForCard;
            staticImage.onerror = () => { staticImage.style.display='none'; lottieContainer.innerHTML = '🖼️'; };
            
            imageContainer.appendChild(lottieContainer);
            imageContainer.appendChild(staticImage);
            card.appendChild(imageContainer);
            
            if (gift.is_pinned && !selectionModeActive && !gift.is_on_sale) {
                const pinDiv = document.createElement('div');
                pinDiv.className = 'pin-indicator';
                pinDiv.innerHTML = PIN_ICON_SVG;
                card.appendChild(pinDiv);
            }
        
            // Main interaction logic (only applies if not in Move Mode)
            if (!moveModeActive) {
                if (selectionModeActive) {
                    const checkbox = document.createElement('div');
                    checkbox.className = 'selection-checkbox';
                    card.appendChild(checkbox);
                    if (selectedGiftIds.has(gift.instance_id)) card.classList.add('selected');
                    card.onclick = () => toggleGiftSelection(gift.instance_id);
                } else if (reorderModeActive) {
                    card.style.cursor = gift.is_pinned ? 'grab' : 'default';
                } else {
                    card.onclick = () => openGiftDetailByInstanceId(gift.instance_id);
                    if (viewingOwnProfile) setupLongPress(card, gift);
                }
            }
        
            return card;
        }
        // --- END REPLACEMENT: Full createGiftCardDOM function ---
        // --- START: Replace this entire function ---
        function renderTopPinnedGiftsPreview() {
            Array.from(profileTopPinnedGifts.children).forEach(childLottieContainer => destroyLottieAnimation(childLottieContainer));
            profileTopPinnedGifts.innerHTML = '';
        
            const pinnedGifts = ownedGifts.filter(g => g.is_pinned && !g.is_hidden)
                                          .sort((a,b) => (a.pin_order || 0) - (b.pin_order || 0));
        
            // Limit to the 6 positions you designed
            const giftsToDisplay = pinnedGifts.slice(0, 6);
            if (giftsToDisplay.length === 0) return;
        
            giftsToDisplay.forEach((gift, index) => {
                const position = PINNED_GIFT_POSITIONS[index];
                if (!position) return; // Failsafe if there are more than 6 gifts
        
                const container = document.createElement('div');
                container.className = 'pinned-gift-item';
                container.dataset.instanceId = gift.instance_id;
                container.style.top = position.top;
                container.style.left = position.left;
                container.addEventListener('click', () => openGiftDetailByInstanceId(gift.instance_id));
                
                let lottiePathForPinned = null, imageForPinned = gift.original_image_url;
                if (gift.is_collectible && gift.collectible_data) {
                    lottiePathForPinned = gift.collectible_data.lottieModelPath;
                    imageForPinned = gift.collectible_data.modelImage || gift.original_image_url;
                } else if (gift.lottie_path) {
                    lottiePathForPinned = gift.lottie_path;
                }
        
                if (animationsEnabled && lottiePathForPinned) {
                    container.classList.add('lottie-animation-container');
                    playLottieAnimation(container, lottiePathForPinned, true);
                } else {
                     container.innerHTML = `<img src="${imageForPinned}" alt="${gift.gift_name}" style="width:100%; height:100%; object-fit:contain;" onerror="this.parentElement.innerHTML = '🎁'">`;
                }
                
                profileTopPinnedGifts.appendChild(container);
           });
        }
        // --- END: Function replacement ---
        
        function renderGiftsTabPreview() {
            giftsTabPreviewContainer.innerHTML = '';
            const uniqueGiftTypes = new Set();
            const giftsToShow = [];
            
            for (const gift of currentlySortedGifts) {
                if (!uniqueGiftTypes.has(gift.gift_type_id)) {
                    uniqueGiftTypes.add(gift.gift_type_id);
                    giftsToShow.push(gift);
                }
                if (giftsToShow.length >= 3) break;
            }

            giftsToShow.forEach(gift => {
                const img = document.createElement('img');
                let imageUrl = gift.original_image_url;
                if (gift.is_collectible && gift.collectible_data) {
                    imageUrl = gift.collectible_data.modelImage || gift.original_image_url;
                }
                img.src = imageUrl;
                img.alt = gift.gift_name;
                img.onerror = () => { img.style.display = 'none'; };
                giftsTabPreviewContainer.appendChild(img);
            });
        }

        async function handleSellAction() {
            const giftInstanceId = collectibleDetailModal.dataset.instanceId;
            const gift = ownedGifts.find(g => g.instance_id === giftInstanceId);
            if (!gift) return;
        
            if (gift.is_on_sale) {
                // --- Logic to UNLIST the gift ---
                tg.showConfirm("Are you sure you want to remove this gift from the market?", async (confirmed) => {
                    if (confirmed) {
                        const originalState = { is_on_sale: gift.is_on_sale, sale_price: gift.sale_price };
                        
                        // Optimistic UI update
                        gift.is_on_sale = false;
                        delete gift.sale_price;
                        
                        // Update the button text in the modal immediately before closing
                        const sellBtnText = collectibleActionSell.querySelector('.text');
                        if (sellBtnText) sellBtnText.textContent = 'Sell';
                        
                        closeModal(collectibleDetailModal);
                        renderProfileGifts(); // Re-render the main grid
                        tg.HapticFeedback.notificationOccurred('success');
                
                        // Backend call
                        try {
                            await callBackend(`/api/gifts/${gift.instance_id}`, 'PUT', {
                                action: 'sell',
                                value: false // Explicitly tell backend to unlist
                            });
                        } catch (error) {
                            // Revert UI on failure
                            gift.is_on_sale = originalState.is_on_sale;
                            gift.sale_price = originalState.sale_price;
                            renderProfileGifts();
                            // Error alert is handled by callBackend
                        }
                    }
                });
            } else {
                // --- Logic to LIST for sale ---
                openSellModal(gift);
            }
        }

        
        function updateActionToolbarVisibility() {
            const hasNonCollectible = ownedGifts.some(g => !g.is_collectible);
            const hasActiveFilter = Object.values(activeFilters).some(f => f !== null);

            const showUpgradeAll = hasNonCollectible && viewingOwnProfile && !reorderModeActive && !selectionModeActive;
            const showFilterExit = hasActiveFilter && !reorderModeActive && !selectionModeActive;

            upgradeAllGiftsButton.classList.toggle('hidden', !showUpgradeAll);
            exitFilterModeButton.classList.toggle('hidden', !showFilterExit);

            const isAnyButtonVisible = showUpgradeAll || showFilterExit || reorderModeActive || selectionModeActive;
            profileGiftsActionsWrapper.classList.toggle('hidden', !isAnyButtonVisible);
        }

        function openBuyMultipleModal(id, name, originalImage, lottiePath) {
            currentGiftToBuyMultiple = { id, name, originalImage, lottiePath };
            buyMultipleModalTitle.textContent = `Buy "${name}"`;
            buyMultipleGiftName.textContent = `Enter quantity for "${name}"`;
            buyMultipleQuantityInput.value = "1";
            openModal(buyMultipleModal);
            buyMultipleQuantityInput.focus();
        }

        // --- Replace your existing buyGift function ---
        async function buyGift(id, name, originalImage, lottiePath, quantity = 1) {
            // --- UPDATED: Check local stock first for immediate feedback ---
            const stockInfo = limitedGiftStock[id];
            if (stockInfo && stockInfo.remaining < quantity) {
                tg.showAlert(`Not enough stock available. Only ${stockInfo.remaining} left.`);
                return;
            }
            // --- END UPDATE ---
        
            if (ownedGifts.length + quantity > GIFT_LIMIT_PER_USER) {
                tg.showAlert(`Cannot buy ${quantity} gifts. You have ${ownedGifts.length} gifts and the limit is ${GIFT_LIMIT_PER_USER}.`);
                return;
            }
        
            // --- OPTIMISTIC UI UPDATE ---
            const newGifts = [];
            for (let i = 0; i < quantity; i++) {
                const tempInstanceId = `temp_${generateUniqueId()}`;
                const newGift = {
                    instance_id: tempInstanceId, owner_id: currentAccountTgId, gift_type_id: id,
                    gift_name: name, original_image_url: originalImage, lottie_path: lottiePath,
                    is_collectible: false, acquired_date: new Date().toISOString(),
                    is_hidden: false, is_pinned: false, is_worn: false, is_pending: true 
                };
                newGifts.push(newGift);
            }
        
            ownedGifts.unshift(...newGifts);
        
            // --- NEW: Optimistically update local stock count ---
            if (stockInfo) {
                limitedGiftStock[id].remaining -= quantity;
            }
            // --- END NEW ---
        
            showPage('profile-page');
            switchTab('gifts');
            renderProfileGifts(); 
            tg.HapticFeedback.notificationOccurred('success');
            
            for (const gift of newGifts) {
                try {
                    await callBackend('/api/gifts', 'POST', {
                        instance_id: gift.instance_id, owner_id: gift.owner_id,
                        gift_type_id: gift.gift_type_id, gift_name: gift.gift_name,
                        original_image_url: gift.original_image_url, lottie_path: gift.lottie_path
                    });
                    const confirmedGift = ownedGifts.find(g => g.instance_id === gift.instance_id);
                    if(confirmedGift) delete confirmedGift.is_pending;
                } catch (error) {
                    tg.HapticFeedback.notificationOccurred('error');
                    ownedGifts = ownedGifts.filter(g => g.instance_id !== gift.instance_id);
                    // Revert stock count on failure
                    if (stockInfo) limitedGiftStock[id].remaining += 1; 
                    renderProfileGifts(); 
                    // The error message for sold out items is handled by the backend
                    if (error.reason !== 'This limited gift is sold out.') {
                        tg.showAlert(`Failed to save one "${name}" gift. Please try again.`);
                    }
                    // If it failed, refresh stock from server to be sure
                    await fetchLimitedGiftStock();
                }
            }
            tg.showAlert(`Added ${quantity} "${name}" gift(s)!`);
        }

        async function openMarket() {
            closeSidebar();
            showPage('market-summary-page');
            const grid = document.getElementById('market-summary-grid');
            grid.innerHTML = '<div class="spinner"></div>';
        
            try {
                const summaryData = await callBackend('/api/market/summary');
                grid.innerHTML = '';
                if (summaryData.length === 0) {
                    grid.innerHTML = '<p class="empty-grid-message">The market is empty right now.</p>';
                    return;
                }
        
                summaryData.forEach(item => {
                    const card = document.createElement('div');
                    // Use the new .market-card class for styling
                    card.className = 'market-card buy-gift-item'; 
                    
                    card.innerHTML = `
                        <div class="resale-banner">resale</div>
                        <div class="image-container">
                            <img class="static-image-fallback" src="${item.original_image_url}" alt="${item.gift_name}" loading="lazy">
                        </div>
                        <div class="gift-name">${item.gift_name}</div>
                        <div class="bottom-price-label">
                            <img src="${STAR_ICON_URL}" alt="Star"/> ${item.lowest_price.toLocaleString()}+
                        </div>
                    `;
                    card.addEventListener('click', () => openMarketListings(item.gift_type_id, item.gift_name));
                    grid.appendChild(card);
                });
            } catch (error) {
                grid.innerHTML = '<p class="empty-grid-message">Could not load the market. Please try again later.</p>';
            }
        }
        
        async function openMarketListings(giftTypeId, giftName) {
            showPage('market-listings-page');
            document.getElementById('market-listings-title').textContent = giftName;
            const grid = document.getElementById('market-listings-grid');
            grid.innerHTML = '<div class="spinner"></div>';
        
            try {
                const listings = await callBackend(`/api/market/listings/${giftTypeId}`);
                grid.innerHTML = '';
        
                if (listings.length === 0) {
                    grid.innerHTML = '<p class="empty-grid-message">No listings found for this gift.</p>';
                    return;
                }
        
                listings.forEach(listing => {
                    const giftDataForCard = {
                        instance_id: listing.instance_id,
                        is_collectible: true,
                        collectible_data: listing.collectible_data,
                        is_on_sale: true,
                        sale_price: listing.sale_price,
                    };
                    const card = createGiftCardDOM(giftDataForCard);
                    // --- THIS IS THE FIX ---
                    // The click handler now correctly calls the confirmation modal with only the instance_id
                    card.onclick = () => openBuyConfirmationModal(listing.instance_id);
                    grid.appendChild(card);
                    observeLottieElement(card);
                });
        
            } catch (error) {
                grid.innerHTML = '<p class="empty-grid-message">Could not load listings. Please try again later.</p>';
            }
        }
        
        async function openBuyConfirmationModal(instanceId) {
            try {
                // --- THIS IS THE FIX ---
                // Fetch full gift details from the NEW, CORRECT endpoint designed for a single listing
                const giftData = await callBackend(`/api/market/listing/${instanceId}`);
        
                const closeButton = document.getElementById('close-collectible-detail-modal');
                const originalText = closeButton.textContent;
                // Stash the original event listener to restore it later
                const originalOnClick = () => closeModal(collectibleDetailModal);
        
                closeButton.textContent = `Buy for ⭐ ${giftData.sale_price.toLocaleString()}`;
                closeButton.onclick = () => handleMarketPurchase(giftData, originalText, originalOnClick);
                
                // Populate the modal with the fetched data
                populateCollectibleDetailModal(giftData);
                // Explicitly show the modal
                collectibleDetailModal.classList.add('active');
                manageBackButton(true, () => {
                    // Restore button before closing to prevent incorrect state
                    closeButton.textContent = originalText;
                    closeButton.onclick = originalOnClick;
                    closeModal(collectibleDetailModal);
                });
        
            } catch (error) {
                // Error is handled by callBackend, which shows an alert
            }
        }
        
        async function handleMarketPurchase(giftData, originalButtonText, originalOnClick) {
            const closeButton = document.getElementById('close-collectible-detail-modal');
            tg.showConfirm(`Confirm purchase of ${giftData.gift_name} #${giftData.collectible_number} for ⭐ ${giftData.sale_price.toLocaleString()}?`, async (confirmed) => {
                if (confirmed) {
                    closeButton.disabled = true;
                    closeButton.textContent = 'Purchasing...';
                    try {
                        await callBackend(`/api/market/buy/${giftData.instance_id}`, 'POST', {
                            buyer_id: currentAccountTgId
                        });
                        
                        tg.HapticFeedback.notificationOccurred('success');
                        tg.showAlert("Purchase successful! The gift has been added to your inventory.");
                        
                        // Reset the button and close the modal
                        closeButton.disabled = false;
                        closeButton.textContent = originalButtonText;
                        closeButton.onclick = originalOnClick;
                        closeModal(collectibleDetailModal);
                        
                        // Refresh user data and go back to their profile
                        await initializeTelegramUserAccount();
                        showPage('profile-page');
                        switchTab('gifts');
        
                    } catch (error) {
                        // Error is handled by callBackend
                        closeButton.disabled = false;
                        closeButton.textContent = `Buy for ⭐ ${giftData.sale_price.toLocaleString()}`;
                    }
                }
            });
        }
                
        function createGiftCardDOM(gift) {
            const card = document.createElement('div');
            card.className = 'gift-card';
            card.dataset.instanceId = gift.instance_id;
            card.dataset.pinned = gift.is_pinned;
        
            if (gift.is_hidden) card.classList.add('is-hidden');
        
            const imageContainer = document.createElement('div');
            imageContainer.className = 'image-container';
            const lottieContainer = document.createElement('div');
            lottieContainer.className = 'lottie-animation-container';
            lottieContainer.style.display = 'none';
            const staticImage = document.createElement('img');
            staticImage.className = 'static-image-fallback';
            staticImage.loading = 'lazy';
            let lottiePathForCard = null;
        
            if (gift.is_collectible && gift.collectible_data) {
                const cd = gift.collectible_data;
                staticImage.src = cd.modelImage || gift.original_image_url;
                staticImage.alt = cd.model?.name || gift.gift_name;
                lottiePathForCard = cd.lottieModelPath;
                
                // --- UPDATED LOGIC to show price or number ---
                if (gift.is_on_sale && gift.sale_price) {
                    card.style.overflow = 'hidden'; // Ensure banner is clipped
                    const saleLabel = document.createElement('div');
                    saleLabel.className = 'top-right-label on-sale';
                    saleLabel.textContent = 'resale';
                    card.appendChild(saleLabel);
        
                    const priceLabel = document.createElement('div');
                    priceLabel.className = 'bottom-price-label';
                    priceLabel.innerHTML = `<img src="${STAR_ICON_URL}" alt="Star"/> ${gift.sale_price.toLocaleString()}`;
                    card.appendChild(priceLabel);
                } else {
                     const labelDiv = document.createElement('div');
                     labelDiv.className = 'top-right-label';
                     if (cd.supply) {
                         const supplyNum = cd.supply;
                         labelDiv.textContent = `1 of ${supplyNum > 1000 ? `${(supplyNum / 1000).toFixed(1)}K` : supplyNum.toLocaleString()}`;
                     } else if (gift.collectible_number) {
                         labelDiv.textContent = `#${gift.collectible_number.toLocaleString()}`;
                     } else {
                         labelDiv.textContent = 'Limitless';
                     }
                     card.appendChild(labelDiv);
                }
        
                const bgDiv = document.createElement('div');
                bgDiv.className = 'gift-card-bg-pattern';
                if (cd.backdropColors) {
                    bgDiv.style.background = `radial-gradient(circle, ${cd.backdropColors.centerColor}, ${cd.backdropColors.edgeColor})`;
                } else {
                    bgDiv.style.background = 'linear-gradient(45deg, #2a3745, #17212b)';
                }
                card.appendChild(bgDiv);
        
                if (cd.patternImage) {
                    const patternContainer = document.createElement('div');
                    patternContainer.className = 'dynamic-pattern-container';
                    card.appendChild(patternContainer);
                    const patternConfig = [
                        { count: 8, radius: 38, size: 12 }, 
                        { count: 8, radius: 62, size: 10, rotationOffset: 22.5 }
                    ];
                    setTimeout(() => generateCircularPattern(patternContainer, cd.patternImage, patternConfig), 0);
                }
        
            } else {
                staticImage.src = gift.original_image_url;
                staticImage.alt = gift.gift_name;
                lottiePathForCard = gift.lottie_path;
            }
        
            if (lottiePathForCard) card.dataset.lottiePath = lottiePathForCard;
            staticImage.onerror = () => { staticImage.style.display='none'; lottieContainer.innerHTML = '🖼️'; };
            
            imageContainer.appendChild(lottieContainer);
            imageContainer.appendChild(staticImage);
            card.appendChild(imageContainer);
            
            if (gift.is_pinned && !selectionModeActive && !gift.is_on_sale) {
                const pinDiv = document.createElement('div');
                pinDiv.className = 'pin-indicator';
                pinDiv.innerHTML = PIN_ICON_SVG;
                card.appendChild(pinDiv);
            }
        
            if (selectionModeActive) {
                const checkbox = document.createElement('div');
                checkbox.className = 'selection-checkbox';
                card.appendChild(checkbox);
                if (selectedGiftIds.has(gift.instance_id)) card.classList.add('selected');
                card.onclick = () => toggleGiftSelection(gift.instance_id);
            } else if (reorderModeActive) {
                card.style.cursor = gift.is_pinned ? 'grab' : 'default';
            } else {
                card.onclick = () => openGiftDetailByInstanceId(gift.instance_id);
                if (viewingOwnProfile) setupLongPress(card, gift);
            }
        
            return card;
        }

        
        async function handleConfirmBuyMultiple() {
            if (!currentGiftToBuyMultiple) return;
            const quantity = parseInt(buyMultipleQuantityInput.value, 10);
            if (isNaN(quantity) || quantity < 1) { tg.showAlert("Please enter a valid quantity."); return; }

            confirmBuyMultipleButton.disabled = true;
            confirmBuyMultipleButton.textContent = 'Buying...';

            await buyGift(currentGiftToBuyMultiple.id, currentGiftToBuyMultiple.name, currentGiftToBuyMultiple.originalImage, currentGiftToBuyMultiple.lottiePath, quantity);

            confirmBuyMultipleButton.disabled = false;
            confirmBuyMultipleButton.textContent = 'Buy';
            closeModal(buyMultipleModal);
            currentGiftToBuyMultiple = null;
        }

        function getGiftDeepLink(gift) {
            const botUsername = "upgradeDemoBot";
            const appShortName = "upgrade";
            const giftTypeIdForLink = gift.gift_type_id;
            const numberForLink = gift.collectible_number;
            return `https://t.me/${botUsername}/${appShortName}?startapp=gift${giftTypeIdForLink}-${numberForLink}`;
        }

        function openGiftDetailByInstanceId(instanceId) {
            const gift = currentlySortedGifts.find(g => g.instance_id === instanceId) || ownedGifts.find(g => g.instance_id === instanceId);
            if (!gift) return;
            
            // This tap counter is now used for the double-tap
            let tapCount = 0;
            let lastTap = 0;

            if (gift.is_collectible) {
                openModal(collectibleDetailModal, gift);
            } else {
                openModal(giftDetailModal, gift);
                
                // --- NEW CODE: Add the double-tap listener ---
                const imageContainer = document.getElementById('modal-gift-image-container');
                const chancesTapHandler = () => {
                    const now = Date.now();
                    const DURATION = 300; // Milliseconds between taps to count as a double-tap
                    
                    if (now - lastTap < DURATION) {
                        tapCount++;
                    } else {
                        tapCount = 1;
                    }
                    lastTap = now;

                    if (tapCount === 2) {
                        tapCount = 0; // Reset counter
                        tg.HapticFeedback.impactOccurred('light');
                        openChancesModal(gift); // Open the calculator
                    }
                };
                
                // Remove any old listener before adding a new one
                imageContainer.removeEventListener('click', imageContainer._chancesTapHandler);
                imageContainer.addEventListener('click', chancesTapHandler);
                imageContainer._chancesTapHandler = chancesTapHandler; // Store reference to remove it later
            }
        }

        async function upgradeSingleGiftLogic(giftToUpgrade, customPattern = null) {
            if (giftToUpgrade.is_collectible) return { status: 'skipped' };
            
            if (CUSTOM_GIFTS_DATA[giftToUpgrade.gift_name] && !customGiftsEnabled) {
                return { status: 'failed', error: "Custom Gifts disabled" };
            }

            try {
                const payload = { instance_id: giftToUpgrade.instance_id };
                if (customPattern) {
                    payload.custom_pattern = customPattern;
                }
                
                const upgradedGiftData = await callBackend('/api/gifts/upgrade', 'POST', payload);

                const giftIndex = ownedGifts.findIndex(g => g.instance_id === upgradedGiftData.instance_id);
                if(giftIndex !== -1) ownedGifts[giftIndex] = upgradedGiftData;
                
                return { ...upgradedGiftData, status: 'success' };
            } catch (error) {
                console.error(`Upgrade error for "${giftToUpgrade.gift_name}" (ID: ${giftToUpgrade.instance_id}):`, error);
                return { status: 'failed', error: error.message };
            }
        }

        async function handleSingleGiftUpgradeFromModal(instanceId) {
            const gift = ownedGifts.find(g => g.instance_id === instanceId);
            if (!gift || gift.is_collectible) return;

            if (CUSTOM_GIFTS_DATA[gift.gift_name] && !customGiftsEnabled) {
                tg.showAlert("Please enable Custom Gifts in settings to upgrade this item.");
                return;
            }

            upgradeGiftDetailModalButton.textContent = 'Upgrading...';
            upgradeGiftDetailModalButton.disabled = true;

            try {
                const result = await upgradeSingleGiftLogic(gift);
                if (result.status === 'success') {
                    renderProfileGifts();
                    tg.HapticFeedback.notificationOccurred('success');
                    closeModal(giftDetailModal);
                    openGiftDetailByInstanceId(gift.instance_id);
                } else if (result.status === 'failed') {
                    // Error is handled by callBackend
                }
            } catch (error) {
                console.error("Error during single gift upgrade:", error);
            } finally {
                upgradeGiftDetailModalButton.textContent = '✨ Upgrade';
                upgradeGiftDetailModalButton.disabled = false;
            }
        }
    
        function openEditProfileModal() {
            const account = accounts.find(acc => acc.tg_id === currentAccountTgId);
            if (!account) return;
        
            document.getElementById('edit-profile-name').value = account.full_name || '';
            document.getElementById('edit-profile-bio').value = account.bio || '';
            document.getElementById('edit-profile-music').value = account.music_status || '';
            
            openModal(document.getElementById('edit-profile-modal'));
        }
        
        async function handleSaveProfile() {
            const name = document.getElementById('edit-profile-name').value.trim();
            const bio = document.getElementById('edit-profile-bio').value.trim();
            const music = document.getElementById('edit-profile-music').value.trim();
        
            if (!name) {
                tg.showAlert("Name cannot be empty.");
                return;
            }
        
            const saveBtn = document.getElementById('save-profile-button');
            saveBtn.disabled = true;
            saveBtn.textContent = "Saving...";
        
            try {
                await callBackend('/api/account', 'PUT', {
                    tg_id: currentAccountTgId,
                    full_name: name,
                    bio: bio,
                    music_status: music
                });
                await initializeTelegramUserAccount(); // Reload all data
                tg.HapticFeedback.notificationOccurred('success');
                closeModal(document.getElementById('edit-profile-modal'));
            } catch (error) {
                // Error handled by callBackend
            } finally {
                saveBtn.disabled = false;
                saveBtn.textContent = "Save";
            }
        }
        
        async function handleUpgradeAllGifts() {
            const giftsToUpgrade = ownedGifts.filter(g => !g.is_collectible);
            if (giftsToUpgrade.length === 0) { tg.showAlert("No gifts to upgrade."); return; }

            if (ownedGifts.length > GIFT_LIMIT_PER_USER) {
                tg.showAlert(`Cannot upgrade all gifts. You have ${ownedGifts.length} gifts and the limit is ${GIFT_LIMIT_PER_USER}.`);
                return;
            }

            const originalButtonText = upgradeAllGiftsButton.textContent;
            upgradeAllGiftsButton.disabled = true;
            let successCount = 0, failureCount = 0;
            for (let i = 0; i < giftsToUpgrade.length; i++) {
                const gift = giftsToUpgrade[i];
                upgradeAllGiftsButton.textContent = `Upgrading (${i + 1}/${giftsToUpgrade.length})...`;
                const cardElement = giftsGrid.querySelector(`.gift-card[data-instance-id="${gift.instance_id}"]`);
                if (cardElement) cardElement.classList.add('is-updating');
                const result = await upgradeSingleGiftLogic(gift);
                if (cardElement) cardElement.classList.remove('is-updating');
                if (result.status === 'success') {
                    successCount++;
                    renderProfileGifts();
                } else if (result.status === 'failed') failureCount++;
                if (giftsToUpgrade.length > 1 && i < giftsToUpgrade.length - 1) await new Promise(resolve => setTimeout(resolve, 200));
            }

            let summaryMessage = `Upgrade complete.\nSucceeded: ${successCount}`;
            if (failureCount > 0) summaryMessage += `\nFailed: ${failureCount}`;
            tg.showAlert(summaryMessage);
            tg.HapticFeedback.notificationOccurred(successCount > 0 ? 'success' : (failureCount > 0 ? 'error' : 'warning'));
            updateActionToolbarVisibility();
            if (upgradeAllGiftsButton) { upgradeAllGiftsButton.textContent = originalButtonText; upgradeAllGiftsButton.disabled = false; }
        }

        function openModal(modalElement, data = null) {
            if (!modalElement) return;

            if(data) modalElement.dataset.instanceId = data.instance_id;

            if (modalElement.id === 'gift-detail-modal' && data) {
                populateGiftDetailModal(data);
            } else if (modalElement.id === 'collectible-detail-modal' && data) {
                populateCollectibleDetailModal(data);
            } else if (modalElement.id === 'giveaway-setup-modal') {
                 populateGiveawaySetupModal();
            }

            modalElement.classList.add('active');
            manageBackButton(true, () => closeModal(modalElement));
        }

        function closeModal(modalElement) {
            if (!modalElement) return;
            const handler = tg._backButtonCallback;
            manageBackButton(false, handler);

            modalElement.classList.remove('active');

            if (modalElement.id === 'gift-detail-modal') destroyLottieAnimation(modalLottieGiftOriginal);
            if (modalElement.id === 'collectible-detail-modal') {
                destroyLottieAnimation(modalLottieCollectibleModel);
                if (patternContainerDynamic) patternContainerDynamic.innerHTML = '';
            }
            if (modalElement.id === 'custom-buy-modal') giftCreationQueue = [];
            if (modalElement.id === 'giveaway-setup-modal') selectedGiveawayGifts.clear();
        }

        function populateGiftDetailModal(gift) {
            modalGiftName.textContent = "Saved Gift";
            destroyLottieAnimation(modalLottieGiftOriginal);
            modalGiftImageStatic.style.display = 'block'; modalLottieGiftOriginal.style.display = 'none';
            if (animationsEnabled && gift.lottie_path) {
                playLottieAnimation(modalLottieGiftOriginal, gift.lottie_path, true);
                modalGiftImageStatic.style.display = 'none'; modalLottieGiftOriginal.style.display = 'flex';
            } else {
                modalGiftImageStatic.src = gift.original_image_url;
                modalGiftImageStatic.onerror = function() { this.src = `https://i.pravatar.cc/100?u=err${generateUniqueId()}`; };
            }
            modalGiftDescription1.textContent = `Add "${gift.gift_name}" to your profile or upgrade it.`;
            modalGiftDescription2.textContent = "Only you can see the sender's name.";
            modalGiftInfo.innerHTML = `
                <div class="info-row"><span class="info-label">Date</span><span class="info-value">${new Date(gift.acquired_date).toLocaleDateString('en-US', {day:'numeric', month:'short', year:'numeric', hour:'2-digit', minute:'2-digit'})}</span></div>
                <div class="info-row"><span class="info-label">Price</span><span class="info-value">Free</span></div>
                <div class="info-row"><span class="info-label">Availability</span><span class="info-value">Limited</span></div>`;
            
            upgradeGiftDetailModalButton.dataset.instanceId = gift.instance_id;
            upgradeGiftDetailModalButton.disabled = gift.owner_id !== currentAccountTgId;
        }
        
        function openTelegramProfile(event, username) {
            event.stopPropagation(); // Prevent parent click
            event.preventDefault();
            tg.openTelegramLink(`https://t.me/${username}`);
        }

        async function populateCollectibleDetailModal(gift) {
            const cd = gift.collectible_data;
            modalCollectibleMainName.textContent = cd.model?.name || gift.gift_name;
        
            const numberForLink = gift.collectible_number;
            const snoopGifts = ['Snoop Dogg', 'Swag Bag', 'Snoop Cigar', 'Low Rider', 'Westside Sign'];
            const vasiliyGifts = ['Dildo', 'Skebob', "Baggin' Cat"];
        
            let subtextHTML;
            if (snoopGifts.includes(gift.gift_name)) {
                subtextHTML = `Collectible #${numberForLink.toLocaleString()} by <a href="#" onclick="openTelegramProfile(event, 'snoopdogg')">@snoopdogg</a>`;
            } else if (vasiliyGifts.includes(gift.gift_name)) {
                subtextHTML = `Collectible #${numberForLink.toLocaleString()} by <a href="#" onclick="openTelegramProfile(event, 'Vasiliy939')">@Vasiliy939</a>`;
            } else {
                subtextHTML = `Collectible #${numberForLink.toLocaleString()}`;
            }
            modalCollectibleNumberSubtext.innerHTML = `<a id="collectible-link-copier" href="#">${subtextHTML}</a>`;
            document.getElementById('collectible-link-copier').onclick = (e) => {
                if (e.target.tagName !== 'A' || e.target.id === 'collectible-link-copier') {
                    e.preventDefault();
                    copyGiftLink(gift);
                }
            };
        
            if (patternContainerDynamic) patternContainerDynamic.innerHTML = '';
            if (collectibleDisplayArea && cd.backdropColors) {
                collectibleDisplayArea.style.background = `radial-gradient(circle at 50% 0%, ${cd.backdropColors.centerColor} 0%, ${cd.backdropColors.edgeColor} 100%)`;
            } else {
                collectibleDisplayArea.style.background = 'var(--tg-theme-secondary-bg-color)';
            }
        
            if (cd.patternImage && patternContainerDynamic) {
                setTimeout(() => {
                    if (!patternContainerDynamic) return;
                    const containerWidth = patternContainerDynamic.offsetWidth;
                    const containerHeight = patternContainerDynamic.offsetHeight;
                    const centerX = containerWidth / 2;
                    const centerY = containerHeight * 0.4;
        
                    const createPattern = (styles) => {
                        const img = document.createElement('img');
                        img.src = cd.patternImage;
                        img.className = 'dynamic-pattern-instance';
                        img.style.width = `${styles.size}px`;
                        img.style.height = 'auto';
                        img.style.left = `${styles.left - (styles.size / 2)}px`;
                        img.style.top = `${styles.top - (styles.size / 2)}px`;
                        patternContainerDynamic.appendChild(img);
                    };
        
                    const circleRadius = Math.min(containerWidth, containerHeight) / 3.5;
                    const numCirclePatterns = 10;
                    for (let i = 0; i < numCirclePatterns; i++) {
                        const angle = (i / numCirclePatterns) * 2 * Math.PI;
                        const x = centerX + circleRadius * Math.cos(angle);
                        const y = centerY + circleRadius * Math.sin(angle);
                        // --- ADJUSTMENT: Made patterns a little smaller ---
                        createPattern({ left: x, top: y, size: 36 }); 
                    }
        
                    const numColumnPatterns = 4;
                    const colYStart = containerHeight * 0.18;
                    const colYStep = (containerHeight * 0.85 - colYStart) / (numColumnPatterns - 1);
        
                    const leftColX = containerWidth * 0.15;
                    for (let i = 0; i < numColumnPatterns; i++) {
                        // --- ADJUSTMENT: Made patterns a little smaller ---
                        createPattern({ left: leftColX, top: colYStart + (i * colYStep), size: 26 }); 
                    }
        
                    const rightColX = containerWidth * 0.85;
                    for (let i = 0; i < numColumnPatterns; i++) {
                        // --- ADJUSTMENT: Made patterns a little smaller ---
                        createPattern({ left: rightColX, top: colYStart + (i * colYStep), size: 26 }); 
                    }
                }, 50);
            }
        
            destroyLottieAnimation(modalLottieCollectibleModel);
            modalCollectibleModelImgStatic.style.display = 'block';
            modalLottieCollectibleModel.style.display = 'none';
            if (animationsEnabled && cd.lottieModelPath) {
                playLottieAnimation(modalLottieCollectibleModel, cd.lottieModelPath, true);
                modalCollectibleModelImgStatic.style.display = 'none';
                modalLottieCollectibleModel.style.display = 'flex';
            } else {
                modalCollectibleModelImgStatic.src = cd.modelImage || gift.original_image_url;
                modalCollectibleModelImgStatic.onerror = function() { this.src = `https://i.pravatar.cc/200?u=err${generateUniqueId()}`; };
            }
        
            let ownerName, ownerAvatar, ownerUsername;
            const isOwner = (gift.owner_id === currentAccountTgId);
            if (isOwner) {
                const myAccount = accounts.find(acc => acc.tg_id === currentAccountTgId);
                ownerName = myAccount.full_name;
                ownerAvatar = myAccount.avatar_url;
                ownerUsername = myAccount.username;
            } else {
                ownerName = gift.owner_name || 'Test Account';
                ownerAvatar = gift.owner_avatar || `https://i.pravatar.cc/140?u=${generateUniqueId()}`;
                ownerUsername = gift.owner_username;
            }
        
            const ownerDisplayHTML = ownerUsername ?
                `<a href="#" onclick="event.preventDefault(); displayUserProfile('${ownerUsername}')"><img src="${ownerAvatar}" alt="" class="owner-avatar">${ownerName}</a>` :
                `<span><img src="${ownerAvatar}" alt="" class="owner-avatar">${ownerName}</span>`;
        
            modalCollectibleInfoTable.innerHTML = `
                <div class="info-row"><span class="info-label">Owner</span><span class="info-value">${ownerDisplayHTML}</span></div>
                <div class="info-row"><span class="info-label">Model</span><span id="collectible-model-value" class="info-value clickable-info">${cd.model?.name || 'N/A'} <span class="rarity-chip">${formatRarity(cd.model?.rarityPermille || 0)}</span></span></div>
                <div class="info-row"><span class="info-label">Backdrop</span><span id="collectible-backdrop-value" class="info-value clickable-info">${cd.backdrop?.name || 'N/A'} <span class="rarity-chip">${formatRarity(cd.backdrop?.rarityPermille || 0)}</span></span></div>
                <div class="info-row"><span class="info-label">Symbol</span><span id="collectible-pattern-value" class="info-value clickable-info">${cd.pattern?.name || 'N/A'} <span class="rarity-chip">${formatRarity(cd.pattern?.rarityPermille || 0)}</span></span></div>
                <div class="info-row"><span class="info-label">Supply</span><span class="info-value">${cd.supply?.toLocaleString() || 'N/A'} issued</span></div>`;
        
            const wearBtnIcon = collectibleActionWear.querySelector('.icon img');
            wearBtnIcon.src = gift.is_worn ? UNWEAR_GIFT_IMG : WEAR_GIFT_IMG;
            collectibleActionWear.querySelector('.text').textContent = gift.is_worn ? 'Take Off' : 'Wear';
        
            const sellBtnIcon = collectibleActionSell.querySelector('.icon img');
            sellBtnIcon.src = gift.is_on_sale ? UNSELL_GIFT_IMG : SELL_GIFT_IMG;
            collectibleActionSell.querySelector('.text').textContent = gift.is_on_sale ? `On Sale` : 'Sell';
        
            collectibleActionTransfer.querySelector('.icon img').src = TRANSFER_GIFT_IMG;
        
            const isVisible = isOwner ? 'flex' : 'none';
            [collectibleActionWear, collectibleActionSell, collectibleActionTransfer, collectibleMenuButton].forEach(el => el.style.display = isVisible);
            hideLinkInModal.style.display = isOwner ? 'inline' : 'none';
        
            const modelValueEl = document.getElementById('collectible-model-value');
            const backdropValueEl = document.getElementById('collectible-backdrop-value');
            const patternValueEl = document.getElementById('collectible-pattern-value');
            if (modelValueEl) modelValueEl.addEventListener('click', (e) => handleTripleTap(e, 'model', gift.collectible_data.model?.name));
            if (backdropValueEl) backdropValueEl.addEventListener('click', (e) => handleTripleTap(e, 'backdrop', gift.collectible_data.backdrop?.name));
            if (patternValueEl) patternValueEl.addEventListener('click', (e) => handleTripleTap(e, 'pattern', gift.collectible_data.pattern?.name));
        }

        let currentLongPressGift = null; let longPressTimer;
        function setupLongPress(element, gift) {
            element.addEventListener('touchstart', (e) => {
                clearTimeout(longPressTimer);
                longPressTimer = setTimeout(() => openLongPressMenu(gift, e.touches[0]), 500);
            }, { passive: false });
            element.addEventListener('touchend', () => clearTimeout(longPressTimer));
            element.addEventListener('touchmove', () => clearTimeout(longPressTimer));
            element.addEventListener('contextmenu', (e) => { e.preventDefault(); clearTimeout(longPressTimer); openLongPressMenu(gift, e); });
        }
        function openLongPressMenu(gift, eventCoords) {
            currentLongPressGift = gift;

            const isOwner = (gift.owner_id === currentAccountTgId);

            if (!gift.is_collectible) {
                menuPinAction.textContent = 'Pin (Collectibles only)';
                menuPinAction.classList.add('disabled');
                menuShareImageAction.classList.add('hidden');
                menuCopyLinkAction.classList.add('hidden');
                menuReorderAction.classList.add('hidden');
            } else {
                const isPinned = gift.is_pinned;
                menuPinAction.textContent = isPinned ? 'Unpin' : 'Pin';
                menuPinAction.classList.toggle('disabled', !isOwner);
                menuShareImageAction.classList.remove('hidden');
                menuCopyLinkAction.classList.add('hidden');
                menuReorderAction.classList.toggle('hidden', !isPinned || !isOwner);
            }

            menuHideAction.textContent = gift.is_hidden ? 'Unhide' : 'Hide';
            menuHideAction.classList.toggle('disabled', !isOwner);
            menuDeleteAction.classList.toggle('disabled', !isOwner);

            longPressMenu.style.top = `${Math.min(eventCoords.clientY, window.innerHeight - longPressMenu.offsetHeight - 10)}px`;
            longPressMenu.style.left = `${Math.min(eventCoords.clientX, window.innerWidth - longPressMenu.offsetWidth - 10)}px`;
            longPressMenu.classList.remove('hidden');
            document.addEventListener('click', closeLongPressMenuOnClickOutside, { once: true, capture: true });
        }

        function openCollectibleMenu(gift, eventCoords) {
            currentLongPressGift = gift;
            const isOwner = (gift.owner_id === currentAccountTgId);

            if (!gift.is_collectible) return;

            const isPinned = gift.is_pinned;
            menuPinAction.textContent = isPinned ? 'Unpin' : 'Pin';
            menuPinAction.classList.toggle('disabled', !isOwner);

            menuHideAction.textContent = gift.is_hidden ? 'Unhide' : 'Hide';
            menuHideAction.classList.toggle('disabled', !isOwner);
            menuDeleteAction.classList.toggle('disabled', !isOwner);
            menuShareImageAction.classList.remove('hidden');
            menuCopyLinkAction.classList.add('hidden');
            menuReorderAction.classList.toggle('hidden', !isPinned || !isOwner);

            const menuWidth = longPressMenu.offsetWidth || 220;
            const menuHeight = longPressMenu.offsetHeight || 150;
            let x = window.innerWidth - menuWidth - 20;
            let y = (collectibleMenuButton.getBoundingClientRect().top + collectibleMenuButton.offsetHeight + 10);
            longPressMenu.style.top = `${Math.min(y, window.innerHeight - menuHeight - 10)}px`;
            longPressMenu.style.left = `${Math.min(x, window.innerWidth - menuWidth - 10)}px`;
            longPressMenu.classList.remove('hidden');
            document.addEventListener('click', closeLongPressMenuOnClickOutside, { once: true, capture: true });
        }

        function closeLongPressMenuOnClickOutside(event) {
            if (!longPressMenu.contains(event.target) && event.target !== longPressMenu) { longPressMenu.classList.add('hidden'); currentLongPressGift = null; }
        }

        // In index.html, replace the entire handlePinAction function with this new version.
        
        function handlePinAction() {
            if (!currentLongPressGift || !currentLongPressGift.is_collectible) {
                tg.showAlert("Only collectible gifts can be pinned.");
                longPressMenu.classList.add('hidden');
                currentLongPressGift = null;
                return;
            }
            if (currentLongPressGift.owner_id !== currentAccountTgId) {
                tg.showAlert("You can only pin gifts you own.");
                longPressMenu.classList.add('hidden');
                currentLongPressGift = null;
                return;
            }
            if (currentLongPressGift.is_hidden) {
                tg.showAlert("Cannot pin a hidden gift.");
                longPressMenu.classList.add('hidden');
                return;
            }
        
            const giftInstanceId = currentLongPressGift.instance_id;
            const giftToUpdate = ownedGifts.find(g => g.instance_id === giftInstanceId);
            if (!giftToUpdate) return;
        
            const isCurrentlyPinned = giftToUpdate.is_pinned;
            const currentlyPinnedCount = ownedGifts.filter(g => g.is_pinned).length;
            longPressMenu.classList.add('hidden'); // Close menu immediately
        
            if (!isCurrentlyPinned && currentlyPinnedCount >= 6) {
                showTooManyPinsModal();
                currentLongPressGift = null;
                return;
            }
        
            // --- NEW LOGIC FOR PINNING/UNPINNING AND RE-ORDERING ---
            const originalGiftState = JSON.parse(JSON.stringify(giftToUpdate));
        
            if (isCurrentlyPinned) {
                // --- UNPINNING ---
                giftToUpdate.is_pinned = false;
                giftToUpdate.pin_order = null;
                
                // Re-sequence the remaining pinned items to close the gap
                const remainingPinned = ownedGifts
                    .filter(g => g.is_pinned)
                    .sort((a, b) => a.pin_order - b.pin_order);
                
                remainingPinned.forEach((gift, index) => {
                    gift.pin_order = index;
                });
        
            } else {
                // --- PINNING ---
                giftToUpdate.is_pinned = true;
                // Place it at the end of the pinned list
                giftToUpdate.pin_order = currentlyPinnedCount;
            }
        
            // This re-renders the grid, causing the item to "teleport" to its new position
            renderProfileGifts();
            tg.HapticFeedback.impactOccurred(isCurrentlyPinned ? 'light' : 'medium');
        
            // Send the update to the backend
            callBackend(`/api/gifts/${giftInstanceId}`, 'PUT', {
                action: 'pin',
                value: !isCurrentlyPinned
            }).catch(error => {
                // On failure, revert the local state to what it was before the action
                const giftToRevert = ownedGifts.find(g => g.instance_id === giftInstanceId);
                if (giftToRevert) {
                    Object.assign(giftToRevert, originalGiftState);
                    // Re-render again to show the reverted state
                    renderProfileGifts(); 
                }
            });
        
            currentLongPressGift = null;
        }

        function handleHideAction() {
            const giftToUpdate = currentLongPressGift || currentlySortedGifts.find(g => g.instance_id === collectibleDetailModal.dataset.instanceId) || ownedGifts.find(g => g.instance_id === collectibleDetailModal.dataset.instanceId);
            if (!giftToUpdate) return;

            if (giftToUpdate.owner_id !== currentAccountTgId) {
                tg.showAlert("You can only hide gifts you own.");
                longPressMenu.classList.add('hidden'); currentLongPressGift = null; return;
            }

            const isCurrentlyHidden = giftToUpdate.is_hidden;
            longPressMenu.classList.add('hidden');
            closeModal(collectibleDetailModal);

            giftToUpdate.is_hidden = !isCurrentlyHidden;
            if (giftToUpdate.is_pinned && giftToUpdate.is_hidden) {
                giftToUpdate.is_pinned = false;
            }
            if (giftToUpdate.is_worn && giftToUpdate.is_hidden) {
                giftToUpdate.is_worn = false;
            }
            renderProfileGifts();
            applyWornGiftStyles();
            tg.HapticFeedback.impactOccurred('light');

            callBackend(`/api/gifts/${giftToUpdate.instance_id}`, 'PUT', { action: 'hide', value: !isCurrentlyHidden })
                .catch(error => {
                    giftToUpdate.is_hidden = isCurrentlyHidden;
                    renderProfileGifts();
                });
            currentLongPressGift = null;
        }

        function handleDeleteAction() {
            if (!currentLongPressGift || currentLongPressGift.owner_id !== currentAccountTgId) {
                if(currentLongPressGift) tg.showAlert("You can only delete gifts you own.");
                longPressMenu.classList.add('hidden'); currentLongPressGift = null; return;
            }

            const giftToDelete = currentLongPressGift;
            longPressMenu.classList.add('hidden');
            closeModal(collectibleDetailModal);

            tg.showConfirm("Are you sure you want to delete this gift? This action cannot be undone.", (confirmed) => {
                if (confirmed) {
                    const giftIndex = ownedGifts.findIndex(g => g.instance_id === giftToDelete.instance_id);
                    if (giftIndex === -1) return;

                    const removedGift = ownedGifts.splice(giftIndex, 1)[0];
                    renderProfileGifts();
                    tg.HapticFeedback.notificationOccurred('success');

                    callBackend(`/api/gifts/${giftToDelete.instance_id}`, 'DELETE')
                        .catch(error => {
                            tg.HapticFeedback.notificationOccurred('error');
                            ownedGifts.splice(giftIndex, 0, removedGift);
                            renderProfileGifts();
                        });
                }
                currentLongPressGift = null;
            });
        }

        function generateCircularPattern(container, imageUrl, circlesConfig) {
            if (!container || !imageUrl || !circlesConfig) return;
            container.innerHTML = ''; 
        
            const centerX = container.offsetWidth / 2;
            const centerY = container.offsetHeight / 2;
        
            circlesConfig.forEach(config => {
                const { count, radius, size, rotationOffset = 0 } = config;
                for (let i = 0; i < count; i++) {
                    const angle = (i / count) * 2 * Math.PI + (rotationOffset * Math.PI / 180);
                    const x = centerX + radius * Math.cos(angle);
                    const y = centerY + radius * Math.sin(angle);
                    const symbolEl = document.createElement('img');
                    symbolEl.src = imageUrl;
                    symbolEl.className = 'card-pattern-symbol';
                    symbolEl.style.width = `${size}px`;
                    symbolEl.style.height = 'auto';
                    symbolEl.style.left = `${x - size / 2}px`;
                    symbolEl.style.top = `${y - size / 2}px`;
                    container.appendChild(symbolEl);
                }
            });
        }
        
        function showTooManyPinsModal() {
            unpinSelectionGrid.innerHTML = '';

            const pinnedGifts = ownedGifts.filter(g => g.is_pinned && !g.is_hidden && g.owner_id === currentAccountTgId);

            pinnedGifts.forEach(pinnedGift => {
                const card = createGiftCardDOM(pinnedGift);
                card.addEventListener('click', async () => {
                    try {
                        await callBackend(`/api/gifts/${pinnedGift.instance_id}`, 'PUT', { action: 'pin', value: false });
                        if (currentLongPressGift && currentLongPressGift.is_collectible) {
                             await callBackend(`/api/gifts/${currentLongPressGift.instance_id}`, 'PUT', { action: 'pin', value: true });
                        }
                        await initializeTelegramUserAccount();
                        tg.HapticFeedback.impactOccurred('medium');
                    } catch (error) {
                       console.error(error);
                    } finally {
                        closeModal(tooManyPinsModal);
                        currentLongPressGift = null;
                    }
                });
                unpinSelectionGrid.appendChild(card);
                observeLottieElement(card);
            });
            openModal(tooManyPinsModal);
        }

        function handleWearAction() {
            const currentModalInstanceId = collectibleDetailModal.dataset.instanceId;
            if (!currentModalInstanceId) return;

            const giftToUpdate = ownedGifts.find(g => g.instance_id === currentModalInstanceId);
            if (!giftToUpdate || giftToUpdate.owner_id !== currentAccountTgId) return;
            if (giftToUpdate.is_hidden) { tg.showAlert("Cannot wear a hidden gift."); return; }

            const isCurrentlyWorn = giftToUpdate.is_worn === true;

            const previouslyWornGift = ownedGifts.find(g => g.is_worn);
            if(previouslyWornGift) previouslyWornGift.is_worn = false;

            giftToUpdate.is_worn = !isCurrentlyWorn;
            collectibleActionWear.querySelector('.text').textContent = giftToUpdate.is_worn ? 'Take Off' : 'Wear';
            applyWornGiftStyles();
            tg.HapticFeedback.impactOccurred('light');

            callBackend(`/api/gifts/${currentModalInstanceId}`, 'PUT', { action: 'wear', value: !isCurrentlyWorn })
                .catch(error => {
                    giftToUpdate.is_worn = isCurrentlyWorn;
                    if(previouslyWornGift) previouslyWornGift.is_worn = true;
                    collectibleActionWear.querySelector('.text').textContent = isCurrentlyWorn ? 'Take Off' : 'Wear';
                    applyWornGiftStyles();
                });
        }
        
        function openFilterPopup() { 
            closeSidebar();
            openModal(filterPopup); 
        }
        
        function populateFilterOptions() {
            const uniqueCollections = [...new Map(ownedGifts.map(item => [item.gift_type_id, {id: item.gift_type_id, name: item.gift_name, image: item.original_image_url}])).values()];
            renderFilterOptions(filterOptionsCollections, uniqueCollections, 'collection', (item) => `<img src="${item.image}" alt="${item.name}">`);

            if (activeFilters.collection) {
                const giftsInCollection = ownedGifts.filter(g => g.gift_type_id === activeFilters.collection && g.is_collectible && g.collectible_data?.model);
                const uniqueModels = [...new Map(giftsInCollection.map(item => [item.collectible_data.model.name, {name: item.collectible_data.model.name, image: item.collectible_data.modelImage}])).values()];
                renderFilterOptions(filterOptionsModels, uniqueModels, 'model', (item) => `<img src="${item.image}" alt="${item.name}">`);
                filterModelsSection.classList.remove('hidden');
            } else { filterModelsSection.classList.add('hidden'); filterOptionsModels.innerHTML = ''; }

            const collectibleGifts = ownedGifts.filter(g => g.is_collectible && g.collectible_data?.backdrop);
            const uniqueBackdrops = [...new Map(collectibleGifts.map(item => [item.collectible_data.backdrop.name, {name: item.collectible_data.backdrop.name, colors: item.collectible_data.backdropColors}])).values()];
            renderFilterOptions(filterOptionsBackdrops, uniqueBackdrops, 'backdrop', (item) => `<div class="gradient-square" style="background: radial-gradient(circle, ${item.colors.centerColor}, ${item.colors.edgeColor});"></div>`);

            const uniquePatterns = [...new Map(ownedGifts.filter(g => g.is_collectible && g.collectible_data && g.collectible_data.pattern).map(item => [item.collectible_data.pattern.name, {name: item.collectible_data.pattern.name, image: item.collectible_data.patternImage}])).values()];
            renderFilterOptions(filterOptionsPatterns, uniquePatterns, 'pattern', (item) => `<img src="${item.image}" alt="${item.name}">`);
        }
        function renderFilterOptions(container, items, filterType, displayFn) {
            container.innerHTML = '';
            items.forEach(item => {
                const optionEl = document.createElement('div'); optionEl.className = 'filter-option';
                optionEl.innerHTML = displayFn(item);
                const valueToCompare = filterType === 'collection' ? item.id : item.name;
                if (activeFilters[filterType] === valueToCompare) optionEl.classList.add('selected');
                optionEl.addEventListener('click', () => {
                    if (activeFilters[filterType] === valueToCompare) {
                        activeFilters[filterType] = null;
                        if (filterType === 'collection') activeFilters.model = null;
                    } else {
                        activeFilters[filterType] = valueToCompare;
                        if (filterType === 'collection') activeFilters.model = null;
                    }
                    populateFilterOptions();
                });
                container.appendChild(optionEl);
            });
        }
        function handleApplyFilters() {
            saveClientSideState();
            renderProfileGifts();
            closeModal(filterPopup);
            updateActionToolbarVisibility();
        }
        function handleClearFilters() {
            activeFilters = { collection: null, model: null, backdrop: null, pattern: null };
            populateFilterOptions(); renderProfileGifts(); saveClientSideState(); updateActionToolbarVisibility();
        }

        async function handleClearCurrentAccountData() {
            if (!currentAccountTgId) return;

            tg.showConfirm(`Are you sure you want to delete all gifts and data for the CURRENT account? This cannot be undone.`, async (confirmed) => {
                if (confirmed) {
                    try {
                        for(const gift of [...ownedGifts]) {
                            await callBackend(`/api/gifts/${gift.instance_id}`, 'DELETE');
                        }

                        const currentAccount = accounts.find(acc => acc.tg_id === currentAccountTgId);
                        if (currentAccount && currentAccount.collectible_usernames) {
                            for(const uname of [...currentAccount.collectible_usernames]) {
                                await callBackend(`/api/collectible_usernames/${uname}`, 'DELETE', { owner_id: currentAccountTgId });
                            }
                        }

                        await callBackend('/api/account', 'PUT', {
                            tg_id: currentAccountTgId,
                            phone_number: "Not specified",
                            bio: "My first account!",
                        });

                        await initializeTelegramUserAccount();

                        activeFilters = { collection: null, model: null, backdrop: null, pattern: null };
                        animationsEnabled = true; showHiddenGifts = false;

                        saveClientSideState();
                        saveClientSideAccounts();

                        tg.HapticFeedback.notificationOccurred('success');
                        tg.showAlert("Current account data cleared.");
                        closeModal(settingsModal);
                    } catch (error) {
                        tg.HapticFeedback.notificationOccurred('error');
                    }
                }
            });
        }

        async function handleClearAllAccountsData() {
            tg.showConfirm("Are you sure you want to delete ALL accounts and data from this simulator? This cannot be undone.", async (confirmed) => {
                if (confirmed) {
                    accounts = [];
                    currentAccountTgId = null;

                    activeFilters = { collection: null, model: null, backdrop: null, pattern: null };
                    animationsEnabled = true; showHiddenGifts = false;

                    localStorage.clear();

                    await initApp();
                    tg.HapticFeedback.notificationOccurred('success');
                    tg.showAlert("All simulator data cleared.");
                    closeModal(settingsModal);
                }
            });
        }

        function handleAnimationToggle() {
            animationsEnabled = animationToggle.checked;
            tg.HapticFeedback.impactOccurred('light');
            updateAllAnimationsState();
            saveClientSideState();
        }

        function handleShowHiddenToggle() {
            showHiddenGifts = showHiddenToggle.checked;
            tg.HapticFeedback.impactOccurred('light');
            renderProfileGifts();
            saveClientSideState();
        }
        
        async function handleCustomGiftsToggle() {
            const isEnabling = customGiftsToggle.checked;
            
            if (isEnabling) {
                tg.showAlert("By enabling, you confirm you're over 18.");
            }
            
            customGiftsEnabled = isEnabling;
            tg.HapticFeedback.impactOccurred('light');

            try {
                await updateCustomGiftsSetting(isEnabling);
                await initializeTelegramUserAccount(); 
            } catch (error) {
                customGiftsEnabled = !isEnabling;
                customGiftsToggle.checked = !isEnabling;
            }
        }

        async function updateCustomGiftsSetting(enabled) {
            return await callBackend('/api/account/settings', 'POST', {
                tg_id: currentAccountTgId,
                custom_gifts_enabled: enabled
            });
        }

        // --- START REPLACEMENT: Full openCustomBuyModal function (with subscription check bypassed) ---
        // --- START: COMPLETE CUSTOMIZATION STUDIO JAVASCRIPT BLOCK ---
        
        // This replaces the old openCustomBuyModal and removes the subscription check
        async function openCustomBuyModal() {
            // We are assuming access is always granted for testing
            if (!customGiftsEnabled && currentAccountTgId !== 5146625949) {
                tg.showAlert("Please enable Custom Gifts in settings first.");
                return;
            }
            
            // Reset Studio State
            giftCreationQueue = [];
            currentlyEditingGiftIndex = -1;
            undoHistory = [];
            redoHistory = [];
            document.getElementById('quick-create-input').value = '';
            document.getElementById('clone-url-input-studio').value = '';
        
            // Load user preferences
            savedTemplates = JSON.parse(localStorage.getItem('savedTemplates' + APP_VERSION_SUFFIX)) || [];
            recentCreations = JSON.parse(localStorage.getItem('recentCreations' + APP_VERSION_SUFFIX)) || [];
            pinnedParts = JSON.parse(localStorage.getItem('pinnedParts' + APP_VERSION_SUFFIX)) || { model: [], backdrop: [], pattern: [] };
            
            addGiftToQueue(); // This will create the first gift, set index to 0, and populate base gifts
            
            renderQuickPickBar();
            updateUndoRedoButtons();
            switchStudioTab('studio');
        
            openModal(customBuyModal);
        }
        
        // Replaces old addGiftToQueue
        function addGiftToQueue() {
            const newGift = {
                queueId: `q_${Date.now()}`,
                id: null, name: null, originalImage: null, lottiePath: null,
                model: null, backdrop: null, pattern: null, quantity: 1
            };
        
            giftCreationQueue.push(newGift);
            currentlyEditingGiftIndex = giftCreationQueue.length - 1;
            
            undoHistory = [];
            redoHistory = [];
            updateUndoRedoButtons();
            
            updateQueueUI();
            updateLivePreview(); // Show a blank state
            
            // Clear the part selectors and expand the first one for the new item
            document.querySelectorAll('.studio-parts-grid').forEach(grid => grid.innerHTML = '');
            document.querySelectorAll('.studio-section-content').forEach(content => content.classList.add('hidden'));
            
            const firstSection = document.querySelector('.studio-section');
            if (firstSection) {
                firstSection.querySelector('.studio-section-content').classList.remove('hidden');
            }
        
            populateBaseGiftOptions(currentAccountTgId); 
        }
        
        // Replaces all old queue rendering logic
        function updateQueueUI() {
            const gridContainer = document.getElementById('queue-grid-preview');
            const gridWrapper = document.getElementById('queue-grid-preview-container');
            const label = document.getElementById('studio-queue-label');
        
            label.textContent = `Editing Gift ${currentlyEditingGiftIndex + 1} of ${giftCreationQueue.length}`;
            
            if (giftCreationQueue.length <= 1) {
                gridWrapper.classList.add('hidden');
                gridContainer.innerHTML = '';
            } else {
                gridWrapper.classList.remove('hidden');
                gridContainer.innerHTML = '';
                giftCreationQueue.forEach((gift, index) => {
                    const item = document.createElement('div');
                    item.className = 'queue-grid-item';
                    if (index === currentlyEditingGiftIndex) {
                        item.classList.add('active');
                    }
                    const modelImage = (gift.model && gift.model.image) || gift.originalImage || '';
                    item.innerHTML = `<img src="${modelImage}" alt="Queue item ${index + 1}">`;
                    item.addEventListener('click', () => editGiftInQueue(index));
                    gridContainer.appendChild(item);
                });
            }
            updateCreateButtonState();
        }
        
        // Replaces old editGiftInQueue
        function editGiftInQueue(index) {
            if (currentlyEditingGiftIndex === index) return;
            
            currentlyEditingGiftIndex = index;
            
            undoHistory = [];
            redoHistory = [];
            updateUndoRedoButtons();
            updateQueueUI();
            
            const giftToEdit = giftCreationQueue[index];
        
            if (giftToEdit.id) {
                selectCustomBaseGift(giftToEdit.id, giftToEdit.name, giftToEdit.originalImage, false);
            } else {
                populateBaseGiftOptions(currentAccountTgId);
            }
            updateLivePreview();
        }
        
        // --- ALL THE NEW HELPER FUNCTIONS THAT WERE MISSING ---
        
        function switchStudioTab(tabName) {
            document.getElementById('studio-tab-content').classList.toggle('active', tabName === 'studio');
            document.getElementById('templates-tab-content').classList.toggle('active', tabName === 'templates');
            document.getElementById('studio-tab-button').classList.toggle('active', tabName === 'studio');
            document.getElementById('templates-tab-button').classList.toggle('active', tabName === 'templates');
            
            if (tabName === 'templates') {
                renderTemplateLibrary();
            }
        }
        
        function updateLivePreview() {
            const gift = giftCreationQueue[currentlyEditingGiftIndex];
            const backdropEl = document.getElementById('live-preview-backdrop');
            const patternEl = document.getElementById('live-preview-pattern');
            const modelEl = document.getElementById('live-preview-model');
        
            if (!gift) return;
        
            if (gift.backdrop && gift.backdrop.hex) {
                backdropEl.style.background = `radial-gradient(circle, ${gift.backdrop.hex.centerColor}, ${gift.backdrop.hex.edgeColor})`;
            } else {
                backdropEl.style.background = 'var(--tg-theme-secondary-bg-color)';
            }
        
            if (gift.pattern) {
                const customData = CUSTOM_GIFTS_DATA[gift.name];
                const patternSourceName = customData ? customData.patterns_source : gift.name;
                const patternUrl = `${CDN_BASE_URL}patterns/${encodeURIComponent(patternSourceName)}/png/${encodeURIComponent(gift.pattern.name)}.png`;
                patternEl.style.backgroundImage = `url('${patternUrl}')`;
            } else {
                patternEl.style.backgroundImage = 'none';
            }
        
            if (gift.model) {
                const modelImageUrl = gift.model.image || `${CDN_BASE_URL}models/${encodeURIComponent(gift.name)}/png/${encodeURIComponent(gift.model.name)}.png`;
                modelEl.src = modelImageUrl;
                modelEl.style.display = 'block';
            } else if (gift.originalImage) {
                modelEl.src = gift.originalImage;
                modelEl.style.display = 'block';
            } else {
                modelEl.src = '';
                modelEl.style.display = 'none';
            }
        }
        
        function handlePartSelection(type, data) {
            const currentGift = giftCreationQueue[currentlyEditingGiftIndex];
            if (!currentGift) return;
        
            pushToUndoHistory();
        
            if (type === 'model') {
                selectCustomBaseGift(data.id, data.name, data.originalImage);
            } else {
                selectCustomPart(type, data);
            }
        }
        
        function pushToUndoHistory() {
            if (!giftCreationQueue[currentlyEditingGiftIndex]) return;
            const currentState = JSON.parse(JSON.stringify(giftCreationQueue[currentlyEditingGiftIndex]));
            undoHistory.push(currentState);
            redoHistory = [];
            updateUndoRedoButtons();
        }
        
        function handleUndo() {
            if (undoHistory.length === 0) return;
            const lastState = undoHistory.pop();
            const currentState = JSON.parse(JSON.stringify(giftCreationQueue[currentlyEditingGiftIndex]));
            redoHistory.push(currentState);
            
            giftCreationQueue[currentlyEditingGiftIndex] = lastState;
            
            selectCustomBaseGift(lastState.id, lastState.name, lastState.originalImage, false);
            updateLivePreview();
            updateUndoRedoButtons();
        }
        
        function handleRedo() {
            if (redoHistory.length === 0) return;
            const nextState = redoHistory.pop();
            const currentState = JSON.parse(JSON.stringify(giftCreationQueue[currentlyEditingGiftIndex]));
            undoHistory.push(currentState);
        
            giftCreationQueue[currentlyEditingGiftIndex] = nextState;
            
            selectCustomBaseGift(nextState.id, nextState.name, nextState.originalImage, false);
            updateLivePreview();
            updateUndoRedoButtons();
        }
        
        function updateUndoRedoButtons() {
            document.getElementById('undo-button').disabled = undoHistory.length === 0;
            document.getElementById('redo-button').disabled = redoHistory.length === 0;
        }
        
        function saveCurrentGiftAsTemplate() {
            const gift = giftCreationQueue[currentlyEditingGiftIndex];
            if (!gift || !gift.model || !gift.backdrop || !gift.pattern) {
                tg.showAlert("A template must have a model, backdrop, and symbol selected.");
                return;
            }
        
            const templateName = prompt("Enter a name for this template:", `${gift.model.name} Combo`);
            if (!templateName) return;
            
            const newTemplate = {
                id: `template_${Date.now()}`,
                name: templateName,
                config: JSON.parse(JSON.stringify(gift))
            };
        
            savedTemplates.unshift(newTemplate);
            localStorage.setItem('savedTemplates' + APP_VERSION_SUFFIX, JSON.stringify(savedTemplates));
            tg.HapticFeedback.notificationOccurred('success');
            tg.showAlert(`Template "${templateName}" saved!`);
        }
        
        function renderTemplateLibrary() {
            const container = document.getElementById('template-library-container');
            container.innerHTML = '';
            if (savedTemplates.length === 0) {
                container.innerHTML = '<p class="empty-grid-message">You have no saved templates.</p>';
                return;
            }
            savedTemplates.forEach(template => {
                const card = document.createElement('div');
                card.className = 'template-card';
                card.innerHTML = `
                    <img class="template-preview" src="${template.config.model.image || ''}" alt="">
                    <div class="template-info"><h4>${template.name}</h4></div>
                    <button class="template-delete-btn">🗑️</button>
                `;
                card.querySelector('.template-delete-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    deleteTemplate(template.id);
                });
                card.addEventListener('click', () => applyTemplate(template.config));
                container.appendChild(card);
            });
        }
        
        function applyTemplate(config) {
            pushToUndoHistory();
            giftCreationQueue[currentlyEditingGiftIndex] = JSON.parse(JSON.stringify(config));
            selectCustomBaseGift(config.id, config.name, config.originalImage, false);
            updateLivePreview();
            switchStudioTab('studio');
        }
        
        function deleteTemplate(templateId) {
            savedTemplates = savedTemplates.filter(t => t.id !== templateId);
            localStorage.setItem('savedTemplates' + APP_VERSION_SUFFIX, JSON.stringify(savedTemplates));
            renderTemplateLibrary();
        }
        
        function renderQuickPickBar() {
            // This is a placeholder for a more complex "most used" logic.
            // For now, it will just be empty.
            const quickPickBar = document.getElementById('quick-pick-bar');
            quickPickBar.innerHTML = ''; // Implement logic later if desired
        }
        
        async function handleCloneGiftFromStudio() {
            const cloneInput = document.getElementById('clone-url-input-studio');
            const userInput = cloneInput.value.trim();
            if (!userInput) return;
        
            if (ownedGifts.length >= GIFT_LIMIT_PER_USER) {
                tg.showAlert(`Cannot clone gift. Your inventory is full.`);
                return;
            }
        
            const originalText = cloneInput.placeholder;
            cloneInput.disabled = true;
            cloneInput.placeholder = "Cloning...";
        
            try {
                await callBackend('/api/gifts/clone', 'POST', {
                    url: userInput,
                    owner_id: currentAccountTgId
                });
                await initializeTelegramUserAccount();
                tg.HapticFeedback.notificationOccurred('success');
                tg.showAlert("Gift cloned successfully!");
                closeModal(customBuyModal);
                showPage('profile-page');
            } catch (error) {
                // Error is shown by callBackend
            } finally {
                cloneInput.disabled = false;
                cloneInput.value = '';
                cloneInput.placeholder = originalText;
            }
        }
        
        function handleQuickCreate(text) {
            // Placeholder for a text command feature.
            console.log("Quick Create triggered with:", text);
            tg.showAlert("Quick Create feature is not yet implemented.");
        }
        
        // --- END: COMPLETE CUSTOMIZATION STUDIO JAVASCRIPT BLOCK ---
        
        // In index.html, replace the entire populateBaseGiftOptions function with this new version.
        
        // --- START REPLACEMENT: Full populateBaseGiftOptions function ---
        function populateBaseGiftOptions(currentUserId) {
            // This is the corrected line:
            const modelsGrid = document.getElementById('custom-buy-models-grid');
            modelsGrid.innerHTML = ''; 
            
            const ADMIN_USER_ID = 5146625949;
        
            for (const id in allAvailableGifts) {
                const name = allAvailableGifts[id];
                const customGiftData = CUSTOM_GIFTS_DATA[name];
                
                if (customGiftData && !customGiftsEnabled) continue;
                
                if (customGiftData && customGiftData.limit && currentUserId !== ADMIN_USER_ID) {
                    continue; 
                }
        
                const originalImageUrl = customGiftData
                    ? customGiftData.defaultImage
                    : `${CDN_BASE_URL}originals/${id}/Original.png`;
        
                const item = document.createElement('div');
                item.className = 'filter-option';
                item.dataset.id = id;
                item.innerHTML = `<img src="${originalImageUrl}" alt="${name}" loading="lazy"><div class="label">${name}</div>`;
                
                // This now calls the correct function to handle the next step
                item.addEventListener('click', () => handlePartSelection('model', {id: id, name: name}));
        
                modelsGrid.appendChild(item);
            }
        }
        // --- END REPLACEMENT ---

        function renderGiftQueue() {
            giftQueueContainer.innerHTML = '';
            giftCreationQueue.forEach((gift, index) => {
                const item = document.createElement('button');
                item.className = 'gift-queue-item';
                item.textContent = gift.name || `Gift ${index + 1}`;
                if (index === currentlyEditingGiftIndex) {
                    item.classList.add('active');
                }
                
                const removeBtn = document.createElement('span');
                removeBtn.className = 'remove-queue-item';
                removeBtn.textContent = '×';
                removeBtn.onclick = (e) => {
                    e.stopPropagation();
                    removeGiftFromQueue(index);
                };
                
                item.appendChild(removeBtn);
                item.onclick = () => editGiftInQueue(index);
                giftQueueContainer.appendChild(item);
            });
            updateCreateButtonState();
        }
    
        
        function updateCurrentGiftInQueue(updates) {
            if (currentlyEditingGiftIndex > -1) {
                Object.assign(giftCreationQueue[currentlyEditingGiftIndex], updates);
                renderGiftQueue();
            }
            updateCreateButtonState();
        }

        async function selectCustomBaseGift(id, name, originalImage, resetParts = true) {
            const currentGift = giftCreationQueue[currentlyEditingGiftIndex];
            
            if (resetParts) {
                currentGift.model = null;
                currentGift.backdrop = null;
                currentGift.pattern = null;
            }
            updateCurrentGiftInQueue({ id, name, originalImage });

            customBuyModelsGrid.innerHTML = ''; customBuyBackdropsGrid.innerHTML = ''; customBuyPatternsGrid.innerHTML = '';
            
            const customGiftInfo = CUSTOM_GIFTS_DATA[name];
            updateCurrentGiftInQueue({lottiePath: customGiftInfo ? null : `${CDN_BASE_URL}originals/${id}/Original.json`});

            if (!cachedCollectibleParts[id]) {
                 if (customGiftInfo) {
                    const backdropsSourceName = customGiftInfo.backdrops_source;
                    const patternsSourceName = customGiftInfo.patterns_source;
                    try {
                        const parts = await Promise.all([
                            fetch(`${CDN_BASE_URL}backdrops/${encodeURIComponent(backdropsSourceName)}/backdrops.json`).then(res => res.ok ? res.json() : []),
                            fetch(`${CDN_BASE_URL}patterns/${encodeURIComponent(patternsSourceName)}/patterns.json`).then(res => res.ok ? res.json() : [])
                        ]);
                        cachedCollectibleParts[id] = { models: customGiftInfo.models, backdrops: parts[0], patterns: parts[1] };
                    } catch (e) { cachedCollectibleParts[id] = { models: customGiftInfo.models, backdrops: [], patterns: [] }; }
                } else {
                    try {
                        const giftNameEncoded = encodeURIComponent(name);
                        const partsData = await Promise.all([
                            fetch(`${CDN_BASE_URL}models/${giftNameEncoded}/models.json`).then(res => res.ok ? res.json() : []),
                            fetch(`${CDN_BASE_URL}backdrops/${giftNameEncoded}/backdrops.json`).then(res => res.ok ? res.json() : []),
                            fetch(`${CDN_BASE_URL}patterns/${giftNameEncoded}/patterns.json`).then(res => res.ok ? res.json() : [])
                        ]);
                        cachedCollectibleParts[id] = { models: partsData[0], backdrops: partsData[1], patterns: partsData[2] };
                    } catch (e) { cachedCollectibleParts[id] = { models: [], backdrops: [], patterns: [] }; }
                }
            }

            populatePartSelector(id, name);
            
            if (resetParts && cachedCollectibleParts[id].patterns.length > 0) {
                const randomPattern = getRandomElement(cachedCollectibleParts[id].patterns);
                if (randomPattern) {
                    selectCustomPart('pattern', randomPattern);
                }
            }
        }

        // --- END UPDATE: New Customization Studio Functions ---
        
        function populatePartSelector(id, name) {
            let { models, backdrops, patterns } = cachedCollectibleParts[id];
            
            models = [...models].sort((a, b) => (a.rarityPermille || 999) - (b.rarityPermille || 999));
            
            const pinnedBackdropNames = ['Black', 'Onyx Black', 'Midnight Blue', 'Electric Purple', 'Amber', 'Cyberpunk'];
            backdrops = [...backdrops].sort((a, b) => {
                const aIndex = pinnedBackdropNames.indexOf(a.name);
                const bIndex = pinnedBackdropNames.indexOf(b.name);
                if (aIndex !== -1 && bIndex !== -1) return aIndex - bIndex;
                if (aIndex !== -1) return -1;
                if (bIndex !== -1) return 1; 
                return a.name.localeCompare(b.name);
            });

            const customData = CUSTOM_GIFTS_DATA[name];
            const patternSourceName = customData ? customData.patterns_source : name;
            const currentGift = giftCreationQueue[currentlyEditingGiftIndex];

            const populateGrid = (grid, section, items, type, getImagePathFn) => {
                grid.innerHTML = '';
                if (items.length > 0) {
                    section.classList.remove('hidden');
                    items.forEach(item => {
                        const itemEl = document.createElement('div');
                        itemEl.className = 'filter-option';
                        itemEl.dataset.name = item.name;
                        const imagePath = getImagePathFn(item);
                        itemEl.innerHTML = type === 'backdrop' 
                            ? `<div class="gradient-square" style="background: radial-gradient(circle, ${item.hex.centerColor}, ${item.hex.edgeColor});"></div><div class="label">${item.name}</div>`
                            : `<img src="${imagePath}" alt="${item.name}" loading="lazy"><div class="label">${item.name}</div>`;
                        
                        if (currentGift[type] && currentGift[type].name === item.name) {
                            itemEl.classList.add('selected');
                        }
                        
                        itemEl.addEventListener('click', () => selectCustomPart(type, item));
                        grid.appendChild(itemEl);
                    });
                } else {
                    section.classList.add('hidden');
                }
            };
            
            populateGrid(customBuyModelsGrid, customBuyModelsSection, models, 'model', (item) => item.image || `${CDN_BASE_URL}models/${encodeURIComponent(name)}/png/${encodeURIComponent(item.name)}.png`);
            populateGrid(customBuyBackdropsGrid, customBuyBackdropsSection, backdrops, 'backdrop', (item) => null);
            populateGrid(customBuyPatternsGrid, customBuyPatternsSection, patterns, 'pattern', (item) => `${CDN_BASE_URL}patterns/${encodeURIComponent(patternSourceName)}/png/${encodeURIComponent(item.name)}.png`);
            
            document.getElementById('custom-buy-base-gifts-grid').classList.add('hidden');
            addAnotherGiftButton.style.display = 'block';
            updateCreateButtonState();
        }

        function selectCustomPart(type, data) {
            const grid = document.getElementById(`custom-buy-${type}s-grid`);
            Array.from(grid.children).forEach(el => el.classList.remove('selected'));
            const selectedElement = grid.querySelector(`[data-name="${data.name}"]`);
            if(selectedElement) selectedElement.classList.add('selected');
            updateCurrentGiftInQueue({ [type]: data });
        }
        
        function updateCreateButtonState() {
            const allGiftsValid = giftCreationQueue.every(gift => {
                if (!gift.id) return false;
                const partsInfo = cachedCollectibleParts[gift.id];
                if (!partsInfo) return false;
                return (partsInfo.models.length === 0 || !!gift.model) &&
                       (partsInfo.backdrops.length === 0 || !!gift.backdrop) &&
                       (partsInfo.patterns.length === 0 || !!gift.pattern);
            });
            
            customBuyConfirmButton.disabled = !allGiftsValid;
            const total = giftCreationQueue.length;
            customBuyConfirmButton.textContent = `Create ${total > 1 ? `${total} Gifts` : 'Gift'}`;
        }

        async function handleCloneGift() {
            const userInput = cloneUrlInput.value.trim();
            if (!userInput) { tg.showAlert("Please provide a link or gift name and number."); return; }
            if (ownedGifts.length >= GIFT_LIMIT_PER_USER) {
                tg.showAlert(`Cannot clone gift. Your inventory is full.`);
                return;
            }
            cloneGiftButton.disabled = true;
            cloneGiftButton.textContent = "Cloning...";
            try {
                await callBackend('/api/gifts/clone', 'POST', {
                    url: userInput,
                    owner_id: currentAccountTgId
                });
                await initializeTelegramUserAccount();
                tg.HapticFeedback.notificationOccurred('success');
                tg.showAlert("Gift cloned successfully!");
                closeModal(customBuyModal);
                showPage('profile-page');
            } catch (error) {
                // Error is shown by callBackend
            } finally {
                cloneGiftButton.disabled = false;
                cloneGiftButton.textContent = "Clone Gift";
            }
        }

        async function handleCalculateCollectionPrice() {
            closeSidebar();
            openModal(collectionPriceModal);
            
            // Reset UI and show spinner
            collectionPriceSpinner.classList.remove('hidden');
            collectionPriceTotal.textContent = '';
            collectionPriceInfo.textContent = 'Calculating total floor price...';
            collectionPriceList.innerHTML = '';
        
            try {
                const response = await callBackend('/api/account/collection_price', 'GET', null, {
                    tg_id: currentAccountTgId
                });
        
                if (response) {
                    const { total_price, priced_gifts } = response;
                    collectionPriceTotal.textContent = `${total_price.toLocaleString()} 💎`;
                    collectionPriceInfo.textContent = `Based on ${priced_gifts.length} priced collectibles.`;
        
                    if (priced_gifts.length > 0) {
                        priced_gifts.sort((a, b) => b.price - a.price); // Sort by highest price first
                        
                        priced_gifts.forEach(gift => {
                            const li = document.createElement('li');
                            const sourceLabel = gift.source === 'Direct Listing' ? '' : ` <small>(${gift.source})</small>`;
                            li.innerHTML = `<span>${gift.name}</span><span>${gift.price.toLocaleString()}💎${sourceLabel}</span>`;
                            collectionPriceList.appendChild(li);
                        });
                    } else {
                        collectionPriceList.innerHTML = '<p class="empty-grid-message">You have no collectible gifts to price.</p>';
                    }
                }
            } catch (error) {
                collectionPriceInfo.textContent = 'Could not calculate price. Please try again later.';
                console.error("Error calculating collection price:", error);
            } finally {
                collectionPriceSpinner.classList.add('hidden');
            }
        }
        
        async function handleCustomBuyConfirm() {
            if (customBuyConfirmButton.disabled) return;
            
            if (currentlyEditingGiftIndex > -1) {
                giftCreationQueue[currentlyEditingGiftIndex].quantity = parseInt(customBuyQuantityInput.value, 10) || 1;
            }

            const totalToCreate = giftCreationQueue.reduce((sum, gift) => sum + gift.quantity, 0);
            if (ownedGifts.length + totalToCreate > GIFT_LIMIT_PER_USER) {
                tg.showAlert(`Cannot create ${totalToCreate} gifts. Your inventory is full.`);
                return;
            }

            customBuyConfirmButton.disabled = true;
            customBuyConfirmButton.textContent = 'Creating...';

            try {
                for (const giftConfig of giftCreationQueue) {
                    for (let i = 0; i < giftConfig.quantity; i++) {
                        const newInstanceId = generateUniqueId();
                        await callBackend('/api/gifts', 'POST', {
                            instance_id: newInstanceId,
                            owner_id: currentAccountTgId,
                            gift_type_id: giftConfig.id,
                            gift_name: giftConfig.name,
                            original_image_url: giftConfig.originalImage,
                            lottie_path: giftConfig.lottiePath,
                        });
                        
                        const upgradePayload = {
                            instance_id: newInstanceId,
                            custom_model: giftConfig.model,
                            custom_backdrop: giftConfig.backdrop,
                        };
                        
                        if (giftConfig.quantity === 1) {
                            upgradePayload.custom_pattern = giftConfig.pattern;
                        }

                        await callBackend('/api/gifts/upgrade', 'POST', upgradePayload);
                    }
                }
                
                await initializeTelegramUserAccount();
                tg.HapticFeedback.notificationOccurred('success');
                tg.showAlert(`${totalToCreate} gift(s) created successfully!`);
                closeModal(customBuyModal); 
                showPage('profile-page');

            } catch (error) {
            } finally {
                customBuyConfirmButton.disabled = false;
                updateCreateButtonState();
            }
        }

        function handleTripleTap(e, filterType, value) {
            const now = Date.now(); const DURATION = 300;
            if (now - lastTap < DURATION) tapCount++; else tapCount = 1;
            lastTap = now;
            if (tapCount === 3) {
                tapCount = 0; tg.HapticFeedback.impactOccurred('medium');
                activeFilters = { collection: null, model: null, backdrop: null, pattern: null };
                if (value) { activeFilters[filterType] = value; tg.showAlert(`Showing gifts with ${filterType}: "${value}"`); }
                else { tg.showAlert(`Cannot apply filter: ${filterType} is undefined.`); return; }
                saveClientSideState(); renderProfileGifts(); updateActionToolbarVisibility(); closeModal(collectibleDetailModal);
            }
        }
        
        async function preloadImage(url) {
            return new Promise((resolve) => {
                if (!url) { resolve(); return; }
                const img = new Image(); img.crossOrigin = 'Anonymous'; img.src = url;
                img.onload = resolve;
                img.onerror = () => { console.warn(`Failed to preload image: ${url}`); resolve(); };
            });
        }

        async function handleShareImageAction() {
            longPressMenu.classList.add('hidden');
            if (!currentLongPressGift || !currentLongPressGift.is_collectible) { tg.showAlert("Cannot share an image for this gift."); return; }

            const giftForImage = currentLongPressGift;

            sendGeneratedImageButton.disabled = true;
            sendGeneratedImageButton.textContent = "Send to Me";
            generatedImageMessage.textContent = 'Generating image...';
            generatedImagePreview.src = '';
            openModal(generatedImageModal);

            const imageDataUrl = await generateGiftImage(giftForImage);

            if (imageDataUrl) {
                generatedImagePreview.src = imageDataUrl;
                generatedImageMessage.textContent = 'Image is ready. Click "Send to Me" to receive it via bot.';
                sendGeneratedImageButton.disabled = false;
                sendGeneratedImageButton.onclick = () => sendGeneratedImage(imageDataUrl, giftForImage);
                tg.HapticFeedback.notificationOccurred('success');
            } else {
                generatedImageMessage.textContent = 'Failed to generate image.';
                tg.HapticFeedback.notificationOccurred('error');
            }
            currentLongPressGift = null;
        }

        async function sendGeneratedImage(imageDataUrl, gift) {
            sendGeneratedImageButton.disabled = true;
            sendGeneratedImageButton.textContent = "Sending...";
            try {
                await callBackend('/api/gifts/send_image', 'POST', {
                    imageDataUrl: imageDataUrl,
                    userId: currentAccountTgId,
                    caption: `Your generated image for ${gift.gift_name} #${gift.collectible_number.toLocaleString()}`
                });
                tg.HapticFeedback.notificationOccurred('success');
                tg.showAlert("Image sent! Check your chat with the bot.");
                closeModal(generatedImageModal);
            } catch (error) {
                sendGeneratedImageButton.disabled = false;
                sendGeneratedImageButton.textContent = "Send to Me";
            }
        }

        async function generateGiftImage(gift) {
            const cd = gift.collectible_data; if (!cd) return null;
            await Promise.all([ preloadImage(cd.modelImage || gift.original_image_url), preloadImage(cd.patternImage) ]);
            const tempContainer = document.createElement('div');
            tempContainer.style.position = 'absolute'; tempContainer.style.left = '-9999px'; tempContainer.style.top = '-9999px';
            tempContainer.style.width = '450px'; tempContainer.style.height = '600px';
            tempContainer.style.display = 'flex'; tempContainer.style.flexDirection = 'column';
            tempContainer.style.alignItems = 'center'; tempContainer.style.justifyContent = 'flex-start';
            tempContainer.style.padding = '30px'; tempContainer.style.boxSizing = 'border-box';
            tempContainer.style.fontFamily = '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif';
            if (cd.backdropColors) tempContainer.style.background = `radial-gradient(circle at 50% 0%, ${cd.backdropColors.centerColor} 0%, ${cd.backdropColors.edgeColor} 100%)`;
            else tempContainer.style.background = 'linear-gradient(45deg, #2a3745, #17212b)';
            const textColor = '#ffffff';
            if (cd.patternImage) {
                const patternOverlay = document.createElement('div');
                patternOverlay.style.position = 'absolute'; patternOverlay.style.top = '0'; patternOverlay.style.left = '0';
                patternOverlay.style.width = '100%'; patternOverlay.style.height = '100%';
                patternOverlay.style.backgroundImage = `url('${cd.patternImage}')`;
                patternOverlay.style.backgroundRepeat = 'repeat'; patternOverlay.style.backgroundSize = '30% auto';
                patternOverlay.style.opacity = '0.07'; tempContainer.appendChild(patternOverlay);
            }
            const giftModelContainer = document.createElement('div');
            giftModelContainer.style.width = '70%'; giftModelContainer.style.height = 'auto'; giftModelContainer.style.aspectRatio = '1 / 1';
            giftModelContainer.style.display = 'flex'; giftModelContainer.style.alignItems = 'center'; giftModelContainer.style.justifyContent = 'center';
            giftModelContainer.style.position = 'relative'; giftModelContainer.style.zIndex = '10'; giftModelContainer.style.marginBottom = '20px';
            const modelImageEl = document.createElement('img'); modelImageEl.src = cd.modelImage || gift.original_image_url;
            modelImageEl.style.maxWidth = '100%'; modelImageEl.style.maxHeight = '100%'; modelImageEl.style.objectFit = 'contain';
            giftModelContainer.appendChild(modelImageEl); tempContainer.appendChild(giftModelContainer);
            const upgradedGiftText = document.createElement('div');
            upgradedGiftText.textContent = 'Upgraded Gift'; upgradedGiftText.style.fontSize = '2.2em'; upgradedGiftText.style.fontWeight = '600';
            upgradedGiftText.style.color = textColor; upgradedGiftText.style.marginBottom = '10px'; upgradedGiftText.style.position = 'relative';
            upgradedGiftText.style.zIndex = '10'; tempContainer.appendChild(upgradedGiftText);
            const giftNameAndNumber = document.createElement('div');
            giftNameAndNumber.textContent = `${gift.gift_name} #${gift.collectible_number}`; giftNameAndNumber.style.fontSize = '1.8em'; giftNameAndNumber.style.fontWeight = '500';
            giftNameAndNumber.style.color = textColor; giftNameAndNumber.style.opacity = '0.9'; giftNameAndNumber.style.marginBottom = '25px';
            giftNameAndNumber.style.position = 'relative'; giftNameAndNumber.style.zIndex = '10'; tempContainer.appendChild(giftNameAndNumber);
            const infoSection = document.createElement('div');
            infoSection.style.display = 'flex'; infoSection.style.flexDirection = 'column'; infoSection.style.alignItems = 'flex-start';
            infoSection.style.width = '80%'; infoSection.style.position = 'relative'; infoSection.style.zIndex = '10';
            const createInfoRow = (label, value) => {
                const row = document.createElement('div'); row.style.display = 'flex'; row.style.justifyContent = 'space-between';
                row.style.width = '100%'; row.style.marginBottom = '10px';
                const labelEl = document.createElement('span'); labelEl.textContent = label; labelEl.style.fontSize = '1.2em';
                labelEl.style.fontWeight = 'normal'; labelEl.style.color = textColor; row.appendChild(labelEl);
                const valueEl = document.createElement('span'); valueEl.textContent = value; valueEl.style.fontSize = '1.2em';
                valueEl.style.fontWeight = '500'; valueEl.style.color = textColor; valueEl.style.opacity = '0.7'; row.appendChild(valueEl);
                return row;
            };
            infoSection.appendChild(createInfoRow('Model', cd.model?.name || 'N/A'));
            infoSection.appendChild(createInfoRow('Backdrop', cd.backdrop?.name || 'N/A'));
            infoSection.appendChild(createInfoRow('Symbol', cd.pattern?.name || 'N/A'));
            tempContainer.appendChild(infoSection); document.body.appendChild(tempContainer);
            let dataUrl = null;
            try {
                const canvas = await html2canvas(tempContainer, { backgroundColor: null, scale: 1.5, useCORS: true });
                dataUrl = canvas.toDataURL('image/png');
            } catch (error) { console.error("Error generating image:", error); }
            finally { document.body.removeChild(tempContainer); }
            return dataUrl;
        }

        let currentGiftForChances = null; let selectedChances = { model: null, backdrop: null, pattern: null };
        async function openChancesModal(gift) {
            closeModal(giftDetailModal); currentGiftForChances = gift;
            selectedChances = { model: null, backdrop: null, pattern: null };
            chancesGiftName.textContent = `For gift: "${gift.gift_name}"`;
            chancesLoadingSpinner.classList.remove('hidden');
            chancesModelsSection.classList.add('hidden'); chancesBackdropsSection.classList.add('hidden');
            chancesPatternsSection.classList.add('hidden'); chancesProbabilityDisplay.innerHTML = '';
            openModal(chancesModal); calculateAndDisplayChances();

            if (!cachedCollectibleParts[gift.gift_type_id]) {
                await selectCustomBaseGift(gift.gift_type_id, gift.gift_name);
            }
            chancesLoadingSpinner.classList.add('hidden');
            populateChancesOptions(gift.gift_type_id, gift.gift_name);
        }

        function populateChancesOptions(giftTypeId, giftName) {
            const { models, backdrops, patterns } = cachedCollectibleParts[giftTypeId];
            if (models.length > 0) { renderChanceOptions(chancesOptionsModels, models, 'model', giftName); chancesModelsSection.classList.remove('hidden'); }
            if (backdrops.length > 0) { renderChanceOptions(chancesOptionsBackdrops, backdrops, 'backdrop', giftName); chancesBackdropsSection.classList.remove('hidden'); }
            if (patterns.length > 0) { renderChanceOptions(chancesOptionsPatterns, patterns, 'pattern', giftName); chancesPatternsSection.classList.remove('hidden'); }
        }
        function renderChanceOptions(container, items, type, giftName) {
            container.innerHTML = '';
            const customData = CUSTOM_GIFTS_DATA[giftName];
            const patternSourceName = customData ? customData.patterns_source : giftName;

            items.forEach(itemData => {
                const optionEl = document.createElement('div');
                optionEl.className = 'filter-option';
                let innerHTML = '';
                if (type === 'model') {
                     const modelImage = itemData.image || `${CDN_BASE_URL}models/${encodeURIComponent(giftName)}/png/${encodeURIComponent(itemData.name)}.png`;
                     innerHTML = `<img src="${modelImage}" alt="${itemData.name}" loading="lazy"><div class="label">${itemData.name}</div>`;
                } else if (type === 'backdrop') {
                     innerHTML = `<div class="gradient-square" style="background: radial-gradient(circle, ${itemData.hex.centerColor}, ${itemData.hex.edgeColor});"></div><div class="label">${itemData.name}</div>`;
                } else if (type === 'pattern') {
                     const patternImage = `${CDN_BASE_URL}patterns/${encodeURIComponent(patternSourceName)}/png/${encodeURIComponent(itemData.name)}.png`;
                     innerHTML = `<img src="${patternImage}" alt="${itemData.name}" loading="lazy"><div class="label">${itemData.name}</div>`;
                }
                optionEl.innerHTML = innerHTML;
                optionEl.addEventListener('click', () => handleChanceSelection(optionEl, container, type, itemData));
                container.appendChild(optionEl);
            });
        }

        function handleChanceSelection(element, container, type, data) {
            const isSelected = element.classList.contains('selected');
            Array.from(container.children).forEach(el => el.classList.remove('selected'));

            if(isSelected) {
                selectedChances[type] = null;
            } else {
                element.classList.add('selected');
                selectedChances[type] = data;
            }
            calculateAndDisplayChances();
        }

        function calculateAndDisplayChances() {
            let totalProbability = 1.0;
            const selectedParts = [];

            if (selectedChances.model) {
                totalProbability *= ((selectedChances.model.rarityPermille || 1) / 1000);
                selectedParts.push(`Model: ${selectedChances.model.name}`);
            }
             if (selectedChances.backdrop) {
                totalProbability *= ((selectedChances.backdrop.rarityPermille || 1) / 1000);
                selectedParts.push(`Backdrop: ${selectedChances.backdrop.name}`);
            }
             if (selectedChances.pattern) {
                totalProbability *= ((selectedChances.pattern.rarityPermille || 1) / 1000);
                selectedParts.push(`Symbol: ${selectedChances.pattern.name}`);
            }

            if (selectedParts.length === 0) {
                 chancesProbabilityDisplay.innerHTML = `<span class="prob-details">Select one or more parts to calculate the chance of getting them together.</span>`;
            } else {
                const probabilityPercent = totalProbability * 100;
                const oneInX = Math.round(1 / totalProbability);
                let displayPercent = probabilityPercent.toExponential(2);
                if (probabilityPercent > 0.0001) {
                    displayPercent = probabilityPercent.toPrecision(3) + '%';
                } else {
                    displayPercent += '%';
                }

                chancesProbabilityDisplay.innerHTML = `
                    <span class="prob-value">${displayPercent}</span>
                    <span class="prob-details">1 in ${oneInX.toLocaleString('en-US')}<br>${selectedParts.join('<br>')}</span>`;
            }
        }

        function openSellModal(gift) {
            if (!gift || !gift.is_collectible || gift.owner_id !== currentAccountTgId) return;
            currentGiftToSell = gift;
            closeModal(collectibleDetailModal);
        
            sellGiftImage.src = gift.collectible_data.modelImage || gift.original_image_url;
            sellGiftName.textContent = `${gift.gift_name} #${gift.collectible_number}`;
            sellPriceInput.value = '';
            sellReceiveAmount.textContent = 'You will receive...';
            sellUsdAmount.textContent = '';
            confirmSellButton.disabled = true;
        
            openModal(sellGiftModal);
            setTimeout(() => sellPriceInput.focus(), 250);
        }

        function updateSellPriceDetails() {
            const price = parseInt(sellPriceInput.value, 10);
            if (!isNaN(price) && price >= MIN_SALE_PRICE && price <= MAX_SALE_PRICE) {
                const commission = 0.20;
                const received = Math.floor(price * (1 - commission));
                const usdEquivalent = (price * 0.013).toFixed(2);

                sellReceiveAmount.textContent = `You will receive ${received} Stars.`;
                sellUsdAmount.textContent = `≈US$${usdEquivalent}`;
                confirmSellButton.disabled = false;
            } else {
                sellReceiveAmount.textContent = 'You will receive...';
                sellUsdAmount.textContent = '';
                confirmSellButton.disabled = true;
            }
        }

        async function handleConfirmSell() {
            if (!currentGiftToSell || confirmSellButton.disabled) return;
            const price = parseInt(sellPriceInput.value, 10);
            const giftToUpdate = ownedGifts.find(g => g.instance_id === currentGiftToSell.instance_id);
            if (!giftToUpdate) return;
            
            // Optimistic UI Update
            giftToUpdate.is_on_sale = true;
            giftToUpdate.sale_price = price;
            renderProfileGifts();
            closeModal(sellGiftModal);
            tg.HapticFeedback.notificationOccurred('success');
            tg.showAlert(`Gift "${currentGiftToSell.gift_name}" successfully listed for ${price} Stars.`);
        
            // Backend call
            try {
                await callBackend(`/api/gifts/${currentGiftToSell.instance_id}`, 'PUT', {
                    action: 'sell',
                    value: true,
                    price: price
                });
            } catch (error) {
                // Revert on failure
                giftToUpdate.is_on_sale = false;
                delete giftToUpdate.sale_price;
                renderProfileGifts();
            }
        }

        function openTransferModal(gift) {
            if (!gift || !gift.is_collectible) return;
            if (gift.owner_id !== currentAccountTgId) return;
            currentGiftToTransfer = gift;
            closeModal(collectibleDetailModal);

            transferModalTitle.textContent = "Transfer Gift";
            transferGiftImage.src = gift.collectible_data.modelImage || gift.original_image_url;
            transferGiftImage.classList.remove('hidden');
            transferGiftName.classList.remove('hidden');
            transferUsernameInput.value = '';
            transferCommentInput.value = '';
            confirmTransferButton.disabled = true;
            transferStatusMessage.innerHTML = '<p>Gift ownership will be transferred to this username.</p>';

            openModal(transferGiftModal);
            setTimeout(() => transferUsernameInput.focus(), 250);
        }

        function handleConfirmTransfer() {
            if (!currentGiftToTransfer || confirmTransferButton.disabled) return;
            const receiverUsername = transferUsernameInput.value.trim();
            const comment = transferCommentInput.value.trim();

            if (!receiverUsername) { transferStatusMessage.innerHTML = '<p style="color:red;">Please enter a username.</p>'; return; }
            const currentAccount = accounts.find(acc => acc.tg_id === currentAccountTgId);
            if (receiverUsername.toLowerCase() === currentAccount?.username.toLowerCase()) {
                transferStatusMessage.innerHTML = '<p style="color:red;">Cannot transfer to yourself.</p>';
                return;
            }

            confirmTransferButton.disabled = true;
            confirmTransferButton.textContent = 'Transferring...';

            const giftIndex = ownedGifts.findIndex(g => g.instance_id === currentGiftToTransfer.instance_id);
            if (giftIndex === -1) {
                confirmTransferButton.disabled = false;
                confirmTransferButton.textContent = 'Confirm Transfer';
                return;
            }

            const removedGift = ownedGifts.splice(giftIndex, 1)[0];
            renderProfileGifts();
            closeModal(transferGiftModal);

            callBackend('/api/gifts/transfer', 'POST', {
                instance_id: currentGiftToTransfer.instance_id,
                receiver_username: receiverUsername,
                sender_id: currentAccountTgId,
                comment: comment
            }).then(() => {
                tg.HapticFeedback.notificationOccurred('success');
                tg.showAlert(`Gift transferred to @${receiverUsername}!`);
            }).catch(error => {
                tg.HapticFeedback.notificationOccurred('error');
                ownedGifts.splice(giftIndex, 0, removedGift);
                renderProfileGifts();
            });
        }

        // --- Collectible Numbers & Usernames ---
        function generateRandom888Number() {
            const part1 = Math.floor(Math.random() * 10000).toString().padStart(4, '0');
            const part2 = Math.floor(Math.random() * 10000).toString().padStart(4, '0');
            return `+888 ${part1} ${part2}`;
        }

        async function handleOpenNumbersModal() {
            numbersList.innerHTML = '';
            const allPossibleNumbers = [...coolNumbers];
            for (let i = 0; i < 20; i++) { allPossibleNumbers.push(generateRandom888Number()); }
    
            const currentAccount = accounts.find(acc => acc.tg_id === currentAccountTgId);
            const userPhoneNumber = currentAccount?.phone_number;
            // The backend will enforce uniqueness, this just prevents showing owned number in list
            const availableNumbers = [...new Set(allPossibleNumbers)].filter(n => n !== userPhoneNumber);
    
            if (availableNumbers.length === 0) {
                numbersList.innerHTML = '<p class="empty-grid-message">No numbers available.</p>';
            } else {
                availableNumbers.forEach(num => {
                    const li = document.createElement('li');
                    li.className = 'collectible-list-item';
                    // --- NEW: Display price ---
                    li.innerHTML = `${num} <span style="color:var(--tg-theme-hint-color); font-size: 0.8em; margin-left: auto;">(⭐ 25,000)</span>`;
                    li.style.display = 'flex';
                    li.style.alignItems = 'center';
                    li.addEventListener('click', () => buyNumber(num));
                    numbersList.appendChild(li);
                });
            }
            closeSidebar();
            openModal(numbersModal);
        }

        async function buyNumber(number) {
            const cost = 25000;
            const currentAccount = accounts.find(acc => acc.tg_id === currentAccountTgId);
            if (!currentAccount || currentAccount.stars_balance < cost) {
                tg.showAlert(`You need ${cost.toLocaleString()} Stars to buy this number. Your balance is ${parseFloat(currentAccount.stars_balance || 0).toLocaleString()}.`);
                return;
            }
    
            tg.showConfirm(`Buy the number ${number} for ${cost.toLocaleString()} Stars?`, async (confirmed) => {
                if(confirmed) {
                    try {
                        await callBackend(`/api/account`, 'PUT', {
                            tg_id: currentAccountTgId,
                            phone_number: number
                        });
    
                        await initializeTelegramUserAccount(); // Refreshes data including new balance
                        tg.HapticFeedback.notificationOccurred('success');
                        tg.showAlert(`Number ${number} purchased successfully!`);
                        closeModal(numbersModal);
                    } catch (error) {
                        // Error is handled by callBackend
                    }
                }
            });
        }

        async function handleOpenUsernamesModal() {
            await populateUsernamesList();
            usernameSearchInput.value = '';
            closeSidebar();
            openModal(usernamesModal);
        }

        async function populateUsernamesList(searchTerm = '') {
            usernamesList.innerHTML = '';
            let listToShow = [];

            if (searchTerm) {
                listToShow = [searchTerm.toLowerCase().replace(/[^a-z0-9_]/g, '')].filter(Boolean);
            } else {
                const shuffled = [...coolUsernames].sort(() => 0.5 - Math.random());
                listToShow = shuffled.slice(0, 25);
            }

            const currentAccount = accounts.find(acc => acc.tg_id === currentAccountTgId);
            const ownedUsernames = currentAccount?.collectible_usernames || [];
            const filteredList = listToShow.filter(uname => !ownedUsernames.includes(uname));

            if (filteredList.length === 0) {
                usernamesList.innerHTML = '<p class="empty-grid-message">No usernames available.</p>';
            } else {
                filteredList.forEach(uname => {
                    const li = document.createElement('li');
                    li.className = 'collectible-list-item';
                    li.innerHTML = `<span class="at-symbol">@</span>${uname}`;
                    li.addEventListener('click', () => buyUsername(uname));
                    usernamesList.appendChild(li);
                });
            }
        }

        async function buyUsername(username) {
            const cost = 10000;
            const currentAccount = accounts.find(acc => acc.tg_id === currentAccountTgId);
            if (!currentAccount || currentAccount.stars_balance < cost) {
                tg.showAlert(`You need ${cost.toLocaleString()} Stars to buy a username. Your balance is ${parseFloat(currentAccount.stars_balance || 0).toLocaleString()}.`);
                return;
            }
    
            if (currentAccount.collectible_usernames && currentAccount.collectible_usernames.length >= MAX_COLLECTIBLE_USERNAMES) {
                tg.showAlert(`Username limit reached (${MAX_COLLECTIBLE_USERNAMES}).`);
                return;
            }
    
            tg.showConfirm(`Buy the username @${username} for ${cost.toLocaleString()} Stars?`, async (confirmed) => {
                if(confirmed) {
                    try {
                        await callBackend('/api/collectible_usernames', 'POST', {
                            owner_id: currentAccountTgId,
                            username: username
                        });

                        await initializeTelegramUserAccount();
                        tg.HapticFeedback.notificationOccurred('success');
                        tg.showAlert(`Username @${username} purchased successfully!`);
                        closeModal(usernamesModal);
                    } catch (error) {
                        tg.HapticFeedback.notificationOccurred('error');
                    }
                }
            });
        }

        async function handleDeleteCollectibleUsername(username) {
             tg.showConfirm(`Are you sure you want to delete the username @${username}?`, async (confirmed) => {
                if(confirmed) {
                    try {
                        await callBackend(`/api/collectible_usernames/${username}`, 'DELETE', { owner_id: currentAccountTgId });
                        await initializeTelegramUserAccount();
                        tg.HapticFeedback.notificationOccurred('success');
                        tg.showAlert(`Username @${username} has been deleted.`);
                    } catch (error) {
                        tg.HapticFeedback.notificationOccurred('error');
                    }
                }
            });
        }

        async function handleEditBio() {
            const currentAccount = accounts.find(acc => acc.tg_id === currentAccountTgId);
            if (!currentAccount) return;
            const newBio = prompt("Enter your new bio:", currentAccount.bio);
            if (newBio !== null) {
                try {
                    await callBackend('/api/account', 'PUT', { tg_id: currentAccountTgId, bio: newBio });
                    await initializeTelegramUserAccount();
                } catch (error) {
                    console.error(error);
                }
            }
        }

        async function handleAvatarUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    await callBackend('/api/account', 'PUT', { tg_id: currentAccountTgId, avatar_url: e.target.result });
                    await initializeTelegramUserAccount();
                } catch (error) {
                    console.error(error);
                }
            };
            reader.readAsDataURL(file);
        }

        function switchTab(tabName) {
            [giftsTabButton, postsTabButton, buyGiftsTabButton].forEach(btn => btn.classList.remove('active'));
            [giftsContent, postsContent].forEach(content => content.classList.remove('active'));
            newPostFab.classList.add('hidden');

            if (tabName === 'gifts') {
                giftsTabButton.classList.add('active');
                giftsContent.classList.add('active');
            } else if (tabName === 'posts') {
                postsTabButton.classList.add('active');
                postsContent.classList.add('active');
                if (viewingOwnProfile) newPostFab.classList.remove('hidden');
            } else if (tabName === 'buy-gifts') {
                buyGiftsTabButton.classList.add('active');
                giftsContent.classList.add('active'); // Keep gifts visible as a base
                showPage('buy-gifts-page');
            }
        }

        function openSettingsModal() { openModal(settingsModal); }

        function copyGiftLink(gift) {
            const link = getGiftDeepLink(gift);
            navigator.clipboard.writeText(link).then(() => {
                tg.HapticFeedback.notificationOccurred('success');
                tg.showAlert('Link copied to clipboard!');
            }, () => {
                tg.HapticFeedback.notificationOccurred('error');
                tg.showAlert('Failed to copy link.');
            });
            longPressMenu.classList.add('hidden');
        }

        // --- Reorder Logic ---
        function enterReorderMode() {
            if (!viewingOwnProfile) return;
            reorderModeActive = true;
            longPressMenu.classList.add('hidden');
            exitReorderModeButton.classList.remove('hidden');
            updateActionToolbarVisibility();
            giftsGrid.classList.add('reordering');
            
            // We call renderProfileGifts to ensure the grid is correctly sorted before making it draggable
            renderProfileGifts(); 
        
            sortableInstance = new Sortable(giftsGrid, {
                animation: 150,
                filter: '.gift-card:not([data-pinned="true"])',
                preventOnFilter: true,
                // --- NEW: This is the magic that keeps pinned items separate ---
                onMove: function (evt) {
                    // Allow dragging a pinned item (evt.dragged) ONLY over another pinned item (evt.related).
                    // This prevents pinned items from being moved into the unpinned section.
                    return evt.related.dataset.pinned === 'true';
                }
                // --- END NEW ---
            });
        }

        async function exitReorderMode() {
            reorderModeActive = false;
            if (sortableInstance) sortableInstance.destroy();
            sortableInstance = null;
            exitReorderModeButton.classList.add('hidden');
            giftsGrid.classList.remove('reordering');
            
            const newOrderIds = Array.from(giftsGrid.querySelectorAll('.gift-card[data-pinned="true"]')).map(el => el.dataset.instanceId);
            newOrderIds.forEach((id, index) => {
                const gift = ownedGifts.find(g => g.instance_id === id);
                if (gift) gift.pin_order = index;
            });
            
            renderProfileGifts();
        
            try {
                await callBackend('/api/gifts/reorder', 'POST', {
                    owner_id: currentAccountTgId,
                    ordered_instance_ids: newOrderIds
                });
            } catch (error) {
                await initializeTelegramUserAccount();
            }
        }

        // --- Selection Mode Logic ---
        function enterSelectionMode(action) {
            closeModal(settingsModal);
            if (!viewingOwnProfile) return;
            selectionModeActive = true;
            selectionAction = action;
            selectedGiftIds.clear();

            exitSelectionModeButton.classList.remove('hidden');
            if (action === 'hide') hideSelectedGiftsButton.classList.remove('hidden');
            else if (action === 'transfer') transferSelectedGiftsButton.classList.remove('hidden');
            renderProfileGifts();
        }

        function exitSelectionMode() {
            selectionModeActive = false;
            selectionAction = null;
            selectedGiftIds.clear();

            exitSelectionModeButton.classList.add('hidden');
            hideSelectedGiftsButton.classList.add('hidden');
            transferSelectedGiftsButton.classList.add('hidden');
            updateActionToolbarVisibility();

            renderProfileGifts();
        }

        function toggleGiftSelection(instanceId) {
            const card = giftsGrid.querySelector(`.gift-card[data-instance-id="${instanceId}"]`);
            if (!card) return;

            if (selectedGiftIds.has(instanceId)) {
                selectedGiftIds.delete(instanceId);
                card.classList.remove('selected');
            } else {
                selectedGiftIds.add(instanceId);
                card.classList.add('selected');
            }
            const count = selectedGiftIds.size;
            if (selectionAction === 'hide') {
                hideSelectedGiftsButton.textContent = `Hide (${count})`;
                hideSelectedGiftsButton.disabled = count === 0;
            } else if (selectionAction === 'transfer') {
                transferSelectedGiftsButton.textContent = `Transfer (${count})`;
                transferSelectedGiftsButton.disabled = count === 0;
            }
        }

        async function handleHideMultiple() {
            if (selectedGiftIds.size === 0) return;
            const idsToHide = Array.from(selectedGiftIds);

            exitSelectionMode();
            tg.showConfirm(`Are you sure you want to hide ${idsToHide.length} selected gifts?`, async (confirmed) => {
                if (confirmed) {
                    const originalGifts = JSON.parse(JSON.stringify(ownedGifts));
                    ownedGifts.forEach(g => {
                        if (idsToHide.includes(g.instance_id)) g.is_hidden = true;
                    });
                    renderProfileGifts();
                    tg.HapticFeedback.notificationOccurred('success');

                    try {
                        await callBackend('/api/gifts/batch_action', 'POST', {
                            action: 'hide',
                            instance_ids: idsToHide,
                            owner_id: currentAccountTgId
                        });
                        await initializeTelegramUserAccount();
                    } catch (error) {
                        tg.HapticFeedback.notificationOccurred('error');
                        ownedGifts = originalGifts;
                        renderProfileGifts();
                    }
                }
            });
        }

        function handleTransferMultiple() {
            if (selectedGiftIds.size === 0) return;

            openModal(transferGiftModal);
            transferModalTitle.textContent = `Transfer ${selectedGiftIds.size} Gifts`;
            transferGiftImage.classList.add('hidden');
            transferGiftName.classList.add('hidden');

            confirmTransferButton.onclick = async () => {
                 if (confirmTransferButton.disabled) return;
                 const receiverUsername = transferUsernameInput.value.trim();
                 const comment = transferCommentInput.value.trim();
                 const idsToTransfer = Array.from(selectedGiftIds);

                 if (!receiverUsername) { transferStatusMessage.innerHTML = '<p style="color:red;">Please enter a username.</p>'; return; }

                 confirmTransferButton.disabled = true;
                 confirmTransferButton.textContent = 'Transferring...';

                 try {
                     await callBackend('/api/gifts/batch_action', 'POST', {
                         action: 'transfer',
                         instance_ids: idsToTransfer,
                         owner_id: currentAccountTgId,
                         receiver_username: receiverUsername,
                         comment: comment
                     });
                     tg.HapticFeedback.notificationOccurred('success');
                     tg.showAlert(`${idsToTransfer.length} gifts transferred successfully!`);
                     await initializeTelegramUserAccount();
                 } catch (error) {
                     console.error(error);
                 } finally {
                     closeModal(transferGiftModal);
                     exitSelectionMode();
                 }
            };
        }

        // --- GIVEAWAY ---
        function openGiveawaySetupModal() {
            closeSidebar();
            openModal(giveawaySetupModal);
        }
        function populateGiveawaySetupModal() {
            giveawayGiftSelectionGrid.innerHTML = '';
            giveawayChannelsInput.value = '';
            selectedGiveawayGifts.clear();
            confirmGiveawaySetupButton.disabled = true;

            const collectibleGifts = ownedGifts.filter(g => g.is_collectible && !g.is_hidden);
            if (collectibleGifts.length === 0) {
                giveawayGiftSelectionGrid.innerHTML = '<p class="empty-grid-message">You have no collectible gifts to give away.</p>';
                return;
            }

            collectibleGifts.forEach(gift => {
                const card = createGiftCardDOM(gift);
                card.onclick = () => {
                    const id = gift.instance_id;
                    if (selectedGiveawayGifts.has(id)) {
                        selectedGiveawayGifts.delete(id);
                        card.classList.remove('selected');
                    } else {
                        selectedGiveawayGifts.add(id);
                        card.classList.add('selected');
                    }
                    confirmGiveawaySetupButton.disabled = selectedGiveawayGifts.size === 0;
                };
                giveawayGiftSelectionGrid.appendChild(card);
                observeLottieElement(card);
            });
        }
        async function handleConfirmGiveawaySetup() {
            if (selectedGiveawayGifts.size === 0) return;
            const winnerRule = document.querySelector('input[name="winner-rule"]:checked').value;
            const requiredChannels = giveawayChannelsInput.value.trim();

            confirmGiveawaySetupButton.disabled = true;
            confirmGiveawaySetupButton.textContent = "Initiating...";

            try {
                await callBackend('/api/giveaways/create', 'POST', {
                    creator_id: currentAccountTgId,
                    gift_instance_ids: Array.from(selectedGiveawayGifts),
                    winner_rule: winnerRule,
                    required_channels: requiredChannels
                });
                closeModal(giveawaySetupModal);
                tg.HapticFeedback.notificationOccurred('success');
                tg.showAlert("Giveaway saved! Please return to your chat with the bot to complete the setup.");
            } catch (error) {
            } finally {
                confirmGiveawaySetupButton.disabled = false;
                confirmGiveawaySetupButton.textContent = "Start Setup in Bot";
            }
        }

        function handleFullscreenToggle() {
            const isEnabled = document.getElementById('fullscreen-toggle').checked;
            if (isEnabled) {
                Telegram.WebApp.requestFullscreen();
                localStorage.setItem('fullscreenEnabled' + APP_VERSION_SUFFIX, 'true');
            } else {
                Telegram.WebApp.exitFullscreen();
                localStorage.setItem('fullscreenEnabled' + APP_VERSION_SUFFIX, 'false');
            }
        }
        
        function openSubscriptionModal() {
            if (!currentPublicProfileData) return;
            const subStatus = currentPublicProfileData.subscription_status || {};
            document.getElementById('mentions-toggle').checked = subStatus.mentions || false;
            document.getElementById('new-posts-toggle').checked = subStatus.new_posts || false;
            openModal(document.getElementById('subscription-modal'));
        }
        
        async function updateSubscription(type, isSubscribing) {
            if (!currentPublicProfileData) return;
            try {
                await callBackend('/api/users/subscribe', 'POST', {
                    subscriber_id: currentAccountTgId,
                    target_user_id: currentPublicProfileData.tg_id,
                    notification_type: type,
                    is_subscribing: isSubscribing
                });
                // Update local state
                if (!currentPublicProfileData.subscription_status) {
                    currentPublicProfileData.subscription_status = {};
                }
                currentPublicProfileData.subscription_status[type] = isSubscribing;
                tg.HapticFeedback.impactOccurred('light');
            } catch (error) {
                tg.showAlert('Failed to update subscription.');
                // Revert toggle state
                const toggle = document.getElementById(type === 'mentions' ? 'mentions-toggle' : 'new-posts-toggle');
                toggle.checked = !isSubscribing;
            }
        }
        
        async function handleDeletePost(postId) {
            tg.showConfirm("Are you sure you want to delete this post?", async (confirmed) => {
                if (confirmed) {
                    try {
                        await callBackend(`/api/posts/${postId}`, 'DELETE', { owner_id: currentAccountTgId });
                        profilePosts = profilePosts.filter(p => p.id !== postId);
                        renderPosts();
                        tg.HapticFeedback.notificationOccurred('success');
                    } catch (error) {
                        // Error is handled by callBackend
                    }
                }
            });
        }
        
        // --- Swipe Navigation Logic ---
        function handleModalSwipe(direction) {
            const currentInstanceId = collectibleDetailModal.dataset.instanceId;
            if (!currentInstanceId) return;

            const swipableGifts = currentlySortedGifts.filter(g => g.is_collectible);
            if (swipableGifts.length < 2) return;

            let currentIndex = swipableGifts.findIndex(g => g.instance_id === currentInstanceId);
            if (currentIndex === -1) return;

            let nextIndex = direction === 'next' ? currentIndex + 1 : currentIndex - 1;

            if (nextIndex >= swipableGifts.length) nextIndex = 0;
            if (nextIndex < 0) nextIndex = swipableGifts.length - 1;

            const nextGift = swipableGifts[nextIndex];
            if (nextGift && nextGift.instance_id !== currentInstanceId) {
                closeModal(collectibleDetailModal);
                setTimeout(() => openGiftDetailByInstanceId(nextGift.instance_id), 50);
            }
        }
        
        // --- NEW HELPER FUNCTION: To render the reaction chips ---
        function renderReactionChips(container, post) {
            container.innerHTML = '';
            if (!post.reactions || Object.keys(post.reactions).length === 0) {
                return;
            }
        
            for (const [emoji, data] of Object.entries(post.reactions)) {
                const chip = document.createElement('div');
                chip.className = 'reaction-chip';
                chip.textContent = `${emoji} ${data.count > 1 ? data.count : ''}`.trim();
        
                // Highlight if the current user has reacted with this emoji
                if (data.users && data.users.includes(currentAccountUsername)) {
                    chip.classList.add('reacted-by-user');
                }
        
                // Store user list for the "who reacted" popup
                chip.dataset.users = JSON.stringify(data.users || []);
                chip.dataset.emoji = emoji;
        
                chip.addEventListener('click', (e) => {
                    e.stopPropagation(); // Prevent post click from firing
                    const users = JSON.parse(e.currentTarget.dataset.users);
                    const emoji = e.currentTarget.dataset.emoji;
                    if (users.length > 0) {
                        tg.showAlert(`Reacted with ${emoji}:\n- ${users.join('\n- ')}`);
                    }
                });
        
                container.appendChild(chip);
            }
        }
        
        
        // --- NEW FUNCTION: To open the reaction selection popup ---
        function openReactionPopup(postElement, event) {
            // Close any existing popups
            document.querySelector('.reaction-popup')?.remove();
        
            const postId = postElement.dataset.postId;
            const popup = document.createElement('div');
            popup.className = 'reaction-popup';
        
            AVAILABLE_REACTIONS.forEach(emoji => {
                const emojiSpan = document.createElement('span');
                emojiSpan.textContent = emoji;
                emojiSpan.onclick = (e) => {
                    e.stopPropagation();
                    handleReactionClick(postId, emoji);
                    popup.remove();
                };
                popup.appendChild(emojiSpan);
            });
        
            // Make it fixed to handle scrolling while it's open
            popup.style.position = 'fixed'; 
            document.body.appendChild(popup);
            
            // CORRECTED POSITIONING LOGIC
            // Use clientX/Y which are relative to the viewport.
            // This is simpler and works well with position: fixed.
            let left = event.clientX - popup.offsetWidth / 2;
            let top = event.clientY - 60; // 60px offset above the cursor
        
            // Boundary checks to prevent the popup from going off-screen
            if (left < 10) left = 10;
            if (top < 10) top = 10;
            if (left + popup.offsetWidth > window.innerWidth - 10) {
                left = window.innerWidth - popup.offsetWidth - 10;
            }
        
            popup.style.left = `${left}px`;
            popup.style.top = `${top}px`;
            // --- END CORRECTION ---
        
            // Close when clicking outside
            setTimeout(() => {
                document.addEventListener('click', () => popup.remove(), { once: true });
            }, 0);
        }
        
        // --- NEW FUNCTION: To handle the API call when a reaction is made ---
        async function handleReactionClick(postId, emoji) {
            const post = profilePosts.find(p => p.id == postId);
            if (!post) return;
        
            // Optimistic UI Update
            if (!post.reactions) post.reactions = {};
            if (!post.reactions[emoji]) {
                post.reactions[emoji] = { count: 0, users: [] };
            }
            const reactionData = post.reactions[emoji];
            const userHasReacted = reactionData.users.includes(currentAccountUsername);
            const totalUserReactions = Object.values(post.reactions).filter(r => r.users.includes(currentAccountUsername)).length;
        
            if (userHasReacted) {
                // Un-reacting
                reactionData.count--;
                reactionData.users = reactionData.users.filter(u => u !== currentAccountUsername);
                if (reactionData.count === 0) {
                    delete post.reactions[emoji];
                }
            } else {
                // Reacting
                if (totalUserReactions >= 3) {
                    tg.showAlert("You can add a maximum of 3 different reactions.");
                    return;
                }
                reactionData.count++;
                reactionData.users.push(currentAccountUsername);
            }
            
            // Re-render just the chips for this post
            const postElement = postsContent.querySelector(`.post-card[data-post-id='${postId}']`);
            if (postElement) {
                renderReactionChips(postElement.querySelector('.post-reactions'), post);
            }
        
            // Backend call
            try {
                const response = await callBackend(`/api/posts/${postId}/react`, 'POST', {
                    user_id: currentAccountTgId,
                    reaction_emoji: emoji
                });
                // Sync with authoritative state from backend
                post.reactions = response.reactions;
                if (postElement) {
                    renderReactionChips(postElement.querySelector('.post-reactions'), post);
                }
            } catch (error) {
                // Revert UI on failure - for simplicity, we'll just refetch and rerender all posts
                // In a more complex app, you'd revert the specific change.
                tg.showAlert("Failed to save reaction.");
                await initializeTelegramUserAccount(); // This is a simple way to resync state
            }
        }
        
        
        // --- FULLY UPDATED renderPosts FUNCTION ---
        function renderPosts() {
            postsContent.innerHTML = '';
            if (!profilePosts || profilePosts.length === 0) {
                postsContent.innerHTML = `<p class="empty-grid-message">${viewingOwnProfile ? 'Your wall is empty.' : 'This user has no posts.'}</p>`;
                return;
            }
            profilePosts.forEach(post => {
                const card = document.createElement('div');
                card.className = 'post-card';
                card.dataset.postId = post.id;
                
                const header = document.createElement('div');
                header.className = 'post-card-header';
                header.innerHTML = `
                    <span class="post-date">${new Date(post.created_at).toLocaleString()}</span>
                    <button class="post-menu-btn ${viewingOwnProfile ? '' : 'hidden'}">⋮</button>
                `;
                
                const contentDiv = document.createElement('div');
                contentDiv.className = 'post-content';
                contentDiv.innerHTML = parsePostContent(post.content);
        
                const reactionsContainer = document.createElement('div');
                reactionsContainer.className = 'post-reactions';
        
                card.appendChild(header);
                card.appendChild(contentDiv);
                card.appendChild(reactionsContainer); // Add the container for chips
                
                postsContent.appendChild(card);
                
                // Initial render of reaction chips
                renderReactionChips(reactionsContainer, post);
        
                // Add listeners
                if (viewingOwnProfile) {
                    header.querySelector('.post-menu-btn').addEventListener('click', (e) => {
                        e.stopPropagation();
                        handleDeletePost(post.id);
                    });
                }
                
                // Listener to open reaction popup on post click
                contentDiv.addEventListener('click', (event) => {
                    openReactionPopup(card, event);
                });
            });
        }
        
        function parsePostContent(content) {
            let html = content.replace(/</g, "&lt;").replace(/>/g, "&gt;");
            
            // Bold
            html = html.replace(/\*(.*?)\*/g, '<b>$1</b>');
            // Demonic Red
            html = html.replace(/&(.*?)&/g, '<span class="text-demonic">$1</span>');
            // Pink
            html = html.replace(/♡(.*?)♡/g, '<span class="text-pink">$1</span>');
            // Green
            html = html.replace(/\$(.*?)\$/g, '<span class="text-green">$1</span>');
            // Blue
            html = html.replace(/%(.*?)%/g, '<span class="text-blue">$1</span>');
            // Username
            html = html.replace(/@([a-zA-Z0-9_]{5,32})/g, '<a href="#" class="user-link" data-username="$1">@$1</a>');
            // Gift Name and Number
            html = html.replace(/([A-Za-z\s']{3,20})-([0-9]{1,6})/g, (match, name, number) => {
                const giftId = `${name.replace(/\s/g, '')}-${number}`;
                return `<a href="#" class="gift-link" data-gift-id="${giftId}">${match}</a>`;
            });

            return html;
        }

        function handleWallClick(e) {
            const userLink = e.target.closest('.user-link');
            if (userLink) {
                e.preventDefault();
                displayUserProfile(userLink.dataset.username);
                return;
            }
            const giftLink = e.target.closest('.gift-link');
            if (giftLink) {
                e.preventDefault();
                const [giftName, giftNumber] = giftLink.dataset.giftId.split('-');
                if (giftName && giftNumber) {
                     displayDeepLinkedGift(giftName, parseInt(giftNumber));
                }
            }
        }
        
        async function handleNewPostSubmit() {
            const content = newPostContent.value.trim();
            if (!content) {
                tg.showAlert("Post content cannot be empty.");
                return;
            }
            submitNewPostButton.disabled = true;
            submitNewPostButton.textContent = "Posting...";

            try {
                const newPost = await callBackend('/api/posts', 'POST', {
                    owner_id: currentAccountTgId,
                    content: content
                });
                profilePosts.unshift(newPost); // Add to top
                renderPosts();
                closeModal(newPostModal);
            } catch (error) {
                 // Error handled by callBackend
            } finally {
                submitNewPostButton.disabled = false;
                submitNewPostButton.textContent = "Submit";
                newPostContent.value = '';
            }
        }


        function setupEventListeners() {
            giftsTabButton.addEventListener('click', () => switchTab('gifts'));
            postsTabButton.addEventListener('click', () => switchTab('posts'));
            buyGiftsTabButton.addEventListener('click', () => switchTab('buy-gifts'));
            postsContent.addEventListener('click', handleWallClick);
            newPostFab.addEventListener('click', () => openModal(newPostModal));
            

            if (upgradeAllGiftsButton) upgradeAllGiftsButton.addEventListener('click', handleUpgradeAllGifts);

            profileBio.addEventListener('click', () => { if (viewingOwnProfile) handleEditBio(); });
            profileAvatar.addEventListener('contextmenu', (e) => { e.preventDefault(); if (viewingOwnProfile) avatarUploadInput.click(); });

            document.querySelectorAll('.modal-overlay').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) closeModal(modal);
                });
            });
            closeGiftDetailModalButton.addEventListener('click', () => closeModal(giftDetailModal));
            upgradeGiftDetailModalButton.addEventListener('click', (e) => handleSingleGiftUpgradeFromModal(e.target.dataset.instanceId));

            document.getElementById('close-collectible-detail-modal').addEventListener('click', () => closeModal(collectibleDetailModal));
            document.getElementById('cancel-unpin-modal').addEventListener('click', () => closeModal(tooManyPinsModal));
            document.getElementById('cancel-buy-multiple').addEventListener('click', () => closeModal(buyMultipleModal));
            document.getElementById('close-chances-modal').addEventListener('click', () => closeModal(chancesModal));
            document.getElementById('close-generated-image-modal').addEventListener('click', () => closeModal(generatedImageModal));
            document.getElementById('cancel-sell-button').addEventListener('click', () => closeModal(sellGiftModal));
            document.getElementById('cancel-transfer-button').addEventListener('click', () => closeModal(transferGiftModal));
            document.getElementById('close-numbers-modal').addEventListener('click', () => closeModal(numbersModal));
            document.getElementById('close-usernames-modal').addEventListener('click', () => closeModal(usernamesModal));
            document.getElementById('cancel-giveaway-setup').addEventListener('click', () => closeModal(giveawaySetupModal));
            document.getElementById('profile-edit-btn').addEventListener('click', openEditProfileModal);
            document.getElementById('save-profile-button').addEventListener('click', handleSaveProfile);
            document.getElementById('cancel-edit-profile-button').addEventListener('click', () => closeModal(document.getElementById('edit-profile-modal')));
            document.getElementById('profile-level-bubble').addEventListener('click', showLevelInfoPopup);
            document.getElementById('close-level-modal').addEventListener('click', () => closeModal(document.getElementById('level-info-modal')));

            const hamburgerBtn = document.getElementById('hamburger-btn');
            if (hamburgerBtn) {
                hamburgerBtn.addEventListener('click', openSidebar);
            }
            
            submitNewPostButton.addEventListener('click', handleNewPostSubmit);
            document.getElementById('cancel-new-post-button').addEventListener('click', () => closeModal(newPostModal));
            document.getElementById('formatting-help-toggle').addEventListener('click', (e) => {
                const content = document.getElementById('formatting-help-content');
                content.classList.toggle('hidden');
                e.target.textContent = content.classList.contains('hidden') ? 'Show Formatting Help ▼' : 'Hide Formatting Help ▲';
            });
            const sidebarFooter = document.querySelector('.sidebar-footer');
            const marketButton = document.createElement('button');
            marketButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12,18H6V14H12M21,14V12L20,7H4L3,12V14H4V20H14V14H18V20H20V14M20,4H4V6H20Z" /></svg>Market`;
            marketButton.addEventListener('click', openMarket);
            sidebarFooter.prepend(marketButton); // Add at the top of the footer
        
            const starsButton = document.createElement('button');
            starsButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12,17.27L18.18,21L16.54,13.97L22,9.24L14.81,8.62L12,2L9.19,8.62L2,9.24L7.45,13.97L5.82,21L12,17.27Z" /></svg>Stars`;
            starsButton.addEventListener('click', openStarsPopup);
            sidebarFooter.prepend(starsButton);
            
            // Listeners for new modals
            document.getElementById('topup-stars-button').addEventListener('click', openTopUpModal);
            document.getElementById('cancel-topup-button').addEventListener('click', () => closeModal(document.getElementById('topup-modal')));
            document.getElementById('confirm-topup-button').addEventListener('click', handleSimulateTopUp);
            document.getElementById('topup-amount-input').addEventListener('input', (e) => {
                document.getElementById('confirm-topup-button').disabled = !e.target.value || parseInt(e.target.value) <= 0;
            });

            collectibleActionWear.addEventListener('click', handleWearAction);
            collectibleActionSell.addEventListener('click', handleSellAction);
            collectibleActionTransfer.addEventListener('click', () => {
                const giftInstanceId = collectibleDetailModal.dataset.instanceId;
                const gift = ownedGifts.find(g => g.instance_id === giftInstanceId);
                openTransferModal(gift);
            });
            collectibleMenuButton.addEventListener('click', (e) => {
                const gift = ownedGifts.find(g => g.instance_id === collectibleDetailModal.dataset.instanceId);
                if (gift) openCollectibleMenu(gift, e);
            });
            hideLinkInModal.addEventListener('click', () => {
                const gift = ownedGifts.find(g => g.instance_id === collectibleDetailModal.dataset.instanceId);
                currentLongPressGift = gift;
                handleHideAction();
            });

            menuPinAction.addEventListener('click', handlePinAction);
            menuHideAction.addEventListener('click', handleHideAction);
            menuCopyLinkAction.addEventListener('click', () => { if(currentLongPressGift) copyGiftLink(currentLongPressGift); });
            menuDeleteAction.addEventListener('click', handleDeleteAction);
            menuShareImageAction.addEventListener('click', handleShareImageAction);
            menuReorderAction.addEventListener('click', enterReorderMode);

            confirmBuyMultipleButton.addEventListener('click', handleConfirmBuyMultiple);

            openFiltersButton.addEventListener('click', openFilterPopup);
            applyFiltersButton.addEventListener('click', handleApplyFilters);
            clearFiltersButton.addEventListener('click', handleClearFilters);
            exitFilterModeButton.addEventListener('click', handleClearFilters);
            exitReorderModeButton.addEventListener('click', exitReorderMode);

            exitSelectionModeButton.addEventListener('click', exitSelectionMode);
            hideSelectedGiftsButton.addEventListener('click', handleHideMultiple);
            transferSelectedGiftsButton.addEventListener('click', handleTransferMultiple);

            settingsModal.querySelector('.modal-button.secondary')?.addEventListener('click', () => closeModal(settingsModal));
            animationToggle.addEventListener('change', handleAnimationToggle);
            customGiftsToggle.addEventListener('change', handleCustomGiftsToggle);
            showHiddenToggle.addEventListener('change', handleShowHiddenToggle);
            hideMultipleButton.addEventListener('click', () => enterSelectionMode('hide'));
            transferMultipleButton.addEventListener('click', () => enterSelectionMode('transfer'));
            clearCurrentAccountDataButton.addEventListener('click', handleClearCurrentAccountData);
            clearAllAccountsDataButton.addEventListener('click', handleClearAllAccountsData);

            customizeGiftButton.addEventListener('click', openCustomBuyModal);
            customBuyConfirmButton.addEventListener('click', handleCustomBuyConfirm);
            addAnotherGiftButton.addEventListener('click', addGiftToQueue);

            closeCollectionPriceModal.addEventListener('click', () => closeModal(collectionPriceModal));
            
            sellPriceInput.addEventListener('input', updateSellPriceDetails);
            confirmSellButton.addEventListener('click', handleConfirmSell);

            transferUsernameInput.addEventListener('input', () => { confirmTransferButton.disabled = transferUsernameInput.value.trim() === ''; });
            confirmTransferButton.addEventListener('click', handleConfirmTransfer);

            document.getElementById('fullscreen-toggle').addEventListener('change', handleFullscreenToggle);
            document.getElementById('close-subscription-modal').addEventListener('click', () => closeModal(document.getElementById('subscription-modal')));
            document.getElementById('mentions-toggle').addEventListener('change', (e) => updateSubscription('mentions', e.target.checked));
            document.getElementById('new-posts-toggle').addEventListener('change', (e) => updateSubscription('new_posts', e.target.checked));
        
            avatarUploadInput.addEventListener('change', handleAvatarUpload);

            wornGiftIconContainer.addEventListener('click', () => {
                const wornGift = ownedGifts.find(g => g.is_worn);
                if (wornGift) openGiftDetailByInstanceId(wornGift.instance_id);
            });

            const organizeGiftsButton = document.getElementById('organize-gifts-button');
            if (organizeGiftsButton) organizeGiftsButton.addEventListener('click', enterMoveMode);
            exitMoveModeButton.addEventListener('click', exitMoveMode);
            
            document.getElementById('studio-tab-button').addEventListener('click', () => switchStudioTab('studio'));
            document.getElementById('templates-tab-button').addEventListener('click', () => switchStudioTab('templates'));
            document.getElementById('undo-button').addEventListener('click', handleUndo);
            document.getElementById('redo-button').addEventListener('click', handleRedo);
            document.getElementById('add-another-gift-button').addEventListener('click', addGiftToQueue);
            document.getElementById('apply-last-button').addEventListener('click', () => {
                if (recentCreations.length > 0) applyTemplate(recentCreations[0]);
            });
            document.getElementById('save-template-button').addEventListener('click', saveCurrentGiftAsTemplate);
            customBuyConfirmButton.addEventListener('click', handleCustomBuyConfirm);
            customizeGiftButton.addEventListener('click', openCustomBuyModal);
            
            // Add listeners to collapsible headers
            document.querySelectorAll('.studio-section-header').forEach(header => {
                header.addEventListener('click', () => {
                    header.nextElementSibling.classList.toggle('hidden');
                });
            });
            
            // Text command / clipboard listener
            const quickCreateInput = document.getElementById('quick-create-input');
            quickCreateInput.addEventListener('paste', (e) => {
                setTimeout(() => handleQuickCreate(e.target.value), 0);
            });
            quickCreateInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') handleQuickCreate(e.target.value);
            });
            
            // Search bar listeners
            document.querySelectorAll('#studio-parts-selector .part-search-bar').forEach(input => {
                input.addEventListener('keyup', () => {
                    const gift = giftCreationQueue[currentlyEditingGiftIndex];
                    if (gift && gift.id) {
                        populatePartSelector(gift.id, gift.name); // Re-render with search terms
                    }
                });
            });
            
            openNumbersButton.addEventListener('click', handleOpenNumbersModal);
            openUsernamesButton.addEventListener('click', handleOpenUsernamesModal);
            usernameSearchInput.addEventListener('input', (e) => populateUsernamesList(e.target.value));

            createGiveawayButton.addEventListener('click', openGiveawaySetupModal);
            confirmGiveawaySetupButton.addEventListener('click', handleConfirmGiveawaySetup);

            let touchStartX = 0; const swipeEdgeThreshold = 50;
            appContainer.addEventListener('touchstart', e => { touchStartX = e.changedTouches[0].screenX; }, { passive: true });
            appContainer.addEventListener('touchend', e => {
                if (e.target.closest('.account-sidebar')) return;
                const touchEndX = e.changedTouches[0].screenX;
                const deltaX = touchEndX - touchStartX;
                const currentPage = document.querySelector('.page.active');
                
                if (touchStartX < swipeEdgeThreshold && deltaX > swipeEdgeThreshold) { 
                    openSidebar(); 
                }
                else if (currentPage && currentPage.id === 'profile-page' && deltaX < -swipeEdgeThreshold) {
                    switchTab('buy-gifts');
                }
            }, { passive: true });

            sidebarOverlay.addEventListener('click', closeSidebar);
            

            collectibleDetailModal.addEventListener('touchstart', (e) => {
                modalSwipeState.startX = e.touches[0].clientX;
                modalSwipeState.isSwiping = true;
            }, { passive: true });
            collectibleDetailModal.addEventListener('touchend', (e) => {
                if (!modalSwipeState.isSwiping) return;
                const endX = e.changedTouches[0].clientX;
                const deltaX = endX - modalSwipeState.startX;
                const swipeThreshold = 50;
                if (Math.abs(deltaX) > swipeThreshold) {
                    if (deltaX < 0) handleModalSwipe('next');
                    else handleModalSwipe('prev');
                }
                modalSwipeState.isSwiping = false;
            }, { passive: true });
        }
        // --- END REPLACEMENT: Full setupEventListeners function ---

        if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.initData !== undefined) {
            initApp();
        } else {
            console.warn("Telegram WebApp not found. Running in mock mode.");
            document.addEventListener('DOMContentLoaded', () => {
                tg.initDataUnsafe = {
                    user: {
                        id: 123456789,
                        first_name: "Mock",
                        last_name: "User",
                        username: "mock_user",
                        photo_url: "https://i.pravatar.cc/140?img=1"
                    }
                };
                tg.themeParams = {};
                tg.showAlert = (message, callback) => { alert(message); if (callback) callback(); };
                tg.showConfirm = (message, callback) => callback(confirm(message));
                tg.HapticFeedback = {
                    impactOccurred: (style) => console.log(`Haptic: ${style}`),
                    notificationOccurred: (type) => console.log(`Haptic Notification: ${type}`),
                };
                tg.openTelegramLink = (url) => { console.log(`Opening TG Link: ${url}`); window.open(url, '_blank'); };
                tg.ready = () => {}; tg.expand = () => {}; tg.onEvent = () => {};
                tg.SettingsButton = { isVisible: false, onClick: (cb) => {tg._settingsCb = cb}, show: () => console.log("Settings Button Show"), hide: () => console.log("Settings Button Hide") };
                tg.BackButton = { isVisible: false, onClick: (cb) => {tg._backCb = cb}, offClick: (cb) => {}, show: () => console.log("Back button shown"), hide: () => console.log("Back button hidden") };

                initApp();
            });
        }
    </script>
</body>
</html>
