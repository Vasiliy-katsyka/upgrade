<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>–°–∏–º—É–ª—è—Ç–æ—Ä –ü–æ–¥–∞—Ä–∫–æ–≤ Telegram</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            /* Base Telegram Theme Variables (Fallbacks / Defaults) */
            --tg-theme-bg-color: #171A21;
            --tg-theme-text-color: #ffffff;
            --tg-theme-hint-color: #AAAAAA;
            --tg-theme-link-color: #64B5F6;
            --tg-theme-button-color: #597DA3;
            --tg-theme-button-text-color: #ffffff;
            --tg-theme-secondary-bg-color: #222831;
            --tg-theme-header-bg-color: #171A21;
            --tg-theme-accent-blue: #64B5F6;
            --tg-theme-border-color: #2A3038;

            /* Custom App Variables based on "–ì—Ä–∏—à–∞" screenshots */
            --app-profile-header-bg: #171A21;
            --app-gift-card-bg: #F5E8C7;
            --app-gift-card-text-color: #3A352A;
            --app-gift-card-collectible-badge-bg: rgba(0,0,0,0.6);
            --app-gift-card-collectible-badge-text: #ffffff;
            --app-collectible-modal-ok-button-bg: #A06CD5;
            --app-collectible-modal-ok-button-text: #ffffff;
            --app-collectible-modal-info-label-color: #666666;
            --app-collectible-modal-info-value-color: #000000;
            --app-collectible-modal-bg: #FFFFFF;


            /* Telegram Safe Area Insets (with fallbacks) */
            --tg-safe-area-inset-top: env(safe-area-inset-top, 0px);
            --tg-safe-area-inset-bottom: env(safe-area-inset-bottom, 0px);
            --tg-safe-area-inset-left: env(safe-area-inset-left, 0px);
            --tg-safe-area-inset-right: env(safe-area-inset-right, 0px);

            --app-modal-backdrop-color: rgba(0,0,0,0.65);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--tg-theme-bg-color);
            color: var(--tg-theme-text-color);
            overscroll-behavior-y: none;
            line-height: 1.4;
            font-size: 16px;
        }

        .app-container {
            margin: 0 auto;
            min-height: var(--tg-viewport-height, 100vh);
            height: var(--tg-viewport-height, 100vh);
            display: flex;
            flex-direction: column;
            padding-top: var(--tg-safe-area-inset-top);
            padding-bottom: var(--tg-safe-area-inset-bottom);
            padding-left: var(--tg-safe-area-inset-left);
            padding-right: var(--tg-safe-area-inset-right);
            background-color: var(--tg-theme-bg-color);
        }

        .page {
            display: none;
            flex-direction: column;
            flex-grow: 1;
            background-color: var(--tg-theme-bg-color);
        }
        .page.active { display: flex; }

        .page-header {
            display: flex;
            align-items: center;
            padding: 0 15px;
            background-color: var(--tg-theme-header-bg-color);
            border-bottom: 1px solid var(--tg-theme-border-color);
            min-height: 50px;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .page-header h2 {
            font-size: 1.1em;
            color: var(--tg-theme-text-color);
            font-weight: 500;
            margin-left: 10px;
        }


        /* Profile Page - "–ì—Ä–∏—à–∞" style */
        .profile-header-area {
            background-color: var(--app-profile-header-bg);
            padding: 12px 15px 15px 15px;
        }
        .profile-top-pinned-gifts {
            display: flex;
            justify-content: flex-start;
            margin-bottom: 10px;
            padding-left: 65px;
            height: 28px;
        }
        .profile-top-pinned-gifts img {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            object-fit: contain;
            background-color: var(--app-gift-card-bg);
            border: 1.5px solid var(--app-profile-header-bg);
            margin-left: -8px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }
        .profile-top-pinned-gifts img:first-child { margin-left: 0; }

        .profile-main-info {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }
        .profile-avatar {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            background-color: var(--tg-theme-hint-color);
            margin-right: 12px;
            object-fit: cover;
        }
        .profile-name-status h1 {
            font-size: 1.4em;
            font-weight: 600;
            margin-bottom: 1px;
        }
        .profile-name-status p {
            font-size: 0.85em;
            color: var(--tg-theme-hint-color);
        }
        
        .profile-info-section {
             padding: 0 5px;
        }
        .profile-info-section .info-item {
            padding: 8px 0;
            border-bottom: 1px solid var(--tg-theme-border-color);
        }
        .profile-info-section .info-item:last-child { border-bottom: none; }
        .profile-info-section .info-item .label {
            font-size: 0.8em; color: var(--tg-theme-hint-color); margin-bottom: 2px;
        }
        .profile-info-section .info-item .value {
            font-size: 0.95em; color: var(--tg-theme-text-color);
        }
        .profile-info-section .info-item .value.link { color: var(--tg-theme-link-color); }
        .profile-info-section .info-item .bio-text {
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 1.5;
        }
        .profile-info-section .info-item .bio-text.expanded {
            -webkit-line-clamp: unset;
        }
        .profile-info-section .info-item .more-link {
            color: var(--tg-theme-link-color); cursor: pointer; font-size: 0.95em;
        }
        
        .profile-tabs-container {
            position: sticky;
            top: 0;
            z-index: 5;
            background-color: var(--tg-theme-bg-color);
            padding-top: var(--tg-safe-area-inset-top); 
            margin-top: calc(-1 * var(--tg-safe-area-inset-top));
        }
        .profile-tabs {
            display: flex; justify-content: space-around;
            background-color: var(--app-profile-header-bg);
            padding: 0;
            border-bottom: 1px solid var(--tg-theme-border-color);
        }
        .profile-tabs button {
            background: none; border: none; color: var(--tg-theme-hint-color);
            padding: 14px 10px; font-size: 0.95em; cursor: pointer; flex-grow: 1;
            border-bottom: 3px solid transparent; position: relative;
        }
        .profile-tabs button.active { color: var(--tg-theme-link-color); font-weight: 500; }
        .profile-tabs button.active::after {
            content: ''; position: absolute; bottom: -1px;
            left: 0; right: 0; height: 3px; background-color: var(--tg-theme-link-color);
        }
        
        .gifts-grid-container {
            flex-grow: 1;
            overflow-y: auto;
        }
        .gifts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
            padding: 12px;
            background-color: var(--tg-theme-bg-color);
        }
        .no-gifts-message {
            display: flex; justify-content: center; align-items: center;
            height: 100%; color: var(--tg-theme-hint-color);
            text-align: center; font-size: 1em; padding: 20px;
        }

        .gift-card {
            background-color: var(--app-gift-card-bg);
            color: var(--app-gift-card-text-color);
            border-radius: 12px;
            padding: 8px;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            aspect-ratio: 10 / 11;
            cursor: pointer; position: relative; overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .gift-card-bg-pattern {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background-size: cover; pointer-events: none;
            border-radius: inherit;
        }
        .gift-card-pattern-overlay {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background-repeat: repeat;
            background-size: 30% auto;
            background-position: center;
            opacity: 0.08;
            pointer-events: none;
            border-radius: inherit;
        }
        .gift-card img.gift-image {
            max-width: 70%; max-height: 70%;
            object-fit: contain; z-index: 1; margin-bottom: 5px;
        }
        .gift-card .collectible-number-badge {
            position: absolute; top: 8px; right: 8px;
            background-color: var(--app-gift-card-collectible-badge-bg);
            color: var(--app-gift-card-collectible-badge-text);
            font-size: 0.7em; padding: 3px 7px;
            border-radius: 6px; z-index: 2; font-weight: 500;
        }
        .gift-card .pin-indicator {
            position: absolute; top: 8px; left: 8px;
            width: 18px; height: 18px;
            z-index: 2;
        }
        .gift-card .gift-card-name {
            font-size: 0.75em;
            text-align: center;
            margin-top: 4px;
            line-height: 1.2;
            max-height: 2.4em;
            overflow: hidden;
            text-overflow: ellipsis;
            color: var(--app-gift-card-text-color);
        }

        /* Buy Gifts Page */
        #buy-gifts-page .gifts-grid { background-color: var(--tg-theme-bg-color); }
        .buy-gift-item {
            background-color: var(--tg-theme-secondary-bg-color);
            color: var(--tg-theme-text-color);
            border-radius: 10px; padding: 10px;
            display: flex; flex-direction: column; align-items: center;
            cursor: pointer; position: relative;
        }
        .buy-gift-item img {
            width: 60%; height: auto; max-height: 70px;
            object-fit: contain; margin-bottom: 8px;
        }
        .buy-gift-item .gift-name {
            font-size: 0.8em; text-align: center;
            color: var(--tg-theme-text-color); margin-bottom: 6px;
            min-height: 2.4em; overflow: hidden; text-overflow: ellipsis;
            display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;
        }
        .buy-gift-item .gift-price {
            font-size: 0.9em; color: var(--tg-theme-hint-color);
        }
        .buy-gift-item .gift-price .star-icon { color: #f5a623; margin-right: 3px;}
        .limited-label {
            position: absolute; top: 6px; right: 6px;
            background-color: var(--tg-theme-accent-blue);
            color: var(--tg-theme-button-text-color);
            font-size: 0.65em; padding: 3px 8px;
            border-radius: 10px; font-weight: 500;
        }

        /* Modals Generic Styles */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background-color: var(--app-modal-backdrop-color);
            display: flex; align-items: flex-end;
            justify-content: center; z-index: 1000;
            opacity: 0; visibility: hidden;
            transition: opacity 0.25s ease, transform 0.25s ease;
            transform: translateY(100%);
        }
        .modal-overlay.active {
            opacity: 1; visibility: visible;
            transform: translateY(0%);
        }
        .modal-content {
            background-color: var(--tg-theme-secondary-bg-color);
            padding-top: 10px;
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
            width: 100%; max-width: 600px;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.2);
            display: flex; flex-direction: column;
            max-height: calc(var(--tg-viewport-height, 100vh) - var(--tg-safe-area-inset-top) - 20px); /* Respect top safe area */
        }
        .modal-header-bar {
            padding: 10px 20px 15px 20px; text-align: center;
            border-bottom: 1px solid var(--tg-theme-border-color);
        }
        .modal-header-bar h3 { font-size: 1.1em; font-weight: 500; }
        .modal-scrollable-content {
            overflow-y: auto; padding: 20px; flex-grow: 1;
        }
        .modal-buttons-footer {
            padding: 15px 20px;
            border-top: 1px solid var(--tg-theme-border-color);
            background-color: var(--tg-theme-secondary-bg-color);
        }
        .modal-button {
            background-color: var(--tg-theme-button-color);
            color: var(--tg-theme-button-text-color);
            border: none; padding: 13px; border-radius: 8px;
            font-size: 1em; cursor: pointer; text-align: center;
            font-weight: 500; width: 100%;
        }
        .modal-button.secondary {
            background-color: var(--app-action-button-bg);
            color: var(--tg-theme-link-color);
            margin-top: 10px;
        }

        /* Gift Detail Modal (Non-Collectible) Styles */
        #gift-detail-modal .modal-gift-image {
            width: 100px; height: 100px; object-fit: contain;
            margin: 0 auto 20px auto; display: block;
        }
        #gift-detail-modal .modal-info-table .info-row {
            display: flex; justify-content: space-between;
            padding: 10px 0; font-size: 0.95em;
            border-bottom: 1px solid var(--tg-theme-border-color);
        }
        #gift-detail-modal .modal-info-table .info-row:last-child { border-bottom: none; }
        #gift-detail-modal .modal-info-table .info-label { color: var(--tg-theme-hint-color); }

        /* Collectible Detail Modal (Kissed Frog Style) */
        #collectible-detail-modal .modal-content {
            background-color: var(--app-collectible-modal-bg);
            color: var(--app-collectible-modal-info-value-color);
            padding-top: 0;
        }
        .collectible-modal-header {
            display: flex; justify-content: flex-end;
            align-items: center;
            padding: 10px 15px; height: 44px;
        }
        .collectible-modal-header .menu-icon {
            font-size: 1.5em; color: var(--tg-theme-hint-color); cursor: pointer;
        }

        .collectible-modal-display-area {
            padding: 15px; text-align: center;
            background-image: var(--collectible-pattern-url);
            background-repeat: repeat;
            background-size: 25% auto;
            background-color: var(--collectible-backdrop-center);
            position: relative;
        }
        #collectible-detail-modal #modal-collectible-model-img {
            max-width: 70%;
            max-height: 220px;
            object-fit: contain;
            display: block; margin: 0 auto;
        }
        .collectible-modal-text-info {
            padding: 15px 20px;
        }
        .collectible-modal-text-info .gift-title {
            font-size: 1.3em; font-weight: 600; text-align: center;
            margin-bottom: 4px; color: var(--app-collectible-modal-info-value-color);
        }
        .collectible-modal-text-info .collectible-id {
            font-size: 0.9em; text-align: center;
            color: #8A8A8E;
            margin-bottom: 20px;
        }

        .collectible-modal-info-table { width: 100%; }
        .collectible-modal-info-table .info-row {
            display: flex; align-items: center; justify-content: space-between;
            padding: 12px 0; font-size: 0.95em;
            border-bottom: 1px solid #E5E5EA;
        }
        .collectible-modal-info-table .info-row:last-child { border-bottom: none; }
        .collectible-modal-info-table .info-label { color: var(--app-collectible-modal-info-label-color); }
        .collectible-modal-info-table .info-value {
            color: var(--app-collectible-modal-info-value-color);
            display: flex; align-items: center; font-weight: 500;
        }
        .collectible-modal-info-table .info-value img.owner-avatar {
            width: 22px; height: 22px; border-radius: 50%; margin-right: 8px;
        }
        .collectible-modal-info-table .info-value .rarity-chip {
            padding: 2px 7px; border-radius: 10px;
            font-size: 0.75em; margin-left: 8px; font-weight: 500;
            /* Dynamic background/color set by JS based on rarity values */
        }
        
        #collectible-detail-modal .modal-buttons-footer {
            background-color: var(--app-collectible-modal-bg);
            border-top: none;
            padding: 15px 20px 25px 20px;
        }
        #collectible-detail-modal .modal-button.ok-purple {
            background-color: var(--app-collectible-modal-ok-button-bg);
            color: var(--app-collectible-modal-ok-button-text);
            font-weight: 600;
        }


        /* Long Press Menu */
        #long-press-menu {
            position: fixed;
            background-color: var(--tg-theme-secondary-bg-color);
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            z-index: 1001; padding: 6px 0; min-width: 180px;
        }
        #long-press-menu ul { list-style: none; }
        #long-press-menu li {
            padding: 10px 20px; cursor: pointer;
            color: var(--tg-theme-text-color); font-size: 0.95em;
        }
        #long-press-menu li.disabled {
            color: var(--tg-theme-hint-color);
            cursor: default;
        }
        #long-press-menu li:not(.disabled):hover { background-color: var(--tg-theme-border-color); }
        
        .spinner {
            border: 4px solid var(--tg-theme-hint-color);
            border-top: 4px solid var(--tg-theme-link-color);
            border-radius: 50%; width: 30px; height: 30px;
            animation: spin 1s linear infinite; margin: 20px auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .hidden { display: none !important; }
        .placeholder-image {
            background-color: var(--tg-theme-hint-color); width: 100%; height: 100%;
            display: flex; align-items: center; justify-content: center;
            color: var(--tg-theme-bg-color); font-size: 0.8em; border-radius: 8px;
        }

    </style>
</head>
<body>
    <div class="app-container">
        <!-- Profile Page -->
        <div id="profile-page" class="page active">
            <div class="profile-header-area">
                <div id="profile-top-pinned-gifts" class="profile-top-pinned-gifts"></div>
                <div class="profile-main-info">
                    <img id="profile-avatar" class="profile-avatar" src="" alt="Avatar">
                    <div class="profile-name-status">
                        <h1 id="profile-name">–ò–º—è</h1>
                        <p id="profile-status">–Ω–µ–¥–∞–≤–Ω–æ</p>
                    </div>
                </div>
                <div class="profile-info-section">
                    <div class="info-item">
                        <div class="label">–¢–µ–ª–µ—Ñ–æ–Ω</div>
                        <div class="value" id="profile-phone"></div>
                    </div>
                    <div class="info-item">
                        <div class="label">–û —Å–µ–±–µ</div>
                        <div class="value">
                            <span id="profile-bio-text" class="bio-text"></span>
                            <span id="profile-bio-more" class="more-link hidden">–µ—â—ë</span>
                        </div>
                    </div>
                     <div class="info-item">
                        <div class="label">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</div>
                        <div class="value link" id="profile-username"></div>
                    </div>
                    <div class="info-item">
                        <div class="label">–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è</div>
                        <div class="value" id="profile-dob">28 —è–Ω–≤</div>
                    </div>
                    <div class="info-item" style="display:flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div class="label">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</div>
                            <div class="value" id="profile-notifications">–í–∫–ª.</div>
                        </div>
                        <div class="switch-placeholder" style="width: 40px; height: 24px; background-color: var(--tg-theme-button-color); border-radius: 12px; position:relative;">
                           <span style="display:block; width:20px;height:20px;background:white;border-radius:50%;position:absolute;top:2px;right:2px;"></span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="profile-tabs-container">
                <div class="profile-tabs">
                    <button class="active" id="gifts-tab-button">–ü–æ–¥–∞—Ä–∫–∏ <span id="profile-gift-count-tab"></span></button>
                    <button>–ú–µ–¥–∏–∞</button>
                    <button>–§–∞–π–ª—ã</button>
                    <button>–°—Å—ã–ª–∫–∏</button>
                    <button>–ú—É–∑—ã–∫–∞</button>
                </div>
            </div>
            <div class="gifts-grid-container">
                 <!-- Buy Gifts button, if needed, can be placed here or in a footer -->
                <div style="padding: 10px 15px; text-align: right;">
                     <button id="go-to-buy-gifts" style="background-color: var(--tg-theme-button-color); color: var(--tg-theme-button-text-color); border:none; padding: 8px 15px; border-radius: 20px; font-size: 0.9em; cursor:pointer;">üéÅ –ö—É–ø–∏—Ç—å</button>
                </div>
                <div id="gifts-grid" class="gifts-grid">
                    <div class="spinner hidden" id="gifts-loading-spinner"></div>
                </div>
            </div>
        </div>

        <!-- Buy Gifts Page -->
        <div id="buy-gifts-page" class="page">
            <div class="page-header">
                <h2>–ú–∞–≥–∞–∑–∏–Ω –ø–æ–¥–∞—Ä–∫–æ–≤</h2>
            </div>
             <div class="gifts-grid-container">
                <div id="buy-gifts-grid" class="gifts-grid">
                    <div class="spinner" id="buy-gifts-loading-spinner"></div>
                </div>
            </div>
        </div>

        <!-- Modals -->
        <div id="gift-detail-modal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header-bar"><h3 id="modal-gift-name">–ù–∞–∑–≤–∞–Ω–∏–µ –ø–æ–¥–∞—Ä–∫–∞</h3></div>
                <div class="modal-scrollable-content">
                    <img id="modal-gift-image" class="modal-gift-image" src="" alt="–ü–æ–¥–∞—Ä–æ–∫">
                    <div id="modal-gift-info" class="modal-info-table"></div>
                </div>
                <div class="modal-buttons-footer">
                    <button id="upgrade-gift-button" class="modal-button">–£–ª—É—á—à–∏—Ç—å</button>
                    <button id="close-gift-detail-modal" class="modal-button secondary">–û–ö</button>
                </div>
            </div>
        </div>

        <div id="collectible-detail-modal" class="modal-overlay">
            <div class="modal-content">
                <div class="collectible-modal-header">
                    <span class="menu-icon">‚ãÆ</span>
                </div>
                <div class="modal-scrollable-content" style="padding:0;">
                    <div id="collectible-modal-display-area" class="collectible-modal-display-area">
                        <img id="modal-collectible-model-img" src="" alt="–ú–æ–¥–µ–ª—å">
                    </div>
                    <div class="collectible-modal-text-info">
                        <div id="modal-collectible-main-name" class="gift-title">–ù–∞–∑–≤–∞–Ω–∏–µ –ú–æ–¥–µ–ª–∏</div>
                        <p id="modal-collectible-number-subtext" class="collectible-id">–ö–æ–ª–ª–µ–∫—Ü–∏–æ–Ω–Ω—ã–π #123</p>
                        <div id="modal-collectible-info-table" class="collectible-modal-info-table">
                        </div>
                    </div>
                </div>
                <div class="modal-buttons-footer">
                    <button id="close-collectible-detail-modal" class="modal-button ok-purple">–û–ö</button>
                </div>
            </div>
        </div>

        <div id="too-many-pins-modal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header-bar"><h3>–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –∑–∞–∫—Ä–µ–ø–ª—ë–Ω–Ω—ã—Ö –ø–æ–¥–∞—Ä–∫–æ–≤</h3></div>
                <div class="modal-scrollable-content" style="text-align: center;">
                    <p style="margin-bottom:15px; color: var(--tg-theme-hint-color);">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–¥–∞—Ä–æ–∫ –¥–ª—è –æ—Ç–∫—Ä–µ–ø–ª–µ–Ω–∏—è. –ú–æ–∂–Ω–æ –∑–∞–∫—Ä–µ–ø–∏—Ç—å –¥–æ 6 –ø–æ–¥–∞—Ä–∫–æ–≤.</p>
                    <div id="unpin-selection-grid" class="gifts-grid" style="grid-template-columns: repeat(3, 1fr); max-height: 200px; overflow-y: auto; padding:0 10px;">
                    </div>
                </div>
                 <div class="modal-buttons-footer">
                    <button id="cancel-unpin-modal" class="modal-button secondary">–û—Ç–º–µ–Ω–∞</button>
                </div>
            </div>
        </div>
    </div>

    <div id="long-press-menu" class="hidden">
        <ul><li id="menu-pin-action">–ó–∞–∫—Ä–µ–ø–∏—Ç—å</li></ul>
    </div>

    <script>
    // Constants and Variables
    const CDN_BASE_URL = "https://cdn.changes.tg/gifts/";
    const GIFTS_JSON_URL = `${CDN_BASE_URL}id-to-name.json`;
    const PIN_THUMBTACK_SVG = `<svg viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M16 3.99998C16 2.89541 15.1046 1.99998 14 1.99998H9.99999C8.89542 1.99998 7.99999 2.89541 7.99999 3.99998V9.99998H5.99999C5.65637 9.99998 5.32834 10.1039 5.06065 10.2945C4.79296 10.4851 4.59999 10.7512 4.51063 11.0507C4.42127 11.3502 4.43958 11.6689 4.56295 11.9511C4.68632 12.2333 4.90822 12.4651 5.19065 12.5998L11.1907 15.6C11.6957 15.8242 12.3043 15.8242 12.8093 15.6L18.8093 12.5998C19.0918 12.4651 19.3137 12.2333 19.437 11.9511C19.5604 11.6689 19.5787 11.3502 19.4894 11.0507C19.4000 10.7512 19.2070 10.4851 18.9393 10.2945C18.6717 10.1039 18.3436 9.99998 18 9.99998H16V3.99998ZM14 9.99998H9.99999V3.99998H14V9.99998Z M12 22L12.7071 21.2929L12 20.5858L11.2929 21.2929L12 22Z" /></svg>`;

    let allAvailableGifts = {};
    let ownedGifts = [];
    let pinnedGifts = [];
    const MAX_PINS = 6;
    let tg = window.Telegram.WebApp;

    // DOM Elements
    const profilePage = document.getElementById('profile-page');
    const profileAvatar = document.getElementById('profile-avatar');
    const profileName = document.getElementById('profile-name');
    const profileStatus = document.getElementById('profile-status');
    const profileGiftCountTab = document.getElementById('profile-gift-count-tab');
    const profilePhone = document.getElementById('profile-phone');
    const profileBioText = document.getElementById('profile-bio-text');
    const profileBioMore = document.getElementById('profile-bio-more');
    const profileUsername = document.getElementById('profile-username');
    const profileTopPinnedGifts = document.getElementById('profile-top-pinned-gifts');
    const giftsGrid = document.getElementById('gifts-grid');
    const goToBuyGiftsButton = document.getElementById('go-to-buy-gifts');
    
    const buyGiftsPage = document.getElementById('buy-gifts-page');
    const buyGiftsGrid = document.getElementById('buy-gifts-grid');

    const giftDetailModal = document.getElementById('gift-detail-modal');
    const modalGiftName = document.getElementById('modal-gift-name');
    const modalGiftImage = document.getElementById('modal-gift-image');
    const modalGiftInfo = document.getElementById('modal-gift-info');
    const upgradeGiftButton = document.getElementById('upgrade-gift-button');
    const closeGiftDetailModalButton = document.getElementById('close-gift-detail-modal');

    const collectibleDetailModal = document.getElementById('collectible-detail-modal');
    const modalCollectibleDisplayArea = document.getElementById('collectible-modal-display-area');
    const modalCollectibleModelImg_KF = document.querySelector('#collectible-detail-modal #modal-collectible-model-img');
    const modalCollectibleMainName_KF = document.querySelector('#collectible-detail-modal #modal-collectible-main-name');
    const modalCollectibleNumberSubtext_KF = document.querySelector('#collectible-detail-modal #modal-collectible-number-subtext');
    const modalCollectibleInfoTable_KF = document.querySelector('#collectible-detail-modal #modal-collectible-info-table');
    const closeCollectibleDetailModalButton_KF = document.querySelector('#collectible-detail-modal #close-collectible-detail-modal');
    
    const tooManyPinsModal = document.getElementById('too-many-pins-modal');
    const unpinSelectionGrid = document.getElementById('unpin-selection-grid');
    const cancelUnpinModal = document.getElementById('cancel-unpin-modal');

    const longPressMenu = document.getElementById('long-press-menu');
    const menuPinAction = document.getElementById('menu-pin-action');
    
    const giftsLoadingSpinner = document.getElementById('gifts-loading-spinner');
    const buyGiftsLoadingSpinner = document.getElementById('buy-gifts-loading-spinner');
    
    // Mock User Data Generation
    const russianFirstNames = ["–ì—Ä–∏—à–∞", "–ò–≤–∞–Ω", "–ê–ª–µ–∫—Å–µ–π", "–î–º–∏—Ç—Ä–∏–π", "–°–µ—Ä–≥–µ–π", "–ê–Ω–¥—Ä–µ–π", "–ï–ª–µ–Ω–∞", "–û–ª—å–≥–∞", "–ú–∞—Ä–∏—è", "–ê–Ω–Ω–∞", "–ü–∞–≤–µ–ª", "–ú–∞–∫—Å–∏–º"];
    const russianLastNames = ["–ú–∏–ª–∞–Ω–æ–≤", "–ü–µ—Ç—Ä–æ–≤", "–ò–≤–∞–Ω–æ–≤", "–°–º–∏—Ä–Ω–æ–≤", "–ö—É–∑–Ω–µ—Ü–æ–≤", "–ü–æ–ø–æ–≤", "–í–∞—Å–∏–ª—å–µ–≤", "–ó–∞–π—Ü–µ–≤–∞", "–°–æ–∫–æ–ª–æ–≤–∞", "–õ–µ–±–µ–¥–µ–≤–∞", "–û—Ä–ª–æ–≤", "–ö–æ–∑–ª–æ–≤"];
    const russianBios = [
        "–Ø —Ö–æ—á—É —Å–±–µ–∂–∞—Ç—å –æ—Ç—Å—é–¥–∞, –Ω–æ —è —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –∑–Ω–∞—é... –ü–∞—Ä–æ–ª–∏, —Å—Ö–µ–º—ã –¥–æ–º–∞, –ª—É—Ç–æ–≤—ã–µ, –∏–º–µ–Ω–∞ –∏—Ö.. –ú–µ–Ω—è –Ω–µ –æ—Ç–ø—É—Å–∫–∞—é—Ç –ø–æ–º–æ–≥–∏—Ç–µ",
        "–ü—Ä–æ—Å—Ç–æ —Ö–æ—Ä–æ—à–∏–π —á–µ–ª–æ–≤–µ–∫. –õ—é–±–ª—é –∫–æ—Ç–∏–∫–æ–≤ –∏ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ. –ò—â—É –¥—Ä—É–∑–µ–π –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤.",
        "–ò—â—É –≤–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏–µ –≤ –∫–∞–∂–¥–æ–º –¥–Ω–µ. –í–µ—Ä—é –≤ –ª—É—á—à–µ–µ –∏ —Å—Ç–∞—Ä–∞—é—Å—å –¥–µ–ª–∞—Ç—å –º–∏—Ä –Ω–µ–º–Ω–æ–≥–æ —è—Ä—á–µ."
    ];
    function getRandomElement(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
    function generateRandomPhoneNumber() { let num = '+7 (9'; for (let i = 0; i < 2; i++) num += Math.floor(Math.random() * 10); num += ') '; for (let i = 0; i < 3; i++) num += Math.floor(Math.random() * 10); num += '-'; for (let i = 0; i < 2; i++) num += Math.floor(Math.random() * 10); num += '-'; for (let i = 0; i < 2; i++) num += Math.floor(Math.random() * 10); return num; }
    
    const mockUser = {
        first_name: "–ì—Ä–∏—à–∞",
        photo_url: `https://i.pravatar.cc/128?u=grisha${Math.random()}`,
        bio: russianBios[0],
        phone: "+7 (931) 354-75-74",
        username: "Levont1y_Sigma"
    };

    function generateInstanceId() { return Date.now().toString(36) + Math.random().toString(36).substring(2, 7); }

    // --- Initialization ---
    function initApp() {
        tg.ready();
        tg.expand();
        
        if (tg.isVersionAtLeast('6.9') && tg.setHeaderColor) {
            const headerBgColor = getComputedStyle(document.documentElement).getPropertyValue('--tg-theme-header-bg-color').trim();
            if (headerBgColor) tg.setHeaderColor(headerBgColor);
        }
        
        const setViewportHeight = () => {
            const vh = tg.viewportHeight;
            const vsh = tg.viewportStableHeight;
            document.documentElement.style.setProperty('--tg-viewport-height', `${vh}px`);
            document.documentElement.style.setProperty('--tg-viewport-stable-height', `${vsh}px`);

            // Apply safe area insets from TWA
            if (tg.isVersionAtLeast('8.0') && tg.safeAreaInsets) {
                 document.documentElement.style.setProperty('--tg-safe-area-inset-top', `${tg.safeAreaInsets.top || 0}px`);
                 document.documentElement.style.setProperty('--tg-safe-area-inset-bottom', `${tg.safeAreaInsets.bottom || 0}px`);
                 document.documentElement.style.setProperty('--tg-safe-area-inset-left', `${tg.safeAreaInsets.left || 0}px`);
                 document.documentElement.style.setProperty('--tg-safe-area-inset-right', `${tg.safeAreaInsets.right || 0}px`);
            }
        };
        setViewportHeight(); // Initial call
        tg.onEvent('viewportChanged', setViewportHeight);
        if (tg.isVersionAtLeast('8.0')) { // Listen for safeAreaChanged if available
            tg.onEvent('safeAreaChanged', setViewportHeight); 
        }


        applyTheme(tg.themeParams);
        tg.onEvent('themeChanged', () => {
            applyTheme(tg.themeParams);
            // Re-set header color if theme changed
             if (tg.isVersionAtLeast('6.9') && tg.setHeaderColor) {
                const headerBgColor = getComputedStyle(document.documentElement).getPropertyValue('--tg-theme-header-bg-color').trim();
                if (headerBgColor) tg.setHeaderColor(headerBgColor);
            }
        });
        
        loadUserData();
        loadState();
        renderProfileGifts();
        setupEventListeners();
        fetchAvailableGifts();

        tg.BackButton.hide();
    }
    
    function applyTheme(themeParams) {
        if (themeParams && Object.keys(themeParams).length > 0) {
            const root = document.documentElement;
            const setVar = (varName, value) => { if (value) root.style.setProperty(varName, value); };
            
            setVar('--tg-theme-bg-color', themeParams.bg_color);
            setVar('--tg-theme-text-color', themeParams.text_color);
            setVar('--tg-theme-hint-color', themeParams.hint_color);
            setVar('--tg-theme-link-color', themeParams.link_color);
            setVar('--tg-theme-button-color', themeParams.button_color);
            setVar('--tg-theme-button-text-color', themeParams.button_text_color);
            setVar('--tg-theme-secondary-bg-color', themeParams.secondary_bg_color);
            // Ensuring header_bg_color is specifically set if available, else fallback
            setVar('--tg-theme-header-bg-color', themeParams.header_bg_color || themeParams.secondary_bg_color || themeParams.bg_color); 
            
            document.body.style.backgroundColor = themeParams.bg_color || 'var(--tg-theme-bg-color)';
            document.body.style.color = themeParams.text_color || 'var(--tg-theme-text-color)';
        }
    }

    function loadUserData() {
        const user = tg.initDataUnsafe?.user || mockUser;
        profileName.textContent = user.first_name || mockUser.first_name;
        profileAvatar.src = user.photo_url || mockUser.photo_url;
        profileAvatar.onerror = () => { profileAvatar.src = `https://i.pravatar.cc/128?u=fallback${Math.random()}`; };
        profileUsername.textContent = user.username ? `@${user.username}` : `@${mockUser.username}`;
        profilePhone.textContent = mockUser.phone;
        
        const bio = mockUser.bio;
        profileBioText.textContent = bio;
        // Simple check if text overflows its container (3 lines due to -webkit-line-clamp)
        // This check needs to happen after text is rendered and styles applied.
        // For robustness, it's better to check after a microtask or short timeout if direct check is unreliable.
        requestAnimationFrame(() => { // Ensure styles are applied
            if (profileBioText.scrollHeight > profileBioText.offsetHeight) {
                profileBioMore.classList.remove('hidden');
            } else {
                profileBioMore.classList.add('hidden');
            }
        });
    }
    profileBioMore.addEventListener('click', () => {
        profileBioText.classList.toggle('expanded');
        profileBioMore.textContent = profileBioText.classList.contains('expanded') ? '–º–µ–Ω—å—à–µ' : '–µ—â—ë';
    });


    function saveState() {
        localStorage.setItem('ownedGifts_v5_final', JSON.stringify(ownedGifts));
        localStorage.setItem('pinnedGifts_v5_final', JSON.stringify(pinnedGifts));
    }
    function loadState() {
        ownedGifts = JSON.parse(localStorage.getItem('ownedGifts_v5_final')) || [];
        pinnedGifts = JSON.parse(localStorage.getItem('pinnedGifts_v5_final')) || [];
    }
    
    function showPage(pageId, onBackCallback) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        const targetPage = document.getElementById(pageId);
        if (targetPage) {
            targetPage.classList.add('active');
        } else {
            console.error("Target page not found:", pageId);
            return; // Exit if page doesn't exist
        }

        if (pageId !== 'profile-page' && onBackCallback && typeof onBackCallback === 'function') {
            tg.BackButton.show();
            // Clear previous onClick handlers before setting a new one
            tg.BackButton.offClick(tg.BackButton._currentCallback); // Assuming we store current for removal
            tg.BackButton._currentCallback = onBackCallback; // Store for removal
            tg.BackButton.onClick(onBackCallback);
        } else {
            tg.BackButton.hide();
            if (tg.BackButton._currentCallback) {
                tg.BackButton.offClick(tg.BackButton._currentCallback);
                tg.BackButton._currentCallback = null;
            }
        }
    }
    
    async function fetchAvailableGifts() {
        buyGiftsLoadingSpinner.classList.remove('hidden');
        buyGiftsGrid.innerHTML = '';
        try {
            const response = await fetch(GIFTS_JSON_URL);
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            allAvailableGifts = await response.json();
            renderAvailableGifts();
        } catch (error) {
            console.error("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–æ—Å—Ç—É–ø–Ω—ã–µ –ø–æ–¥–∞—Ä–∫–∏:", error);
            buyGiftsGrid.innerHTML = `<div class="no-gifts-message">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø–æ–¥–∞—Ä–∫–∏.<br>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.</div>`;
        } finally {
            buyGiftsLoadingSpinner.classList.add('hidden');
        }
    }

    function renderAvailableGifts() {
        buyGiftsGrid.innerHTML = '';
        if (Object.keys(allAvailableGifts).length === 0 && buyGiftsLoadingSpinner.classList.contains('hidden')) {
             buyGiftsGrid.innerHTML = `<div class="no-gifts-message">–°–µ–π—á–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –ø–æ–¥–∞—Ä–∫–æ–≤.</div>`;
             return;
        }
        for (const typeId in allAvailableGifts) {
            const name = allAvailableGifts[typeId];
            const originalImageUrl = `${CDN_BASE_URL}originals/${typeId}/Original.png`;
            const item = document.createElement('div');
            item.className = 'buy-gift-item';
            item.dataset.typeId = typeId;
            item.dataset.name = name;
            item.innerHTML = `
                <img src="${originalImageUrl}" alt="${name}" loading="lazy" onerror="this.parentNode.replaceChild(createPlaceholderImage(), this);">
                <div class="gift-name">${name}</div>
                <div class="gift-price"><span class="star-icon">‚≠ê</span> –ë–µ—Å–ø–ª–∞—Ç–Ω–æ</div>
                <div class="limited-label">–û–≥—Ä–∞–Ω–∏—á–µ–Ω–æ</div>
            `;
            item.addEventListener('click', () => buySingleGift(typeId, name, originalImageUrl));
            setupLongPress(item, { typeId, name, originalImageUrl }, true); // isBuyPage = true
            buyGiftsGrid.appendChild(item);
        }
    }
        
    function getGiftCountText(count) {
        if (count % 10 === 1 && count % 100 !== 11) return `${count} –ø–æ–¥–∞—Ä–æ–∫`;
        if (count % 10 >= 2 && count % 10 <= 4 && (count % 100 < 10 || count % 100 >= 20)) return `${count} –ø–æ–¥–∞—Ä–∫–∞`;
        return `${count} –ø–æ–¥–∞—Ä–∫–æ–≤`;
    }

    function renderProfileGifts() {
        giftsGrid.innerHTML = '';
        const giftCount = ownedGifts.length;
        profileGiftCountTab.textContent = giftCount > 0 ? ` ${giftCount}` : ''; // Note the space for better visual
        profileStatus.textContent = giftCount > 0 ? getGiftCountText(giftCount) : "–Ω–µ–¥–∞–≤–Ω–æ";

        const sortedGifts = [...ownedGifts].sort((a, b) => {
            const aIsPinned = pinnedGifts.includes(a.instanceId);
            const bIsPinned = pinnedGifts.includes(b.instanceId);
            if (aIsPinned && !bIsPinned) return -1;
            if (!aIsPinned && bIsPinned) return 1;
            return (new Date(b.acquiredDate || 0)) - (new Date(a.acquiredDate || 0));
        });

        if (sortedGifts.length === 0) {
            giftsGrid.innerHTML = `<div class="no-gifts-message">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –ø–æ–¥–∞—Ä–∫–æ–≤.<br>–í—Ä–µ–º—è —á—Ç–æ-–Ω–∏–±—É–¥—å –∫—É–ø–∏—Ç—å!</div>`;
        } else {
            sortedGifts.forEach(gift => {
                const card = document.createElement('div');
                card.className = 'gift-card';
                card.dataset.instanceId = gift.instanceId;

                const giftImage = document.createElement('img');
                giftImage.className = 'gift-image';
                
                if (gift.isCollectible && gift.collectibleData) {
                    const cd = gift.collectibleData;
                    giftImage.src = cd.modelImage || gift.originalImage;
                    
                    const bgDiv = document.createElement('div');
                    bgDiv.className = 'gift-card-bg-pattern';
                    if (cd.backdropColors) {
                         bgDiv.style.background = `radial-gradient(circle, ${cd.backdropColors.centerColor}, ${cd.backdropColors.edgeColor})`;
                    } else {
                        bgDiv.style.background = 'linear-gradient(45deg, #e0d8b0, #c8bda0)';
                    }
                    card.appendChild(bgDiv);

                    if (cd.patternImage) {
                        const patternOverlayDiv = document.createElement('div');
                        patternOverlayDiv.className = 'gift-card-pattern-overlay';
                        patternOverlayDiv.style.backgroundImage = `url('${cd.patternImage}')`;
                        card.appendChild(patternOverlayDiv);
                    }
                    
                    const numberDiv = document.createElement('div');
                    numberDiv.className = 'collectible-number-badge';
                    numberDiv.textContent = `#${cd.number}`;
                    card.appendChild(numberDiv);
                } else {
                    giftImage.src = gift.originalImage;
                    giftImage.alt = gift.name;
                    const nameDiv = document.createElement('div');
                    nameDiv.className = 'gift-card-name';
                    nameDiv.textContent = gift.name;
                    card.appendChild(nameDiv);
                }
                
                giftImage.onerror = function() { this.parentNode.replaceChild(createPlaceholderImage(true), this); };
                card.insertBefore(giftImage, card.firstChild);

                if (pinnedGifts.includes(gift.instanceId)) {
                    const pinDiv = document.createElement('div');
                    pinDiv.className = 'pin-indicator';
                    pinDiv.innerHTML = PIN_THUMBTACK_SVG; 
                    card.appendChild(pinDiv);
                }

                card.addEventListener('click', () => openGiftDetail(gift.instanceId));
                setupLongPress(card, gift, false);
                giftsGrid.appendChild(card);
            });
        }
        renderTopPinnedGiftsPreview();
    }

    function createPlaceholderImage(isCardPlaceholder = false) {
        const placeholder = document.createElement('div');
        placeholder.className = 'placeholder-image';
        if (isCardPlaceholder) {
            placeholder.style.width = '70%'; placeholder.style.height = '70%';
        }
        placeholder.textContent = 'üñºÔ∏è';
        return placeholder;
    }

    function renderTopPinnedGiftsPreview() {
        profileTopPinnedGifts.innerHTML = '';
        pinnedGifts.slice(0, 5).forEach(instanceId => {
            const gift = ownedGifts.find(g => g.instanceId === instanceId);
            if (gift) {
                const img = document.createElement('img');
                img.src = gift.isCollectible && gift.collectibleData?.modelImage ? gift.collectibleData.modelImage : gift.originalImage;
                img.alt = gift.name;
                img.onerror = function() { this.src = `https://i.pravatar.cc/48?u=pin${Math.random()}`; };
                profileTopPinnedGifts.appendChild(img);
            }
        });
    }
        
    function buySingleGift(typeId, name, originalImage) {
        addGiftsToProfile(typeId, name, originalImage, 1);
        showPage('profile-page'); // BackButton will be hidden by showPage
    }

    function buyMultipleGifts(typeId, name, originalImage) {
        const quantityRaw = prompt(`–°–∫–æ–ª—å–∫–æ "${name}" –≤—ã —Ö–æ—Ç–∏—Ç–µ –∫—É–ø–∏—Ç—å? (1-100)`, "1");
        if (quantityRaw === null) return;
        const quantity = parseInt(quantityRaw);
        if (isNaN(quantity) || quantity < 1 || quantity > 100) {
            tg.showAlert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ –æ—Ç 1 –¥–æ 100.");
            return;
        }
        addGiftsToProfile(typeId, name, originalImage, quantity);
        showPage('profile-page'); // BackButton will be hidden by showPage
    }

    function addGiftsToProfile(typeId, name, originalImage, quantity) {
        for (let i = 0; i < quantity; i++) {
            ownedGifts.unshift({
                instanceId: generateInstanceId(),
                typeId, name, originalImage,
                isCollectible: false, collectibleData: null,
                acquiredDate: new Date().toISOString()
            });
        }
        saveState();
        renderProfileGifts();
        tg.HapticFeedback.notificationOccurred('success');
        if (quantity === 1) {
            tg.showAlert(`"${name}" –¥–æ–±–∞–≤–ª–µ–Ω –≤ –≤–∞—à–∏ –ø–æ–¥–∞—Ä–∫–∏!`);
        } else {
            tg.showAlert(`${quantity} —à—Ç. "${name}" –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ –≤–∞—à–∏ –ø–æ–¥–∞—Ä–∫–∏!`);
        }
    }

    function openGiftDetail(instanceId) {
        const gift = ownedGifts.find(g => g.instanceId === instanceId);
        if (!gift) return;

        if (gift.isCollectible && gift.collectibleData) {
            const cd = gift.collectibleData;
            
            modalCollectibleDisplayArea.style.setProperty('--collectible-pattern-url', cd.patternImage ? `url('${cd.patternImage}')` : 'none');
            modalCollectibleDisplayArea.style.setProperty('--collectible-backdrop-center', cd.backdropColors?.centerColor || '#F5E8C7');
            if (cd.backdropColors?.edgeColor) {
                 modalCollectibleDisplayArea.style.backgroundImage = `linear-gradient(to bottom, ${cd.backdropColors.centerColor}, ${cd.backdropColors.edgeColor}), var(--collectible-pattern-url)`;
            } else {
                 modalCollectibleDisplayArea.style.backgroundImage = `var(--collectible-pattern-url)`;
            }

            modalCollectibleModelImg_KF.src = cd.modelImage || gift.originalImage;
            modalCollectibleMainName_KF.textContent = cd.model?.name || gift.name;
            modalCollectibleNumberSubtext_KF.textContent = `–ö–æ–ª–ª–µ–∫—Ü–∏–æ–Ω–Ω—ã–π #${cd.number}`;
            
            const ownerName = document.getElementById('profile-name').textContent;
            const ownerAvatar = document.getElementById('profile-avatar').src;

            // Helper for rarity chip styling
            const getRarityChipStyle = (permille) => {
                let bgColor, textColor;
                if (permille < 50) { bgColor = '#D1FAE5'; textColor = '#065F46'; } // Low rarity (e.g. green)
                else if (permille < 150) { bgColor = '#FEF3C7'; textColor = '#92400E'; } // Mid rarity (e.g. yellow)
                else { bgColor = '#FFEDD5'; textColor = '#9A3412'; } // High rarity (e.g. orange/red)
                return `style="background-color: ${bgColor}; color: ${textColor};"`;
            };

            modalCollectibleInfoTable_KF.innerHTML = `
                <div class="info-row">
                    <span class="info-label">–í–ª–∞–¥–µ–ª–µ—Ü</span>
                    <span class="info-value"><img src="${ownerAvatar}" alt="" class="owner-avatar">${ownerName}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">–ú–æ–¥–µ–ª—å</span>
                    <span class="info-value">${cd.model?.name || '–ù/–î'} <span class="rarity-chip" ${getRarityChipStyle(cd.model?.rarityPermille || 0)}>${(cd.model?.rarityPermille || 0) / 10}%</span></span>
                </div>
                <div class="info-row">
                    <span class="info-label">–§–æ–Ω</span>
                    <span class="info-value">${cd.backdrop?.name || '–ù/–î'} <span class="rarity-chip" ${getRarityChipStyle(cd.backdrop?.rarityPermille || 0)}>${(cd.backdrop?.rarityPermille || 0) / 10}%</span></span>
                </div>
                <div class="info-row">
                    <span class="info-label">–°–∏–º–≤–æ–ª</span>
                    <span class="info-value">${cd.pattern?.name || '–ù/–î'} <span class="rarity-chip" ${getRarityChipStyle(cd.pattern?.rarityPermille || 0)}>${(cd.pattern?.rarityPermille || 0) / 10}%</span></span>
                </div>
                <div class="info-row">
                    <span class="info-label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</span>
                    <span class="info-value">#${cd.number} (–£–Ω–∏–∫–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä)</span>
                </div>`;
            collectibleDetailModal.classList.add('active');
            tg.BackButton.show();
            tg.BackButton.onClick(() => {
                closeModal(collectibleDetailModal);
                tg.BackButton.hide();
                if (tg.BackButton._currentCallback) {
                     tg.BackButton.offClick(tg.BackButton._currentCallback);
                     tg.BackButton._currentCallback = null;
                }
            });
        } else {
            modalGiftName.textContent = gift.name;
            modalGiftImage.src = gift.originalImage;
            modalGiftInfo.innerHTML = `
                <div class="info-row"><span class="info-label">–î–∞—Ç–∞ –ø–æ–ª—É—á–µ–Ω–∏—è</span><span class="info-value">${new Date(gift.acquiredDate).toLocaleDateString('ru-RU')}</span></div>
                <div class="info-row"><span class="info-label">–°—Ç–æ–∏–º–æ—Å—Ç—å</span><span class="info-value"><span class="star-icon">‚≠ê</span> –ë–µ—Å–ø–ª–∞—Ç–Ω–æ</span></div>
                <div class="info-row"><span class="info-label">–î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å</span><span class="info-value">–û–≥—Ä–∞–Ω–∏—á–µ–Ω–æ</span></div>
                <div class="info-row"><span class="info-label">–£–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å</span><span class="info-value" id="modal-uniqueness-value">–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π</span></div>`;
            upgradeGiftButton.dataset.instanceId = gift.instanceId;
            upgradeGiftButton.disabled = false;
            upgradeGiftButton.textContent = '–£–ª—É—á—à–∏—Ç—å';
            giftDetailModal.classList.add('active');
            tg.BackButton.show();
            tg.BackButton.onClick(() => {
                closeModal(giftDetailModal);
                tg.BackButton.hide();
                 if (tg.BackButton._currentCallback) {
                     tg.BackButton.offClick(tg.BackButton._currentCallback);
                     tg.BackButton._currentCallback = null;
                }
            });
        }
    }
    
    async function handleUpgradeGift(instanceId) {
        const giftIndex = ownedGifts.findIndex(g => g.instanceId === instanceId);
        if (giftIndex === -1) return;
        const gift = ownedGifts[giftIndex];
        if (!gift || gift.isCollectible) return;

        upgradeGiftButton.textContent = '–£–ª—É—á—à–µ–Ω–∏–µ...';
        upgradeGiftButton.disabled = true;
        try {
            const giftNameEncoded = encodeURIComponent(gift.name);
            const [modelsData, backdropsData, patternsData] = await Promise.all([
                fetch(`${CDN_BASE_URL}models/${giftNameEncoded}/models.json`).then(res => res.ok ? res.json() : Promise.reject(new Error(`–ú–æ–¥–µ–ª–∏ –¥–ª—è ${gift.name} –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.`))),
                fetch(`${CDN_BASE_URL}backdrops/${giftNameEncoded}/backdrops.json`).then(res => res.ok ? res.json() : Promise.reject(new Error(`–§–æ–Ω—ã –¥–ª—è ${gift.name} –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.`))),
                fetch(`${CDN_BASE_URL}patterns/${giftNameEncoded}/patterns.json`).then(res => res.ok ? res.json() : Promise.reject(new Error(`–°–∏–º–≤–æ–ª—ã –¥–ª—è ${gift.name} –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.`)))
            ]);

            if (!modelsData?.length || !backdropsData?.length || !patternsData?.length) {
                throw new Error("–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è (–º–æ–¥–µ–ª–∏, —Ñ–æ–Ω—ã –∏–ª–∏ —Å–∏–º–≤–æ–ª—ã).");
            }

            const selectedModel = selectWeightedRandom(modelsData);
            const selectedBackdrop = selectWeightedRandom(backdropsData);
            const selectedPattern = selectWeightedRandom(patternsData);
            const randomNumber = Math.floor(Math.random() * 2000) + 1;

            gift.isCollectible = true;
            gift.collectibleData = {
                model: selectedModel, backdrop: selectedBackdrop, pattern: selectedPattern,
                number: randomNumber,
                modelImage: `${CDN_BASE_URL}models/${giftNameEncoded}/png/${encodeURIComponent(selectedModel.name)}.png`,
                patternImage: `${CDN_BASE_URL}patterns/${giftNameEncoded}/png/${encodeURIComponent(selectedPattern.name)}.png`,
                backdropColors: selectedBackdrop.hex,
            };
            ownedGifts[giftIndex] = gift;

            document.getElementById('modal-uniqueness-value').textContent = `–ö–æ–ª–ª–µ–∫—Ü–∏–æ–Ω–Ω—ã–π #${gift.collectibleData.number}`;
            saveState();
            renderProfileGifts();
            tg.HapticFeedback.notificationOccurred('success');
            setTimeout(() => {
                closeModal(giftDetailModal);
                tg.BackButton.hide(); // Hide back button associated with this modal
                 if (tg.BackButton._currentCallback) {
                     tg.BackButton.offClick(tg.BackButton._currentCallback);
                     tg.BackButton._currentCallback = null;
                }
                openGiftDetail(gift.instanceId); // Open collectible, which will set its own back button
            }, 1200);
        } catch (error) {
            console.error("–û—à–∏–±–∫–∞ —É–ª—É—á—à–µ–Ω–∏—è:", error);
            tg.showAlert(`–ù–µ —É–¥–∞–ª–æ—Å—å —É–ª—É—á—à–∏—Ç—å "${gift.name}". ${error.message}`);
            document.getElementById('modal-uniqueness-value').textContent = '–û—à–∏–±–∫–∞ —É–ª—É—á—à–µ–Ω–∏—è';
        } finally {
            upgradeGiftButton.textContent = '–£–ª—É—á—à–∏—Ç—å';
            upgradeGiftButton.disabled = false;
        }
    }

    function selectWeightedRandom(items) {
        if (!items || items.length === 0) return null;
        let totalWeight = items.reduce((sum, item) => sum + (item.rarityPermille || 1), 0);
        if (totalWeight === 0) return items[Math.floor(Math.random() * items.length)];
        let randomNum = Math.random() * totalWeight;
        for (let item of items) {
            if (randomNum < (item.rarityPermille || 1)) return item;
            randomNum -= (item.rarityPermille || 1);
        }
        return items[items.length - 1];
    }

    function closeModal(modalElement) {
        if (modalElement) modalElement.classList.remove('active');
        // BackButton management is handled by the caller or showPage
    }

    let currentLongPressGift = null;
    let longPressTimer;

    function setupLongPress(element, giftData, isBuyPage = false) {
        element.addEventListener('touchstart', (e) => {
            longPressTimer = window.setTimeout(() => {
                if (isBuyPage) {
                    buyMultipleGifts(giftData.typeId, giftData.name, giftData.originalImageUrl);
                } else {
                    openLongPressMenu(giftData, e.touches[0]);
                }
            }, 500);
        }, { passive: false });

        element.addEventListener('touchend', () => clearTimeout(longPressTimer));
        element.addEventListener('touchmove', () => clearTimeout(longPressTimer));
        
        if (!isBuyPage) {
            element.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                openLongPressMenu(giftData, e);
            });
        }
    }
    
    function openLongPressMenu(gift, eventCoords) {
        currentLongPressGift = gift;
        const isPinned = pinnedGifts.includes(gift.instanceId);
        menuPinAction.textContent = isPinned ? '–û—Ç–∫—Ä–µ–ø–∏—Ç—å' : '–ó–∞–∫—Ä–µ–ø–∏—Ç—å';
        
        if (!gift.isCollectible) {
            menuPinAction.classList.add('disabled');
        } else {
            menuPinAction.classList.remove('disabled');
        }
        
        longPressMenu.style.top = `${Math.min(eventCoords.clientY, window.innerHeight - longPressMenu.offsetHeight - 10)}px`;
        longPressMenu.style.left = `${Math.min(eventCoords.clientX, window.innerWidth - longPressMenu.offsetWidth - 10)}px`;
        longPressMenu.classList.remove('hidden');
        document.addEventListener('click', closeLongPressMenuOnClickOutside, { once: true, capture: true });
    }
    
    function closeLongPressMenuOnClickOutside(event) {
        if (!longPressMenu.contains(event.target) && event.target !== longPressMenu) {
            longPressMenu.classList.add('hidden');
        }
    }

    function handlePinAction() {
        if (!currentLongPressGift || !currentLongPressGift.isCollectible) {
            longPressMenu.classList.add('hidden');
            if (currentLongPressGift && !currentLongPressGift.isCollectible) {
                tg.showAlert("–ú–æ–∂–Ω–æ –∑–∞–∫—Ä–µ–ø–ª—è—Ç—å —Ç–æ–ª—å–∫–æ –∫–æ–ª–ª–µ–∫—Ü–∏–æ–Ω–Ω—ã–µ –ø–æ–¥–∞—Ä–∫–∏.");
            }
            return;
        }

        const giftInstanceId = currentLongPressGift.instanceId;
        const isPinned = pinnedGifts.includes(giftInstanceId);

        if (isPinned) {
            pinnedGifts = pinnedGifts.filter(id => id !== giftInstanceId);
        } else {
            if (pinnedGifts.length >= MAX_PINS) {
                showTooManyPinsModal();
                longPressMenu.classList.add('hidden');
                return;
            }
            pinnedGifts.push(giftInstanceId);
        }
        saveState();
        renderProfileGifts();
        longPressMenu.classList.add('hidden');
        tg.HapticFeedback.impactOccurred(isPinned ? 'light' : 'medium');
    }
    
    function showTooManyPinsModal() {
        unpinSelectionGrid.innerHTML = '';
        pinnedGifts.forEach(instanceIdToUnpin => {
            const giftToUnpin = ownedGifts.find(g => g.instanceId === instanceIdToUnpin);
            if (giftToUnpin) {
                const card = document.createElement('div');
                card.className = 'gift-card'; // Reuse style for selection
                card.style.backgroundColor = 'var(--tg-theme-secondary-bg-color)'; // Darker for modal
                card.style.color = 'var(--tg-theme-text-color)';

                const img = document.createElement('img');
                img.className = 'gift-image';
                img.src = giftToUnpin.isCollectible && giftToUnpin.collectibleData?.modelImage ? giftToUnpin.collectibleData.modelImage : giftToUnpin.originalImage;
                img.alt = giftToUnpin.name;
                img.onerror = function() { this.parentNode.replaceChild(createPlaceholderImage(true), this); };
                card.appendChild(img);
                if (giftToUnpin.isCollectible && giftToUnpin.collectibleData) {
                    const numBadge = document.createElement('div');
                    numBadge.className = 'collectible-number-badge';
                    numBadge.textContent = `#${giftToUnpin.collectibleData.number}`;
                    card.appendChild(numBadge);
                } else {
                    const nameDiv = document.createElement('div');
                    nameDiv.className = 'gift-card-name';
                    nameDiv.textContent = giftToUnpin.name;
                    nameDiv.style.color = 'var(--tg-theme-text-color)';
                    card.appendChild(nameDiv);
                }

                card.addEventListener('click', () => {
                    pinnedGifts = pinnedGifts.filter(id => id !== instanceIdToUnpin);
                    if (currentLongPressGift && currentLongPressGift.isCollectible && !pinnedGifts.includes(currentLongPressGift.instanceId) && pinnedGifts.length < MAX_PINS) {
                         pinnedGifts.push(currentLongPressGift.instanceId);
                    }
                    saveState();
                    renderProfileGifts();
                    closeModal(tooManyPinsModal);
                    tg.HapticFeedback.impactOccurred('medium');
                });
                unpinSelectionGrid.appendChild(card);
            }
        });
        tooManyPinsModal.classList.add('active');
         tg.BackButton.show(); // Show back button for this modal
         tg.BackButton.onClick(() => {
            closeModal(tooManyPinsModal);
            tg.BackButton.hide();
             if (tg.BackButton._currentCallback) {
                tg.BackButton.offClick(tg.BackButton._currentCallback);
                tg.BackButton._currentCallback = null;
            }
         });
    }

    function setupEventListeners() {
        goToBuyGiftsButton.addEventListener('click', () => showPage('buy-gifts-page', () => showPage('profile-page')));

        closeGiftDetailModalButton.addEventListener('click', () => {
            closeModal(giftDetailModal);
            tg.BackButton.hide();
             if (tg.BackButton._currentCallback) {
                tg.BackButton.offClick(tg.BackButton._currentCallback);
                tg.BackButton._currentCallback = null;
            }
        });
        upgradeGiftButton.addEventListener('click', (e) => handleUpgradeGift(e.target.dataset.instanceId));
        
        closeCollectibleDetailModalButton_KF.addEventListener('click', () => {
            closeModal(collectibleDetailModal);
            tg.BackButton.hide();
             if (tg.BackButton._currentCallback) {
                tg.BackButton.offClick(tg.BackButton._currentCallback);
                tg.BackButton._currentCallback = null;
            }
        });
        
        menuPinAction.addEventListener('click', handlePinAction);
        cancelUnpinModal.addEventListener('click', () => {
            closeModal(tooManyPinsModal);
            tg.BackButton.hide();
             if (tg.BackButton._currentCallback) {
                tg.BackButton.offClick(tg.BackButton._currentCallback);
                tg.BackButton._currentCallback = null;
            }
        });

        [giftDetailModal, tooManyPinsModal].forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeModal(modal);
                    // If this modal specifically showed a back button, hide it
                    // This logic is tricky, better to rely on showPage/modal opening to manage BB
                    if (tg.BackButton.isVisible && (modal === giftDetailModal || modal === tooManyPinsModal) ) {
                        tg.BackButton.hide();
                         if (tg.BackButton._currentCallback) {
                            tg.BackButton.offClick(tg.BackButton._currentCallback);
                            tg.BackButton._currentCallback = null;
                        }
                    }
                }
            });
        });
        giftsGrid.addEventListener('scroll', () => { if(!longPressMenu.classList.contains('hidden')) longPressMenu.classList.add('hidden'); });
    }
        
    if (window.Telegram && window.Telegram.WebApp && typeof tg.initData !== 'undefined') {
        initApp();
    } else {
        console.warn("Telegram WebApp –Ω–µ –Ω–∞–π–¥–µ–Ω. –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –º–æ–∫-–¥–∞–Ω–Ω—ã–µ –∏ —Ç–µ–º–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é.");
        document.addEventListener('DOMContentLoaded', () => {
             window.Telegram.WebApp = window.Telegram.WebApp || {}; // Ensure structure exists
             tg = window.Telegram.WebApp; // Re-assign tg if it was initially undefined
             tg.initDataUnsafe = { user: mockUser };
             tg.themeParams = {};
             tg.showAlert = (message) => alert(message);
             tg.HapticFeedback = { impactOccurred: (s) => console.log(`Haptic: ${s}`), notificationOccurred: (t) => console.log(`Haptic: ${t}`) };
             tg.ready = () => {}; tg.expand = () => {}; tg.onEvent = () => {};
             tg.BackButton = { 
                _currentCallback: null,
                show: function() { console.log("TWA Mock: BB.show"); this.isVisible = true; }, 
                hide: function() { console.log("TWA Mock: BB.hide"); this.isVisible = false; }, 
                onClick: function(cb) {this._currentCallback = cb; console.log("TWA Mock: BB.onClick");}, 
                offClick: function(cb) { if(this._currentCallback === cb) this._currentCallback = null; console.log("TWA Mock: BB.offClick");}, 
                isVisible: false 
             };
             tg.isVersionAtLeast = () => true;
             tg.setHeaderColor = (c) => console.log("TWA Mock: setHeaderColor", c);
             tg.viewportHeight = window.innerHeight;
             tg.viewportStableHeight = window.innerHeight;
             tg.safeAreaInsets = {top:0, bottom:0, left:0, right:0}; // Mock safe area
             initApp();
        });
    }
    </script>
</body>
</html>
